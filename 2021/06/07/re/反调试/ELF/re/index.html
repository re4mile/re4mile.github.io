<!DOCTYPE html>
<html lang='zh-CN'>

<head>
  <meta name="generator" content="Hexo 6.3.0">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.18.5">
  <meta charset="utf-8">
  

  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel='dns-prefetch' href='https://gcore.jsdelivr.net'>
  <link rel="preconnect" href="https://gcore.jsdelivr.net" crossorigin>
  <link rel='dns-prefetch' href='//unpkg.com'>

  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#f8f8f8">
  
  <title>ELF反调试 - re4mile</title>

  
    <meta name="description" content="参考链接https:&#x2F;&#x2F;www.cnblogs.com&#x2F;h2zZhou&#x2F;p&#x2F;6637890.html 带学习的参考链接 https:&#x2F;&#x2F;blog.csdn.net&#x2F;stonesharp&#x2F;article&#x2F;details&#x2F;8211526 数据加密 有源码加固 基于特定section的加解密实现   基于section的加解密，是指将elf文件的特定section进行加密，elf文件被加载时解密  代码">
<meta property="og:type" content="article">
<meta property="og:title" content="ELF反调试">
<meta property="og:url" content="https://gitee.com/re4mile/re4mile.git/2021/06/07/re/%E5%8F%8D%E8%B0%83%E8%AF%95/ELF/re/index.html">
<meta property="og:site_name" content="re4mile">
<meta property="og:description" content="参考链接https:&#x2F;&#x2F;www.cnblogs.com&#x2F;h2zZhou&#x2F;p&#x2F;6637890.html 带学习的参考链接 https:&#x2F;&#x2F;blog.csdn.net&#x2F;stonesharp&#x2F;article&#x2F;details&#x2F;8211526 数据加密 有源码加固 基于特定section的加解密实现   基于section的加解密，是指将elf文件的特定section进行加密，elf文件被加载时解密  代码">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="f:/5008/Note/blog/ELF%E6%B7%B7%E6%B7%86/630711_HKTSQYPN8PWY52F.png">
<meta property="og:image" content="f:/5008/Note/blog/ELF%E6%B7%B7%E6%B7%86/630711_G7FYDT94A9NVKNU.png">
<meta property="og:image" content="f:/5008/Note/blog/ELF%E6%B7%B7%E6%B7%86/Snipaste_2022-11-21_23-54-59.png">
<meta property="og:image" content="f:/5008/Note/blog/ELF%E6%B7%B7%E6%B7%86/image-20221122084237397.png">
<meta property="og:image" content="f:/5008/Note/blog/ELF%E6%B7%B7%E6%B7%86/image-20221122084302591.png">
<meta property="og:image" content="f:/5008/Note/blog/ELF%E6%B7%B7%E6%B7%86/image-20221123131806341.png">
<meta property="og:image" content="f:/5008/Note/blog/ELF%E6%B7%B7%E6%B7%86/image-20221123144227040.png">
<meta property="og:image" content="f:/5008/Note/blog/ELF%E6%B7%B7%E6%B7%86/image-20221123144643014.png">
<meta property="article:published_time" content="2021-06-07T01:00:00.000Z">
<meta property="article:modified_time" content="2022-12-29T10:20:13.845Z">
<meta property="article:author" content="邓渠香">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Anti_Dbg">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="f:/5008/Note/blog/ELF%E6%B7%B7%E6%B7%86/630711_HKTSQYPN8PWY52F.png">
  
  

  <!-- feed -->
  

  
    
<link rel="stylesheet" href="/re4mile/css/main.css">

  

  
    <link rel="shortcut icon" href="https://s1.ax1x.com/2023/01/03/pSip2aF.png">
  

  

  


  
</head>

<body>
  




  <div class='l_body' id='start'>
    <aside class='l_left' layout='post'>
    

  

<header class="header"><div class="logo-wrap"><a class="avatar" href="/re4mile/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.4/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="https://s1.ax1x.com/2022/12/21/zOXq9s.png" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.4/image/2659360.svg';"></a><a class="title" href="/re4mile/"><div class="main" ff="title">re4mile</div><div class="sub cap">好记性不如烂笔头</div></a></div>

<nav class="menu dis-select"><a class="nav-item" href="/re4mile/">文章</a><a class="nav-item" href="/re4mile/wiki/">项目</a><a class="nav-item" href="/re4mile/about/">关于</a><a class="nav-item" href="/re4mile/friends/">友链</a></nav>
</header>


<div class="widgets">
<widget class="widget-wrapper search"><div class="widget-body"><div class="search-wrapper" id="search"><form class="search-form"><input type="text" class="search-input" id="search-input" data-filter="/blog/" placeholder="文章搜索"><svg t="1670596976048" class="icon search-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2676" width="200" height="200"><path d="M938.2 832.6L723.8 618.1c-2.5-2.5-5.3-4.4-7.9-6.4 36.2-55.6 57.3-121.8 57.3-193.1C773.3 222.8 614.6 64 418.7 64S64 222.8 64 418.6c0 195.9 158.8 354.6 354.6 354.6 71.3 0 137.5-21.2 193.2-57.4 2 2.7 3.9 5.4 6.3 7.8L832.5 938c14.6 14.6 33.7 21.9 52.8 21.9 19.1 0 38.2-7.3 52.8-21.8 29.2-29.1 29.2-76.4 0.1-105.5M418.7 661.3C284.9 661.3 176 552.4 176 418.6 176 284.9 284.9 176 418.7 176c133.8 0 242.6 108.9 242.6 242.7 0 133.7-108.9 242.6-242.6 242.6" p-id="2677"></path></svg></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div></div></widget>


<widget class="widget-wrapper toc single" id="data-toc"><div class="widget-header cap dis-select"><span class="name">ELF反调试</span></div><div class="widget-body fs14"><div class="doc-tree active"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Inline-hook"><span class="toc-text">Inline hook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GOT-hook"><span class="toc-text">GOT hook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PRELOAD-hook"><span class="toc-text">PRELOAD hook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Linker%E9%87%8D%E5%AE%9A%E4%BD%8Dhook"><span class="toc-text">Linker重定位hook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UPX%E5%A3%B3%E5%8F%8A%E5%88%86%E6%9E%90"><span class="toc-text">UPX壳及分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shellcode%E4%BF%9D%E6%8A%A4%E6%96%B9%E6%A1%88"><span class="toc-text">Shellcode保护方案.</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5%E5%99%A8%E5%8F%8A%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-text">链接器及加载器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VMP"><span class="toc-text">VMP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96"><span class="toc-text">控制流平坦化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95%E8%A7%92%E5%BA%A6"><span class="toc-text">语法角度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%BA%E4%B8%BA%E4%BC%98%E5%8C%96"><span class="toc-text">人为优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E9%87%8F%E4%BC%A0%E6%92%AD-%E5%88%B0%E8%BE%BE%E5%AE%9A%E5%80%BC%E5%88%86%E6%9E%90"><span class="toc-text">常量传播 | 到达定值分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%BB%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96"><span class="toc-text">死代码优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81"><span class="toc-text">虚假控制流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8A%B1%E6%8C%87%E4%BB%A4"><span class="toc-text">花指令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#r%E6%8C%87%E4%BB%A4%E4%B9%B1%E5%BA%8F%EF%BC%8C%E4%BD%BF%E7%94%A8B%E8%A1%94%E6%8E%A5"><span class="toc-text">r指令乱序，使用B衔接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%87%E4%BB%A4%E6%9B%BF%E6%8D%A2%EF%BC%8C%E6%9B%BF%E6%8D%A2%E4%B8%BAB%E6%8C%87%E4%BB%A4"><span class="toc-text">指令替换，替换为B指令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%87%E4%BB%A4%E7%B4%A2%E5%BC%95%E5%B9%B6%E4%B8%94%E4%B9%B1%E5%BA%8F%EF%BC%8C%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95%E8%A1%A8%E6%9D%A5%E8%B7%B3%E8%BD%AC"><span class="toc-text">指令索引并且乱序，使用索引表来跳转</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LLVM%E6%96%B9%E5%BC%8F%E6%B7%B7%E6%B7%86"><span class="toc-text">LLVM方式混淆</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#int3"><span class="toc-text">int3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%88%E4%BA%8Emain%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C"><span class="toc-text">先于main函数执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8D%95%E6%8D%89%E4%BF%A1%E5%8F%B7"><span class="toc-text">捕捉信号</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E8%BF%90%E8%A1%8CtracerPID%E7%8A%B6%E6%80%81%E7%9A%84%E6%A3%80%E6%B5%8B"><span class="toc-text">检测运行tracerPID状态的检测</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E8%B0%83%E8%AF%95%E8%BF%9B%E7%A8%8B"><span class="toc-text">检测调试进程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ptrace"><span class="toc-text">ptrace</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%B9b"><span class="toc-text">吹b</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E4%BB%8B%E7%BB%8D"><span class="toc-text">函数介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%8A%9F%E8%83%BD"><span class="toc-text">应用功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-1"><span class="toc-text">例子</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%96%E5%87%BA%E7%AC%A6%E5%8F%B7%E8%A1%A8"><span class="toc-text">取出符号表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%8A%A0%E8%BD%BD"><span class="toc-text">静态加载</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%A8%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%87%BD%E6%95%B0"><span class="toc-text">用动态加载函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E5%AD%98%E5%82%A8%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-text">局部变量存储字符串</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%A8%E6%B1%87%E7%BC%96%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAptrace%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-text">用汇编实现一个ptrace的函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E5%B5%8C%E6%B1%87%E7%BC%96%E5%AE%9E%E7%8E%B0ptrace"><span class="toc-text">内嵌汇编实现ptrace</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%A8SMC%E9%9A%90%E8%97%8F%E7%B3%BB%E7%BB%9F%E7%9A%84%E8%B0%83%E7%94%A8"><span class="toc-text">用ＳＭＣ隐藏系统的调用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5"><span class="toc-text">代码注入</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%84%E7%90%86ELF%E6%A0%BC%E5%BC%8F%EF%BC%8C%E9%98%BB%E6%AD%A2IDA%E5%8A%A0%E8%BD%BD"><span class="toc-text">处理ELF格式，阻止IDA加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%AE%88%E6%8A%A4"><span class="toc-text">多进程守护</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CRC%E6%A0%A1%E9%AA%8C"><span class="toc-text">CRC校验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E4%B8%AD%E6%96%AD%E6%8C%87%E4%BB%A4%E6%A3%80%E6%B5%8B%EF%BC%88%E7%B1%BB%E4%BC%BCx86-0xCC%EF%BC%89"><span class="toc-text">调试中断指令检测（类似x86 0xCC）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%99%A8%E6%A3%80%E6%B5%8B"><span class="toc-text">调试器检测</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E9%97%B4%E7%9A%84%E6%A3%80%E6%B5%8B"><span class="toc-text">运行时间的检测</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E6%89%93%E5%BC%80%E7%9A%84fd%E6%96%87%E4%BB%B6"><span class="toc-text">检测打开的fd文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ELF%E5%85%A5%E5%8F%A3%E5%8A%A0%E8%A7%A3%E5%AF%86"><span class="toc-text">ELF入口加解密</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E5%8A%A8%E6%80%81%E5%8A%A0%E8%A7%A3%E5%AF%86%EF%BC%8C%E6%8C%87%E4%BB%A4%E7%BA%A7%E5%8A%A0%E8%A7%A3%E5%AF%86"><span class="toc-text">函数动态加解密，指令级加解密</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%8A%A0%E8%BD%BD%E5%99%A8%E7%9A%84%E5%87%BD%E6%95%B0%E5%8A%A0%E8%A7%A3%E5%AF%86"><span class="toc-text">基于加载器的函数加解密</span></a></li></ol></div></div></widget>




</div>


    </aside>
    <div class='l_main'>
      

      


<div class="bread-nav fs12"><div id="breadcrumb"><a class="cap breadcrumb" href="/re4mile/">主页</a><span class="sep"></span><a class="cap breadcrumb" href="/re4mile/">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="/re4mile/categories/Reverse/">Reverse</a></div><div id="post-meta">发布于&nbsp;<time datetime="2021-06-07T01:00:00.000Z">2021-06-07</time></div></div>

<article class='md-text content post reveal'>
<h1 class="article-title"><span>ELF反调试</span></h1>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/h2zZhou/p/6637890.html">https://www.cnblogs.com/h2zZhou/p/6637890.html</a></p>
<p>带学习的参考链接</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/stonesharp/article/details/8211526">https://blog.csdn.net/stonesharp/article/details/8211526</a></p>
<h1 id="数据加密"><a href="#数据加密" class="headerlink" title="数据加密"></a>数据加密</h1><ul>
<li><p>有源码加固 基于特定section的加解密实现</p>
<p>  基于section的加解密，是指将elf文件的特定section进行加密，elf文件被加载时解密</p>
</li>
<li><p>代码加密.可以对指定函数进行代码片加密，只有程序运行的时候才能解密，破解者无法 Dump 出整体的内存，</p>
<p>  有效防止逆向工程工具对程序进行静态分析</p>
<p>  下面是对一个节区的加密代码</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> BYTE unsigned char</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DWORD unsigned int</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> QWORD unsigned long long</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;elf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span>* <span class="title function_">qword_to_str</span><span class="params">(QWORD data, BYTE* buf)</span>;</span><br><span class="line">BYTE* gbuf[<span class="number">64</span>];</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span>  target_section [] = <span class="string">&quot;.text&quot;</span>;</span><br><span class="line">	<span class="type">char</span> *lp_SecName = <span class="number">0</span>;</span><br><span class="line">	<span class="type">char</span> *Sec_Data = <span class="number">0</span>;</span><br><span class="line">	Elf64_Ehdr st_Elf_Header64;</span><br><span class="line">	Elf64_Shdr st_SecHeader64;</span><br><span class="line">	QWORD	i=<span class="number">0</span>;</span><br><span class="line">	QWORD	Sec_FA=<span class="number">0</span>, Sec_Size=<span class="number">0</span>;</span><br><span class="line">	QWORD	nblock=<span class="number">0</span>, nsize=<span class="number">0</span>, block_size = <span class="number">16</span>;</span><br><span class="line">  </span><br><span class="line">	<span class="type">int</span> fd;</span><br><span class="line">	<span class="type">int</span> NumSec = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">if</span> (argc &lt; <span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Input xxx.elf file&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">	fd = open(argv[<span class="number">1</span>], O_RDWR);</span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;open %s failed\n&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line">		<span class="keyword">goto</span> _error;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//读取elf文件头</span></span><br><span class="line">	<span class="keyword">if</span>(read(fd, &amp;st_Elf_Header64, <span class="keyword">sizeof</span>(Elf64_Ehdr)) != <span class="keyword">sizeof</span>(Elf64_Ehdr))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Read ELF header error&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> _error;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//off_t lseek(文件描述符,偏移,起点);</span></span><br><span class="line">	<span class="comment">//找到节区名的section</span></span><br><span class="line">	lseek(fd, st_Elf_Header64.e_shoff + <span class="keyword">sizeof</span>(Elf64_Shdr) * st_Elf_Header64.e_shstrndx, SEEK_SET);</span><br><span class="line">  </span><br><span class="line">	<span class="comment">// ELF section string  table</span></span><br><span class="line">	<span class="keyword">if</span>(read(fd, &amp;st_SecHeader64, <span class="keyword">sizeof</span>(Elf64_Shdr)) != <span class="keyword">sizeof</span>(Elf64_Shdr))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Read ELF section string table error&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> _error;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//分配str空间中</span></span><br><span class="line">	<span class="keyword">if</span>((lp_SecName = (<span class="type">char</span> *) <span class="built_in">malloc</span>(st_SecHeader64.sh_size)) == <span class="number">0</span>) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Malloc space for section string table failed&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> _error;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//Read string table </span></span><br><span class="line">	lseek(fd, st_SecHeader64.sh_offset, SEEK_SET);</span><br><span class="line">	<span class="keyword">if</span> (read(fd, lp_SecName, st_SecHeader64.sh_size) != st_SecHeader64.sh_size) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Read string table failed&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> _error;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//通过st_SecHeader64 -&gt; sh_name 在str字符串中索引，与.mytext进行字符串比较，如果不匹配，继续读取</span></span><br><span class="line">	lseek(fd, st_Elf_Header64.e_shoff, SEEK_SET);</span><br><span class="line">	NumSec = st_Elf_Header64.e_shnum;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;NumSec ; i++) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (read(fd, &amp;st_SecHeader64, <span class="keyword">sizeof</span>(Elf64_Shdr)) != <span class="keyword">sizeof</span>(Elf64_Shdr)) </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">puts</span>(<span class="string">&quot;Find section .text procedure failed&quot;</span>);</span><br><span class="line">			<span class="keyword">goto</span> _error;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">strcmp</span>(lp_SecName + st_SecHeader64.sh_name, target_section)) <span class="comment">//比较遍历的节区和我们的目标节区是否一致</span></span><br><span class="line">		&#123;</span><br><span class="line">			Sec_FA = st_SecHeader64.sh_offset;<span class="comment">//节的文件偏移</span></span><br><span class="line">			Sec_Size = st_SecHeader64.sh_size;<span class="comment">//节的所占文件大小</span></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Find section %s\n&quot;</span>, target_section);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//通过st_SecHeader64 -&gt; sh_offset 和 st_SecHeader64 -&gt; sh_size字段，将.mytext内容读取并保存在Sec_Data中</span></span><br><span class="line">	lseek(fd, Sec_FA, SEEK_SET);</span><br><span class="line">	Sec_Data = (BYTE*) <span class="built_in">malloc</span>(Sec_Size);</span><br><span class="line">	<span class="keyword">if</span> (Sec_Data == <span class="number">0</span>) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Malloc space for Sec_Data failed&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> _error;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (read(fd, Sec_Data, Sec_Size) != Sec_Size) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Read section .text failed&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> _error;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">	nblock = Sec_Size / block_size;</span><br><span class="line">	nsize = Sec_FA / <span class="number">4096</span> + (Sec_FA % <span class="number">4096</span> == <span class="number">0</span> ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Sec_FA = %s, Sec_Size = %s\n&quot;</span>, qword_to_str(Sec_FA, gbuf), qword_to_str(Sec_Size,gbuf+<span class="number">20</span>));</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;nblock = %s, nsize = %s\n&quot;</span>, qword_to_str(nblock, gbuf), qword_to_str(nsize,gbuf+<span class="number">20</span>));</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 下面的代码是没看懂,所以就注释了</span></span><br><span class="line"><span class="comment">//	st_Elf_Header64.e_entry = (Sec_Size &lt;&lt; 16) + nsize;</span></span><br><span class="line"><span class="comment">//	st_Elf_Header64.e_shoff = Sec_FA;</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">	<span class="comment">//将Sec_Data的所有内容取反</span></span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span> ; i &lt; Sec_Size ; i++) </span><br><span class="line">	&#123;</span><br><span class="line">		Sec_Data[i] = Sec_Data[i]^<span class="number">0x90</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">	<span class="comment">//把修改的文件头写入进去</span></span><br><span class="line">	lseek(fd, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">	<span class="keyword">if</span> (write(fd, &amp;st_Elf_Header64, <span class="keyword">sizeof</span>(Elf64_Ehdr)) != <span class="keyword">sizeof</span>(Elf64_Ehdr)) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Write ELFhead to .elf failed&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> _error;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">	<span class="comment">//将Sec_Data内容写入elf文件中</span></span><br><span class="line">	lseek(fd, Sec_FA, SEEK_SET);</span><br><span class="line">	<span class="keyword">if</span> (write(fd, Sec_Data, Sec_Size) != Sec_Size) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Write modified Sec_Data to .elf failed&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> _error;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Completed&quot;</span>);</span><br><span class="line">_error:</span><br><span class="line">	<span class="built_in">free</span>(Sec_Data);</span><br><span class="line">	<span class="built_in">free</span>(lp_SecName);</span><br><span class="line">	close(fd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">char</span>* <span class="title function_">qword_to_str</span><span class="params">(QWORD data, BYTE* buf)</span></span><br><span class="line">&#123;</span><br><span class="line">	BYTE* lp = &amp;data;</span><br><span class="line">	DWORD hi = <span class="number">0</span>;</span><br><span class="line">	DWORD lo = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> i = <span class="number">0</span>, len = <span class="number">0</span>;</span><br><span class="line">	lo = data &amp; <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">	hi = data &gt;&gt; <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">64</span>);</span><br><span class="line">	<span class="built_in">sprintf</span>(buf, <span class="string">&quot;%08X%08X&quot;</span>, hi, lo);</span><br><span class="line">	<span class="keyword">return</span> buf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  解密代码有没有看,因为缺少环境</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;elf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">jstring <span class="title function_">getString</span><span class="params">(JNIEnv*)</span> __<span class="title function_">attribute__</span><span class="params">((section(<span class="string">&quot;.mytext&quot;</span>)))</span>;</span><br><span class="line">jstring <span class="title function_">getString</span><span class="params">(JNIEnv* env)</span> </span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> (*env)-&gt;NewStringUTF(env, <span class="string">&quot;Native method return!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init_getString</span><span class="params">()</span> __<span class="title function_">attribute__</span><span class="params">((constructor))</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">getLibAddr</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init_getString</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> name[<span class="number">15</span>];</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> nblock;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> nsize;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> base;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> text_addr;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> i;</span><br><span class="line">	Elf32_Ehdr *ehdr;</span><br><span class="line">	Elf32_Shdr *shdr;</span><br><span class="line">  </span><br><span class="line">	base = getLibAddr();</span><br><span class="line">  </span><br><span class="line">	ehdr = (Elf32_Ehdr *)base;</span><br><span class="line">	text_addr = ehdr-&gt;e_shoff + base;</span><br><span class="line">  </span><br><span class="line">	nblock = ehdr-&gt;e_entry &gt;&gt; <span class="number">16</span>;</span><br><span class="line">	nsize = ehdr-&gt;e_entry &amp; <span class="number">0xffff</span>;</span><br><span class="line">  </span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;nblock = %d\n&quot;</span>, nblock);</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">if</span> (mprotect((<span class="type">void</span> *) base, <span class="number">4096</span> * nsize, PROT_READ | PROT_EXEC | PROT_WRITE) != <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;mem privilege change failed&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>;i &lt; nblock; i++) &#123;  </span><br><span class="line">		<span class="type">char</span> *addr = (<span class="type">char</span>*)(text_addr + i);</span><br><span class="line">		*addr = ~(*addr);</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">if</span> (mprotect((<span class="type">void</span> *) base, <span class="number">4096</span> * nsize, PROT_READ | PROT_EXEC) != <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;mem privilege change failed&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Decrypt success&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">getLibAddr</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> ret = <span class="number">0</span>;</span><br><span class="line">	<span class="type">char</span> name [] = <span class="string">&quot;libdemo.so&quot;</span>;</span><br><span class="line">	<span class="type">char</span> buf[<span class="number">4096</span>], *temp;</span><br><span class="line">	<span class="type">int</span> pid;</span><br><span class="line">	FILE *fp;</span><br><span class="line">	pid = getpid();</span><br><span class="line">	<span class="built_in">sprintf</span>(buf, <span class="string">&quot;/proc/%d/maps&quot;</span>, pid);</span><br><span class="line">	fp = fopen(buf, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (fp == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;open failed&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> _error;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span> (fgets(buf, <span class="keyword">sizeof</span>(buf), fp)) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, name)) </span><br><span class="line">		&#123;</span><br><span class="line">			temp = strtok(buf, <span class="string">&quot;-&quot;</span>);</span><br><span class="line">			ret = strtoul(temp, <span class="number">0</span>, <span class="number">16</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">_error:</span><br><span class="line">	fclose(fp);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JNIEXPORT jstring JNICALL</span><br><span class="line"><span class="title function_">Java_com_example_shelldemo_MainActivity_getString</span><span class="params">( JNIEnv* env,</span></span><br><span class="line"><span class="params">	jobject thiz)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__arm__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__ARM_ARCH_7A__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__ARM_NEON__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABI <span class="string">&quot;armeabi-v7a/NEON&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABI <span class="string">&quot;armeabi-v7a&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABI <span class="string">&quot;armeabi&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(__i386__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABI <span class="string">&quot;x86&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(__mips__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABI <span class="string">&quot;mips&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABI <span class="string">&quot;unknown&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> getString(env);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="TLS"><a href="#TLS" class="headerlink" title="TLS"></a>TLS</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line">__attribute((constructor)) <span class="type">void</span> <span class="title function_">before_main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, <span class="string">&quot;I Can Before Main&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">__attribute((destructor)) <span class="type">void</span> <span class="title function_">after_main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, <span class="string">&quot;I Can Aftrer Main&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, <span class="string">&quot;I Am Main&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="ELF-LOAD"><a href="#ELF-LOAD" class="headerlink" title="ELF_LOAD"></a>ELF_LOAD</h1><p>把要加固的elf插入到一个load.elf的尾部，然后用load.elf将尾部的那个elf正常加载运行起来。</p>
<p>在外部逆向时只看到那个load的代码，完成加固的操作。</p>
<h1 id="ELF常见HOOK方案及应用"><a href="#ELF常见HOOK方案及应用" class="headerlink" title="ELF常见HOOK方案及应用"></a>ELF常见HOOK方案及应用</h1><h2 id="Inline-hook"><a href="#Inline-hook" class="headerlink" title="Inline hook"></a>Inline hook</h2><h2 id="GOT-hook"><a href="#GOT-hook" class="headerlink" title="GOT hook"></a>GOT hook</h2><h2 id="PRELOAD-hook"><a href="#PRELOAD-hook" class="headerlink" title="PRELOAD hook"></a>PRELOAD hook</h2><h2 id="Linker重定位hook"><a href="#Linker重定位hook" class="headerlink" title="Linker重定位hook"></a>Linker重定位hook</h2><h1 id="ELF若干种保护方案"><a href="#ELF若干种保护方案" class="headerlink" title="ELF若干种保护方案"></a>ELF若干种保护方案</h1><h2 id="UPX壳及分析"><a href="#UPX壳及分析" class="headerlink" title="UPX壳及分析"></a>UPX壳及分析</h2><p>其实就是加壳子,来隐藏某些字符串和资源</p>
<p>常见的有upx</p>
<p>项目地址,可能不是makefile的,但是我的百度云里有源码项目</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/upx/upx</span><br></pre></td></tr></table></figure>



<p>直接下载和安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install upx-ucl</span><br><span class="line">dpkg -i xxx_path</span><br></pre></td></tr></table></figure>



<h2 id="Shellcode保护方案"><a href="#Shellcode保护方案" class="headerlink" title="Shellcode保护方案."></a>Shellcode保护方案.</h2><h2 id="链接器及加载器"><a href="#链接器及加载器" class="headerlink" title="链接器及加载器"></a>链接器及加载器</h2><h2 id="VMP"><a href="#VMP" class="headerlink" title="VMP"></a>VMP</h2><h1 id="ELF混淆方案"><a href="#ELF混淆方案" class="headerlink" title="ELF混淆方案"></a>ELF混淆方案</h1><h2 id="控制流平坦化"><a href="#控制流平坦化" class="headerlink" title="控制流平坦化"></a>控制流平坦化</h2><p>一个很6的大哥写的文章,膜拜</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">https://bbs.pediy.com/thread-260626-1.htm</span><br><span class="line">这个文章讲了很多，还是有很多无法理解的地方（没学过）</span><br><span class="line"></span><br><span class="line">https://bbs.pediy.com/user-884731.htm</span><br><span class="line"></span><br><span class="line">安卓方面</span><br><span class="line">https://bbs.pediy.com/user-home-682449.htm</span><br><span class="line">https://bbs.pediy.com/user-home-617255.htm</span><br><span class="line">https://bbs.pediy.com/user-home-630711.htm</span><br></pre></td></tr></table></figure>



<h3 id="语法角度"><a href="#语法角度" class="headerlink" title="语法角度"></a>语法角度</h3><p>来个很吓人的图片,然后如果优化后</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="F:/5008/Note/blog/ELF混淆/630711_HKTSQYPN8PWY52F.png" alt="630711_HKTSQYPN8PWY52F"></p>
<p>于是优化后(这里是人为优化负责的代码)</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="F:/5008/Note/blog/ELF混淆/630711_G7FYDT94A9NVKNU.png" alt="630711_G7FYDT94A9NVKNU"></p>
<p>于是一些扁平化的代码，可以这么写</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> x=<span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> y=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(!x)</span><br><span class="line">    &#123;</span><br><span class="line">        x=<span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!y)</span><br><span class="line">    &#123;</span><br><span class="line">        y=<span class="number">200</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!x)</span><br><span class="line">    &#123;</span><br><span class="line">        x=<span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!y)</span><br><span class="line">    &#123;</span><br><span class="line">        y=<span class="number">200</span>;</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="keyword">if</span>(!x)</span><br><span class="line">    &#123;</span><br><span class="line">        x=<span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!y)</span><br><span class="line">    &#123;</span><br><span class="line">        y=<span class="number">200</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="F:/5008/Note/blog/ELF混淆/Snipaste_2022-11-21_23-54-59.png"></p>
<h3 id="人为优化"><a href="#人为优化" class="headerlink" title="人为优化"></a>人为优化</h3><p>之前听说过，编译器优化之后的代码会比较恶心</p>
<p>所以如果我们不用编译器优化，采用原始的编译效果，然后认为恶作剧的区优化代码</p>
<p>这个如何实现?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">while (1) &lt;-- 这个就是支配节点</span><br><span class="line">&#123;  			</span><br><span class="line">   if (a)</span><br><span class="line">      ....</span><br><span class="line">   if (b)</span><br><span class="line">      ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="F:/5008/Note/blog/ELF混淆/image-20221122084237397.png" alt="image-20221122084237397"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="F:/5008/Note/blog/ELF混淆/image-20221122084302591.png" alt="image-20221122084302591"></p>
<h3 id="常量传播-到达定值分析"><a href="#常量传播-到达定值分析" class="headerlink" title="常量传播 | 到达定值分析"></a>常量传播 | 到达定值分析</h3><p>这个确定性如果用于远程的距离的跳转,那么就是到达定值分析</p>
<p>如果用于短距离跳转,就是一般的常量传播</p>
<p>利用了结果的确定性吧</p>
<p>比如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">c &lt; -1; 是一个肯定性的结果，于是我们用最高肯定性去构造我们的判断</span><br><span class="line"></span><br><span class="line">c &lt; -1</span><br><span class="line">b + c &lt; 1</span><br><span class="line">cmp c,b</span><br></pre></td></tr></table></figure>

<p>如果我们让b+c&lt;1成立的话，那么c&lt;1-b,所以1-b&lt;&#x3D;-1</p>
<p>临界点就是b&#x3D;2，于是我们就浅浅的构造了b&#x3D;2的事实</p>
<h3 id="死代码优化"><a href="#死代码优化" class="headerlink" title="死代码优化"></a>死代码优化</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov r0, 0</span><br><span class="line">mov r0, 1</span><br></pre></td></tr></table></figure>

<p>可以看到<code>mov r0 ,1</code> 就是一个死代码</p>
<p>于是我们就可以利用它</p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>基于 while(1)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> a = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (a &gt; <span class="number">1</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					a = <span class="number">3</span>;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (a &gt; <span class="number">2</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				a = <span class="number">4</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (a &gt; <span class="number">3</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			a = <span class="number">5</span>;</span><br><span class="line">			<span class="built_in">puts</span>(<span class="string">&quot;66666&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>效果图</p>
<p> <img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="F:/5008/Note/blog/ELF混淆/image-20221123131806341.png" alt="image-20221123131806341"></p>
<p>3个红色🟥是基于while(1)的递归判断</p>
<p>3个紫色🟪是基于if的判断</p>
<p>3个蓝色🟦是基于if处理的处理</p>
<p>3个黑色是基于条件不成立的跳转</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> a = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (a == <span class="number">7</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;hello world\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a &gt; <span class="number">5</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			a = <span class="number">7</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a &gt; <span class="number">4</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			a = <span class="number">6</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a &gt; <span class="number">3</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			a = <span class="number">5</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a &gt; <span class="number">2</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			a = <span class="number">4</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a &gt; <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			a = <span class="number">3</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a &gt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			a = <span class="number">2</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a &gt; <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			a = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="F:/5008/Note/blog/ELF混淆/image-20221123144227040.png" alt="image-20221123144227040"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> a = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (a &gt; <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			a = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (a &gt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			a = <span class="number">2</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (a &gt; <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			a = <span class="number">3</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (a &gt; <span class="number">2</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			a = <span class="number">4</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (a &gt; <span class="number">3</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			a = <span class="number">5</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (a &gt; <span class="number">4</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			a = <span class="number">6</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (a &gt; <span class="number">5</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			a = <span class="number">7</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (a == <span class="number">7</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;hello world\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="F:/5008/Note/blog/ELF混淆/image-20221123144643014.png" alt="image-20221123144643014"></p>
<h2 id="虚假控制流"><a href="#虚假控制流" class="headerlink" title="虚假控制流"></a>虚假控制流</h2><h2 id="花指令"><a href="#花指令" class="headerlink" title="花指令"></a>花指令</h2><h2 id="r指令乱序，使用B衔接"><a href="#r指令乱序，使用B衔接" class="headerlink" title="r指令乱序，使用B衔接"></a>r指令乱序，使用B衔接</h2><h2 id="指令替换，替换为B指令"><a href="#指令替换，替换为B指令" class="headerlink" title="指令替换，替换为B指令"></a>指令替换，替换为B指令</h2><h2 id="指令索引并且乱序，使用索引表来跳转"><a href="#指令索引并且乱序，使用索引表来跳转" class="headerlink" title="指令索引并且乱序，使用索引表来跳转"></a>指令索引并且乱序，使用索引表来跳转</h2><h2 id="LLVM方式混淆"><a href="#LLVM方式混淆" class="headerlink" title="LLVM方式混淆"></a>LLVM方式混淆</h2><h1 id="ELF反调试"><a href="#ELF反调试" class="headerlink" title="ELF反调试"></a>ELF反调试</h1><h2 id="int3"><a href="#int3" class="headerlink" title="int3"></a>int3</h2><p>一个比价老套的的指令</p>
<p>就是如果你执行了int3,就会发出信号SIGTRAP</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">handler</span><span class="params">(<span class="type">int</span> signo)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//signal(SIGTRAP, handler);</span></span><br><span class="line">    __asm__(<span class="string">&quot;nop\n\t&quot;</span></span><br><span class="line">        <span class="string">&quot;int3\n\t&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello from main!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="先于main函数执行"><a href="#先于main函数执行" class="headerlink" title="先于main函数执行"></a>先于main函数执行</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__attribute((constructor)) <span class="type">void</span> <span class="title function_">before_main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (ptrace(PTRACE_TRACEME, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) == <span class="number">-1</span>) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Find Some One Dbg me  before_main\n&quot;</span>);</span><br><span class="line">		<span class="comment">//abort();</span></span><br><span class="line">	&#125; </span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Check All good\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="捕捉信号"><a href="#捕捉信号" class="headerlink" title="捕捉信号"></a>捕捉信号</h2><h2 id="检测运行tracerPID状态的检测"><a href="#检测运行tracerPID状态的检测" class="headerlink" title="检测运行tracerPID状态的检测"></a>检测运行tracerPID状态的检测</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">CheckDbg2</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="type">char</span> buf1[<span class="number">512</span>];</span><br><span class="line">	FILE* fin;</span><br><span class="line">	fin = fopen(<span class="string">&quot;/proc/self/status&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">	<span class="type">int</span> tpid;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *needle = <span class="string">&quot;TracerPid:&quot;</span>;</span><br><span class="line">	<span class="type">size_t</span> nl = <span class="built_in">strlen</span>(needle);</span><br><span class="line">	<span class="keyword">while</span>(fgets(buf1, <span class="number">512</span>, fin))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(!<span class="built_in">strncmp</span>(buf1, needle, nl))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">sscanf</span>(buf1, <span class="string">&quot;TracerPid: %d&quot;</span>, &amp;tpid);</span><br><span class="line">			<span class="keyword">if</span>(tpid != <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Check File Record You are Dbg me:%08X\n&quot;</span>,tpid);</span><br><span class="line">				<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	fclose(fin);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Check All good\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="检测调试进程"><a href="#检测调试进程" class="headerlink" title="检测调试进程"></a>检测调试进程</h2><h3 id="ptrace"><a href="#ptrace" class="headerlink" title="ptrace"></a>ptrace</h3><p>源码</p>
<p>国外的一个培训网站,里面可能有好的资源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://bootlin.com/</span><br><span class="line">	找到了ptrace函数的源码 https://elixir.bootlin.com/linux/v6.1-rc5/source/kernel/ptrace.c</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://cloud.tencent.com/developer/article/1799705</span><br><span class="line">函数介绍手册,比较全面 https://man7.org/linux/man-pages/man2/ptrace.2.html</span><br></pre></td></tr></table></figure>



<h4 id="吹b"><a href="#吹b" class="headerlink" title="吹b"></a>吹b</h4><p>ptrace使用场景：</p>
<ol>
<li>编写动态分析工具，如gdb,strace</li>
<li>反追踪，一个进程只能被一个进程追踪(<em>注：一个进程能同时追踪多个进程</em>)，若此进程已被追踪，其他基于ptrace的追踪器将无法再追踪此进程，更进一步可以实现子母进程双线执行动态解密代码等更高级的反分析技术</li>
<li>代码注入，往其他进程里注入代码。</li>
<li>不退出进程，进行在线升级</li>
</ol>
<h4 id="函数介绍"><a href="#函数介绍" class="headerlink" title="函数介绍"></a>函数介绍</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="type">long</span> <span class="title function_">ptrace</span><span class="params">(<span class="keyword">enum</span> __ptrace_request request, <span class="type">pid_t</span> pid, <span class="type">void</span> *addr, <span class="type">void</span> *data)</span>;</span><br></pre></td></tr></table></figure>

<p>一共有四个参数：</p>
<ul>
<li><code>request</code>: 表示要执行的操作类型。&#x2F;&#x2F;反调试会用到<code>PT_DENY_ATTACH</code>，调试会用到<code>PTRACE_ATTACH</code></li>
<li><code>pid</code>: 要操作的目标进程ID</li>
<li><code>addr</code>: 要监控的目标内存地址</li>
<li><code>data</code>: 保存读取出或者要写入的数据</li>
</ul>
<p>父进程控制子进程运行，检查和改变它的核心Image。</p>
<p>Ptrace主要用来实现断点调试。当进程被中止，通知父进程，进程的内存空间可以被读写，父进程可以选择是子进程继续执行，还是中止</p>
<p>request的不同参数决定了系统调用的功能</p>
<table>
<thead>
<tr>
<th>PTRACE_TRACEME</th>
<th>本进程被其父进程所跟踪。其父进程应该希望跟踪子进程</th>
</tr>
</thead>
<tbody><tr>
<td>PTRACE_PEEKTEXT, PTRACE_PEEKDATA</td>
<td>从内存地址中读取一个字节，内存地址由addr给出。</td>
</tr>
<tr>
<td>PTRACE_PEEKUSR</td>
<td>从USER区域中读取一个字节，偏移量为addr。</td>
</tr>
<tr>
<td>PTRACE_POKETEXT, PTRACE_POKEDATA</td>
<td>往内存地址中写入一个字节。内存地址由addr给出。</td>
</tr>
<tr>
<td>PTRACE_POKEUSR</td>
<td>往USER区域中写入一个字节。偏移量为addr。</td>
</tr>
<tr>
<td>PTRACE_SYSCALL, PTRACE_CONT</td>
<td>重新运行。</td>
</tr>
<tr>
<td>PTRACE_KILL</td>
<td>杀掉子进程，使它退出。</td>
</tr>
<tr>
<td>PTRACE_SINGLESTEP</td>
<td>设置单步执行标志</td>
</tr>
<tr>
<td>PTRACE_ATTACH</td>
<td>跟踪指定pid 进程。</td>
</tr>
<tr>
<td>PTRACE_DETACH</td>
<td>结束跟踪</td>
</tr>
</tbody></table>
<p>Intel386特有：</p>
<table>
<thead>
<tr>
<th>PTRACE_GETREGS</th>
<th>读取寄存器</th>
</tr>
</thead>
<tbody><tr>
<td>PTRACE_SETREGS</td>
<td>设置寄存器</td>
</tr>
<tr>
<td>PTRACE_GETFPREGS</td>
<td>读取浮点寄存器</td>
</tr>
<tr>
<td>PTRACE_SETFPREGS</td>
<td>设置浮点寄存器</td>
</tr>
</tbody></table>
<p>init进程不可以使用此函数</p>
<p> 返回值：</p>
<p>成功返回0。错误返回-1。errno被设置</p>
<p>错误：</p>
<table>
<thead>
<tr>
<th>EPERM</th>
<th>特殊进程不可以被跟踪或进程已经被跟踪。</th>
</tr>
</thead>
<tbody><tr>
<td>ESRCH</td>
<td>指定的进程不存在</td>
</tr>
<tr>
<td>EIO</td>
<td>请求非法</td>
</tr>
</tbody></table>
<h4 id="应用功能"><a href="#应用功能" class="headerlink" title="应用功能"></a>应用功能</h4><p>PTRACE_TRACEME</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptrace(PTRACE_TRACEME,0 ,0 ,0)</span><br></pre></td></tr></table></figure>

<p>描述：本进程被其父进程所跟踪。其父进程应该希望跟踪子进程。</p>
<p>PTRACE_PEEKTEXT, PTRACE_PEEKDATA</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ptrace(PTRACE_PEEKTEXT, _in_ pid, _in_ addr, _out_ data)</span><br><span class="line">ptrace(PTRACE_PEEKDATA, _in_ pid, _in_ addr, _out_ data)</span><br></pre></td></tr></table></figure>

<p>描述：从内存地址中读取一个字节，pid表示被跟踪的子进程，内存地址由addr给出，data为用户变量地址用于返回读到的数据。</p>
<p>在Linux（i386）中用户代码段与用户数据段重合所以读取代码段和数据段数据处理是一样的。</p>
<p>PTRACE_POKETEXT, PTRACE_POKEDATA</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ptrace(PTRACE_POKETEXT, pid, addr, data)</span><br><span class="line">ptrace(PTRACE_POKEDATA, pid, addr, data)</span><br></pre></td></tr></table></figure>

<p>描述：往内存地址中写入一个字节。pid表示被跟踪的子进程，内存地址由addr给出，data为所要写入的数据。</p>
<p>　</p>
<p>PTRACE_PEEKUSR</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptrace(PTRACE_PEEKUSR, pid, addr, data)</span><br></pre></td></tr></table></figure>

<p>描述：从USER区域中读取一个字节，pid表示被跟踪的子进程，USER区域地址由addr给出，data为用户变量地址用于返回读到的数据。</p>
<p>USER结构为core文件的前面一部分，它描述了进程中止时的一些状态，如：寄存器值，代码、数据段大小，代码、数据段开始地址等。</p>
<p>在Linux（i386）中通过PTRACE_PEEKUSER和PTRACE_POKEUSR可以访问USER结构的数据有寄存器和调试寄存器。</p>
<p>PTRACE_POKEUSR</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptrace(PTRACE_POKEUSR, pid, addr, data)</span><br></pre></td></tr></table></figure>

<p>描述：往USER区域中写入一个字节，pid表示被跟踪的子进程，USER区域地址由addr给出，data为需写入的数据。</p>
<p>PTRACE_CONT</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptrace(PTRACE_CONT, pid, 0, signal)</span><br></pre></td></tr></table></figure>

<p>描述：继续执行。pid表示被跟踪的子进程，signal为0则忽略引起调试进程中止的信号，若不为0则继续处理信号signal。</p>
<p>PTRACE_SYSCALL</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptrace(PTRACE_SYS, pid, 0, signal)</span><br></pre></td></tr></table></figure>

<p>描述：继续执行。pid表示被跟踪的子进程，signal为0则忽略引起调试进程中止的信号，若不为0则继续处理信号signal。</p>
<p>与PTRACE_CONT不同的是进行系统调用跟踪。在被跟踪进程继续运行直到调用系统调用开始或结束时，被跟踪进程被中止，并通知父进程。</p>
<p>PTRACE_KILL</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptrace(PTRACE_DETACH，pid,  0,0)  </span><br></pre></td></tr></table></figure>

<p>描述：杀掉子进程，使它退出。pid表示被跟踪的子进程。</p>
<p>　</p>
<p>PTRACE_SINGLESTEP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptrace(PTRACE_KILL, pid, 0, signle)</span><br></pre></td></tr></table></figure>

<p>描述：设置单步执行标志，单步执行一条指令。pid表示被跟踪的子进程。signal为0则忽略引起调试进程中止的信号，</p>
<p>若不为0则继续处理信号signal。当被跟踪进程单步执行完一个指令后，被跟踪进程被中止，并通知父进程。</p>
<p>PTRACE_ATTACH</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ptrace(PTRACE_ATTACH，pid, 0,0)  </span><br><span class="line">wait(pid); //用于等待子进程?</span><br></pre></td></tr></table></figure>

<p>描述：跟踪指定pid 进程。pid表示被跟踪进程。被跟踪进程将成为当前进程的子进程，并进入中止状态。</p>
<p>　</p>
<p>PTRACE_DETACH</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptrace(PTRACE_DETACH，pid,  0,0)  </span><br></pre></td></tr></table></figure>

<p>　描述：结束跟踪。 pid表示被跟踪的子进程。结束跟踪后被跟踪进程将继续执行。</p>
<p>PTRACE_GETREGS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptrace(PTRACE_GETREGS, pid, 0, data)</span><br></pre></td></tr></table></figure>

<p>描述：读取寄存器值，pid表示被跟踪的子进程，data为用户变量地址用于返回读到的数据。此功能将读取所有17个基本寄存器的值。</p>
<p>PTRACE_SETREGS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptrace(PTRACE_SETREGS, pid, 0, data)</span><br></pre></td></tr></table></figure>

<p>描述：设置寄存器值，pid表示被跟踪的子进程，data为用户数据地址。此功能将设置所有17个基本寄存器的值。</p>
<p>PTRACE_GETFPREGS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptrace(PTRACE_GETFPREGS, pid, 0, data)</span><br></pre></td></tr></table></figure>

<p>描述：读取浮点寄存器值，pid表示被跟踪的子进程，data为用户变量地址用于返回读到的数据。此功能将读取所有浮点协处理器387的所有寄存器的值。</p>
<p>PTRACE_SETFPREGS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptrace(PTRACE_SETREGS, pid, 0, data)</span><br></pre></td></tr></table></figure>



<p>描述：设置浮点寄存器值，pid表示被跟踪的子进程，data为用户数据地址。此功能将设置所有浮点协处理器387的所有寄存器的值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv [])</span> </span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (ptrace(PTRACE_TRACEME, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) == <span class="number">-1</span>) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Debugger detected\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125; </span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;All good&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//这里我们使用&#x27;PTRACE_TRACEME&#x27;来指明进程将被调试，在此种情况下其他参数会被忽略。</span></span><br><span class="line"><span class="comment">//如果已经存在调试器，那么这次ptrace调用会失败，返回-1。</span></span><br></pre></td></tr></table></figure>



<h4 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h4><p>基于调试状态的反调试</p>
<p>Linux  系统gdb等调试器，都是通过ptrace系统调用实现，ptrace系统调用有一个特性就是当前进程已经被追踪了，就不能被其他父进程追踪，</p>
<p>所以只要我们设计的反调试程序开头就先执行一次ptrace(PTRACE_TRACEME, 0, 0, 0)，</p>
<p>当gdb再想attach的时候就会发现已经执行了一次不能再执行了从而返回-1，就无法调试了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;    </span><br><span class="line">	<span class="keyword">if</span> (ptrace(PTRACE_TRACEME, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) == <span class="number">-1</span>)<span class="comment">//这里就直接先执行了</span></span><br><span class="line">	&#123; </span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;don&#x27;t trace me!\n&quot;</span>);  </span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;    </span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;no one trace me!\n&quot;</span>);    </span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>如何防它?</p>
<p>查看api调用,然后no掉它</p>
<h5 id="取出符号表"><a href="#取出符号表" class="headerlink" title="取出符号表"></a>取出符号表</h5><p>网上说是,如果可能有ptrace函数的话,就查符号表或者api调用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># readelf -s q | grep ptrace</span></span><br><span class="line">    41: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND ptrace@GLIBC_2.2.5</span><br><span class="line"><span class="comment"># readelf -S q | grep ptrace</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># objdump -t q | grep ptrace</span></span><br><span class="line">0000000000000000       F *UND*	0000000000000000              ptrace@GLIBC_2.2.5</span><br><span class="line"><span class="comment"># objdump -T q | grep ptrace</span></span><br><span class="line">0000000000000000      DF *UND*	0000000000000000 (GLIBC_2.2.5) ptrace</span><br><span class="line"><span class="comment"># </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但是😂我们可以通过删除符号表的选项，来隐藏对ptrace的调用，但只是针对.sysmtab表，不会去掉<code>.dynsym</code></p>
<blockquote>
<p>用strip删除符号,删除多态符号?</p>
</blockquote>
<p>strip 通过删除可执行文件中ELF头的 typchk段、符号表、字符串表、行号信息、调试段、注解段、重定位信息等来实现缩减程序体积的目的。</p>
<p>而被剪裁过的可执行文件不可进行还原。</p>
<p><strong>常用参数：</strong></p>
<table>
<thead>
<tr>
<th>-e</th>
<th>在对象文件的可选头中设置 F_LOADONLY 标志</th>
</tr>
</thead>
<tbody><tr>
<td>-E</td>
<td>复位（关闭）对象文件的可选头中的 F_LOADONLY 位</td>
</tr>
<tr>
<td>-H</td>
<td>删除文件头、不论什么可选的头以及全部段的头部分</td>
</tr>
<tr>
<td>-l</td>
<td>（小写 L）删除行号信息</td>
</tr>
<tr>
<td>-r</td>
<td>除了外部符号和静态符号，将所有符号表信息除去</td>
</tr>
<tr>
<td>-t</td>
<td>除去大多数符号表信息，但并不除去函数符号或行号信息</td>
</tr>
<tr>
<td>-V</td>
<td>打印 strip 命令的版本</td>
</tr>
<tr>
<td>-x</td>
<td>删除重定位信息、符号表，但并不除去静态或外部符号信息</td>
</tr>
<tr>
<td>-X[mode]</td>
<td>删除文件特定符号信息(mode: 32、64、32_64</td>
</tr>
</tbody></table>
<p>【注：使用注意】<br> 1.gcc 对于编译时已经进行深层优化的程序，使用strip命令可能会导致无法正常运行！</p>
<h5 id="静态加载"><a href="#静态加载" class="headerlink" title="静态加载"></a>静态加载</h5><p>也可以在链接阶段使用使用ld的<code>-s</code>和<code>-S</code>参数，使得连接器生成的输出文件时就不产生符号信息，-s<code>和</code>-S<code>的区别在于</code>-S<code>移除调试符号信息，而</code>-s移除所有符号信息。</p>
<p>我们也可以在GCC中通过<code>-Wl,-s</code>和<code>-Wl,-S</code>来移除符号信</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc -static -o q q.c</span><br><span class="line">strip q</span><br><span class="line">然后就查不到ptrace的符号了</span><br></pre></td></tr></table></figure>

<p>惊讶的是,这样一编译,我的elf文件就变得特别大,</p>
<p>以前的文件特别简单,函数不吃过20个,一旦这样编译后,我们的文件就变得特别大,有很多的函数</p>
<p>然后符号表和多态符号表都没了,我的文件类型由原来的多态共享文件转变为可执行文件</p>
<p>在我的IDA上,是看不出来调用了ptrace函数的.系统函数直接被展开了</p>
<h5 id="用动态加载函数"><a href="#用动态加载函数" class="headerlink" title="用动态加载函数"></a>用动态加载函数</h5><p>由于静态elf在过于笨重,也就是可执行文件很大</p>
<p>如果我们使用动态加载技术，就可以回到动态加载库文件（文件很小），并且ptrace不会出现在符号表和动态符号表</p>
<p>但是动态加载函数的时候是需要使用字符串ptrace，所以你可以对字符串<code>ptrace</code>加密一下</p>
<p>动态加载是在运行的时加载库并且检索库函数地址</p>
<p>动态的load函数地址来隐藏ptrace，</p>
<p>比如LoadLibiary然后GetProcess</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;dlfcn.h&gt;</span><span class="comment">//Linux动态库的显式调用</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">MyGdbCheck</span><span class="params">()</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span><br><span class="line">&#123;</span><br><span class="line">    MyGdbCheck();</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">MyGdbCheck</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> *handle;<span class="comment">//定义句柄指针变量</span></span><br><span class="line">    <span class="type">long</span> (*lp_ptrace)(<span class="keyword">enum</span> __ptrace_request request, <span class="type">pid_t</span> pid);<span class="comment">//定义函数指针变量</span></span><br><span class="line">    <span class="comment">//获取包含&#x27;ptrace&#x27;的库的句柄</span></span><br><span class="line">    handle = dlopen (<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>, RTLD_LAZY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对动态解析函数“ptrace”的引用,go变量存的是ptrace的地址</span></span><br><span class="line">    lp_ptrace = dlsym(handle, <span class="string">&quot;ptrace&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (lp_ptrace(PTRACE_TRACEME, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;being traced&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;not being traced&quot;</span>);</span><br><span class="line">    <span class="comment">//关闭句柄</span></span><br><span class="line">    dlclose(handle);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="局部变量存储字符串"><a href="#局部变量存储字符串" class="headerlink" title="局部变量存储字符串"></a>局部变量存储字符串</h5><p>去除字符串的直接搜索</p>
<p>对于elf的话</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strings q | grep flag</span><br></pre></td></tr></table></figure>

<p>是可以搜索字符串的</p>
<p>但是他的局限性，或者是IDA的局限性就是</p>
<p>如果你把字符串定位变量，那么他就搜索不到</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;dlfcn.h&gt;</span><span class="comment">//Linux动态库的显式调用</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">MyGdbCheck</span><span class="params">()</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span><br><span class="line">&#123;</span><br><span class="line">    MyGdbCheck();</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">MyGdbCheck</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> funcName[]=<span class="string">&quot;ptrace&quot;</span>;</span><br><span class="line">    <span class="type">char</span> Youlose[]=<span class="string">&quot;being traced&quot;</span>;</span><br><span class="line">    <span class="type">char</span> YouSucc[]=<span class="string">&quot;not being traced&quot;</span>;</span><br><span class="line">    <span class="type">void</span> *handle;<span class="comment">//定义句柄指针变量</span></span><br><span class="line">    <span class="type">long</span> (*lp_ptrace)(<span class="keyword">enum</span> __ptrace_request request, <span class="type">pid_t</span> pid);<span class="comment">//定义函数指针变量</span></span><br><span class="line">    <span class="comment">//获取包含&#x27;ptrace&#x27;的库的句柄</span></span><br><span class="line">    handle = dlopen (<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>, RTLD_LAZY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对动态解析函数“ptrace”的引用,go变量存的是ptrace的地址</span></span><br><span class="line"></span><br><span class="line">    lp_ptrace = dlsym(handle, funcName);</span><br><span class="line">    <span class="keyword">if</span> (lp_ptrace(PTRACE_TRACEME, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(Youlose);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(YouSucc);</span><br><span class="line">    <span class="comment">//关闭句柄</span></span><br><span class="line">    dlclose(handle);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>比如上面那个例子就是实现了所有的字符串都用变量，于是你用IDA或者strings就搜索不到，</p>
<p>于是我在exe上做了系统的实验，关于字符串搜索的问题  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#include&lt;stdlib.h&gt;</span><br><span class="line">#include&lt;stdio.h&gt;</span><br><span class="line">#include&lt;sys/ptrace.h&gt;</span><br><span class="line">#include&lt;dlfcn.h&gt;//Linux动态库的显式调用</span><br><span class="line">#include&lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">int MyGdbCheck();</span><br><span class="line">int main(int argc, char **argv) </span><br><span class="line">&#123;</span><br><span class="line">    MyGdbCheck();</span><br><span class="line">&#125;</span><br><span class="line">int MyGdbCheck()</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    char Youlose[]=&quot;being traced&quot;;</span><br><span class="line">    char YouSucc[]=&quot;not being traced&quot;;</span><br><span class="line">    puts(&quot;ptrace&quot;);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="用汇编实现一个ptrace的函数"><a href="#用汇编实现一个ptrace的函数" class="headerlink" title="用汇编实现一个ptrace的函数"></a>用汇编实现一个ptrace的函数</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">global _start</span><br><span class="line">section .data</span><br><span class="line">    traced: db &quot;being traced&quot;, 0xA</span><br><span class="line">    tracedLen equ $-traced</span><br><span class="line">    normal: db &quot;not being traced&quot;, 0xA</span><br><span class="line">    normalLen equ $-normal</span><br><span class="line">section .text</span><br><span class="line">_start:</span><br><span class="line">    ;calling ptrace</span><br><span class="line">    mov ebx, 0x0</span><br><span class="line">    mov ecx, 0x0</span><br><span class="line">    mov edx, 0x0</span><br><span class="line">    mov eax, 0x1a</span><br><span class="line">    int 0x80 ; sys_ptrace</span><br><span class="line">    cmp eax, 0xFFFFFFFF;把返回值与-1做比较</span><br><span class="line">    jz debugger;eax值伪-1就跳转</span><br><span class="line"></span><br><span class="line">    mov edx, normalLen;正常输出</span><br><span class="line">    mov ecx, normal;&quot;not being traced&quot;</span><br><span class="line">    xor ebx, ebx</span><br><span class="line">    mov bl, 0x1</span><br><span class="line">    xor eax, eax</span><br><span class="line">    mov al, 0x4</span><br><span class="line">    int 0x80 ; sys_write</span><br><span class="line">    jmp exit</span><br><span class="line"></span><br><span class="line">debugger:</span><br><span class="line">    mov edx, tracedLen;被调试的时候输出</span><br><span class="line">    mov ecx, traced ;&quot;being traced&quot;</span><br><span class="line">    xor ebx, ebx</span><br><span class="line">    mov bl, 0x1</span><br><span class="line">    xor eax, eax</span><br><span class="line">    mov al, 0x4</span><br><span class="line">    int 0x80 ; sys_write</span><br><span class="line"></span><br><span class="line">exit:</span><br><span class="line">    xor eax, eax</span><br><span class="line">    mov al, 0x1</span><br><span class="line">    xor ebx, ebx</span><br><span class="line">    int 0x80 ; sys_exit</span><br></pre></td></tr></table></figure>

<h5 id="内嵌汇编实现ptrace"><a href="#内嵌汇编实现ptrace" class="headerlink" title="内嵌汇编实现ptrace"></a>内嵌汇编实现ptrace</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="keyword">volatile</span> <span class="type">long</span> <span class="title function_">no_hacker</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> status =<span class="number">0</span>; <span class="comment">//定义返回值变量</span></span><br><span class="line">    <span class="comment">//内联汇编代码，系统调用ptrace，把eax寄存器的值赋给status变量</span></span><br><span class="line"></span><br><span class="line">    __asm__ <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov $0x0,%%ebx\n\t&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov $0x0,%%ecx\n\t&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov $0x0,%%edx\n\t&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov $0x1a,%%eax\n\t&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;int $0x80\n\t&quot;</span></span></span><br><span class="line"><span class="params">        :<span class="string">&quot;=a&quot;</span>(status)</span></span><br><span class="line"><span class="params">        :)</span>;</span><br><span class="line">    <span class="keyword">return</span> status;<span class="comment">//这里把系统的调用的返回值作为no_hacke函数的返回值</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;  </span><br><span class="line">    <span class="keyword">if</span> (no_hacker()==<span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;don&#x27;t trace me\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;no one trace me\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="用SMC隐藏系统的调用"><a href="#用SMC隐藏系统的调用" class="headerlink" title="用ＳＭＣ隐藏系统的调用"></a>用ＳＭＣ隐藏系统的调用</h5><p>一种基于动SMC的隐藏ptrace</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nasm -f elf32 q.asm -o q.o</span><br><span class="line">ld -N -m elf_i386 q.o -o q</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>SMC的全名叫self modifying code</p>
<p>意思就是可执行文件在运行的时候改变自己的代码和数据</p>
<p>ld加Ｎ的目的是让ｔｅｘｔ段可读可写可执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">global _start</span><br><span class="line">section .data</span><br><span class="line">    traced: db &quot;being traced&quot;, 0xA</span><br><span class="line">    tracedLen equ $-traced</span><br><span class="line">    normal: db &quot;not being traced&quot;, 0xA</span><br><span class="line">    normalLen equ $-normal</span><br><span class="line">section .text</span><br><span class="line">_start:</span><br><span class="line">    ;显示ptrace </span><br><span class="line">    mov edi, systemcall;</span><br><span class="line">    mov ax, 0x80cd;“0x80cd”是与系统调用指令“ int 0x80”相对应的操作码</span><br><span class="line">    stosw;将AX寄存器的内容存储到EDI寄存器指向的内存中</span><br><span class="line">    ;calling ptrace</span><br><span class="line">    mov ebx, 0x0</span><br><span class="line">    mov ecx, 0x0</span><br><span class="line">    mov edx, 0x0</span><br><span class="line">    mov eax, 0x1a</span><br><span class="line">systemcall:</span><br><span class="line">    xor eax, ebx;这条指令将被int 0x80覆盖</span><br><span class="line">    cmp eax, 0</span><br><span class="line">    jl debugger</span><br><span class="line"></span><br><span class="line">    mov edx, normalLen;正常输出</span><br><span class="line">    mov ecx, normal;&quot;not being traced&quot;</span><br><span class="line">    xor ebx, ebx</span><br><span class="line">    mov bl, 0x1</span><br><span class="line">    xor eax, eax</span><br><span class="line">    mov al, 0x4</span><br><span class="line">    int 0x80 ; sys_write</span><br><span class="line">    jmp exit</span><br><span class="line">debugger:</span><br><span class="line">    mov edx, tracedLen;被调试的时候输出</span><br><span class="line">    mov ecx, traced ;&quot;being traced&quot;</span><br><span class="line">    xor ebx, ebx</span><br><span class="line">    mov bl, 0x1</span><br><span class="line">    xor eax, eax</span><br><span class="line">    mov al, 0x4</span><br><span class="line">    int 0x80 ; sys_write</span><br><span class="line">exit:</span><br><span class="line">    xor eax, eax</span><br><span class="line">    mov al, 0x1</span><br><span class="line">    xor ebx, ebx</span><br><span class="line">    int 0x80 ; sys_exit</span><br></pre></td></tr></table></figure>

<p>然后我们得下载</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">更新pip</span><br><span class="line">然后pip install lief</span><br></pre></td></tr></table></figure>

<p>把之前给ｔｘｔ赋的可写权限给去掉？？为什么要去掉?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pip install lief ,不是life,我直接下载错误</span></span><br><span class="line"><span class="keyword">import</span> lief</span><br><span class="line">binary=lief.parse(<span class="string">&#x27;./q&#x27;</span>)</span><br><span class="line">text=binary.get_section(<span class="string">&#x27;.text&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(text.flags_list)</span><br><span class="line">text.flags=<span class="number">0x6</span></span><br><span class="line"><span class="built_in">print</span>(text.flags_list)</span><br><span class="line">binary.write(<span class="string">&#x27;./q&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h5 id="代码注入"><a href="#代码注入" class="headerlink" title="代码注入"></a>代码注入</h5><p>其实就是用ｐｔｒａｃｅ实现一个简单的调试器</p>
<p>可以达到对进程的寄存器内存修改和读取</p>
<h2 id="处理ELF格式，阻止IDA加载"><a href="#处理ELF格式，阻止IDA加载" class="headerlink" title="处理ELF格式，阻止IDA加载"></a>处理ELF格式，阻止IDA加载</h2><h2 id="多进程守护"><a href="#多进程守护" class="headerlink" title="多进程守护"></a>多进程守护</h2><p>其实有个思路,也哈桑蛮容易实现的</p>
<p>就是是我们执行的主要进程是子进程</p>
<p>然后在main函数种,fork出子进程,父进程关闭自己</p>
<p>然后子进程慢慢运行</p>
<p>那么就达到了一个可以不让IDA反调试的一个目的</p>
<h2 id="CRC校验"><a href="#CRC校验" class="headerlink" title="CRC校验"></a>CRC校验</h2><h2 id="调试中断指令检测（类似x86-0xCC）"><a href="#调试中断指令检测（类似x86-0xCC）" class="headerlink" title="调试中断指令检测（类似x86 0xCC）"></a>调试中断指令检测（类似x86 0xCC）</h2><h2 id="调试器检测"><a href="#调试器检测" class="headerlink" title="调试器检测"></a>调试器检测</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>  <span class="title function_">CheckDbg1</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> buf0[<span class="number">32</span>], buf1[<span class="number">128</span>];</span><br><span class="line">	FILE* fin;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">snprintf</span>(buf0, <span class="number">24</span>, <span class="string">&quot;/proc/%d/cmdline&quot;</span>, getppid());</span><br><span class="line">	fin = fopen(buf0, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">	fgets(buf1, <span class="number">128</span>, fin);</span><br><span class="line">	fclose(fin);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//puts(buf1);</span></span><br><span class="line">	<span class="keyword">if</span>(!<span class="built_in">strcmp</span>(buf1, <span class="string">&quot;gdb&quot;</span>)) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Find  gdb\n&quot;</span>);</span><br><span class="line">		<span class="comment">//abort();</span></span><br><span class="line">	&#125; </span><br><span class="line">	<span class="comment">//puts(buf1);</span></span><br><span class="line">	<span class="keyword">if</span>(!<span class="built_in">strcmp</span>(buf1, <span class="string">&quot;./linux_server64&quot;</span>)) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Find Romote Server Dbg\n&quot;</span>);</span><br><span class="line">		<span class="comment">//abort();</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//puts(buf1);</span></span><br><span class="line">	<span class="keyword">if</span>(!<span class="built_in">strcmp</span>(buf1, <span class="string">&quot;./64&quot;</span>)) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Find Romote Server Dbg\n&quot;</span>);</span><br><span class="line">		<span class="comment">//abort();</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Check All good\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="运行时间的检测"><a href="#运行时间的检测" class="headerlink" title="运行时间的检测"></a>运行时间的检测</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">alarmHandler</span><span class="params">(<span class="type">int</span> sig)</span> </span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;Debugger detected&quot;</span>);</span><br><span class="line">   <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> __attribute__((constructor))setupSig(<span class="type">void</span>) </span><br><span class="line">&#123;</span><br><span class="line">   signal(SIGALRM, alarmHandler);</span><br><span class="line">   alarm(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="检测打开的fd文件"><a href="#检测打开的fd文件" class="headerlink" title="检测打开的fd文件"></a>检测打开的fd文件</h2><p>如果被调试的进程是通过gdb 的方式启动，那么它便是由gdb进程fork得到的。而fork在调用时，</p>
<p>父进程所拥有的fd(file descriptor)会被子进程继承。由于gdb在往往会打开多个fd，因此如果进程拥有的fd较多，</p>
<p>则可能是继承自gdb的，即进程在被调试。具体地，进程拥有的fd会在&#x2F;proc&#x2F;self&#x2F;fd&#x2F;下列出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">CheckDbg3</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> *<span class="title">dir</span>;</span></span><br><span class="line">   DIR *d = opendir(<span class="string">&quot;/proc/self/fd&quot;</span>);</span><br><span class="line">   <span class="keyword">while</span>(dir=readdir(d))</span><br><span class="line">    &#123;</span><br><span class="line">	<span class="built_in">puts</span>(dir-&gt;d_name);</span><br><span class="line">       <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(dir-&gt;d_name, <span class="string">&quot;4&quot;</span>))</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="built_in">printf</span>(<span class="string">&quot;Check fd Debugger detected\n&quot;</span>);</span><br><span class="line">           <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(dir-&gt;d_name, <span class="string">&quot;5&quot;</span>))</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="built_in">printf</span>(<span class="string">&quot;Check fd Debugger detected\n&quot;</span>);</span><br><span class="line">           <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   closedir(d);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;Check fd All good\n&quot;</span>);</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>









<h1 id="ELF函数加密"><a href="#ELF函数加密" class="headerlink" title="ELF函数加密"></a>ELF函数加密</h1><h2 id="ELF入口加解密"><a href="#ELF入口加解密" class="headerlink" title="ELF入口加解密"></a>ELF入口加解密</h2><h2 id="函数动态加解密，指令级加解密"><a href="#函数动态加解密，指令级加解密" class="headerlink" title="函数动态加解密，指令级加解密"></a>函数动态加解密，指令级加解密</h2><h2 id="基于加载器的函数加解密"><a href="#基于加载器的函数加解密" class="headerlink" title="基于加载器的函数加解密"></a>基于加载器的函数加解密</h2><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>以上列出的反调试技术中，往往只进行了一次检测。为了提高强度，</p>
<p>我们可以fork得到一个新的进程，在这个子进程中，每隔一段时间对父进程进行一次检测。<br>然而，这些技术都面临存在另外一个致命弱点：可以通过反汇编静态分析，找到相应的检测代码并修改，从而绕过反调试检测</p>
<p>因此，我们通常还需要对二进制文件进行混淆以对抗静态分析，这样与反调试技术相结合，才能得到理想的保护效果</p>


<div class="article-footer reveal fs14"><section id="license"><div class="header"><span>许可协议</span></div><div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div></section></div>

</article>

<div class="related-wrap reveal" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="/re4mile/2021/06/07/re/%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/%E5%9B%9B%E5%88%99%E8%BF%90%E7%AE%97/re/">底层原理</a></div><div class="item" id="next"><div class="note">较早文章</div><a href="/re4mile/2021/06/07/re/%E5%8F%8D%E8%B0%83%E8%AF%95/PYC/re/">PYC反调试</a></div></section></div>






  <div class='related-wrap md-text reveal' id="comments">
    <section class='header cmt-title cap theme'>
      快来参与讨论吧
    </section>
    <section class='body cmt-body twikoo'>
      

<div id="twikoo_container"><svg class="loading" style="vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg></div>
    </section>
  </div>



      
<footer class="page-footer reveal fs12"><hr><div class="text"><p>本站由 <a href="/">@anonymity</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar">Stellar</a> 主题创建。<br>本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>

      <div class='float-panel mobile-only blur' style='display:none'>
  <button type='button' class='sidebar-toggle mobile' onclick='sidebar.toggle()'>
    <svg class="icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15301"><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 2.3 26.8 24.6 47.5 51.6 47.6h416.5v4z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15302"></path><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 1.9 27.7 23.9 49.7 51.6 51.6h416.5z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15303"></path></svg>
  </button>
</div>

    </div>
  </div>
  <div class='scripts'>
    <script type="text/javascript">
  const stellar = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    loadCSS: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    // 从 butterfly 和 volantis 获得灵感
    loadScript: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    // https://github.com/jerryc127/hexo-theme-butterfly
    jQuery: (fn) => {
      if (typeof jQuery === 'undefined') {
        stellar.loadScript(stellar.plugins.jQuery).then(fn)
      } else {
        fn()
      }
    }
  };
  stellar.version = '1.18.5';
  stellar.github = 'https://github.com/xaoxuu/hexo-theme-stellar/tree/1.18.5';
  stellar.config = {
    date_suffix: {
      just: '刚刚',
      min: '分钟前',
      hour: '小时前',
      day: '天前',
      month: '个月前',
    },
  };

  // required plugins (only load if needs)
  stellar.plugins = {
    jQuery: 'https://gcore.jsdelivr.net/npm/jquery@3.6.2/dist/jquery.min.js'
  };

  if ('local_search') {
    stellar.search = {};
    stellar.search.service = 'local_search';
    if (stellar.search.service == 'local_search') {
      let service_obj = Object.assign({}, {"field":"all","path":"/search.json","content":true,"sort":"-date"});
      stellar.search[stellar.search.service] = service_obj;
    }
  }

  // stellar js
  stellar.plugins.stellar = Object.assign({"sites":"/js/plugins/sites.js","friends":"/js/plugins/friends.js","ghinfo":"/js/plugins/ghinfo.js","timeline":"/js/plugins/timeline.js","linkcard":"/js/plugins/linkcard.js","fcircle":"/js/plugins/fcircle.js","weibo":"/js/plugins/weibo.js"});

  stellar.plugins.marked = Object.assign("https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js");
  // optional plugins
  if ('true' == 'true') {
    stellar.plugins.lazyload = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/vanilla-lazyload@17.8.3/dist/lazyload.min.js","transition":"blur"});
  }
  if ('true' == 'true') {
    stellar.plugins.swiper = Object.assign({"enable":true,"css":"https://unpkg.com/swiper@8.4.5/swiper-bundle.min.css","js":"https://unpkg.com/swiper@8.4.5/swiper-bundle.min.js"});
  }
  if ('true' == 'true') {
    stellar.plugins.scrollreveal = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/scrollreveal@4.0.9/dist/scrollreveal.min.js","distance":"8px","duration":500,"interval":100,"scale":1});
  }
  if ('true' == 'true') {
    stellar.plugins.preload = Object.assign({"enable":true,"service":"flying_pages","instant_page":"https://gcore.jsdelivr.net/gh/volantis-x/cdn-volantis@4.1.2/js/instant_page.js","flying_pages":"https://gcore.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"});
  }
  if ('true' == 'true') {
    stellar.plugins.fancybox = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js","css":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css","selector":".swiper-slide img"});
  }
  if ('false' == 'true') {
    stellar.plugins.heti = Object.assign({"enable":false,"css":"https://unpkg.com/heti@0.9.2/umd/heti.min.css","js":"https://unpkg.com/heti@0.9.2/umd/heti-addon.min.js"});
  }
</script>

<!-- required -->

  
<script src="/re4mile/js/main.js" async></script>



<!-- optional -->

  <script>
    function load_twikoo() {
        if (!document.querySelectorAll("#twikoo_container")[0]) return;
        stellar.loadScript('https://gcore.jsdelivr.net/npm/twikoo@1.6.8/dist/twikoo.all.min.js', {defer: true}).then(function () {
            const el = document.getElementById("twikoo_container");
            var path = el.getAttribute('comment_id');
            if (!path) {
                path = decodeURI(window.location.pathname);
            }
            twikoo.init(Object.assign({"js":"https://gcore.jsdelivr.net/npm/twikoo@1.6.8/dist/twikoo.all.min.js","envId":"https://twik00.vercel.app"}, {
                el: '#twikoo_container',
                path: path,
            }));
        });
    }

    window.addEventListener('DOMContentLoaded', (event) => {
        load_twikoo();
    });
</script>



<!-- inject -->


  </div>
</body>
</html>
