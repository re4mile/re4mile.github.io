<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="https://s1.ax1x.com/2023/01/03/pSip2aF.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://s1.ax1x.com/2023/01/03/pSip2aF.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://s1.ax1x.com/2023/01/03/pSip2aF.png">
  <link rel="mask-icon" href="https://s1.ax1x.com/2023/01/03/pSip2aF.png" color="#222">

<link rel="stylesheet" href="/re4mile.github.io/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"github.com","root":"/re4mile.github.io/","images":"/re4mile.github.io/images","scheme":"Pisces","darkmode":true,"version":"8.14.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":10},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/re4mile.github.io/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/re4mile.github.io/js/config.js"></script>

    <meta name="description" content="代码模板8086.exe1234567891011121314151617181920212223242526272829303132333435363738394041424344454647;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxassume cs:code , ds:data, ss:stack;xxxxxx">
<meta property="og:type" content="article">
<meta property="og:title" content="x86汇编语言实践部分">
<meta property="og:url" content="https://github.com/re4mile/re4mile.github.io/2023/01/11/language/Asm/windwos/32/%E5%AE%9E%E8%B7%B5/language/index.html">
<meta property="og:site_name" content="实践是检验真理的唯一标准">
<meta property="og:description" content="代码模板8086.exe1234567891011121314151617181920212223242526272829303132333435363738394041424344454647;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxassume cs:code , ds:data, ss:stack;xxxxxx">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://re4mile.gitee.io/res/photo/language/image-20221211234519517.png">
<meta property="og:image" content="https://re4mile.gitee.io/res/photo/language/image-20221211235222689.png">
<meta property="og:image" content="f:\5008\GItee\res\photo\language\image-20230109154923684.png">
<meta property="og:image" content="https://s2.loli.net/2022/02/26/J6SBkol3NjqODnb.png">
<meta property="og:image" content="https://s2.loli.net/2022/02/26/4oS3IPbOpQ5uKT9.png">
<meta property="og:image" content="https://github.com/Img/Asm-%E5%AE%9E%E8%B7%B5/image-20221025005544886.png">
<meta property="article:published_time" content="2023-01-11T14:41:22.959Z">
<meta property="article:modified_time" content="2023-01-09T07:49:25.931Z">
<meta property="article:author" content="re4mile(邓渠香)">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://re4mile.gitee.io/res/photo/language/image-20221211234519517.png">


<link rel="canonical" href="https://github.com/re4mile/re4mile.github.io/2023/01/11/language/Asm/windwos/32/%E5%AE%9E%E8%B7%B5/language/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://github.com/re4mile/re4mile.github.io/2023/01/11/language/Asm/windwos/32/%E5%AE%9E%E8%B7%B5/language/","path":"2023/01/11/language/Asm/windwos/32/实践/language/","title":"x86汇编语言实践部分"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>x86汇编语言实践部分 | 实践是检验真理的唯一标准</title>
  








  <noscript>
    <link rel="stylesheet" href="/re4mile.github.io/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/re4mile.github.io/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">实践是检验真理的唯一标准</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">好记性不如烂笔头</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/re4mile.github.io/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/re4mile.github.io/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/re4mile.github.io/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/re4mile.github.io/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E6%A8%A1%E6%9D%BF"><span class="nav-number">1.</span> <span class="nav-text">代码模板</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8086-exe"><span class="nav-number">1.1.</span> <span class="nav-text">8086.exe</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#386-exe"><span class="nav-number">1.2.</span> <span class="nav-text">386.exe</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#x86-ELF"><span class="nav-number">1.3.</span> <span class="nav-text">x86_ELF</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AF%BB%E5%9D%80%E6%96%B9%E5%BC%8F"><span class="nav-number">2.</span> <span class="nav-text">寻址方式</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AD%90%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8"><span class="nav-number">3.</span> <span class="nav-text">子函数调用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%88stack"><span class="nav-number">3.1.</span> <span class="nav-text">栈stack</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%88%E7%BB%93%E6%9E%84"><span class="nav-number">3.1.1.</span> <span class="nav-text">栈结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%88%E6%95%B0%E6%8D%AE%E7%9A%84%E8%8E%B7%E5%8F%96-%E4%B8%8D%E6%98%AF%E9%9D%9E%E8%A6%81%E5%8E%BBpop%E6%9D%A5%E8%8E%B7%E5%8F%96"><span class="nav-number">3.1.2.</span> <span class="nav-text">栈数据的获取(不是非要去pop来获取)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E8%A6%81%E9%9A%8F%E6%80%A7%E7%9A%84push-%E4%B8%8E-pop"><span class="nav-number">3.1.3.</span> <span class="nav-text">不要随性的push 与 pop</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%81%94%E5%90%88%E4%BD%BF%E7%94%A8push%E4%B8%8Epop"><span class="nav-number">3.1.4.</span> <span class="nav-text">联合使用push与pop</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%88%E6%8C%87%E4%BB%A4"><span class="nav-number">3.1.5.</span> <span class="nav-text">栈指令</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#push-x2F-pop"><span class="nav-number">3.1.5.1.</span> <span class="nav-text">push&#x2F;pop</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pushfd-x2F-popfd"><span class="nav-number">3.1.5.2.</span> <span class="nav-text">pushfd&#x2F;popfd</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pushad-x2F-popad-x2F-pusha-x2F-popa"><span class="nav-number">3.1.5.3.</span> <span class="nav-text">pushad&#x2F;popad&#x2F;pusha&#x2F;popa</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#leave"><span class="nav-number">3.1.5.4.</span> <span class="nav-text">leave</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#enter"><span class="nav-number">3.1.5.5.</span> <span class="nav-text">enter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8086%E6%A0%88%E6%8C%87%E4%BB%A4"><span class="nav-number">3.1.5.6.</span> <span class="nav-text">8086栈指令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#pushf-x2F-popf"><span class="nav-number">3.1.5.6.1.</span> <span class="nav-text">pushf&#x2F;popf</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#pusha-x2F-popa"><span class="nav-number">3.1.5.6.2.</span> <span class="nav-text">pusha&#x2F;popa</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%88%E7%BB%B4%E6%8A%A4"><span class="nav-number">3.1.6.</span> <span class="nav-text">栈维护</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8uses%E4%B8%B4%E6%97%B6%E5%88%9B%E5%BB%BA%E5%8F%98%E9%87%8F"><span class="nav-number">3.1.6.1.</span> <span class="nav-text">用uses临时创建变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8local%E5%88%9B%E5%BB%BA%E5%8F%98%E9%87%8F"><span class="nav-number">3.1.6.2.</span> <span class="nav-text">用local创建变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#invoke-%E5%92%8C%E8%B0%83%E7%94%A8%E7%BA%A6%E5%AE%9A"><span class="nav-number">3.1.6.3.</span> <span class="nav-text">invoke 和调用约定</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#x64%E6%A0%88%E5%AF%B9%E9%BD%90"><span class="nav-number">3.1.6.4.</span> <span class="nav-text">x64栈对齐</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A0%86%E6%A0%88%E5%9B%BE"><span class="nav-number">3.2.</span> <span class="nav-text">堆栈图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4"><span class="nav-number">3.3.</span> <span class="nav-text">常用指令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#invoke"><span class="nav-number">3.3.1.</span> <span class="nav-text">invoke</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#addr"><span class="nav-number">3.3.2.</span> <span class="nav-text">addr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#proc-x2F-endp-%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E"><span class="nav-number">3.3.3.</span> <span class="nav-text">proc &#x2F;endp 函数声明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#proto-%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E"><span class="nav-number">3.3.4.</span> <span class="nav-text">proto 函数声明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#extern-%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E"><span class="nav-number">3.3.5.</span> <span class="nav-text">extern 函数声明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#inlcudelib-%E5%AF%BC%E5%85%A5%E5%BA%93"><span class="nav-number">3.3.6.</span> <span class="nav-text">inlcudelib 导入库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#uses-%E4%BC%AA%E6%8C%87%E4%BB%A4-%E4%B8%80%E4%B8%AA%E5%85%A5%E6%A0%88%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="nav-number">3.3.7.</span> <span class="nav-text">uses 伪指令,一个入栈的操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#local-%E5%AE%9A%E4%B9%89%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F"><span class="nav-number">3.3.8.</span> <span class="nav-text">local 定义局部变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lahf-x2F-sahf"><span class="nav-number">3.3.9.</span> <span class="nav-text">lahf&#x2F;sahf</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E4%B8%8E%E5%88%9D%E5%A7%8B%E5%8C%96-x2F-%E5%AD%98%E5%82%A8%E4%BD%8D%E7%BD%AE"><span class="nav-number">3.4.</span> <span class="nav-text">变量声明与初始化&#x2F;存储位置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="nav-number">3.4.1.</span> <span class="nav-text">全局变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#main%E5%8F%98%E9%87%8F"><span class="nav-number">3.4.2.</span> <span class="nav-text">main变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F"><span class="nav-number">3.4.3.</span> <span class="nav-text">局部变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#x64%E7%9A%84%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E"><span class="nav-number">3.4.4.</span> <span class="nav-text">x64的局部变量声明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%90%E5%87%BD%E6%95%B0%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">3.5.</span> <span class="nav-text">子函数的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E5%AD%90%E5%87%BD%E6%95%B0%E8%BF%99%E4%B8%AA%E4%B8%9C%E8%A5%BF"><span class="nav-number">3.5.1.</span> <span class="nav-text">为什么有子函数这个东西</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E6%9C%89ebp%E7%9A%84%E5%AF%BB%E5%9D%80"><span class="nav-number">3.5.2.</span> <span class="nav-text">为什么会有ebp的寻址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92%E4%B8%8E%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="nav-number">3.5.3.</span> <span class="nav-text">参数传递与返回值</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%A0%E9%80%92"><span class="nav-number">3.5.3.1.</span> <span class="nav-text">传递</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%A0%E9%80%92%E7%9A%84%E8%A7%84%E5%BE%8B"><span class="nav-number">3.5.3.2.</span> <span class="nav-text">传递的规律</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%90%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="nav-number">3.5.4.</span> <span class="nav-text">子函数的定义</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E7%9A%84%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="nav-number">3.6.</span> <span class="nav-text">函数的返回值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#x64%E7%9A%84%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8"><span class="nav-number">3.7.</span> <span class="nav-text">x64的函数调用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%8B%E5%AD%90"><span class="nav-number">3.8.</span> <span class="nav-text">例子</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%92%E5%BD%92"><span class="nav-number">3.8.1.</span> <span class="nav-text">递归</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B1%82%E5%92%8C"><span class="nav-number">3.8.1.1.</span> <span class="nav-text">求和</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%B6%E4%B9%98"><span class="nav-number">3.8.1.2.</span> <span class="nav-text">阶乘</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#x64-%E8%AE%A1%E6%95%B0%E5%9C%86%E7%9A%84%E5%91%A8%E9%95%BF-x2F-%E9%9D%A2%E7%A7%AF"><span class="nav-number">3.8.2.</span> <span class="nav-text">x64 计数圆的周长&#x2F;面积</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%A3%B8%E5%87%BD%E6%95%B0"><span class="nav-number">4.</span> <span class="nav-text">裸函数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5"><span class="nav-number">4.1.</span> <span class="nav-text">导入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%A0%E5%8F%82%E6%95%B0%E5%92%8C%E8%BF%94%E5%9B%9E%E5%80%BC%E7%9A%84%E8%A3%B8%E5%87%BD%E6%95%B0"><span class="nav-number">4.2.</span> <span class="nav-text">无参数和返回值的裸函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%89%E5%8F%82%E6%95%B0%E5%92%8C%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="nav-number">4.3.</span> <span class="nav-text">有参数和返回值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%A6%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E7%9A%84%E8%A3%B8%E5%87%BD%E6%95%B0"><span class="nav-number">4.4.</span> <span class="nav-text">带局部变量的裸函数</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MS-Windows"><span class="nav-number">5.</span> <span class="nav-text">MS-Windows</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E8%A1%A8"><span class="nav-number">5.1.</span> <span class="nav-text">数据类型表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E4%B8%80%E8%A7%88%E8%A1%A8"><span class="nav-number">5.2.</span> <span class="nav-text">函数一览表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%A5%E6%9F%84"><span class="nav-number">5.3.</span> <span class="nav-text">句柄</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97"><span class="nav-number">5.4.</span> <span class="nav-text">模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Messagebox-A-x2F-W"><span class="nav-number">5.5.</span> <span class="nav-text">Messagebox A&#x2F;W</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AE%B9%E5%92%8C%E8%A1%8C%E4%B8%BA"><span class="nav-number">5.5.1.</span> <span class="nav-text">内容和行为</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E6%8C%89%E9%92%AE"><span class="nav-number">5.5.2.</span> <span class="nav-text">默认按钮</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%BE%E6%A0%87"><span class="nav-number">5.5.3.</span> <span class="nav-text">图标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="nav-number">5.5.4.</span> <span class="nav-text">返回值</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AA%97%E5%8F%A3%E8%BE%93%E5%85%A5"><span class="nav-number">5.6.</span> <span class="nav-text">窗口输入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ReadConsole-%E8%AF%BB%E5%8F%96%E8%BE%93%E5%85%A5"><span class="nav-number">5.6.1.</span> <span class="nav-text">ReadConsole 读取输入</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GetLastError-x2F-FormatMessage-%E8%8E%B7%E5%8F%96%E9%94%99%E8%AF%AF%E6%B6%88%E6%81%AF"><span class="nav-number">5.7.</span> <span class="nav-text">GetLastError&#x2F;FormatMessage 获取错误消息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ReadChar-x2F-ReadKey-%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E6%8C%89%E9%94%AE"><span class="nav-number">5.7.1.</span> <span class="nav-text">ReadChar&#x2F;ReadKey 获取当前按键</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GetKeyState-%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E6%8C%89%E4%B8%8B%E7%9A%84%E9%94%AE"><span class="nav-number">5.7.2.</span> <span class="nav-text">GetKeyState 获取当前按下的键</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AA%97%E5%8F%A3%E8%BE%93%E5%87%BA"><span class="nav-number">5.8.</span> <span class="nav-text">窗口输出</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#WriteConsole-%E8%BE%93%E5%87%BA"><span class="nav-number">5.8.1.</span> <span class="nav-text">WriteConsole 输出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WriteConsoleOutputCharacter"><span class="nav-number">5.8.2.</span> <span class="nav-text">WriteConsoleOutputCharacter</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6-%E5%A4%84%E7%90%86"><span class="nav-number">5.9.</span> <span class="nav-text">文件 处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CreateFile"><span class="nav-number">5.9.1.</span> <span class="nav-text">CreateFile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CloseHandle"><span class="nav-number">5.9.2.</span> <span class="nav-text">CloseHandle</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ReadFile"><span class="nav-number">5.9.3.</span> <span class="nav-text">ReadFile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WriteFile"><span class="nav-number">5.9.4.</span> <span class="nav-text">WriteFile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SetFilePointer"><span class="nav-number">5.9.5.</span> <span class="nav-text">SetFilePointer</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E5%8F%B0%E7%AA%97%E5%8F%A3%E6%93%8D%E4%BD%9C"><span class="nav-number">5.10.</span> <span class="nav-text">控制台窗口操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SetConsoleTitle"><span class="nav-number">5.10.1.</span> <span class="nav-text">SetConsoleTitle</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GetConsoleScreenBufferInfo"><span class="nav-number">5.10.2.</span> <span class="nav-text">GetConsoleScreenBufferInfo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SetConsoleWindowInfo"><span class="nav-number">5.10.3.</span> <span class="nav-text">SetConsoleWindowInfo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SetConsoleScreenBufferSize"><span class="nav-number">5.10.4.</span> <span class="nav-text">SetConsoleScreenBufferSize</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E5%8F%B0%E5%85%89%E6%A0%87%E8%AE%BE%E7%BD%AE%E5%87%BD%E6%95%B0"><span class="nav-number">5.11.</span> <span class="nav-text">控制台光标设置函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GetConsoleCursorInfo"><span class="nav-number">5.11.1.</span> <span class="nav-text">GetConsoleCursorInfo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SetConsoleCursorInfo"><span class="nav-number">5.11.2.</span> <span class="nav-text">SetConsoleCursorInfo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SetConsoleCursorPosition"><span class="nav-number">5.11.3.</span> <span class="nav-text">SetConsoleCursorPosition</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E5%8F%B0%E6%96%87%E6%9C%AC%E9%A2%9C%E8%89%B2"><span class="nav-number">5.12.</span> <span class="nav-text">控制台文本颜色</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SetConsoleTextAttribute"><span class="nav-number">5.12.1.</span> <span class="nav-text">SetConsoleTextAttribute</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WriteConsoleOutputAttribute"><span class="nav-number">5.12.2.</span> <span class="nav-text">WriteConsoleOutputAttribute</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Win32%E6%97%B6%E9%97%B4%E4%B8%8E%E6%97%A5%E6%9C%9F%E5%87%BD%E6%95%B0"><span class="nav-number">5.13.</span> <span class="nav-text">Win32时间与日期函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E4%B8%80%E8%A7%88%E8%A1%A8-1"><span class="nav-number">5.13.1.</span> <span class="nav-text">函数一览表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SYSTEMTIME-%E7%BB%93%E6%9E%84"><span class="nav-number">5.13.2.</span> <span class="nav-text">SYSTEMTIME 结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FILETIME"><span class="nav-number">5.13.3.</span> <span class="nav-text">FILETIME</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GetLocalTime-%E5%92%8C-SetLocalTime"><span class="nav-number">5.13.4.</span> <span class="nav-text">GetLocalTime 和 SetLocalTime</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GetTickCount"><span class="nav-number">5.13.5.</span> <span class="nav-text">GetTickCount</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sleep"><span class="nav-number">5.13.6.</span> <span class="nav-text">Sleep</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GetDateTime"><span class="nav-number">5.13.7.</span> <span class="nav-text">GetDateTime</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%BE%E5%BD%A2%E5%8C%96%E7%9A%84Windows%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="nav-number">5.14.</span> <span class="nav-text">图形化的Windows应用程序</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BF%85%E8%A6%81%E7%9A%84%E7%BB%93%E6%9E%84"><span class="nav-number">5.14.1.</span> <span class="nav-text">必要的结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WinMain%E8%BF%87%E7%A8%8B"><span class="nav-number">5.14.2.</span> <span class="nav-text">WinMain过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WinProc%E8%BF%87%E7%A8%8B"><span class="nav-number">5.14.3.</span> <span class="nav-text">WinProc过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ErrorHandler"><span class="nav-number">5.14.4.</span> <span class="nav-text">ErrorHandler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%88%E4%B8%80%E4%B8%AA%E6%97%A0%E6%B3%95%E8%BF%90%E8%A1%8C%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="nav-number">5.14.5.</span> <span class="nav-text">又一个无法运行的例子</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AA%97%E5%8F%A3"><span class="nav-number">5.15.</span> <span class="nav-text">窗口</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%BA%9B%E5%8F%98%E9%87%8F%E5%89%8D%E7%BC%80"><span class="nav-number">5.15.1.</span> <span class="nav-text">一些变量前缀</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0-%E4%BE%9B%E6%9F%A5%E7%9C%8B"><span class="nav-number">5.15.2.</span> <span class="nav-text">函数(供查看)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#GetModuleHandle-%E8%8E%B7%E5%8F%96%E5%8F%A5%E6%9F%84"><span class="nav-number">5.15.2.1.</span> <span class="nav-text">GetModuleHandle 获取句柄</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RegisterClassEx-%E7%AA%97%E5%8F%A3%E6%B3%A8%E5%86%8C"><span class="nav-number">5.15.2.2.</span> <span class="nav-text">RegisterClassEx 窗口注册</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#hIcon-dd-%E7%AA%97%E5%8F%A3%E5%9B%BE%E6%A0%87"><span class="nav-number">5.15.2.2.1.</span> <span class="nav-text">hIcon;			dd	?	;窗口图标</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#hCursor-dd-%E7%AA%97%E5%8F%A3%E5%85%89%E6%A0%87"><span class="nav-number">5.15.2.2.2.</span> <span class="nav-text">hCursor;		dd	?	;窗口光标</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#lpszMenuName-dd-%E7%AA%97%E5%8F%A3%E8%8F%9C%E5%8D%95"><span class="nav-number">5.15.2.2.3.</span> <span class="nav-text">lpszMenuName;	dd	?	;窗口菜单</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#hInstance-dd-%E5%AE%9E%E4%BE%8B%E5%8F%A5%E6%9F%84"><span class="nav-number">5.15.2.2.4.</span> <span class="nav-text">hInstance;		dd	?	;实例句柄</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#cbSizedd-%E7%BB%93%E6%9E%84%E4%BD%93%E5%AD%97%E8%8A%82%E6%95%B0-%E7%94%A8sizeof%E8%AE%A1%E7%AE%97"><span class="nav-number">5.15.2.2.5.</span> <span class="nav-text">cbSize			dd	?	;结构体字节数,用sizeof计算</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#style-dd"><span class="nav-number">5.15.2.2.6.</span> <span class="nav-text">style;			dd	?	;</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#hbrBackground-dd-%E8%83%8C%E6%99%AF%E8%89%B2"><span class="nav-number">5.15.2.2.7.</span> <span class="nav-text">hbrBackground;	dd	?	;背景色</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#lpszClassName-dd-Class-Name%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%9C%B0%E5%9D%80"><span class="nav-number">5.15.2.2.8.</span> <span class="nav-text">lpszClassName;	dd	?	;Class_Name的字符串地址</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#cbClsExtra-x2F-cbWndExtra"><span class="nav-number">5.15.2.2.9.</span> <span class="nav-text">cbClsExtra&#x2F;cbWndExtra</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#lpfnWndProc-dd-%E7%AA%97%E5%8F%A3%E8%BF%87%E7%A8%8B%E7%9A%84%E5%9C%B0%E5%9D%80"><span class="nav-number">5.15.2.2.10.</span> <span class="nav-text">lpfnWndProc;	dd	?	;窗口过程的地址</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CreateWindowEx-%E5%BB%BA%E7%AB%8B%E7%AA%97%E5%8F%A3"><span class="nav-number">5.15.2.3.</span> <span class="nav-text">CreateWindowEx  建立窗口</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#lpClassName-%E4%B9%8B%E5%89%8D%E6%B3%A8%E5%86%8C%E7%9A%84%E7%AA%97%E5%8F%A3%E7%B1%BB"><span class="nav-number">5.15.2.3.1.</span> <span class="nav-text">lpClassName 之前注册的窗口类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#lpwindowName-%E7%AA%97%E5%8F%A3%E6%A0%87%E9%A2%98%E6%A0%8F%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%9C%B0%E5%9D%80"><span class="nav-number">5.15.2.3.2.</span> <span class="nav-text">lpwindowName 窗口标题栏字符串地址</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#hMenu-%E8%8F%9C%E5%8D%95%E5%8F%A5%E6%9F%84"><span class="nav-number">5.15.2.3.3.</span> <span class="nav-text">hMenu 菜单句柄</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#lpParam"><span class="nav-number">5.15.2.3.4.</span> <span class="nav-text">lpParam</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#hinstance"><span class="nav-number">5.15.2.3.5.</span> <span class="nav-text">hinstance</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#hWndParent-%E7%AA%97%E5%8F%A3%E6%89%80%E5%B1%9E%E7%88%B6%E7%AA%97%E5%8F%A3"><span class="nav-number">5.15.2.3.6.</span> <span class="nav-text">hWndParent 窗口所属父窗口</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#x-y"><span class="nav-number">5.15.2.3.6.1.</span> <span class="nav-text">x,y</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#nWidth-nHeight"><span class="nav-number">5.15.2.3.7.</span> <span class="nav-text">nWidth,nHeight</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#dwStyle-x2F-dwExStyle"><span class="nav-number">5.15.2.3.8.</span> <span class="nav-text">dwStyle&#x2F;dwExStyle</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Showwindows-%E6%98%BE%E7%A4%BA%E7%AA%97%E5%8F%A3"><span class="nav-number">5.15.2.4.</span> <span class="nav-text">Showwindows 显示窗口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UpdateWindow-%E7%BB%98%E5%88%B6%E5%AE%A2%E6%88%B7%E5%8C%BA"><span class="nav-number">5.15.2.5.</span> <span class="nav-text">UpdateWindow 绘制客户区</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CreatewindowEx-%E5%BB%BA%E7%AB%8B%E5%AD%90%E7%AA%97%E5%8F%A3"><span class="nav-number">5.15.2.6.</span> <span class="nav-text">CreatewindowEx 建立子窗口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E5%BE%AA%E7%8E%AF"><span class="nav-number">5.15.2.7.</span> <span class="nav-text">消息循环</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#GetMessage"><span class="nav-number">5.15.2.7.1.</span> <span class="nav-text">GetMessage</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#TranslateMessage"><span class="nav-number">5.15.2.7.2.</span> <span class="nav-text">TranslateMessage</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#DispatchMessage"><span class="nav-number">5.15.2.7.3.</span> <span class="nav-text">DispatchMessage</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B6%E5%AE%83%E5%BD%A2%E5%BC%8F%E7%9A%84%E6%B6%88%E6%81%AF%E5%BE%AA%E7%8E%AF"><span class="nav-number">5.15.2.8.</span> <span class="nav-text">其它形式的消息循环</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AA%97%E5%8F%A3%E8%BF%87%E7%A8%8B"><span class="nav-number">5.15.2.9.</span> <span class="nav-text">窗口过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%94%B6%E5%88%B0%E6%B6%88%E6%81%AF%E7%9A%84%E9%A1%BA%E5%BA%8F"><span class="nav-number">5.15.2.10.</span> <span class="nav-text">收到消息的顺序</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AA%97%E5%8F%A3%E9%97%B4%E7%9A%84%E9%80%9A%E4%BF%A1"><span class="nav-number">5.15.3.</span> <span class="nav-text">窗口间的通信</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D"><span class="nav-number">6.</span> <span class="nav-text">动态内存分配</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E4%B8%80%E8%A7%88%E8%A1%A8-2"><span class="nav-number">6.1.</span> <span class="nav-text">函数一览表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GetProcessHeap-%E8%BF%94%E5%9B%9E%E5%B7%B2%E7%94%A8%E5%A0%86%E5%8C%BA%E7%9A%84%E5%9C%B0%E5%9D%80"><span class="nav-number">6.2.</span> <span class="nav-text">GetProcessHeap 返回已用堆区的地址</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HeapCreate-%E5%88%9B%E5%BB%BA%E5%A0%86%E5%8C%BA"><span class="nav-number">6.3.</span> <span class="nav-text">HeapCreate 创建堆区</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HeapDeatroy-%E9%94%80%E6%AF%81%E5%A0%86%E5%8C%BA"><span class="nav-number">6.4.</span> <span class="nav-text">HeapDeatroy 销毁堆区</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HeapAlloc-%E5%A0%86%E5%8C%BA%E4%B8%AD%E5%88%86%E9%85%8D%E5%86%85%E5%AD%98%E5%9D%97"><span class="nav-number">6.5.</span> <span class="nav-text">HeapAlloc 堆区中分配内存块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HeapFree-%E9%87%8A%E6%94%BE%E5%9C%A8%E5%A0%86%E5%8C%BA%E5%88%86%E9%85%8D%E7%9A%84%E5%86%85%E5%AD%98%E5%9D%97"><span class="nav-number">6.6.</span> <span class="nav-text">HeapFree 释放在堆区分配的内存块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Error-Handling"><span class="nav-number">6.7.</span> <span class="nav-text">Error Handling</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%85%E5%B5%8C%E6%B1%87%E7%BC%96"><span class="nav-number">7.</span> <span class="nav-text">内嵌汇编</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#asm-%E6%BA%90%E4%BA%8Evs-2010"><span class="nav-number">7.1.</span> <span class="nav-text">__asm 源于vs-2010</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#asm-%E6%BA%90%E4%BA%8Elinux%E7%B3%BB%E7%BB%9F%E7%9A%84nasm"><span class="nav-number">7.2.</span> <span class="nav-text">_asm _ 源于linux系统的nasm</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E5%86%85%E8%81%94"><span class="nav-number">7.2.1.</span> <span class="nav-text">基本内联</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E5%86%85%E8%81%94"><span class="nav-number">7.2.2.</span> <span class="nav-text">扩展内联</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%AD%E6%96%AD%E7%A8%8B%E5%BA%8F"><span class="nav-number">8.</span> <span class="nav-text">中断程序</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8086"><span class="nav-number">8.1.</span> <span class="nav-text">8086</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E2%91%A0-%E5%86%85%E4%B8%AD%E6%96%AD"><span class="nav-number">8.1.1.</span> <span class="nav-text">①. 内中断</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E8%A6%81%E4%BB%8B%E7%BB%8D"><span class="nav-number">8.1.1.1.</span> <span class="nav-text">简要介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%AD%E6%96%AD%E7%9A%84%E8%BF%87%E7%A8%8B%E7%9A%84%E5%85%A5%E6%A0%88"><span class="nav-number">8.1.1.2.</span> <span class="nav-text">中断的过程的入栈</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E4%BD%95DIY%E4%B8%80%E4%B8%AA%E4%B8%AD%E6%96%AD"><span class="nav-number">8.1.1.3.</span> <span class="nav-text">如何DIY一个中断</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%8E%E4%B9%88%E8%B0%83%E7%94%A8%E4%B8%80%E4%B8%AA%E4%B8%AD%E6%96%AD"><span class="nav-number">8.1.1.4.</span> <span class="nav-text">怎么调用一个中断</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#int-10h-gt-ah-x3D-2-%E5%85%89%E6%A0%87%E4%B8%AD%E6%96%AD"><span class="nav-number">8.1.1.5.</span> <span class="nav-text">int  10h-&gt;ah&#x3D;2 光标中断</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#int-10h-gt-ah-x3D-9-%E6%98%BE%E7%A4%BA%E4%B8%80%E4%B8%AA%E5%AD%97%E7%AC%A6"><span class="nav-number">8.1.1.6.</span> <span class="nav-text">int 10h-&gt;ah&#x3D;9 显示一个字符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#int-21h-gt-ah-x3D-9-%E8%BE%93%E5%87%BA%E4%BB%A5%E2%80%98-%E2%80%99%E7%BB%93%E5%B0%BE%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-number">8.1.1.7.</span> <span class="nav-text">int 21h-&gt;ah&#x3D;9 输出以‘$’结尾的字符串</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E2%91%A1-%E5%A4%96%E4%B8%AD%E6%96%AD"><span class="nav-number">8.1.2.</span> <span class="nav-text">②. 外中断</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E8%BF%B0"><span class="nav-number">8.1.2.1.</span> <span class="nav-text">简述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PC%E6%9C%BAI-x2F-O%E9%94%AE%E7%9B%98%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B"><span class="nav-number">8.1.2.2.</span> <span class="nav-text">PC机I&#x2F;O键盘处理过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#int-9%E4%B8%AD%E6%96%AD-%E6%89%93%E5%8D%B0ascii%E7%9A%84abcef"><span class="nav-number">8.1.2.3.</span> <span class="nav-text">int 9中断  打印ascii的abcef</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#x64"><span class="nav-number">8.2.</span> <span class="nav-text">x64</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#printf-syscall"><span class="nav-number">8.2.1.</span> <span class="nav-text">printf_syscall</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#scanf-syscall"><span class="nav-number">8.2.2.</span> <span class="nav-text">scanf_syscall</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ret-syscall"><span class="nav-number">8.2.3.</span> <span class="nav-text">ret_syscall</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3"><span class="nav-number">9.</span> <span class="nav-text">端口</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80-%E8%AF%BB%E5%86%99%E6%8C%87%E4%BB%A4"><span class="nav-number">9.1.</span> <span class="nav-text">(一). 读写指令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%BB"><span class="nav-number">9.1.1.</span> <span class="nav-text">读</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%99"><span class="nav-number">9.1.2.</span> <span class="nav-text">写</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C-CMOS-RAM-%E8%8A%AF%E7%89%87%E7%AB%AF%E5%8F%A3"><span class="nav-number">9.2.</span> <span class="nav-text">(二). CMOS RAM 芯片端口</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E8%A6%81%E4%BB%8B%E7%BB%8D-1"><span class="nav-number">9.2.1.</span> <span class="nav-text">简要介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CMOS%E4%B8%8B%E7%9A%84%E6%97%B6%E9%97%B4%E5%8D%95%E5%85%83"><span class="nav-number">9.2.2.</span> <span class="nav-text">CMOS下的时间单元</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E5%8F%ABBCD%E7%A0%81"><span class="nav-number">9.2.2.1.</span> <span class="nav-text">什么叫BCD码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E5%8D%95%E5%85%83"><span class="nav-number">9.2.2.2.</span> <span class="nav-text">时间单元</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%89%93%E5%8D%B0%E6%9C%88%E4%BB%BD"><span class="nav-number">9.2.2.2.1.</span> <span class="nav-text">打印月份</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%89%93%E5%8D%B0%E5%B9%B4%E6%9C%88%E6%97%A5%E6%97%B6%E5%88%86%E7%A7%92"><span class="nav-number">9.2.2.2.2.</span> <span class="nav-text">打印年月日时分秒</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8BIOS%E8%BF%9B%E8%A1%8C%E9%94%AE%E7%9B%98%E7%9A%84%E8%AF%BB%E5%86%99"><span class="nav-number">9.2.3.</span> <span class="nav-text">利用BIOS进行键盘的读写</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8BIOS%E8%BF%9B%E8%A1%8C%E7%A3%81%E7%9B%98%E7%9A%84%E8%AF%BB%E5%86%99"><span class="nav-number">9.2.4.</span> <span class="nav-text">利用BIOS进行磁盘的读写</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#x64%E7%9A%84%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86"><span class="nav-number">10.</span> <span class="nav-text">x64的文件处理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="nav-number">10.1.</span> <span class="nav-text">源代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0"><span class="nav-number">10.2.</span> <span class="nav-text">函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BE%93%E5%87%BA"><span class="nav-number">10.2.1.</span> <span class="nav-text">输出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA"><span class="nav-number">10.2.2.</span> <span class="nav-text">创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%99%E5%85%A5"><span class="nav-number">10.2.3.</span> <span class="nav-text">写入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E9%97%AD"><span class="nav-number">10.2.4.</span> <span class="nav-text">关闭</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E5%BC%80"><span class="nav-number">10.2.5.</span> <span class="nav-text">打开</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%BD%E5%8A%A0%E5%BD%A2%E5%BC%8F%E6%89%93%E5%BC%80"><span class="nav-number">10.2.6.</span> <span class="nav-text">追加形式打开</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%BD%8D%E5%81%8F%E7%A7%BB%E9%87%8F"><span class="nav-number">10.2.7.</span> <span class="nav-text">定位偏移量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%BB%E5%8F%96"><span class="nav-number">10.2.8.</span> <span class="nav-text">读取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%96%87%E4%BB%B6"><span class="nav-number">10.2.9.</span> <span class="nav-text">删除文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%8B%E5%AD%90-1"><span class="nav-number">10.3.</span> <span class="nav-text">例子</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-x2F-%E5%86%99%E5%85%A5-x2F-%E5%85%B3%E9%97%AD"><span class="nav-number">10.3.1.</span> <span class="nav-text">创建&#x2F;写入&#x2F;关闭</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E5%BC%80-x2F-%E8%A6%86%E7%9B%96-x2F-%E5%85%B3%E9%97%AD"><span class="nav-number">10.3.2.</span> <span class="nav-text">打开&#x2F;覆盖&#x2F;关闭</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%BD%E5%8A%A0-x2F-%E5%86%99%E5%85%A5-x2F-%E5%85%B3%E9%97%AD"><span class="nav-number">10.3.3.</span> <span class="nav-text">追加&#x2F;写入&#x2F;关闭</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E5%BC%80-x2F-%E5%AE%9A%E4%BD%8D%E5%81%8F%E7%A7%BB%E9%87%8F-x2F-%E8%BF%BD%E5%8A%A0%E5%9E%8B%E8%A6%86%E7%9B%96%E5%86%99%E5%85%A5-x2F-%E5%85%B3%E9%97%AD"><span class="nav-number">10.3.4.</span> <span class="nav-text">打开&#x2F;定位偏移量&#x2F;追加型覆盖写入&#x2F;关闭</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E5%BC%80-x2F-%E8%AF%BB%E5%8F%96-x2F-%E5%85%B3%E9%97%AD"><span class="nav-number">10.3.5.</span> <span class="nav-text">打开&#x2F;读取&#x2F;关闭</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E5%BC%80-x2F-%E5%AE%9A%E4%BD%8D%E5%81%8F%E7%A7%BB-x2F-%E8%AF%BB%E5%8F%96-x2F-%E5%85%B3%E9%97%AD"><span class="nav-number">10.3.6.</span> <span class="nav-text">打开&#x2F;定位偏移&#x2F;读取&#x2F;关闭</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%96%87%E4%BB%B6-1"><span class="nav-number">10.3.7.</span> <span class="nav-text">删除文件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B1%87%E7%BC%96%E8%B0%83%E7%94%A8C%E5%BA%93%E5%87%BD%E6%95%B0"><span class="nav-number">11.</span> <span class="nav-text">汇编调用C库函数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#x86"><span class="nav-number">11.1.</span> <span class="nav-text">x86</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#x64-1"><span class="nav-number">11.2.</span> <span class="nav-text">x64</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#linux%E4%B8%8B"><span class="nav-number">11.2.1.</span> <span class="nav-text">linux下</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E7%94%A8printf"><span class="nav-number">11.2.1.1.</span> <span class="nav-text">调用printf</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#windows%E4%B8%8B"><span class="nav-number">11.2.2.</span> <span class="nav-text">windows下</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#printf"><span class="nav-number">11.2.2.1.</span> <span class="nav-text">printf</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A0%86%E6%A0%88%E5%AF%B9%E9%BD%90"><span class="nav-number">11.2.3.</span> <span class="nav-text">堆栈对齐</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C"><span class="nav-number">12.</span> <span class="nav-text">实验</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8086-%E8%AF%BE%E7%A8%8B%E8%AE%BE%E8%AE%A1"><span class="nav-number">12.1.</span> <span class="nav-text">8086 课程设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1"><span class="nav-number">12.1.1.</span> <span class="nav-text">1</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8086-%E8%AF%BE%E5%90%8E%E5%AE%9E%E9%AA%8C"><span class="nav-number">12.2.</span> <span class="nav-text">8086 课后实验</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E6%8B%9Fjcxz"><span class="nav-number">12.2.1.</span> <span class="nav-text">模拟jcxz</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E4%BA%8Eloop%E4%B8%8Ecx%E5%8E%BB%E6%A3%80%E7%B4%A2%E6%95%B0%E6%8D%AE%E6%AE%B5%E4%B8%AD0%E7%9A%84%E4%BD%8D%E7%BD%AE"><span class="nav-number">12.2.2.</span> <span class="nav-text">关于loop与cx去检索数据段中0的位置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E7%BB%8F%E5%85%B8%E7%9A%84%E6%8C%87%E4%BB%A4%E5%A4%8D%E5%88%B6%E5%AE%9E%E9%AA%8C-jmp%E6%8C%87%E4%BB%A4%E7%9A%84%E6%9C%AC%E8%B4%A8"><span class="nav-number">12.2.3.</span> <span class="nav-text">一个经典的指令复制实验-jmp指令的本质</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E5%B1%8F%E5%B9%95%E4%B8%AD%E5%A4%AE%E6%98%BE%E7%A4%BA%E5%B8%A6%E9%A2%9C%E8%89%B2%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E2%80%98welcome-to-masm%E2%80%99"><span class="nav-number">12.2.4.</span> <span class="nav-text">在屏幕中央显示带颜色的字符串‘welcome to masm’</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%8D%E5%88%B6%E7%9A%84%E8%84%9A%E6%9C%AC"><span class="nav-number">12.2.5.</span> <span class="nav-text">复制的脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E4%BB%A4%E5%A4%8D%E5%88%B6"><span class="nav-number">12.2.6.</span> <span class="nav-text">指令复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E5%8D%B0%E5%B0%8F%E5%86%99%E4%B8%8E%E5%A4%A7%E5%86%99%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-number">12.2.7.</span> <span class="nav-text">打印小写与大写字符串</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E5%8D%B0%E4%B8%80%E4%B8%AA%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-number">12.2.8.</span> <span class="nav-text">打印一个字符串</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81-gt-ASCII%E7%9A%84%E6%89%93%E5%8D%B0"><span class="nav-number">12.2.9.</span> <span class="nav-text">源代码-&gt;ASCII的打印</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B1%8F%E5%B9%95%E5%A4%8D%E5%88%B6"><span class="nav-number">12.2.10.</span> <span class="nav-text">屏幕复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E4%BB%A4%E5%A4%8D%E5%88%B6-1"><span class="nav-number">12.2.11.</span> <span class="nav-text">指令复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Copy-Code%E5%87%BD%E6%95%B0"><span class="nav-number">12.2.12.</span> <span class="nav-text">Copy_Code函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E4%B8%AD%E6%96%AD%E6%A8%A1%E6%8B%9F%E6%B2%A1%E6%9C%89loop-%E7%9A%84%E7%9A%84loop"><span class="nav-number">12.2.13.</span> <span class="nav-text">用中断模拟没有loop 的的loop</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E4%B8%80%E5%AE%9A%E7%9A%84%E5%85%89%E6%A0%87%E4%BD%8D%E7%BD%AE%E6%98%BE%E7%A4%BA%E5%AD%97%E7%AC%A6"><span class="nav-number">12.2.14.</span> <span class="nav-text">在一定的光标位置显示字符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#int-7ch-%E8%AE%A1%E7%AE%97sqrt"><span class="nav-number">12.2.15.</span> <span class="nav-text">int 7ch 计算sqrt</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#int-7ch-%E5%A4%A7%E5%B0%8F%E5%86%99%E8%BD%AC%E5%8C%96"><span class="nav-number">12.2.16.</span> <span class="nav-text">int 7ch 大小写转化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%8B%E5%86%99%E5%AE%9E%E7%8E%B0-int21h%E7%9A%84ah-x3D-9"><span class="nav-number">12.2.17.</span> <span class="nav-text">手写实现 int21h的ah&#x3D;9</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BE%93%E5%87%BA4%E5%8F%A5%E8%AF%97"><span class="nav-number">12.2.18.</span> <span class="nav-text">输出4句诗</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8int9%E6%89%93%E5%8D%B0%E4%B8%80%E9%A6%96%E4%BA%94%E9%A2%9C%E5%85%AD%E8%89%B2%E7%9A%84%E6%83%85%E8%AF%97"><span class="nav-number">12.2.19.</span> <span class="nav-text">用int9打印一首五颜六色的情诗</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E4%BB%A3%E7%A0%81%E6%8D%AE%E6%94%BEdata-segment%E7%9A%84%E5%9D%8F%E5%A4%84"><span class="nav-number">12.2.20.</span> <span class="nav-text">在代码据放data segment的坏处</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85DIY%E7%9A%84int9%E4%B8%AD%E6%96%AD-%E7%84%B6%E5%90%8E%E8%BF%90%E8%A1%8C-%E5%8F%AF%E4%BB%A5%E4%BF%AE%E6%94%B9%E5%B1%8F%E5%B9%95%E7%9A%84%E9%A2%9C%E8%89%B2"><span class="nav-number">12.2.21.</span> <span class="nav-text">安装DIY的int9中断,然后运行,,,可以修改屏幕的颜色</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%B7%B1%E5%86%99%E4%BA%86%E4%B8%80%E9%81%8D-%E5%8F%91%E7%8E%B0%E4%BA%86%E5%BE%88%E5%A4%9A%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">12.2.22.</span> <span class="nav-text">自己写了一遍..发现了很多的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DIY%E4%B8%AD%E6%96%AD%E5%AE%89%E8%A3%85-%E6%89%A7%E8%A1%8C4%E4%B8%AA%E5%87%BD%E6%95%B0%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="nav-number">12.2.23.</span> <span class="nav-text">DIY中断安装,执行4个函数的功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8086CPU-gt-div%E7%9A%84Interger-over-flow%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">12.2.24.</span> <span class="nav-text">8086CPU-&gt;div的Interger_over_flow解决方案</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#x86-%E8%AF%BE%E5%A0%82%E4%BB%A3%E7%A0%81"><span class="nav-number">12.3.</span> <span class="nav-text">x86 课堂代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%8D%E5%88%B6%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-number">12.3.1.</span> <span class="nav-text">复制字符串</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%86%E5%BA%8F%E5%AD%97%E7%AC%A6%E4%B8%B2-IDA%E6%97%A0%E6%B3%95%E8%B0%83%E8%AF%95-xdebug%E5%8F%AF%E4%BB%A5"><span class="nav-number">12.3.2.</span> <span class="nav-text">逆序字符串,IDA无法调试,xdebug可以</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#strcmp-%E6%B1%87%E7%BC%96%E7%89%88-%E6%97%A0%E9%AB%98%E7%BA%A7%E8%B0%83%E7%94%A8"><span class="nav-number">12.3.3.</span> <span class="nav-text">strcmp 汇编版-无高级调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#strlen-%E6%B1%87%E7%BC%96%E7%89%88-%E6%97%A0%E9%AB%98%E7%BA%A7%E8%B0%83%E7%94%A8"><span class="nav-number">12.3.4.</span> <span class="nav-text">strlen 汇编版-无高级调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%89%E8%BE%93%E5%85%A5%E7%9A%84strlen"><span class="nav-number">12.3.5.</span> <span class="nav-text">有输入的strlen</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#strcpy-%E6%B1%87%E7%BC%96%E7%89%88-%E6%97%A0%E9%AB%98%E7%BA%A7%E8%B0%83%E7%94%A8"><span class="nav-number">12.3.6.</span> <span class="nav-text">strcpy 汇编版-无高级调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#strtrim-%E5%88%A0%E9%99%A4%E6%9C%AB%E5%B0%BE%E7%89%B9%E5%AE%9A%E7%9A%84%E5%AD%97%E7%AC%A6"><span class="nav-number">12.3.7.</span> <span class="nav-text">strtrim 删除末尾特定的字符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#toupper-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%A7%E5%86%99%E8%AF%9D"><span class="nav-number">12.3.8.</span> <span class="nav-text">toupper 字符串大写话</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tolower-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%B0%8F%E5%86%99%E5%8C%96"><span class="nav-number">12.3.9.</span> <span class="nav-text">tolower 字符串小写化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#asm-%E4%B8%A4%E6%95%B0%E7%9B%B8%E5%8A%A0"><span class="nav-number">12.3.10.</span> <span class="nav-text">__asm 两数相加</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#asm-%E6%95%B0%E7%BB%84%E6%B1%82%E5%92%8C"><span class="nav-number">12.3.11.</span> <span class="nav-text">__asm 数组求和</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#asm-10%E8%BF%9B%E5%88%B6value-gt-2%E8%BF%9B%E5%88%B6%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-number">12.3.12.</span> <span class="nav-text">__asm 10进制value-&gt;2进制字符串</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%96%E4%BD%99%E8%BF%90%E7%AE%97-%E9%9A%BE%E7%9C%8B"><span class="nav-number">12.3.13.</span> <span class="nav-text">取余运算,难看</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%84%E7%90%86-%E8%BE%93%E5%85%A5-x2F-%E8%BE%93%E5%87%BA-%E6%BA%A2%E5%87%BA"><span class="nav-number">12.3.14.</span> <span class="nav-text">处理 输入&#x2F;输出 溢出</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#win32"><span class="nav-number">12.4.</span> <span class="nav-text">win32</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#helloword"><span class="nav-number">12.4.1.</span> <span class="nav-text">helloword</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AA%E7%AA%97%E5%8F%A3"><span class="nav-number">12.4.2.</span> <span class="nav-text">第一个窗口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E4%B8%AA%E7%AA%97%E5%8F%A3"><span class="nav-number">12.4.3.</span> <span class="nav-text">第二个窗口</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#asm-gt-avx"><span class="nav-number">12.5.</span> <span class="nav-text">asm-&gt;avx</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%8D%B016%E8%BF%9B%E5%88%B6"><span class="nav-number">12.6.</span> <span class="nav-text">打印16进制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%8D%B0%E4%BA%8C%E8%BF%9B%E5%88%B6"><span class="nav-number">12.7.</span> <span class="nav-text">打印二进制</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C%E7%9A%84%E6%94%B6%E8%8E%B7"><span class="nav-number">13.</span> <span class="nav-text">实验的收获</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E9%81%8D%E5%8E%86%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-number">13.1.</span> <span class="nav-text">循环遍历的方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#jcxz-jmp"><span class="nav-number">13.1.1.</span> <span class="nav-text">jcxz+jmp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#loop%E4%B8%8Ecx"><span class="nav-number">13.1.2.</span> <span class="nav-text">loop与cx</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E8%8E%B7%E5%8F%96string-dup-0"><span class="nav-number">13.2.</span> <span class="nav-text">数据获取string dup (0)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A8%8B%E5%BA%8F%E6%AD%BB%E6%9C%BA%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="nav-number">13.3.</span> <span class="nav-text">程序死机的原因</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#windows%E4%B8%8B-C-x2F-C-%E5%AD%A6%E4%B9%A0-%E8%B0%83%E8%AF%95"><span class="nav-number">14.</span> <span class="nav-text">windows下 C&#x2F;C++学习-调试</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#x86-1"><span class="nav-number">14.1.</span> <span class="nav-text">x86</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#count-3-x3D-x3D-0-%E5%90%90%E4%BA%86"><span class="nav-number">14.1.1.</span> <span class="nav-text">count++ % 3 &#x3D;&#x3D; 0 吐了</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ds-iob-func"><span class="nav-number">14.1.2.</span> <span class="nav-text">ds:__iob_func</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RTC-CheckEsp"><span class="nav-number">14.1.3.</span> <span class="nav-text">RTC_CheckEsp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E%E5%87%BD%E6%95%B0-RTC-CheckEsp"><span class="nav-number">14.1.4.</span> <span class="nav-text">关于函数__RTC_CheckEsp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#security-check-cookie"><span class="nav-number">14.1.5.</span> <span class="nav-text">@__security_check_cookie</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RTC-CheckStackVar"><span class="nav-number">14.1.6.</span> <span class="nav-text">@_RTC_CheckStackVar</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E6%95%B0%E7%BB%84%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E4%BF%AE%E6%94%B9ip"><span class="nav-number">14.1.7.</span> <span class="nav-text">基于数组缓冲区溢出修改ip</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E4%BF%AE%E6%94%B9%E5%85%B6%E5%AE%83%E5%8F%98%E9%87%8F"><span class="nav-number">14.1.8.</span> <span class="nav-text">缓冲区溢出修改其它变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gets%E5%86%85%E5%AD%98%E8%B6%8A%E7%95%8C"><span class="nav-number">14.1.9.</span> <span class="nav-text">gets内存越界</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A1%AE%E5%AE%9A%E5%93%AA%E4%B8%AAcall%E6%98%AF%E4%B8%BB%E8%A6%81%E7%9A%84call"><span class="nav-number">14.1.10.</span> <span class="nav-text">确定哪个call是主要的call</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#x64-2"><span class="nav-number">14.2.</span> <span class="nav-text">x64</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#printf-1"><span class="nav-number">14.2.1.</span> <span class="nav-text">printf</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#switch"><span class="nav-number">15.</span> <span class="nav-text">switch</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%A1%AC%E7%BC%96%E7%A0%81"><span class="nav-number">16.</span> <span class="nav-text">硬编码</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PELAOD"><span class="nav-number">17.</span> <span class="nav-text">PELAOD</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="re4mile(邓渠香)"
      src="https://s1.ax1x.com/2023/01/10/pSefBp6.jpg">
  <p class="site-author-name" itemprop="name">re4mile(邓渠香)</p>
  <div class="site-description" itemprop="description">an ordinary people</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/re4mile.github.io/archives/">
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/re4mile.github.io/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/re4mile.github.io/tags/">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://re4mile.gitee.io/" title="Gitee → https:&#x2F;&#x2F;re4mile.gitee.io" rel="noopener me" target="_blank"><i class="fa fa-subway fa-fw"></i>Gitee</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.cnblogs.com/re4mile/" title="cnblog → https:&#x2F;&#x2F;www.cnblogs.com&#x2F;re4mile&#x2F;" rel="noopener me" target="_blank"><i class="fa fa-space-shuttle fa-fw"></i>cnblog</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/re4mile/re4mile.github.io/2023/01/11/language/Asm/windwos/32/%E5%AE%9E%E8%B7%B5/language/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://s1.ax1x.com/2023/01/10/pSefBp6.jpg">
      <meta itemprop="name" content="re4mile(邓渠香)">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="实践是检验真理的唯一标准">
      <meta itemprop="description" content="an ordinary people">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="x86汇编语言实践部分 | 实践是检验真理的唯一标准">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          x86汇编语言实践部分
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-01-11 22:41:22" itemprop="dateCreated datePublished" datetime="2023-01-11T22:41:22+08:00">2023-01-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-01-09 15:49:25" itemprop="dateModified" datetime="2023-01-09T15:49:25+08:00">2023-01-09</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="代码模板"><a href="#代码模板" class="headerlink" title="代码模板"></a>代码模板</h1><h2 id="8086-exe"><a href="#8086-exe" class="headerlink" title="8086.exe"></a>8086.exe</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><br><span class="line">assume cs:code , ds:data, ss:stack</span><br><span class="line">;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><br><span class="line">;数据源S</span><br><span class="line">        data segment</span><br><span class="line">                        db 128 dup(&#x27;x&#x27;) </span><br><span class="line">        data ends  </span><br><span class="line">;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><br><span class="line">;栈段</span><br><span class="line">        stack segment stack</span><br><span class="line">                        db 128 dup(&#x27;y&#x27;)</span><br><span class="line">        stack ends</span><br><span class="line">;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">;main code  </span><br><span class="line">;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><br><span class="line">;数据源S</span><br><span class="line">						;为数据来源source分配大小</span><br><span class="line">                        mov ax,data</span><br><span class="line">                        mov ds,ax       </span><br><span class="line">;数据地D</span><br><span class="line">						;数据的目的地destation</span><br><span class="line">                        mov ax,7e00h</span><br><span class="line">                        mov es,ax        </span><br><span class="line">;栈</span><br><span class="line">						;申请了一段栈空间</span><br><span class="line">                        mov ax,stack</span><br><span class="line">                        mov ss,ax</span><br><span class="line">                        mov sp,128</span><br><span class="line">               </span><br><span class="line">;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx       </span><br><span class="line">        </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">over:    </span><br><span class="line">                        mov ax,4c00h;初始化内中段的参数</span><br><span class="line">                        int 21h;调用内中段</span><br><span class="line">;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx       </span><br><span class="line">;function</span><br><span class="line"></span><br><span class="line">                        </span><br><span class="line">           </span><br><span class="line">;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><br><span class="line">code ends</span><br><span class="line">end start</span><br><span class="line">;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><br></pre></td></tr></table></figure>

<p>对于上面的数据它是一个顺序结构的存储</p>
<p>也就是你的源代码数据怎么写,那么你的数据就怎么存储,好比你的data写在了code上面,那么的话IDA里面看到的也是</p>
<p>data在code上面</p>
<h2 id="386-exe"><a href="#386-exe" class="headerlink" title="386.exe"></a>386.exe</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; 使用 nmake 或下列命令进行编译和链接:</span><br><span class="line">; ml /c /coff Hello.asm</span><br><span class="line">; Link /subsystem:windows Hello.obj</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.386</span><br><span class="line">		.model flat,stdcall</span><br><span class="line">		option casemap:none</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; Include 文件定义</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">include		windows.inc</span><br><span class="line">include		user32.inc</span><br><span class="line">includelib		user32.lib</span><br><span class="line">include		kernel32.inc</span><br><span class="line">includelib		kernel32.lib</span><br><span class="line">;对于上面的lib,inc还不是很理解</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; 数据段</span><br><span class="line">.data</span><br><span class="line">	A_Title			db	&#x27;My_First_Box !&#x27;,0</span><br><span class="line">	A_Text			db	&#x27;Hello,World !&#x27;,0</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">;栈断分配一些数据</span><br><span class="line">.stack 1024</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; 代码段</span><br><span class="line">.code</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;	</span><br><span class="line">start:</span><br><span class="line">		invoke	MessageBox,	\</span><br><span class="line">		NULL,				\</span><br><span class="line">		offset A_Text,		\</span><br><span class="line">		offset A_Title,		\</span><br><span class="line">		MB_OK</span><br><span class="line">		invoke	ExitProcess,NULL</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		end	start</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">    .386</span><br><span class="line">    .model flat,stdcall</span><br><span class="line">    option casemap:none</span><br><span class="line"></span><br><span class="line">include    windows.inc</span><br><span class="line">include    user32.inc</span><br><span class="line">includelib user32.lib</span><br><span class="line">include    kernel32.inc</span><br><span class="line">includelib kernel32.lib</span><br><span class="line"></span><br><span class="line">    .data</span><br><span class="line">szText		db  &#x27;HelloWorld&#x27;,0</span><br><span class="line">    .code</span><br><span class="line">start:</span><br><span class="line">    invoke	MessageBox,NULL,offset szText,NULL,MB_OK</span><br><span class="line">    invoke	ExitProcess,NULL</span><br><span class="line">    end		start</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后就编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ml -c -coff Helloworld.asm</span><br><span class="line">link -subsystem:windows He1loworld.obj</span><br></pre></td></tr></table></figure>

<p>-c 独立编译,而不进行链接</p>
<p>-coff 生产obj文件</p>
<p>movsx 有符号的复制语句,带一个符号的扩展</p>
<p><img src="https://re4mile.gitee.io/res/photo/language/image-20221211234519517.png"></p>
<p><img src="https://re4mile.gitee.io/res/photo/language/image-20221211235222689.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">.386</span><br><span class="line">.model flat,stdcall</span><br><span class="line">option casemap:none</span><br><span class="line">include msvcrt.inc</span><br><span class="line">includelib msvcrt.lib</span><br><span class="line">include kernel32.inc</span><br><span class="line">includelib kernel32.lib</span><br><span class="line"> </span><br><span class="line">.data</span><br><span class="line">szText1 db &quot;hello world&quot;,0Ah,00h</span><br><span class="line">szPause db &quot;pause&quot;,0Ah</span><br><span class="line">.code</span><br><span class="line"> </span><br><span class="line">testdd:</span><br><span class="line">	push offset szText1</span><br><span class="line">	call crt_printf</span><br><span class="line">	add esp,4</span><br><span class="line">	push offset szPause</span><br><span class="line">	call crt_system</span><br><span class="line">	add esp,4</span><br><span class="line">	ret</span><br><span class="line">end testdd</span><br><span class="line">end</span><br></pre></td></tr></table></figure>



<h2 id="x86-ELF"><a href="#x86-ELF" class="headerlink" title="x86_ELF"></a>x86_ELF</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">section .data		</span><br><span class="line">		A_str 	db	&quot;I am Dqx_Gh0st&quot;,10,0</span><br><span class="line">		format	db	&quot;%s&quot;,0</span><br><span class="line">;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx	</span><br><span class="line">section .bss</span><br><span class="line">;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx	</span><br><span class="line">section .text</span><br><span class="line">	</span><br><span class="line">extern		printf		</span><br><span class="line">;extern		func</span><br><span class="line">					</span><br><span class="line">	global main						</span><br><span class="line">main:</span><br><span class="line">;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx	</span><br><span class="line"></span><br><span class="line">			push	rbp</span><br><span class="line">			mov 	rbp,rsp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			mov		rax, 0	</span><br><span class="line">			mov   	rsi, A_str</span><br><span class="line">			mov		rdi, format	</span><br><span class="line">			call   	printf	         </span><br><span class="line">			       </span><br><span class="line">;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx	</span><br><span class="line">			leave</span><br><span class="line">			ret</span><br><span class="line">;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx	</span><br><span class="line"></span><br><span class="line">;func</span><br><span class="line">;参数</span><br><span class="line">;返回值</span><br><span class="line">;注意事项</span><br><span class="line"></span><br><span class="line">;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx	</span><br></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public _start</span><br><span class="line">_start proc near</span><br><span class="line">; __unwind &#123;</span><br><span class="line">endbr64</span><br><span class="line">xor     ebp, ebp</span><br><span class="line">mov     r9, rdx         ; rtld_fini</span><br><span class="line">pop     rsi             ; argc</span><br><span class="line">mov     rdx, rsp        ; ubp_av</span><br><span class="line">and     rsp, 0FFFFFFFFFFFFFFF0h</span><br><span class="line">push    rax</span><br><span class="line">push    rsp             ; stack_end</span><br><span class="line">mov     r8, offset __libc_csu_fini ; fini</span><br><span class="line">mov     rcx, offset __libc_csu_init ; init</span><br><span class="line">mov     rdi, offset $_53_1_ ; main			//你自己函数入口是一以rdi的形式给了函数cs:__libc_start_main_ptr</span><br><span class="line">call    cs:__libc_start_main_ptr</span><br><span class="line">hlt</span><br><span class="line">; &#125; // starts at 401040</span><br><span class="line">_start endp</span><br></pre></td></tr></table></figure>









<h1 id="寻址方式"><a href="#寻址方式" class="headerlink" title="寻址方式"></a>寻址方式</h1><p>寻址公式一:[立即数]</p>
<p>寻址公式二:[reg] reg代表寄存器可以是8个通用寄存器中的任意一个</p>
<p>寻址公式三:[reg+立即数]</p>
<p>寻址公式四: [reg1+reg2*{1,2,4,8}]</p>
<p>寻址公式五:[reg1+reg2*{1,2,4,8}+立即数]</p>
<h1 id="子函数调用"><a href="#子函数调用" class="headerlink" title="子函数调用"></a>子函数调用</h1><h2 id="栈stack"><a href="#栈stack" class="headerlink" title="栈stack"></a>栈stack</h2><h3 id="栈结构"><a href="#栈结构" class="headerlink" title="栈结构"></a>栈结构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  SS:SP		数据			说明	</span><br><span class="line">0019FF54  12345678  立即数-局部变量</span><br><span class="line">0019FF58  00403000  .data:aSsssssssss-局部变量</span><br><span class="line">0019FF5C  41530000  字符串3-局部变量</span><br><span class="line">0019FF60  41414141  字符串2-局部变量</span><br><span class="line">0019FF64  45414141  字符串1-局部变量</span><br><span class="line">------------------------------------在子函数分配栈空间之前</span><br><span class="line">0019FF68  0019FF84  Stack[00003F3C]:0019FF84	|| EBP</span><br><span class="line">0019FF6C  00401009  start+9||IP</span><br><span class="line">0019FF70  0000000A  参数2-main变量</span><br><span class="line">0019FF74  00000064  参数1-main变量</span><br></pre></td></tr></table></figure>





<p>一个main函数栈的使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">这里就是子函数栈的部分</span><br><span class="line"></span><br><span class="line">[esp+0]</span><br><span class="line"></span><br><span class="line">在这之间的栈是用来传递参数的</span><br><span class="line"></span><br><span class="line">[esp+40]:40个字节的字符串</span><br><span class="line">[esp+80]:float的浮点数</span><br><span class="line">[esp+84]:float计算结果</span><br><span class="line">[esp+88]:计算的的字符串长度</span><br><span class="line">[esp+92]:字符串的大小</span><br><span class="line">然而C语言的函数声明,我还不知道他怎么分配栈空间的</span><br><span class="line">    float weight, volume;</span><br><span class="line">    int   size, letters;</span><br><span class="line">    char  name[40];  </span><br></pre></td></tr></table></figure>





<h3 id="栈数据的获取-不是非要去pop来获取"><a href="#栈数据的获取-不是非要去pop来获取" class="headerlink" title="栈数据的获取(不是非要去pop来获取)"></a>栈数据的获取(不是非要去pop来获取)</h3><p>每次push一下</p>
<p>sp就会向上移动减少</p>
<p>如果你取栈数据</p>
<p>[sp]其实他会向下的方向获取一个type的数据</p>
<p>栈里的数据是取出时从低位到高位拿出</p>
<p>好比</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">push ax</span><br><span class="line">mov  bp,sp</span><br><span class="line">push cx</span><br><span class="line">push dx</span><br><span class="line">mov bx,ss:[bp]</span><br></pre></td></tr></table></figure>

<p>这样的话,你是可以获取数据ax的</p>
<p>这里的bp也给你记录了位置</p>
<p>但是我们通常不会去改变ebp的值</p>
<h3 id="不要随性的push-与-pop"><a href="#不要随性的push-与-pop" class="headerlink" title="不要随性的push 与 pop"></a>不要随性的push 与 pop</h3><p>你一定要记住,不要随性的push</p>
<p>push的东西也是有讲究的</p>
<p>你要用它,你要临时保存它,你才会去push</p>
<p>否者的话,当你要用的时候,pop的东西,又不是你想要的</p>
<h3 id="联合使用push与pop"><a href="#联合使用push与pop" class="headerlink" title="联合使用push与pop"></a>联合使用push与pop</h3><p>数据的传递</p>
<p>通常是</p>
<p>mov ax,ds:[si]</p>
<p>mov es:[di],ax</p>
<p>我们也可以这样</p>
<p>push ax:[si]</p>
<p>pop   es:[di]</p>
<h3 id="栈指令"><a href="#栈指令" class="headerlink" title="栈指令"></a>栈指令</h3><p>16位栈指针sp&#x2F;bp</p>
<p>32位指针esp&#x2F;ebp</p>
<p>64位rsp&#x2F;rbp</p>
<h4 id="push-x2F-pop"><a href="#push-x2F-pop" class="headerlink" title="push&#x2F;pop"></a>push&#x2F;pop</h4><p>esp指向了当前的数据,</p>
<p>如果再push</p>
<p>数据会放在esp的下一个</p>
<p>esp然后-4</p>
<p>不是说x86的sp一定是+或-4</p>
<p>当push 16位数据就sp-2</p>
<p>当push 32位数据就是sp-4</p>
<p>当push 立即数,默认就是sp-4</p>
<p>不能push 8位数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">xor eax,eax                                                                                                                                                                                        </span><br><span class="line">;mov al,10</span><br><span class="line">;push al</span><br><span class="line">mov  ax,10</span><br><span class="line">push ax</span><br><span class="line">mov eax,10</span><br><span class="line">push eax</span><br><span class="line"></span><br><span class="line">pop eax</span><br><span class="line">pop ax</span><br></pre></td></tr></table></figure>







<p>一些异常</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">push eax</span><br><span class="line">pop  ax</span><br></pre></td></tr></table></figure>

<p>push 进一个32位,esp-&#x3D;4</p>
<p>pop  出一个16位,esp+&#x3D;2</p>
<p>这导致堆栈不平衡</p>
<h4 id="pushfd-x2F-popfd"><a href="#pushfd-x2F-popfd" class="headerlink" title="pushfd&#x2F;popfd"></a>pushfd&#x2F;popfd</h4><p>可以对比一下8086的pushf与popf..然后就明白了</p>
<p>它到底push了啥????</p>
<p>EFL有些啥????</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center"></th>
<th align="center"></th>
<th align="center"></th>
<th align="center"></th>
<th align="center">0</th>
<th align="center"></th>
<th align="center">0</th>
<th align="center"></th>
<th align="center">1</th>
<th align="center"></th>
<th align="center"></th>
</tr>
</thead>
<tbody><tr>
<td align="center">高位左边</td>
<td align="center">IF</td>
<td align="center">TF</td>
<td align="center">SF</td>
<td align="center">ZF</td>
<td align="center">0</td>
<td align="center">AF</td>
<td align="center">0</td>
<td align="center">PF</td>
<td align="center">1</td>
<td align="center">CF</td>
<td align="center">低位右边</td>
</tr>
</tbody></table>
<p>如何用专门的变量保存EFL以供使用?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.data</span><br><span class="line">recive dd 0</span><br><span class="line">.code</span><br><span class="line">	pushfd</span><br><span class="line">	pop recive;得是一个32位的接收者</span><br></pre></td></tr></table></figure>





<h4 id="pushad-x2F-popad-x2F-pusha-x2F-popa"><a href="#pushad-x2F-popad-x2F-pusha-x2F-popa" class="headerlink" title="pushad&#x2F;popad&#x2F;pusha&#x2F;popa"></a>pushad&#x2F;popad&#x2F;pusha&#x2F;popa</h4><p>把所有寄存器入栈出栈</p>
<p>对于pusha&#x2F;popa是针对16位数据的寄存器</p>
<p>push什么? AX,CX,DX,BX,.SP,BP,SI,DI</p>
<p>pop就是一个逆序</p>
<p>对于pushad是针对32位数据的寄存器</p>
<p>push&#x2F;pop同理</p>
<p>使用的注意事项,一个函数的返回值用一个寄存器来作为接收者,你用了pushad&#x2F;popad会把返回值给覆盖了,返回无效</p>
<h4 id="leave"><a href="#leave" class="headerlink" title="leave"></a>leave</h4><p>我们之前会有一个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">push ebp</span><br><span class="line">mov ebp,esp</span><br><span class="line">sub esp,20</span><br><span class="line">....</span><br><span class="line">然后leave</span><br></pre></td></tr></table></figure>



<p>首先我们要明确,函数栈的开辟我们不一定会把局部变量给全部使用完..所以esp要回到起点!也就是恢复到进来的时候!</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov esp,ebp</span><br><span class="line">pop ebp</span><br></pre></td></tr></table></figure>



<p>进来push ebp,mov ebp,esp</p>
<p>出去 mov esp,ebp,pop ebp</p>
<p>进来,ebp要发生变化,esp要指向新的栈顶</p>
<p>出去,esp要恢复,ebp要还原</p>
<p>如果在x86的模式下,我们源码用ret</p>
<p>在IDA就会生成leave</p>
<p>如果源码写为</p>
<p>mov esp,epb</p>
<p>pop ebp</p>
<p>retn</p>
<p>就不会出现leave</p>
<h4 id="enter"><a href="#enter" class="headerlink" title="enter"></a>enter</h4><p>与leave相对应</p>
<p>enter出现在子函数的开头部分</p>
<p>enter有2个参数,都是立即数</p>
<p>参数一时开辟的字节数,得是4的倍数,有利于寻址</p>
<p>参数二,就写0,以后遇到再说吧</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">enter 12,0</span><br></pre></td></tr></table></figure>

<p>等价于</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">push ebp</span><br><span class="line">mov esp,ebp</span><br><span class="line">sub ebp,12</span><br></pre></td></tr></table></figure>



<p>关于enter与leave的应用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.386</span><br><span class="line">		.model flat,stdcall</span><br><span class="line">		option casemap:none</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">include		Dqx.inc</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.data			</span><br><span class="line">.data</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.code</span><br><span class="line"></span><br><span class="line">start:</span><br><span class="line">	call	my</span><br><span class="line">	invoke	ExitProcess,NULL</span><br><span class="line">	my	proc</span><br><span class="line">		enter	12,0</span><br><span class="line"></span><br><span class="line">		mov	dword ptr [ebp-4],10</span><br><span class="line">		mov	dword ptr [ebp-8],20</span><br><span class="line">		mov	esp,ebp</span><br><span class="line"></span><br><span class="line">		leave</span><br><span class="line">		ret</span><br><span class="line">	my	endp</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">	end	start</span><br></pre></td></tr></table></figure>

<p>IDA</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">fun proc near</span><br><span class="line"></span><br><span class="line">var_8= dword ptr -8</span><br><span class="line">var_4= dword ptr -4</span><br><span class="line"></span><br><span class="line">enter   0Ch, 0</span><br><span class="line">mov     [ebp+var_4], 0Ah</span><br><span class="line">mov     [ebp+var_8], 14h</span><br><span class="line">mov     esp, ebp</span><br><span class="line">leave</span><br><span class="line">retn</span><br><span class="line">fun endp</span><br></pre></td></tr></table></figure>





<h4 id="8086栈指令"><a href="#8086栈指令" class="headerlink" title="8086栈指令"></a>8086栈指令</h4><h5 id="pushf-x2F-popf"><a href="#pushf-x2F-popf" class="headerlink" title="pushf&#x2F;popf"></a>pushf&#x2F;popf</h5><p>就是对所有的flag寄存器给push一下或者pop一下</p>
<p>它会把8位的二进制寄存器合成2位的16进制然后出入栈</p>
<h5 id="pusha-x2F-popa"><a href="#pusha-x2F-popa" class="headerlink" title="pusha&#x2F;popa"></a>pusha&#x2F;popa</h5><p>x86说16位可以pusha&#x2F;popa,但是我试了一下,好像不可以</p>
<h3 id="栈维护"><a href="#栈维护" class="headerlink" title="栈维护"></a>栈维护</h3><h4 id="用uses临时创建变量"><a href="#用uses临时创建变量" class="headerlink" title="用uses临时创建变量"></a>用uses临时创建变量</h4><p>关于uses和[ebp+8]</p>
<p>uses指令的顺序先于push ebp,mov ebp,esp</p>
<p>所以的话,</p>
<p>你的[ebp+8]就不再是传入的第一个参数</p>
<p>[ebp+8+N],N是你是你传入的那些参数,具体遇到再说</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.386</span><br><span class="line">		.model flat,stdcall</span><br><span class="line">		option casemap:none</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">include		Dqx.inc</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.data			</span><br><span class="line">.data</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">;func proto	:byte,:byte</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.code</span><br><span class="line">start:</span><br><span class="line">	call	func</span><br><span class="line">	invoke	ExitProcess,NULL</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">func PROC	uses	eax ebx</span><br><span class="line">		mov	eax,1</span><br><span class="line">		mov	ebx,2</span><br><span class="line">		ret</span><br><span class="line">func ENDP</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">	end	start</span><br></pre></td></tr></table></figure>



<p>关于uses的变量内部入栈,他在内部平衡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">func proc near</span><br><span class="line">push    eax</span><br><span class="line">push    ebx</span><br><span class="line">mov     eax, 1</span><br><span class="line">mov     ebx, 2</span><br><span class="line">pop     ebx</span><br><span class="line">pop     eax</span><br><span class="line">retn</span><br><span class="line">func endp</span><br></pre></td></tr></table></figure>



<h4 id="用local创建变量"><a href="#用local创建变量" class="headerlink" title="用local创建变量"></a>用local创建变量</h4><p>它的特点就是</p>
<p>栈空间的申请是内部<code>add esp,负数</code></p>
<p>然后栈的平衡内部是mov esp,ebp,pop ebp</p>
<p>也就是一个leave就解决</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.386</span><br><span class="line">		.model flat,stdcall</span><br><span class="line">		option casemap:none</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">include		Dqx.inc</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.data			</span><br><span class="line">.data</span><br><span class="line">arr1	db	16 dup(&#x27;s&#x27;)</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.code</span><br><span class="line">start:	</span><br><span class="line">	call	func</span><br><span class="line">	invoke	ExitProcess,NULL</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">func	proc</span><br><span class="line">	local	x[10]:byte</span><br><span class="line">	local	y:ptr byte</span><br><span class="line">	mov	byte ptr x[9],6</span><br><span class="line">	mov	byte ptr x[0],3</span><br><span class="line">	mov	y,offset arr1</span><br><span class="line">	ret</span><br><span class="line">func	endp</span><br><span class="line"></span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">	end	start</span><br></pre></td></tr></table></figure>



<p>IDA</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame</span><br><span class="line"></span><br><span class="line">fun proc near</span><br><span class="line"></span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line">add     esp, 0FFFFFFF0h</span><br><span class="line">mov     byte ptr [ebp-1], 6</span><br><span class="line">mov     byte ptr [ebp-10], 3</span><br><span class="line">mov     dword ptr [ebp-16], offset aSsssssssssssss ; &quot;ssssssssssssssss&quot;</span><br><span class="line">leave</span><br><span class="line">retn</span><br><span class="line">fun endp</span><br></pre></td></tr></table></figure>

<p>可以看到,我创建了14字节</p>
<p>它给我分配了16字节</p>
<p>关于local建立的变量,他的本质是一个push,先push谁,取决于你先写谁</p>
<h4 id="invoke-和调用约定"><a href="#invoke-和调用约定" class="headerlink" title="invoke 和调用约定"></a>invoke 和调用约定</h4><p>都是实现push,然后call</p>
<p>参数的传递在子函数栈空间的下方</p>
<p>内部平衡就<code>retn xx</code></p>
<p>外部平衡就<code>add esp,xx</code></p>
<table>
<thead>
<tr>
<th>调用约定</th>
<th>参数压栈顺序</th>
<th>平衡堆栈</th>
</tr>
</thead>
<tbody><tr>
<td>__cdecl</td>
<td>从右至左入栈</td>
<td>调用者清理栈</td>
</tr>
<tr>
<td>__stdcall</td>
<td>从右至左入栈</td>
<td>自身清理堆栈</td>
</tr>
<tr>
<td>__fastcall</td>
<td>ECX&#x2F;EDX传送前两个剩下:从右至左入栈</td>
<td>自身清理堆栈</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl Plus(int a, int b)				</span><br><span class="line">&#123;				</span><br><span class="line">	return a+b;			</span><br><span class="line">&#125;				</span><br><span class="line">				</span><br><span class="line">push        2				</span><br><span class="line">push        1				</span><br><span class="line">call        @ILT+15(Plus) (00401014)				</span><br><span class="line">add         esp,8				</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">2、int __stdcall Plus(int a, int b)				</span><br><span class="line">&#123;				</span><br><span class="line">	return a+b;			</span><br><span class="line">&#125;				</span><br><span class="line">				</span><br><span class="line">push        2				</span><br><span class="line">push        1				</span><br><span class="line">call        @ILT+10(Plus) (0040100f)				</span><br><span class="line">				</span><br><span class="line">函数内部：				</span><br><span class="line">				</span><br><span class="line">ret         8				</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">					</span><br><span class="line">3、int __fastcall Plus(int a, int b)					</span><br><span class="line">&#123;					</span><br><span class="line">	return a+b;				</span><br><span class="line">&#125;					</span><br><span class="line">					</span><br><span class="line">mov         edx,2					</span><br><span class="line">mov         ecx,1					</span><br><span class="line">call        @ILT+0(Plus) (00401005)					</span><br><span class="line">					</span><br><span class="line">函数内部：					</span><br><span class="line">					</span><br><span class="line">ret </span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">   4、int __fastcall Plus4(int a, int b,int c,int d)					</span><br><span class="line">&#123;					</span><br><span class="line">	return a+b+c+d;				</span><br><span class="line">&#125;					</span><br><span class="line">					</span><br><span class="line">push        4					</span><br><span class="line">push        3					</span><br><span class="line">mov         edx,2					</span><br><span class="line">mov         ecx,1					</span><br><span class="line">call        @ILT+5(Plus) (0040100a)					</span><br><span class="line">					</span><br><span class="line">函数内部：					</span><br><span class="line">					</span><br><span class="line">ret         8					</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>所以,如果根据<code>ret 8</code>是无法直接判断有几个参数</p>
<p>因为可能是fastcall</p>
<p>如果你直接看出了一个函数有几个参数,</p>
<p>那些参数也有可能不是当前call</p>
<p>也可能是内嵌call的</p>
<p>所以如何看一个函数用了多少个参数?</p>
<p>(0).不用管是什么调用约定</p>
<p>(1). 看函数内部用了哪些对应的内存和寄存器</p>
<p>(2). 结合最后ret n的n</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; 使用 nmake 或下列命令进行编译和链接:</span><br><span class="line">; ml /c /coff Hello.asm</span><br><span class="line">; Link /subsystem:windows Hello.obj</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.386</span><br><span class="line">		.model flat,stdcall</span><br><span class="line">		option casemap:none</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; Include 文件定义</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">include		windows.inc</span><br><span class="line">include		kernel32.inc</span><br><span class="line">includelib	kernel32.lib</span><br><span class="line">;对于上面的lib,inc还不是很理解</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; 数据段</span><br><span class="line">.data</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">;c_var1		dd	10</span><br><span class="line">;c_var2		dd	20</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; 代码段</span><br><span class="line">.code</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;	</span><br><span class="line"></span><br><span class="line">		sub1	proto	C,:DWORD,:DWORD</span><br><span class="line">		sub2	proto	StdCall,:DWORD,:DWORD</span><br><span class="line">		sub3	proto	sysCall,:DWORD,:DWORD</span><br><span class="line">		sub4	proto	PASCAl,:DWORD,:DWORD</span><br><span class="line">		sub5	proto	BASIC,:DWORD,:DWORD</span><br><span class="line">		sub6	proto	fortran,:DWORD,:DWORD</span><br><span class="line">	</span><br><span class="line">		</span><br><span class="line">start:</span><br><span class="line">		</span><br><span class="line">		xor eax,eax</span><br><span class="line"></span><br><span class="line">		invoke  sub1,1,2</span><br><span class="line">		invoke  sub2,1,2</span><br><span class="line">		invoke  sub3,1,2</span><br><span class="line">		invoke  sub4,1,2</span><br><span class="line">		invoke  sub5,1,2</span><br><span class="line">		invoke  sub6,1,2</span><br><span class="line"></span><br><span class="line">		push 0</span><br><span class="line">		call ExitProcess</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		sub1	proc	C,c_var1,c_var2</span><br><span class="line">				mov	eax,c_var1</span><br><span class="line">				mov	ebx,c_var2</span><br><span class="line">				ret</span><br><span class="line">		sub1	endp</span><br><span class="line">		</span><br><span class="line">		sub2	proc	StdCall,c_var1,c_var2</span><br><span class="line">				mov	eax,c_var1</span><br><span class="line">				mov	ebx,c_var2</span><br><span class="line">				ret</span><br><span class="line">		sub2	endp;在内部 retn 8,他们是在外部add esp,8</span><br><span class="line">		</span><br><span class="line">		sub3	proc	sysCall,c_var1,c_var2</span><br><span class="line">				mov	eax,c_var1</span><br><span class="line">				mov	ebx,c_var2</span><br><span class="line">				ret</span><br><span class="line">		sub3	endp</span><br><span class="line"></span><br><span class="line">		sub4	proc	PASCAl,c_var1,c_var2</span><br><span class="line">				mov	eax,c_var1</span><br><span class="line">				mov	ebx,c_var2</span><br><span class="line">				ret</span><br><span class="line">		sub4	endp</span><br><span class="line"></span><br><span class="line">		sub5	proc	BASIC,c_var1,c_var2</span><br><span class="line">				mov	eax,c_var1</span><br><span class="line">				mov	ebx,c_var2</span><br><span class="line">				ret</span><br><span class="line">		sub5	endp</span><br><span class="line"></span><br><span class="line">		sub6	proc	fortran,c_var1,c_var2</span><br><span class="line">				mov	eax,c_var1</span><br><span class="line">				mov	ebx,c_var2</span><br><span class="line">				ret</span><br><span class="line">		sub6	endp</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		end	start</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>







<h4 id="x64栈对齐"><a href="#x64栈对齐" class="headerlink" title="x64栈对齐"></a>x64栈对齐</h4><p>栈帧是一个过程</p>
<p>好比</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">push pbp</span><br><span class="line">mov  rbp,rsp</span><br><span class="line"></span><br><span class="line">mov rsp,rbp</span><br><span class="line">pop rbp</span><br></pre></td></tr></table></figure>

<p>为什么需要这2个东西</p>
<p>我们得知道一个函数栈的建立是不会触及栈底rbp的修改的,那为什么还要push rbp呢????</p>
<p>这就是一个16字节的栈对齐了</p>
<p>一些函数的约定或者是个啥要求栈的地址必须是16的倍数</p>
<p>对于x64而言,push一下就是8字节</p>
<p>对于一个函数的调用</p>
<p>call一下8字节</p>
<p>push rbp 8字节</p>
<p>这几构成了16字节,达到了16字节对齐</p>
<p>还有一种栈对齐的方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">and rsp , 0xfffffffffffffff0 ; 16 byte align the stack</span><br></pre></td></tr></table></figure>





<h2 id="堆栈图"><a href="#堆栈图" class="headerlink" title="堆栈图"></a>堆栈图</h2><p><img src="F:\5008\GItee\res\photo\language\image-20230109154923684.png" alt="image-20230109154923684"></p>
<p>就代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PUSH EBP</span><br><span class="line">MOV EBP ,ESP</span><br><span class="line">SUB ESP,4B</span><br><span class="line">------这3个push是保护现场的</span><br><span class="line">PUSH EBX</span><br><span class="line">PUSH ESI</span><br><span class="line">PUSH EDI </span><br><span class="line">LEA EDI,DwoRD PTR SS: [EBP一40]</span><br><span class="line">mov Ecx,10</span><br><span class="line">mov EAx,ccccccCc ;之所以写0xCC,是为了防止缓冲区溢出,跑去0xcc那里执行</span><br><span class="line">REP Stos DwORD PTR ES:[EDI]</span><br><span class="line"></span><br><span class="line">----------------------------------------------上面的操作好比以炒菜前的准备</span><br><span class="line"></span><br><span class="line">MOV EAx,DwORD PTR SS: [ EBp+8 ]</span><br><span class="line">ADD EAx, DwoRD PTR SS:[EBP+C]</span><br><span class="line"></span><br><span class="line">----------------------------------------------下面的操作就像是炒菜后的刷锅</span><br><span class="line">PoP EDI</span><br><span class="line">POP ESI</span><br><span class="line">POP EBx</span><br><span class="line">MOV ESP,EBP</span><br><span class="line">POP EBP</span><br><span class="line">retn</span><br></pre></td></tr></table></figure>



<p>所以你把char给传递进去,其实是被扩展</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func(char x,char y)</span><br></pre></td></tr></table></figure>

<p>所以传递1&#x2F;2个字节的参数都会被转化为4字节</p>
<p>为什么要扩展?因为效率的原因</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">char i 他会分配4个字节给i</span><br><span class="line">char o[2] 他会分配4个字节</span><br><span class="line">char p[7] 他会分配8个字节</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="常用指令"><a href="#常用指令" class="headerlink" title="常用指令"></a>常用指令</h2><h3 id="invoke"><a href="#invoke" class="headerlink" title="invoke"></a>invoke</h3><p>它只是属于masm32的伪指令,不具有移植性</p>
<p>用法</p>
<p>invoke 函数名 参数1 参数2 参数3</p>
<p>&#x2F;&#x2F;参数的个数由函数确定</p>
<p>例如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invoke	MessageBox, NULL, offset A_Text, offset A_Title, MB_OK</span><br></pre></td></tr></table></figure>

<p>假设是stdcall的调用方式</p>
<p>你在invoke写的正序</p>
<p>入栈的时候是逆序</p>
<p>invoke 不能用addr,只能offset,为什么????</p>
<p>注意事项</p>
<p>如果你的参数是小于32位的寄存器eax&#x2F;edx,最后invoke会有一个扩展到32位,使得数据的丢失</p>
<p>如果数据重要,你就把他保存一下</p>
<p>还有一个东西巨坑,我们之前说过,我们不能push一个8位的数据,所以你不能传入一个字节的东西,除非强制类型转化</p>
<p>于是invoke是不能带有8位的参数的,否则就无法识别</p>
<h3 id="addr"><a href="#addr" class="headerlink" title="addr"></a>addr</h3><p>取地址的操作</p>
<p>对于全局变量</p>
<p>addr会转化为offset</p>
<p>对于局部变量</p>
<p>addr会转化为lea指令</p>
<p>addr怎么用,我好不懂</p>
<p>见&lt;&lt;琢石成器&gt;&gt;.Page76</p>
<p>addr&#x3D;&#x3D;只能和invoke&#x3D;&#x3D;一起用</p>
<p>addr的参数只能是常熟,不能是变量?????</p>
<h3 id="proc-x2F-endp-函数声明"><a href="#proc-x2F-endp-函数声明" class="headerlink" title="proc &#x2F;endp 函数声明"></a>proc &#x2F;endp 函数声明</h3><p>在8086里面,我们定义一个函数直接是标号就🆗</p>
<p>在x86下,我们是定义一个函数的是定义一个过程,称之为函数的声明</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">函数的名字 	 proc [ 距离] [ 调用方式 ] [可视区域] [uses 寄存器列表] [参数名称:参数类型,参数名称:参数类型] [vararg]</span><br><span class="line">		 	local 局部变量</span><br></pre></td></tr></table></figure>

<p>请写明参数的类型,否则将无法识别,或者偷鸡摸狗耍小聪明</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">main proc</span><br><span class="line">				call func1</span><br><span class="line">                push    0       </span><br><span class="line">                call    j_ExitProcess</span><br><span class="line">main endp</span><br><span class="line"></span><br><span class="line">fucn1 proc</span><br><span class="line">				ret</span><br><span class="line">func1 endp</span><br></pre></td></tr></table></figure>









<h3 id="proto-函数声明"><a href="#proto-函数声明" class="headerlink" title="proto 函数声明"></a>proto 函数声明</h3><p>类比C语言,它是一个函数的声明</p>
<p>用法 ,参考proc</p>
<p>好比</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MessageBox Proto :dword, :dword,:dword,:dword,</span><br></pre></td></tr></table></figure>

<p>通常这样写是的等价的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MessageBox Proto hwnd:dword, text:dword,title:dword,Type:dword,</span><br></pre></td></tr></table></figure>



<p>使用例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sub2	proto	StdCall,:DWORD,:DWORD</span><br><span class="line">invoke  sub2,1,2</span><br><span class="line">sub2	proc	StdCall,c_var1:DWORD,c_var2:DWORD</span><br><span class="line">mov	eax,c_var1</span><br><span class="line">mov	ebx,c_var2</span><br><span class="line">ret</span><br><span class="line">sub2	endp;在内部 retn 8,他们是在外部add esp,8</span><br></pre></td></tr></table></figure>



<p>作用1:外部声明</p>
<p>作用2:检查参数列表,proc与proto是否一致</p>
<h3 id="extern-函数声明"><a href="#extern-函数声明" class="headerlink" title="extern 函数声明"></a>extern 函数声明</h3><p>怎么用,遇到再说</p>
<h3 id="inlcudelib-导入库"><a href="#inlcudelib-导入库" class="headerlink" title="inlcudelib 导入库"></a>inlcudelib 导入库</h3><p>8086的汇编,在调用中断时,我们只需要int一个编号就可以寻址</p>
<p>可能是因为中断不多,,,,</p>
<p>在win32-API中,类似的int很多,,,,我在这里称之为dll文件…根据不同的函数实现要求..我们的obj要选取不同的dll文件</p>
<p>此时就需要include来调用dll</p>
<h3 id="uses-伪指令-一个入栈的操作"><a href="#uses-伪指令-一个入栈的操作" class="headerlink" title="uses 伪指令,一个入栈的操作"></a>uses 伪指令,一个入栈的操作</h3><p>uses连接的东西是没有逗号的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">func_sum PROC		uses ecx  esi</span><br><span class="line"></span><br><span class="line">					xor eax,eax</span><br><span class="line">	sum_loop:</span><br><span class="line">					add al,[esi]</span><br><span class="line">					add esi,type arr1</span><br><span class="line">					loop sum_loop</span><br><span class="line">					ret</span><br><span class="line">func_sum ENDP</span><br></pre></td></tr></table></figure>

<p>在IDA里面就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">start_0 proc near</span><br><span class="line">xor     eax, eax</span><br><span class="line">mov     ecx, 10</span><br><span class="line">mov     esi, offset unk_384000</span><br><span class="line">call    sub_382051</span><br><span class="line">mov     byte_38400A, al</span><br><span class="line">push    0               ; uExitCode</span><br><span class="line">call    j_ExitProcess</span><br><span class="line">start_0 endp</span><br></pre></td></tr></table></figure>





<p>你可以把这个C代码翻译为汇编看看</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> str[<span class="number">10</span>]=<span class="string">&quot;Dqx+Gh0st&quot;</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">func</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> x2=<span class="number">4</span>,y2=<span class="number">5</span>,z2=<span class="number">6</span>;</span><br><span class="line">    <span class="type">char</span> temp[<span class="number">10</span>]=<span class="string">&quot;Dqx&quot;</span>;</span><br><span class="line">	<span class="built_in">puts</span>(str); </span><br><span class="line"> 	func(<span class="number">100</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">func</span><span class="params">(<span class="type">int</span> w)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> x3=<span class="number">1</span>,y3=<span class="number">2</span>,z3=<span class="number">3</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d %d %d&quot;</span>,x3,y3,z3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>IDA</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public _main</span><br><span class="line">_main proc near</span><br><span class="line"></span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line">and     esp, 0FFFFFFF0h</span><br><span class="line">sub     esp, 30h</span><br><span class="line">call    ___main</span><br><span class="line">mov     dword ptr [esp+44], 4</span><br><span class="line">mov     dword ptr [esp+40], 5</span><br><span class="line">mov     dword ptr [esp+36], 6</span><br><span class="line">//上面分别是你在main函数定义的变量</span><br><span class="line">mov     dword ptr [esp+26], 787144h</span><br><span class="line">//这是你在main函数定义的字符串,你的字符串是10个字节,前3个字节被初始化了,也就是787144h</span><br><span class="line">//它用4字节的dword装下了你的3字节字符串</span><br><span class="line">//剩下了6字节,用了dword与word来初始化为0</span><br><span class="line">mov     dword ptr [esp+30], 0</span><br><span class="line">mov     word ptr [esp+34], 0</span><br><span class="line">mov     dword ptr [esp], offset _str ; &quot;Dqx+Gh0st&quot;</span><br><span class="line">//对于全局变量他用offset取地址</span><br><span class="line">//mov     dword ptr [esp], offset _str ; &quot;Dqx+Gh0st&quot;==push dword ptr [esp]</span><br><span class="line">call    _puts</span><br><span class="line">mov     dword ptr [esp], 64h ; &#x27;d&#x27; ; w</span><br><span class="line">/方式对[esp]操作的都==push xxxx</span><br><span class="line">call    _func</span><br><span class="line">mov     eax, 0</span><br><span class="line">leave</span><br><span class="line">retn</span><br><span class="line">_main endp</span><br></pre></td></tr></table></figure>

<p>进入子函数,前面已经传入参数了,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public _func</span><br><span class="line">_func proc near</span><br><span class="line"></span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line">sub     esp, 28h</span><br><span class="line">mov     dword ptr [ebp-12], 1</span><br><span class="line">mov     dword ptr [ebp-16], 2</span><br><span class="line">mov     eax, [ebp+8]</span><br><span class="line">mov     [esp+12], eax</span><br><span class="line">mov     eax, [ebp-16]</span><br><span class="line">mov     [esp+8], eax</span><br><span class="line">mov     eax, [ebp-12]</span><br><span class="line">mov     [esp+4], eax</span><br><span class="line">mov     dword ptr [esp], offset Format ; &quot;%d %d %d&quot;</span><br><span class="line">call    _printf</span><br><span class="line">leave</span><br><span class="line">retn</span><br><span class="line">_func endp</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//下级函数栈</span><br><span class="line">//EBP</span><br><span class="line">//IP</span><br><span class="line">//------------上级函数栈</span><br><span class="line">//参数1</span><br><span class="line">//参数2</span><br></pre></td></tr></table></figure>

<p>所以的话,传入的参数都是通过ebp+8开始,是第一个参数</p>
<h3 id="local-定义局部变量"><a href="#local-定义局部变量" class="headerlink" title="local 定义局部变量"></a>local 定义局部变量</h3><p>local创建的变量是不可传递的参数,只能在函数内部使用</p>
<p>另外局部变量不能和形式参数同名</p>
<p>local定义的类型在函数声明proc后,在程序执行CS:IP之前</p>
<p>local在win32模式下,默认数据的长度是32位的dd,如果主观的定义一个32位的的数据长度,我们是不需要指出数据长度的</p>
<p>local不支持和dup指令一起使用…</p>
<p>local变量肯定不是在data区,它是在栈区</p>
<p>相比于proc的函数参数列表声明,它可以在invoke的时候传入参数的</p>
<p>现在有个问题,如果invoke只是一个call与push,那么我们是可以通过local来接受传递过来的参数的</p>
<p>也就是好比这个意思</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">func</span><span class="params">(<span class="type">int</span> x)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> y=x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>于是局部变量y就接受了传递过来的参数</p>
<p>local 是enter与leave的高级版</p>
<p>用local会自动在最后使用leave指令,就不用你去手动的释放,最后再ret</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">func proc</span><br><span class="line">	local arr[16]:byte</span><br><span class="line">	local Num</span><br><span class="line">	;local unk:WNDCLASS</span><br><span class="line">	xor eax,eax</span><br><span class="line">	....</span><br></pre></td></tr></table></figure>



<p>然后利用local变量得到的数据不适用于一些指令</p>
<p>对于上面的代码在IDA的显示是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line">add     esp, 0FFFFFFECh</span><br><span class="line">mov     eax, [ebp+var_14]</span><br></pre></td></tr></table></figure>

<p>0FFFFFFECh的绝对值是20,也就是16+4的长度</p>
<p>其实我们用<code>sub esp,20</code>会更加的形象</p>
<p>注意不可对局部变量取地址,我也不知道为什么</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">func proc</span><br><span class="line"></span><br><span class="line">	local arr[16]:byte</span><br><span class="line">	local Num	</span><br><span class="line">	;mov	esi,offset arr</span><br><span class="line">	;mov	esi,lea arr</span><br><span class="line">	;mov	esi,arr</span><br><span class="line">	mov eax,Num</span><br></pre></td></tr></table></figure>



<p>上面被注释的指令都是不合法的!!!!!!!!!</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.386</span><br><span class="line">		.model flat,stdcall</span><br><span class="line">		option casemap:none</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">include		Dqx.inc</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.data			</span><br><span class="line">.data</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.code</span><br><span class="line"></span><br><span class="line">start:</span><br><span class="line">	call	my</span><br><span class="line">	invoke	ExitProcess,NULL</span><br><span class="line">	my	proc</span><br><span class="line">		local	arr[10]:word</span><br><span class="line">		ret</span><br><span class="line">	my	endp</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">	end	start</span><br></pre></td></tr></table></figure>

<p>在IDA里面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame</span><br><span class="line"></span><br><span class="line">fun proc near</span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line">add     esp, 0FFFFFFECh</span><br><span class="line">leave</span><br><span class="line">retn</span><br><span class="line">fun endp</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="lahf-x2F-sahf"><a href="#lahf-x2F-sahf" class="headerlink" title="lahf&#x2F;sahf"></a>lahf&#x2F;sahf</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lahf 把寄存器的低8位给了ah</span><br><span class="line">sahf 把ah给了寄存器的低8位</span><br></pre></td></tr></table></figure>



<h2 id="变量声明与初始化-x2F-存储位置"><a href="#变量声明与初始化-x2F-存储位置" class="headerlink" title="变量声明与初始化&#x2F;存储位置"></a>变量声明与初始化&#x2F;存储位置</h2><h3 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h3><p>全局变量在data区</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.data:00403004                 public _str</span><br><span class="line">.data:00403004 ; char str[]</span><br><span class="line">.data:00403004 _str            db &#x27;Dqx+Gh0st&#x27;,0        ; DATA XREF: _main+26↑o</span><br><span class="line">.data:0040300E                 align 10h			</span><br><span class="line">.data:00403010                 public __charmax</span><br><span class="line">.data:00403010 ; int _charmax</span><br><span class="line">.data:00403010 __charmax       dd 255</span><br></pre></td></tr></table></figure>

<p>可以看到.数据在data区域</p>
<p>我定义的数组长度是10,然后它<code> align 10h</code>进行了10字节对齐</p>
<p>main函数定义的变量只能在main区域使用,也叫局部变量</p>
<p>在函数外定义的变量才叫全局变量,不知道说对了没有</p>
<p>全局变量的调用,一是去data区取地址,用esp把地址放在栈区</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov     dword ptr [esp], offset _str ; &quot;Dqx+Gh0st&quot;</span><br></pre></td></tr></table></figure>

<h3 id="main变量"><a href="#main变量" class="headerlink" title="main变量"></a>main变量</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> x=<span class="number">4</span>,y=<span class="number">5</span>,z=<span class="number">6</span>;</span><br><span class="line">    <span class="type">char</span> temp[<span class="number">15</span>]=<span class="string">&quot;Dqx-20019&quot;</span>;</span><br><span class="line">    <span class="built_in">printf</span>(temp);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>32位</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//int的初始化</span><br><span class="line">mov     dword ptr [esp+44], 4</span><br><span class="line">mov     dword ptr [esp+40], 5</span><br><span class="line">mov     dword ptr [esp+36], 6</span><br><span class="line">//字符串初始化</span><br><span class="line">mov     dword ptr [esp+21], 2D787144h</span><br><span class="line">mov     dword ptr [esp+25], 31303032h</span><br><span class="line">mov     dword ptr [esp+29], 39h ; &#x27;9&#x27;</span><br><span class="line">mov     word ptr [esp+33], 0</span><br><span class="line">mov     byte ptr [esp+35], 0</span><br><span class="line">//可以看到数据放在了.text区域</span><br><span class="line">//然后放在了esp高栈位</span><br></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lea     eax, [esp+21]</span><br><span class="line">mov     [esp], eax      ; Format</span><br><span class="line">call    _printf</span><br><span class="line">//数据的使用就放在了低栈位</span><br></pre></td></tr></table></figure>

<p>64位</p>
<h3 id="局部变量"><a href="#局部变量" class="headerlink" title="局部变量"></a>局部变量</h3><p>[ebp-n]的为局部变量</p>
<h3 id="x64的局部变量声明"><a href="#x64的局部变量声明" class="headerlink" title="x64的局部变量声明"></a>x64的局部变量声明</h3><p>好比这样一个子函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">circle:</span><br><span class="line"></span><br><span class="line">	section .data</span><br><span class="line">		.fmt_area	db	&quot;The area is %f&quot;,10,0</span><br><span class="line">		.fmt_circum	db	&quot;The circumference is %f&quot;,10,0</span><br><span class="line">		</span><br><span class="line">	section .text</span><br><span class="line">	</span><br><span class="line">	push rbp</span><br><span class="line">	mov rbp, rsp	</span><br><span class="line">	</span><br><span class="line">		call area	</span><br><span class="line">		mov	rdi,.fmt_area</span><br><span class="line">		mov	rax,1			; area in xmm0</span><br><span class="line">		call printf</span><br><span class="line">		call circum</span><br><span class="line">		mov	rdi,.fmt_circum</span><br><span class="line">		mov	rax,1			; circumference in xmm0</span><br><span class="line">		call printf</span><br><span class="line">		</span><br><span class="line">	leave</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>

<p>局部变量的名字带有一个点<code>.</code></p>
<p>在section .data声明</p>
<p>然后不要忘记section .text写代码</p>
<h2 id="子函数的使用"><a href="#子函数的使用" class="headerlink" title="子函数的使用"></a>子函数的使用</h2><h3 id="为什么有子函数这个东西"><a href="#为什么有子函数这个东西" class="headerlink" title="为什么有子函数这个东西"></a>为什么有子函数这个东西</h3><p>使用子程序</p>
<p>为什么使用子程序?就好比为什么使用函数一样?</p>
<p>当一个过程..</p>
<p>①,比较繁琐</p>
<p>②.需要移植到很多处地方重复使用</p>
<p>那么我们就把它封装为一个函数</p>
<p>一个简单的函数栈建立</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.386</span><br><span class="line">		.model flat,stdcall</span><br><span class="line">		option casemap:none</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">include		windows.inc</span><br><span class="line">include		kernel32.inc</span><br><span class="line">includelib	kernel32.lib</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.data			</span><br><span class="line">.data</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.code</span><br><span class="line"></span><br><span class="line">start:</span><br><span class="line">	call	my</span><br><span class="line">	invoke	ExitProcess,NULL</span><br><span class="line">	my	proc</span><br><span class="line">		push	ebp</span><br><span class="line">		mov	ebp,esp</span><br><span class="line">		sub	esp,8</span><br><span class="line">		mov	dword ptr [ebp-4],10</span><br><span class="line">		mov	dword ptr [ebp-8],20</span><br><span class="line">		mov	esp,ebp</span><br><span class="line">		;add	esp,8</span><br><span class="line">		;add 和这里的 mov 的效果是一样的</span><br><span class="line">		pop	ebp</span><br><span class="line">		ret</span><br><span class="line">	my	endp</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">	end	start</span><br></pre></td></tr></table></figure>



<p>写汇编的时候,局部变量使用符号…</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">x	equ	dword ptr [ebp-4]</span><br><span class="line">y	equ	dword ptr [ebp-8]</span><br><span class="line"></span><br><span class="line">	my	proc</span><br><span class="line">		push	ebp</span><br><span class="line">		mov		ebp,esp</span><br><span class="line">		sub		esp,8</span><br><span class="line">		mov		x,10</span><br><span class="line">		mov		y,20</span><br><span class="line">		mov		esp,ebp</span><br><span class="line">		pop		ebp</span><br><span class="line">		ret</span><br><span class="line">	my	endp</span><br></pre></td></tr></table></figure>



<p>有些离谱的传入参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov     dword ptr [esp+4], 3</span><br><span class="line">mov     dword ptr [esp], 2</span><br><span class="line">call    func</span><br></pre></td></tr></table></figure>

<p>其实上面2菊花等价于</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">push 3</span><br><span class="line">push 2</span><br></pre></td></tr></table></figure>

<p>push 3可以让dword ptr [esp+4]&#x3D;3</p>
<p>push 2可以让dword ptr [esp+0],&#x3D;2</p>
<h3 id="为什么会有ebp的寻址"><a href="#为什么会有ebp的寻址" class="headerlink" title="为什么会有ebp的寻址"></a>为什么会有ebp的寻址</h3><p>ebp获取的数据都是传入的参数,而参数的使用需要转移到esp中</p>
<p>我还不知道为什么要这么复杂</p>
<p>调用子函数前我们push 了2次,push 2,push 3</p>
<table>
<thead>
<tr>
<th>假设函数开辟了3*4字节.push ebp,mov ebp,esp,sub esp,12</th>
<th align="center"></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>esp+0&#x2F;&#x2F;<code>sub esp,12</code></td>
<td align="center"></td>
<td></td>
</tr>
<tr>
<td>esp+4</td>
<td align="center"></td>
<td></td>
</tr>
<tr>
<td>esp+8</td>
<td align="center"></td>
<td></td>
</tr>
<tr>
<td>ebp&#x2F;<code>/push ebp</code></td>
<td align="center">A old ebp</td>
<td></td>
</tr>
<tr>
<td>Next IP&#x2F;&#x2F;<code>cal func</code></td>
<td align="center">0xbalablalbla</td>
<td></td>
</tr>
<tr>
<td>A old esp+4&#x2F;&#x2F;<code>push3</code></td>
<td align="center">3</td>
<td></td>
</tr>
<tr>
<td>A old esp&#x2F;&#x2F;<code>push 2</code></td>
<td align="center">2</td>
<td></td>
</tr>
<tr>
<td>所以的话要传递2,3的话</td>
<td align="center"></td>
<td></td>
</tr>
</tbody></table>
<p>就用[ebp+8]和[ebp+12]来获取,传入函数栈用eax媒介,然后使用esp来最终的使用</p>
<h3 id="参数传递与返回值"><a href="#参数传递与返回值" class="headerlink" title="参数传递与返回值"></a>参数传递与返回值</h3><h4 id="传递"><a href="#传递" class="headerlink" title="传递"></a>传递</h4><p>参数传递的本质</p>
<p>把原来的数据复制一份到堆栈,然后对堆栈里面的数据进行操作</p>
<p>所以这就解决了形参和实参的问题</p>
<p>在masm32中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sub3	proc	sysCall,c_var1,c_var2</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		push 1</span><br><span class="line">		push 2</span><br><span class="line">		call sub3</span><br><span class="line">		;invlok sub3 C,var1,var2//不知道为什么这样写不可以</span><br></pre></td></tr></table></figure>

<p>在栈中传递参数</p>
<p>①.push到栈里面</p>
<p>②.直接mov [esp+xxx],num,向栈里面直接写入数据.其实它等价于第一种</p>
<p>③. 通过寄存器传递参数</p>
<blockquote>
<p> 如何在32位下传入一个64位的参数???</p>
</blockquote>
<p>Way-1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sub esp,8</span><br><span class="line">fld xxx</span><br><span class="line">fstp qword ptr [esp]</span><br><span class="line">call func</span><br><span class="line">add esp,8</span><br></pre></td></tr></table></figure>

<p>把栈顶指针做一些修改就可以了</p>
<p>Way-2</p>
<p>先把高4字节入栈</p>
<p>再把低4字节入栈</p>
<blockquote>
<p>如何在32位环境下,返回一个64位的值</p>
</blockquote>
<p>将结果拆分为2个32位的,然后分别放在eax,edx</p>
<p>在外面的时候,把eax,edx整合在栈中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov [ebp-4],eax</span><br><span class="line">mov [ebp-8],edx</span><br></pre></td></tr></table></figure>



<h4 id="传递的规律"><a href="#传递的规律" class="headerlink" title="传递的规律"></a>传递的规律</h4><p>参数是从           ebp+8开始</p>
<p>局部变量是从    ebp-4开始的</p>
<p>参数的传递是放在了堆栈里面</p>
<p>是4个字节放一个参数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//基于缓冲区溢出的HelloWorld</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> x1 = <span class="number">1</span>;</span><br><span class="line">	<span class="type">int</span> x2 = <span class="number">2</span>;</span><br><span class="line">	<span class="type">int</span> x3 = <span class="number">3</span>;</span><br><span class="line">	<span class="type">int</span> arr[<span class="number">3</span>] = &#123; <span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>&#125;;</span><br><span class="line">	<span class="type">int</span> x4 = <span class="number">4</span>;</span><br><span class="line">	<span class="type">char</span> str[<span class="number">10</span>] = &#123;<span class="number">9</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">10</span> &#125;;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最先声明的 离 ebp最近</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">0019FE90  CCCCCCCC  </span><br><span class="line">0019FE94  07070709  str[0,3]</span><br><span class="line">0019FE98  07070707  str[4,7]</span><br><span class="line">0019FE9C  CCCC0A07  str[8,9] 余下2位是CC</span><br><span class="line">0019FEA0  CCCCCCCC  </span><br><span class="line">0019FEA4  CCCCCCCC  </span><br><span class="line">0019FEA8  00000004  x4</span><br><span class="line">0019FEAC  CCCCCCCC  </span><br><span class="line">0019FEB0  CCCCCCCC  </span><br><span class="line">0019FEB4  00000006  arr[0]</span><br><span class="line">0019FEB8  00000007  arr[1]</span><br><span class="line">0019FEBC  00000008  arr[2]</span><br><span class="line">0019FEC0  CCCCCCCC  </span><br><span class="line">0019FEC4  CCCCCCCC  </span><br><span class="line">0019FEC8  00000003  x3</span><br><span class="line">0019FECC  CCCCCCCC  </span><br><span class="line">0019FED0  CCCCCCCC  </span><br><span class="line">0019FED4  00000002  x2</span><br><span class="line">0019FED8  CCCCCCCC  </span><br><span class="line">0019FEDC  CCCCCCCC  </span><br><span class="line">0019FEE0  00000001  x1</span><br><span class="line">0019FEE4  CCCCCCCC  </span><br><span class="line">0019FEE8  0019FF08  Stack[000027E0]:0     ebp</span><br><span class="line">0019FEEC  00411F23  invoke_main+33        eip</span><br></pre></td></tr></table></figure>













<h3 id="子函数的定义"><a href="#子函数的定义" class="headerlink" title="子函数的定义"></a>子函数的定义</h3><p>子程序的定义</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//函数的声明</span><br><span class="line">函数名字	proto	[距离][调用方式][可视区域][uses 寄存器列表][参数名称:参数类型,参数名称:参数类</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">//函数的定义</span><br><span class="line">函数的名字 	 proc [距离][调用方式][可视区域][uses 寄存器列表][参数名称:参数类型,参数名称:参数类型][vararg]</span><br><span class="line">		 	local 局部变量</span><br><span class="line">		 </span><br><span class="line">		 	 指令</span><br><span class="line">		 </span><br><span class="line">函数的名字  	 endp</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">//函数的调用</span><br><span class="line">			push xx</span><br><span class="line">			call yy</span><br><span class="line">			或者用invoke指令</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;			</span><br></pre></td></tr></table></figure>

<p>详情见&lt;&lt;琢式成器&gt;&gt;.Page-75</p>
<p>距离:	…决定了最后的ret的指令是哪种类型,好比retf,retn..????</p>
<p>调用方式:	好比stdcall,子函数的调用方式一般是缺省的,与源代码前面的option保持一致</p>
<p>可视化区域;	…可能就是什么私有公开权限啥的</p>
<p>uses寄存器:	可以以查看一下uses的伪指令</p>
<p>参数名称与参数列表:	现在还不会用…</p>
<p>vararg:一个参数的扩展</p>
<p>子程序的声明</p>
<p>联想一下C语言</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">fun</span><span class="params">()</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	func();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">func</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果你不声明一下函数的话,main函数的fun()是无法使用的…除非你把fun()函数写在了main()之前</p>
<p>对于win32的函数同样如此</p>
<p>win32的报错会是<code>error a2006:undefined symbol:找不到程序名</code></p>
<p>于是此刻你要像C语言一样函数声明,那你就要用到proto指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MessageBox Proto hwnd:dword, text:dword,title:dword,Type:dword,</span><br></pre></td></tr></table></figure>



<h2 id="函数的返回值"><a href="#函数的返回值" class="headerlink" title="函数的返回值"></a>函数的返回值</h2><p>若是32位的程序,一般通过eax寄存器返回</p>
<p>若是64位,一般通过edx和eax寄存器返回</p>
<p>若是浮点数,用st(0)返回</p>
<p>如果函数不写return的话</p>
<p>计算的临时结果就hi放弃在栈里面</p>
<p>写了return ,计算的结果就会存入eax</p>
<h2 id="x64的函数调用"><a href="#x64的函数调用" class="headerlink" title="x64的函数调用"></a>x64的函数调用</h2><p>首先参数的不是靠栈的传递</p>
<p>对于内置函数,他又一套专门的寄存器传参</p>
<p>对DIY的函数,你的传的参数取决与你子函数要用哪个寄存器</p>
<p>非浮点数</p>
<p>6个参数以内</p>
<p>参数传递的顺序 rdi,rsi,rdx,rcx,r8,r9</p>
<p>第7个参数以外,假设有10个,从右边往左边压入</p>
<p>压入第10个,压入第9个….压入第7个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mov rdi,fmt1	</span><br><span class="line">mov rsi, first		; the correct registers</span><br><span class="line">mov rdx, second</span><br><span class="line">mov rcx, third			</span><br><span class="line">mov r8, fourth</span><br><span class="line"> 	mov r9, fifth</span><br><span class="line"></span><br><span class="line"> 	push tenth		; now start pushing in</span><br><span class="line">  	push ninth		; reverse order</span><br><span class="line"> 	push eighth</span><br><span class="line">	push seventh</span><br><span class="line">push sixth</span><br><span class="line">mov rax, 0</span><br><span class="line">call printf</span><br></pre></td></tr></table></figure>



<p>浮点数</p>
<p>通过xmm寄存器传递</p>
<p>第一个是xmm0</p>
<p>第二个是xmm1</p>
<p>依次类推</p>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><h3 id="递归"><a href="#递归" class="headerlink" title="递归"></a>递归</h3><h4 id="求和"><a href="#求和" class="headerlink" title="求和"></a>求和</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.386</span><br><span class="line">		.model flat,stdcall</span><br><span class="line">		option casemap:none</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">include		Dqx.inc</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.data			</span><br><span class="line">.data</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.code</span><br><span class="line"></span><br><span class="line">start:</span><br><span class="line">	mov  ecx,6	; count = 10</span><br><span class="line">	mov  eax,0	; holds the sum</span><br><span class="line">	;------------------------------------------</span><br><span class="line">	;传入的参数ecx,eax</span><br><span class="line">	;功能,实现6一直加到1</span><br><span class="line">	;eax是累加值</span><br><span class="line">	;-------------------------------------------</span><br><span class="line">	call CalcSum</span><br><span class="line">	invoke	ExitProcess,NULL</span><br><span class="line"></span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">CalcSum PROC</span><br><span class="line">	cmp  ecx,0	</span><br><span class="line">	jz   L2		</span><br><span class="line">	add  eax,ecx	</span><br><span class="line">	dec  ecx		</span><br><span class="line">	call CalcSum</span><br><span class="line">    ;每次调用都会不断的push IP of ret</span><br><span class="line">    ;一旦pop 出去就会返回一个函数</span><br><span class="line">L2:	ret</span><br><span class="line">CalcSum ENDP</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">	end	start</span><br></pre></td></tr></table></figure>



<p>看一下函数栈</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0019FF5C  | 00401023  | sub_401016:locret_401023</span><br><span class="line">0019FF60  | 00401023  | sub_401016:locret_401023</span><br><span class="line">0019FF64  | 00401023  | sub_401016:locret_401023</span><br><span class="line">0019FF68  | 00401023  | sub_401016:locret_401023</span><br><span class="line">0019FF6C  | 00401023  | sub_401016:locret_401023</span><br><span class="line">0019FF70  | 00401023  | sub_401016:locret_401023</span><br></pre></td></tr></table></figure>

<p>你会发现栈里面的数据都是ret的地址,一旦达到函数的返回条件,他就不断的把ret的地址pop 到IP</p>
<h4 id="阶乘"><a href="#阶乘" class="headerlink" title="阶乘"></a>阶乘</h4><p>我的阶乘.有点简单</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.386</span><br><span class="line">		.model flat,stdcall</span><br><span class="line">		option casemap:none</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">include		Dqx.inc</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.data			</span><br><span class="line">.data</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.code</span><br><span class="line"></span><br><span class="line">start:</span><br><span class="line">	mov	eax,5</span><br><span class="line">	mov	ebx,eax</span><br><span class="line">	call	func</span><br><span class="line">	invoke	ExitProcess,NULL</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">func PROC</span><br><span class="line">	dec	ebx</span><br><span class="line">	cmp	ebx,0</span><br><span class="line">	jz	over</span><br><span class="line">	mul	ebx</span><br><span class="line">	call	func</span><br><span class="line">over:</span><br><span class="line">	ret</span><br><span class="line">func ENDP</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">	end	start</span><br></pre></td></tr></table></figure>



<p>整体实现的一个流程是</p>
<p>eax–,然后不断的push eax</p>
<p>直到eax&#x3D;0,就让eax&#x3D;1,开始在栈里面取数据做乘法</p>
<p>对书上的理解,我又写的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.386</span><br><span class="line">		.model flat,stdcall</span><br><span class="line">		option casemap:none</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">include		Dqx.inc</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.data			</span><br><span class="line">.data</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.code</span><br><span class="line"></span><br><span class="line">start:</span><br><span class="line">	push	5</span><br><span class="line">	call	func</span><br><span class="line">	invoke	ExitProcess,NULL</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">func PROC</span><br><span class="line">	push	ebp</span><br><span class="line">	mov	ebp,esp</span><br><span class="line">	mov	eax,[ebp+8]</span><br><span class="line">	cmp	eax,1</span><br><span class="line">	jz	q1</span><br><span class="line">	dec	eax</span><br><span class="line">	push	eax</span><br><span class="line">	call	func</span><br><span class="line">	mov	ebx,[ebp+8]</span><br><span class="line">	mul	ebx</span><br><span class="line">q1:	</span><br><span class="line">	pop	ebp</span><br><span class="line">	retn	4</span><br><span class="line">	;为什么pop </span><br><span class="line">	;ebp?为了让eip指向返回地址</span><br><span class="line">	;为什么ebx,[ebp+8]</span><br><span class="line">	;因为完全进入了一个完整的函数,参数的获取</span><br><span class="line">	;怎么保持的栈平衡?让eip指向了正确的地址</span><br><span class="line">	;为什么是retn 4</span><br><span class="line">	;为了让esp指ebp的位置</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">func ENDP</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">	end	start</span><br></pre></td></tr></table></figure>

<p>书上的方法,很妙’很复杂</p>
<p>‘</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.386</span><br><span class="line">		.model flat,stdcall</span><br><span class="line">		option casemap:none</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">include		Dqx.inc</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.data			</span><br><span class="line">.data</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.code</span><br><span class="line"></span><br><span class="line">start:</span><br><span class="line">	push	5</span><br><span class="line">	call	func</span><br><span class="line">	invoke	ExitProcess,NULL</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">func PROC</span><br><span class="line">	push ebp</span><br><span class="line">	mov  ebp,esp</span><br><span class="line">	mov  eax,[ebp+8]	</span><br><span class="line">	cmp  eax,0		</span><br><span class="line">	ja   break_up			</span><br><span class="line">	mov  eax,1		</span><br><span class="line">	jmp  ok</span><br><span class="line">break_up:</span><br><span class="line">	dec  eax</span><br><span class="line">	push eax			</span><br><span class="line">	call func</span><br><span class="line">begin_mul:</span><br><span class="line">	mov  ebx,[ebp+8]   	</span><br><span class="line">	mul  ebx</span><br><span class="line">	</span><br><span class="line">ok:	pop  ebp			</span><br><span class="line">	ret  4</span><br><span class="line">	;pop ip</span><br><span class="line">	;esp+=4</span><br><span class="line">func ENDP</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">	end	start</span><br></pre></td></tr></table></figure>



<h3 id="x64-计数圆的周长-x2F-面积"><a href="#x64-计数圆的周长-x2F-面积" class="headerlink" title="x64 计数圆的周长&#x2F;面积"></a>x64 计数圆的周长&#x2F;面积</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">section .data		</span><br><span class="line">		</span><br><span class="line">		radius	dq	10.0	</span><br><span class="line">					</span><br><span class="line">		</span><br><span class="line">;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx	</span><br><span class="line">section .bss</span><br><span class="line"></span><br><span class="line">;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx	</span><br><span class="line">section .text</span><br><span class="line">	</span><br><span class="line">extern		printf		</span><br><span class="line">extern		area</span><br><span class="line">extern		circum</span><br><span class="line">extern		circle	</span><br><span class="line">					</span><br><span class="line">	global main						</span><br><span class="line">main:</span><br><span class="line">    mov rbp, rsp; for correct debugging</span><br><span class="line">;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx	</span><br><span class="line">           mov  rbp, rsp;</span><br><span class="line">	push rbp</span><br><span class="line">	mov  rbp, rsp</span><br><span class="line">	</span><br><span class="line">	call circle</span><br><span class="line">	</span><br><span class="line">	leave</span><br><span class="line">	ret			       		</span><br><span class="line">;------------------------------------------------------	</span><br><span class="line">circle:</span><br><span class="line"></span><br><span class="line">	section .data</span><br><span class="line">		.fmt_area	db	&quot;The area is %f&quot;,10,0</span><br><span class="line">		.fmt_circum	db	&quot;The circumference is %f&quot;,10,0</span><br><span class="line">	section .text</span><br><span class="line">	</span><br><span class="line">	push rbp</span><br><span class="line">	mov rbp, rsp	</span><br><span class="line">	</span><br><span class="line">		call area	</span><br><span class="line">		mov	rdi,.fmt_area</span><br><span class="line">		mov	rax,1			; area in xmm0</span><br><span class="line">		call printf</span><br><span class="line">		call circum</span><br><span class="line">		mov	rdi,.fmt_circum</span><br><span class="line">		mov	rax,1			; circumference in xmm0</span><br><span class="line">		call printf</span><br><span class="line">		</span><br><span class="line">	leave</span><br><span class="line">	ret</span><br><span class="line">;----------------------------------------------------</span><br><span class="line">;function name:area</span><br><span class="line">；no var get in</span><br><span class="line">；proc: calc PI x R^2</span><br><span class="line">；return xmm0</span><br><span class="line"></span><br><span class="line">area:</span><br><span class="line">	section .data</span><br><span class="line">		.pi	dq	3.141592654	; local to area</span><br><span class="line">	section .text </span><br><span class="line">	</span><br><span class="line">	push rbp</span><br><span class="line">	mov rbp, rsp</span><br><span class="line">	</span><br><span class="line">		movsd xmm0, [radius]</span><br><span class="line">		mulsd xmm0, [radius]</span><br><span class="line">		mulsd xmm0, [.pi]</span><br><span class="line">		</span><br><span class="line">	leave</span><br><span class="line">	ret</span><br><span class="line">;----------------------------------------------------</span><br><span class="line">;fuction name:circum</span><br><span class="line">;no var get in</span><br><span class="line">;proc: 2*PI*R</span><br><span class="line">;return xmm0</span><br><span class="line"></span><br><span class="line">circum:</span><br><span class="line">	section .data</span><br><span class="line">		.pi	dq	3.14		; local to circum</span><br><span class="line">	section .text</span><br><span class="line">	</span><br><span class="line">	push rbp</span><br><span class="line">	mov rbp, rsp	</span><br><span class="line"></span><br><span class="line">		movsd xmm0, [radius]</span><br><span class="line">		addsd xmm0, [radius]</span><br><span class="line">		mulsd xmm0, [.pi]</span><br><span class="line">		</span><br><span class="line">	leave</span><br><span class="line">	ret</span><br><span class="line">;----------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	</span><br></pre></td></tr></table></figure>





<h1 id="裸函数"><a href="#裸函数" class="headerlink" title="裸函数"></a>裸函数</h1><h2 id="导入"><a href="#导入" class="headerlink" title="导入"></a>导入</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">void __declspec(naked) Function()  				</span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;				</span><br><span class="line"></span><br><span class="line">上面的函数调用时，为什么会出错？				</span><br><span class="line"></span><br><span class="line">void __declspec(naked) Function()  				</span><br><span class="line">&#123;				</span><br><span class="line"></span><br><span class="line">	__asm ret			</span><br><span class="line">&#125;										</span><br></pre></td></tr></table></figure>

<p>对于第一种裸函数的写法,编译器不会给你生成任何东西,就连ret都不会给你生成</p>
<p>所以对于空的裸函数,你要写上<code>ret</code></p>
<h2 id="无参数和返回值的裸函数"><a href="#无参数和返回值的裸函数" class="headerlink" title="无参数和返回值的裸函数"></a>无参数和返回值的裸函数</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">void __declspec(naked) Function()  					</span><br><span class="line">&#123;					</span><br><span class="line">	__asm				</span><br><span class="line">	&#123;				</span><br><span class="line">		push ebp			</span><br><span class="line">		mov ebp,esp			</span><br><span class="line">		sub esp,0x40			</span><br><span class="line">		push ebx			</span><br><span class="line">		push esi			</span><br><span class="line">		push edi			</span><br><span class="line">		lea edi,dword ptr ds:[ebp-0x40]			</span><br><span class="line">		mov eax,0xCCCCCCCC			</span><br><span class="line">		mov ecx,0x10			</span><br><span class="line">		rep stosd			</span><br><span class="line">					</span><br><span class="line">		pop edi			</span><br><span class="line">		pop esi			</span><br><span class="line">		pop ebx			</span><br><span class="line">		mov esp,ebp			</span><br><span class="line">		pop ebp			</span><br><span class="line">					</span><br><span class="line">		ret			</span><br><span class="line">	&#125;				</span><br><span class="line">&#125;					</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="有参数和返回值"><a href="#有参数和返回值" class="headerlink" title="有参数和返回值"></a>有参数和返回值</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">int __declspec(naked) Function(int x,int y)  	//实现x+y				</span><br><span class="line">&#123;					</span><br><span class="line">	__asm				</span><br><span class="line">	&#123;				</span><br><span class="line">		push ebp			</span><br><span class="line">		mov ebp,esp			</span><br><span class="line">		sub esp,0x40			</span><br><span class="line">		push ebx			</span><br><span class="line">		push esi			</span><br><span class="line">		push edi			</span><br><span class="line">		lea edi,dword ptr ds:[ebp-0x40]			</span><br><span class="line">		mov eax,0xCCCCCCCC			</span><br><span class="line">		mov ecx,0x10			</span><br><span class="line">		rep stosd			</span><br><span class="line">					</span><br><span class="line">		mov eax,dword ptr ds:[ebp+8]			</span><br><span class="line">		add eax,dword ptr ds:[ebp+0xC]			</span><br><span class="line">					</span><br><span class="line">		pop edi			</span><br><span class="line">		pop esi			</span><br><span class="line">		pop ebx			</span><br><span class="line">		mov esp,ebp			</span><br><span class="line">		pop ebp			</span><br><span class="line">					</span><br><span class="line">		ret			</span><br><span class="line">	&#125;				</span><br><span class="line">&#125;					</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="带局部变量的裸函数"><a href="#带局部变量的裸函数" class="headerlink" title="带局部变量的裸函数"></a>带局部变量的裸函数</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">					</span><br><span class="line">int __declspec(naked) Function(int x,int y)  					</span><br><span class="line">&#123;					</span><br><span class="line">	__asm				</span><br><span class="line">	&#123;				</span><br><span class="line">		push ebp			</span><br><span class="line">		mov ebp,esp			</span><br><span class="line">		sub esp,0x40			</span><br><span class="line">		push ebx			</span><br><span class="line">		push esi			</span><br><span class="line">		push edi			</span><br><span class="line">		lea edi,dword ptr ds:[ebp-0x40]			</span><br><span class="line">		mov eax,0xCCCCCCCC			</span><br><span class="line">		mov ecx,0x10			</span><br><span class="line">		rep stosd			</span><br><span class="line">		mov dword ptr ds:[ebp-4],2			</span><br><span class="line">		mov dword ptr ds:[ebp-8],3			</span><br><span class="line">					</span><br><span class="line">		mov eax,dword ptr ds:[ebp+8]			</span><br><span class="line">		add eax,dword ptr ds:[ebp+0xC]			</span><br><span class="line">					</span><br><span class="line">		pop edi			</span><br><span class="line">		pop esi			</span><br><span class="line">		pop ebx			</span><br><span class="line">		mov esp,ebp			</span><br><span class="line">		pop ebp			</span><br><span class="line">					</span><br><span class="line">		ret			</span><br><span class="line">	&#125;				</span><br><span class="line">&#125;					</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="MS-Windows"><a href="#MS-Windows" class="headerlink" title="MS-Windows"></a>MS-Windows</h1><p>可以对比一下你8086学的int21h的ah&#x3D;9,或者其它之类的中断……</p>
<p>8086的中断比较晦涩难懂</p>
<p>win32的API就比较好理解一些</p>
<p>有的API是有返回值的</p>
<p>如果返回值是32位寄存器放得下的,那么一定放在eax中,如果放不下</p>
<p>情况1,eax放一个返回值的指针</p>
<p>情况2,返回值到了buff区域</p>
<h2 id="数据类型表"><a href="#数据类型表" class="headerlink" title="数据类型表"></a>数据类型表</h2><table>
<thead>
<tr>
<th>MS-Windows 类型</th>
<th>MASM类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>BOOL, BOOLEAN</td>
<td>DWORD</td>
<td>布尔值 (TRUE 或 FALSE)</td>
</tr>
<tr>
<td>BYTE</td>
<td>BYTE</td>
<td>8 位无符号整数</td>
</tr>
<tr>
<td>CHAR</td>
<td>BYTE</td>
<td>8 位 Windows ANSI 字符</td>
</tr>
<tr>
<td>COLORREF</td>
<td>DWORD</td>
<td>作为颜色值的 32 位数值</td>
</tr>
<tr>
<td>DWORD</td>
<td>DWORD</td>
<td>32 位无符号整数</td>
</tr>
<tr>
<td>HANDLE</td>
<td>DWORD</td>
<td>对象句柄</td>
</tr>
<tr>
<td>HFILE</td>
<td>DWORD</td>
<td>用 OpenFile 打开的文件的句柄</td>
</tr>
<tr>
<td>INT</td>
<td>SDWORD</td>
<td>32 位有符号整数</td>
</tr>
<tr>
<td>LONG</td>
<td>SDWORD</td>
<td>32 位有符号整数</td>
</tr>
<tr>
<td>LPARAM</td>
<td>DWORD</td>
<td>消息参数，由窗口过程和回调函数使用</td>
</tr>
<tr>
<td>LPCSTR</td>
<td>PTR BYTE</td>
<td>32 位指针，指向由 8 位 Windows (ANSI)字符组成的空字节结束的字符串常量</td>
</tr>
<tr>
<td>LPCVOID</td>
<td>DWORD</td>
<td>指向任何类型的常量</td>
</tr>
<tr>
<td>LPSTR</td>
<td>PTR BYTE</td>
<td>32 位指针，指向由 8 位 Windows (ANSI) 字符组成的空字节结束的字符串</td>
</tr>
<tr>
<td>LPCTSTR</td>
<td>PTR WORD</td>
<td>32 位指针，指向对 Unicode 和双字节字符集可移植的字符串常量</td>
</tr>
<tr>
<td>LPTSTR</td>
<td>PTR WORD</td>
<td>32 位指针，指向对 Unicode 和双字节字符集可移植的字符串</td>
</tr>
<tr>
<td>LPVOID</td>
<td>DWORD</td>
<td>32 位指针，指向未指定类</td>
</tr>
<tr>
<td>LRESULT</td>
<td>DWORD</td>
<td>窗口过程和回调函数返回的 32 位数值</td>
</tr>
<tr>
<td>SIZE_T</td>
<td>DWORD</td>
<td>一个指针可以指向的最大字节数</td>
</tr>
<tr>
<td>UNIT</td>
<td>DWORD</td>
<td>32 位无符号整数</td>
</tr>
<tr>
<td>WNDPROC</td>
<td>DWORD</td>
<td>32 位指针，指向窗口过程</td>
</tr>
<tr>
<td>WORD</td>
<td>WORD</td>
<td>16 位无符号整数</td>
</tr>
<tr>
<td>WPARAM</td>
<td>DWORD</td>
<td>作为参数传递给窗口过程或回调函数的 32 位数值</td>
</tr>
</tbody></table>
<h2 id="函数一览表"><a href="#函数一览表" class="headerlink" title="函数一览表"></a>函数一览表</h2><p>下表为所有 Win32 控制台函数的一览表。在 <a target="_blank" rel="noopener" href="http://www.msdn.microsoft.com/">www.msdn.microsoft.com</a> 上可以找到 MSDN 库中每个函数的完整描述。</p>
<blockquote>
<p>提示：Win32 API 函数不保存 EAX、EBX、ECX 和 EDX，因此程序员需自己完成这些寄存器的入栈和出栈操作。</p>
<p>所以你会发现,一个函数使用,你的寄存器会发生一些改变</p>
</blockquote>
<table>
<thead>
<tr>
<th>函数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>AllocConsole</td>
<td>为调用进程分配一个新控制台</td>
</tr>
<tr>
<td>CreateConsoleScreenBuffer</td>
<td>创建控制台屏幕缓冲区</td>
</tr>
<tr>
<td>ExitProcess</td>
<td>结束进程及其所有线程</td>
</tr>
<tr>
<td>FillConsoleOutputAttribute</td>
<td>为指定数量的字符单元格设置文本和背景颜色属性</td>
</tr>
<tr>
<td>FillConsoleOutputCharacter</td>
<td>按指定次数将一个字符写入屏幕缓冲区</td>
</tr>
<tr>
<td>FlushConsoleInputBuffer</td>
<td>刷新控制台输入缓冲区</td>
</tr>
<tr>
<td>FreeConsole</td>
<td>将主调进程与其控制台分离</td>
</tr>
<tr>
<td>GenerateConsoleCtrlEvent</td>
<td>向控制台进程组发送指定信号，这些进程组共享与主调进程关联的控制台</td>
</tr>
<tr>
<td>GetConsoleCP</td>
<td>获取与主调进程关联的控制台使用的输入代码页</td>
</tr>
<tr>
<td>GetConsoleCursorInfo</td>
<td>获取指定控制台屏幕缓冲区光标大小和可见性的信息</td>
</tr>
<tr>
<td>GetConsoleMode</td>
<td>获取控制台输入缓冲区的当前输入模式或控制台屏幕缓冲区的当前输出模式</td>
</tr>
<tr>
<td>GetConsoleOutputCP</td>
<td>获取与主调进程关联的控制台使用的输出代码页</td>
</tr>
<tr>
<td>GetConsoleScreenBufferInfo</td>
<td>获取指定控制台屏幕缓冲区信息</td>
</tr>
<tr>
<td>GetConsoleTitle</td>
<td>获取当前控制台窗口的标题栏字符串</td>
</tr>
<tr>
<td>GetConsoleWindow</td>
<td>获取与主调进程关联的控制台使用的窗口句柄</td>
</tr>
<tr>
<td>GetLargestConsoleWindowSize</td>
<td>获取控制台窗口最大可能的大小</td>
</tr>
<tr>
<td>GetNumberOfConsoleInputEvents</td>
<td>获取控制台输入缓冲区中未读输入记录的个数</td>
</tr>
<tr>
<td>GetNumberOfConsoleMouseButtons</td>
<td>获取当前控制台使用的鼠标按钮数</td>
</tr>
<tr>
<td>GetStdHandle</td>
<td>获取标准输入、标准输出或标准错误设备的句柄</td>
</tr>
<tr>
<td>HandlerRoutine</td>
<td>与 SetConsoleCtrlHandler 函数一起使用的应用程序定义的函数</td>
</tr>
<tr>
<td>PeekConsoleInput</td>
<td>从指定控制台输入缓冲区读取数据，且不从缓冲区删除该数据</td>
</tr>
<tr>
<td>ReadConsole</td>
<td>从控制台输入缓冲区读取并删除输入字符</td>
</tr>
<tr>
<td>ReadConsoleInput</td>
<td>从控制台输入缓冲区读取并删除该数据</td>
</tr>
<tr>
<td>ReadConsoleOutput</td>
<td>从控制台屏幕缓冲区的矩形字符单元格区域读取字符和颜色属性数据</td>
</tr>
<tr>
<td>ReadConsoleOutputAttribute</td>
<td>从控制台屏幕缓冲区的连续单元格复制指定数量的前景和背景颜色属性</td>
</tr>
<tr>
<td>ReadConsoleOutputCharacter</td>
<td>从控制台屏幕缓冲区的连续单元格复制若干字符</td>
</tr>
<tr>
<td>ScrollConsoleScreenBuffer</td>
<td>移动屏幕缓冲区内的一个数据块</td>
</tr>
<tr>
<td>SetConsoleActiveScreenBuffer</td>
<td>设置指定屏幕缓冲区为当前显示的控制台屏幕缓冲区</td>
</tr>
<tr>
<td>SetConsoleCP</td>
<td>设置主调过程的控制台输入代码页</td>
</tr>
<tr>
<td>SetConsoleCtrlHandler</td>
<td>为主调过程从处理函数列表中添加或删除应用程序定义的 HandlerRoutine</td>
</tr>
<tr>
<td>SetConsoleCursorInfo</td>
<td>设置指定控制台屏幕缓冲区光标的大小和可见度</td>
</tr>
<tr>
<td>SetConsoleCursorPosition</td>
<td>设置光标在指定控制台屏幕缓冲区中的位置</td>
</tr>
<tr>
<td>SetConsoleMode</td>
<td>设置控制台输入缓冲区的输入模式或者控制台屏幕缓冲区的输出模式</td>
</tr>
<tr>
<td>SetConsoleOntputCP</td>
<td>设置主调过程的控制台输出代码页</td>
</tr>
<tr>
<td>SetConsoleScreenBufferSize</td>
<td>修改指定控制台屏幕缓冲区的大小</td>
</tr>
<tr>
<td>SetConsoleTextAttribute</td>
<td>设置写入屏幕缓冲区的字符的前景（文本）和背景颜色属性</td>
</tr>
<tr>
<td>SetConsoleTitle</td>
<td>为当前控制台窗口设置标题栏字符串</td>
</tr>
<tr>
<td>SetConsoleWindowInfo</td>
<td>设置控制台屏幕缓冲区窗口当前的大小和位置</td>
</tr>
<tr>
<td>SetStdHandle</td>
<td>设置标准输入、输出和标准错误设备的句柄.</td>
</tr>
<tr>
<td>WriteConsole</td>
<td>向由当前光标位置标识开始的控制台屏幕缓冲区写一个字符串</td>
</tr>
<tr>
<td>WriteConsoleInput</td>
<td>直接向控制台输入缓冲区写数据</td>
</tr>
<tr>
<td>WriteConsoleOutput</td>
<td>向控制台屏幕缓冲区内指定字符单元格的矩形块写字符和颜色属性数据</td>
</tr>
<tr>
<td>WriteConsoleOutputAttribute</td>
<td>向控制台屏幕缓冲区的连续单元格复制一组前景和背景颜色属性</td>
</tr>
<tr>
<td>WriteConsoleOutputCharacter</td>
<td>向控制台屏幕缓冲区的连续单元格复制一组字符</td>
</tr>
</tbody></table>
<h2 id="句柄"><a href="#句柄" class="headerlink" title="句柄"></a>句柄</h2><p>他只是用来表示各种资源的编号</p>
<p>书上说了这么一句话,不是很理解</p>
<p>加入你把句柄&#x3D;11给了应用程序,应用程序不知道他是什么</p>
<p>你把句柄&#x3D;11给了windows,windows就知道去查找哪个窗口</p>
<p>可能他说了句柄也有分类,线程局部,窗口句柄,文件句柄……..</p>
<p>他还说,如果以前有10个窗口,你给了windows11号窗口</p>
<p>当原来的10个窗口关闭,留下5个,那么你的11号窗口就变了6号窗口</p>
<p>他说我们不需要关系句柄的值,用就对了</p>
<h2 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h2><p>一个模块代表了&#x3D;&#x3D;运行中&#x3D;&#x3D;的exe或者dll文件,用来代表这个文件中所有的&#x3D;&#x3D;代码与资源&#x3D;&#x3D;</p>
<p>每个不同的模块都有唯一的的模块句柄来标识,&#x3D;&#x3D;利用这个句柄我们可以访问文件的资源…&#x3D;&#x3D;</p>
<p>很多的API函数都要用到都要用到模块的句柄,以便利用程序的各种资源</p>
<p>在win32上,模块句柄的值&#x3D;&#x3D;程序在内存中载入的启示地址</p>
<h2 id="Messagebox-A-x2F-W"><a href="#Messagebox-A-x2F-W" class="headerlink" title="Messagebox A&#x2F;W"></a>Messagebox A&#x2F;W</h2><p>Messagebox一般默认为MessageboxA</p>
<p>MessageboxA一般用于ANSI标准,这个标准你之前也是遇到过的,不能显示中文,</p>
<p>ANSI规定字符占一个字节,我们就用MessageboxA</p>
<p>Unicode码规定字符占2个字节,我们就用MessageboxW</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MessageBoxA PROTO,</span><br><span class="line">  hWnd:DWORD,          ;窗口句柄（可以为空）</span><br><span class="line">  lpText:PTR BYTE,         ;字符串，对话框内</span><br><span class="line">  lpCaption:PTR BYTE,      ;字符串，对话框标题</span><br><span class="line">  uType:DWORD          ;内容和行为</span><br></pre></td></tr></table></figure>

<p>hwnd 基于控制台的应用程序可以将 hWnd 设置为空，表示该消息框没有相关的包含窗口或父窗口。</p>
<p>lpText 消息框内容的指针</p>
<p>lpCaption 消息框标题的指针</p>
<p>uType 指定对话框的内容和行为</p>
<h3 id="内容和行为"><a href="#内容和行为" class="headerlink" title="内容和行为"></a>内容和行为</h3><p>uType 参数包含的位图整数组合了三种选项：显示按钮、图标和默认按钮选择。几种可能的按钮组合如下：</p>
<ul>
<li>MB_OK</li>
<li>MB_OKCANCEL</li>
<li>MB_YESNO</li>
<li>MB_YESNOCANCEL</li>
<li>MB_RETRYCANCEL</li>
<li>MB_ABORTRETRYIGNORE</li>
<li>MB_CANCELTRYCONTINUE</li>
</ul>
<h3 id="默认按钮"><a href="#默认按钮" class="headerlink" title="默认按钮"></a>默认按钮</h3><p>可以选择按钮作为用户点击 Enter 键时的自动选项。选项包括</p>
<p> MB_DEFBUTTON1（默认）、MB_DEFBUTTON2、MB_DEFBUTTON3 和 MB_DEFBUTTON4。</p>
<p>按钮从左到右，从 1 开始编号。</p>
<h3 id="图标"><a href="#图标" class="headerlink" title="图标"></a>图标</h3><p>有四个图标可用。有时多个常数会产生相同的图标：</p>
<ul>
<li>停止符：MB_ICONSTOP. MB_ICONHAND 或 MB_ICONERROR</li>
<li>问号（?）：MB_ICONQUESTION</li>
<li>信息符（i）：MB_ICONINFORMATION、MB_ICONASTERISK</li>
<li>感叹号（!）：MB_ICONEXCLAMATION、MB_ICONWARNING</li>
</ul>
<h3 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h3><p>如果 MessageBoxA 失败，则返回零；</p>
<p>否则，它将返回一个整数以表示用户在关闭对话框时点击的按钮。</p>
<p>选项包括 IDABORT、IDCANCEL、IDCONTINUE、IDIGNORE、IDNO、IDOK、IDRETRY、IDTRYAGAIN，以及 IDYES。</p>
<p>。</p>
<p>如果想要消息框窗口浮动于桌面所有其他窗口之上，就在传递的最后一个参数（uType 参数）值上添加 MB_SYSTEMMODAL 选项</p>
<p>例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">include		Dqx.inc</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.data	</span><br><span class="line"></span><br><span class="line">captionW        BYTE &quot;Warning&quot;,0</span><br><span class="line">warningMsg		BYTE &quot;The current operation may take years &quot;</span><br><span class="line">                BYTE &quot;to complete.&quot;,0</span><br><span class="line"></span><br><span class="line">captionQ        BYTE &quot;Question&quot;,0</span><br><span class="line">questionMsg		BYTE &quot;A matching user account was not found.&quot;</span><br><span class="line">                BYTE 0dh,0ah,&quot;Do you wish to continue?&quot;,0   </span><br><span class="line"></span><br><span class="line">captionC        BYTE &quot;Information&quot;,0</span><br><span class="line">infoMsg			BYTE &quot;Select Yes to save a backup file &quot;</span><br><span class="line">                BYTE &quot;before continuing,&quot;,0dh,0ah</span><br><span class="line">                BYTE &quot;or click Cancel to stop the operation&quot;,0</span><br><span class="line"></span><br><span class="line">captionH        BYTE &quot;Cannot View User List&quot;,0</span><br><span class="line">haltMsg			BYTE &quot;This operation not supported by your &quot;</span><br><span class="line">                BYTE &quot;user account.&quot;,0               </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">.code</span><br><span class="line">start:		</span><br><span class="line">		; 显示感叹号图标和 OK 按钮</span><br><span class="line">		INVOKE MessageBoxA, </span><br><span class="line">			NULL, </span><br><span class="line">			ADDR warningMsg,</span><br><span class="line">			ADDR captionW,</span><br><span class="line">			MB_OK + MB_ICONEXCLAMATION</span><br><span class="line"></span><br><span class="line">		; 显示问号图标和 Yes/No 按钮</span><br><span class="line">		INVOKE MessageBoxA, </span><br><span class="line">			NULL, </span><br><span class="line">			ADDR questionMsg,</span><br><span class="line">			ADDR captionQ, </span><br><span class="line">			MB_YESNO + MB_ICONQUESTION</span><br><span class="line">       </span><br><span class="line">		; 解释用户点击的按钮  </span><br><span class="line">		cmp    eax,IDYES        ; YES button clicked?</span><br><span class="line"></span><br><span class="line">		; 显示信息图标和 Yes/No/Cancel 按钮</span><br><span class="line">		INVOKE MessageBoxA, </span><br><span class="line">			NULL, </span><br><span class="line">			ADDR infoMsg,</span><br><span class="line">			ADDR captionC, </span><br><span class="line">			MB_YESNOCANCEL + MB_ICONINFORMATION + MB_DEFBUTTON2</span><br><span class="line"></span><br><span class="line">		; 显示停止图标和 OK 按钮</span><br><span class="line">		INVOKE MessageBoxA, </span><br><span class="line">			NULL, </span><br><span class="line">			ADDR haltMsg,</span><br><span class="line">			ADDR captionH,</span><br><span class="line">			MB_OK + MB_ICONSTOP</span><br><span class="line"></span><br><span class="line">		invoke	ExitProcess,NULL</span><br><span class="line">end start</span><br><span class="line">;-----------------------------------------------------</span><br></pre></td></tr></table></figure>





<h2 id="窗口输入"><a href="#窗口输入" class="headerlink" title="窗口输入"></a>窗口输入</h2><h3 id="ReadConsole-读取输入"><a href="#ReadConsole-读取输入" class="headerlink" title="ReadConsole 读取输入"></a>ReadConsole 读取输入</h3><p>函数 ReadConsole 为读取文本输入并将其送入缓冲区提供了便捷的方法。其原型如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ReadConsole PROTO,</span><br><span class="line">hConsoleInput: HANDLE z            ;输入句柄</span><br><span class="line">lpBuffer:PTR BYTE,                  ;缓冲区指针</span><br><span class="line">nNumberOfCharsToRead:DWORD,     ;读取的字符数</span><br><span class="line">lpNumberOfCharsRead:PTR DWORD,   ;指向读取字节数的指针</span><br><span class="line">lpReserved:DWORD                 ;未使用</span><br></pre></td></tr></table></figure>

<p>hConsoleInput 是函数 GetStdHandle 返回的可用控制台输入句柄。</p>
<p> lpBuffer 是字符数组的偏移量。</p>
<p>nNumberOfCharsToRead 是一个 32 位整数，指明读取的最大字符数。</p>
<p>lpNumberOfCharsRead 是一个允许函数填充的双字指针，当函数返回时，字符数的计数值将被放入缓冲区。</p>
<p>最后一个参数未使用，因此传递的值为 0。</p>
<p>在调用 ReadConsole 时，输入缓冲区还要包含两个额外的字节用来保存行结束字符。</p>
<p>如果希望输入缓冲区里是空字节结束字符串，则用空字节来代替内容为 ODh 的字节。Irvine32.lib 的过程 ReadString 就是这样操作的。</p>
<blockquote>
<p>注意：Win32 API 函数不会保存 EAX、EBX、ECX 和 EDX 寄存器。</p>
</blockquote>
<p>例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">include		Dqx.inc</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">			.data	</span><br><span class="line">max			= 80</span><br><span class="line">Input_Buff		BYTE max DUP(?),0,0</span><br><span class="line">An_Input_Handle		HANDLE ?</span><br><span class="line">len			DWORD ?</span><br><span class="line">captionC		byte &quot;Gh0st&quot;,0</span><br><span class="line"></span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">.code</span><br><span class="line">start:		</span><br><span class="line">		        ; 获取标准输入句柄</span><br><span class="line">	INVOKE	GetStdHandle, STD_INPUT_HANDLE</span><br><span class="line">	mov	An_Input_Handle,eax</span><br><span class="line"></span><br><span class="line">    ; 等待用户输入</span><br><span class="line">	INVOKE	ReadConsole, </span><br><span class="line">		An_Input_Handle	, </span><br><span class="line">		ADDR Input_Buff,</span><br><span class="line">		max, </span><br><span class="line">		ADDR len, </span><br><span class="line">		0</span><br><span class="line"></span><br><span class="line">	INVOKE MessageBoxA, </span><br><span class="line">	NULL, </span><br><span class="line">	ADDR Input_Buff,</span><br><span class="line">	ADDR captionC, </span><br><span class="line">	MB_YESNOCANCEL + MB_ICONINFORMATION + MB_DEFBUTTON2</span><br><span class="line"></span><br><span class="line">	invoke	ExitProcess,NULL</span><br><span class="line">end start</span><br><span class="line">;-----------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>它并没有等待我的输入,我根本就没啥输入的地方,以后慢慢解决</p>
<p>解决办法就是修改编译方式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LINK_FLAG = /subsystem:console</span><br></pre></td></tr></table></figure>



<p>输入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">I am here !</span><br><span class="line">然后回车</span><br></pre></td></tr></table></figure>

<p>得到长度13&#x3D;2+11</p>
<p>IDA-data</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aIAmHere db &#x27;I am here !&#x27;,0Dh,0Ah,0</span><br></pre></td></tr></table></figure>

<p>所以会有11个</p>
<h2 id="GetLastError-x2F-FormatMessage-获取错误消息"><a href="#GetLastError-x2F-FormatMessage-获取错误消息" class="headerlink" title="GetLastError&#x2F;FormatMessage 获取错误消息"></a>GetLastError&#x2F;FormatMessage 获取错误消息</h2><p>GetLastError没有参数</p>
<p>FormatMessage</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FormatMessage PROTO,         ;格式化消息</span><br><span class="line">    dwFlags:DWORD,                ;格式化选项</span><br><span class="line">    lpSource:DWORD,               ;消息定义的位置</span><br><span class="line">    dwMsgID:DWORD,              ;消息标识符</span><br><span class="line">    dwLanguageID:DWORD,     ;语言标识符</span><br><span class="line">    lpBuffer:PTR BYTE,               ;缓冲区接收字符串指针</span><br><span class="line">    nSize:DWORD,                     ;缓冲区大小</span><br><span class="line">    va_list: DWORD                   ;参数列表指针</span><br></pre></td></tr></table></figure>

<p>下面简要列出了最常用的参数值。除了 lpBuffer 是输出参数外，其他都是输入参数</p>
<ol>
<li>dwFlags</li>
</ol>
<p>保存格式化选项的双字整数，包括如何解释参数 lpSource。</p>
<p>它规定怎样处理换行，以及格式化输出行的最大宽度.</p>
<p>建议值为 FORMAT_MESSAGE_ALLOCATE_BUFFER 和 FORMAT_MESSAGE_FROM_SYSTEM。</p>
<ol start="2">
<li>lpSource</li>
</ol>
<p>消息定义位置的指针。若按照建议值设置 dwFlags，则 lpSource 设置为 NULL(0)。</p>
<ol start="3">
<li>dwMsgID</li>
</ol>
<p>调用 GetLastError 后返回的双字整数。</p>
<ol start="4">
<li>dwLanguageID</li>
</ol>
<p>语言标识符。若将其设置为 0，则消息为语言无关，否则将对应于用户的默认语言环境。</p>
<ol start="5">
<li>lpBuffer( 输出参数 )</li>
</ol>
<p>接收空字节结束消息字符串的缓冲区指针。如果使用了 FORMAT_MESSAGE_ALLOCATE_BUFFER 选项，则会自动分配缓冲区。</p>
<ol start="6">
<li>nSize</li>
</ol>
<p>用于指定一个缓冲区来保存消息字符串。如果 dwFlags 使用了上述建议选项，则该参数可以设置为 0。</p>
<ol start="7">
<li>va_list</li>
</ol>
<p>数组指针，该数组包含了可以插入到格式化消息的值。由于没有格式化错误消息，这个参数可以为 NULL(0)。</p>
<p>例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">include		Dqx.inc</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.data	</span><br><span class="line">	</span><br><span class="line">	messageId DWORD ?</span><br><span class="line">	pErrorMsg DWORD ?            ;指向错误消息</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">.code</span><br><span class="line">start:		</span><br><span class="line">		       </span><br><span class="line"></span><br><span class="line">	.code</span><br><span class="line">	call GetLastError</span><br><span class="line">	mov messageId,eax</span><br><span class="line">	INVOKE	FormatMessage,</span><br><span class="line">		FORMAT_MESSAGE_ALLOCATE_BUFFER + FORMAT_MESSAGE_FROM_SYSTEM, </span><br><span class="line">		NULL, </span><br><span class="line">		messageId, </span><br><span class="line">		0,</span><br><span class="line">		ADDR pErrorMsg, </span><br><span class="line">		0, </span><br><span class="line">		NULL</span><br><span class="line">	INVOKE LocalFree, pErrorMsg	</span><br><span class="line">	invoke	ExitProcess,NULL</span><br><span class="line">end start</span><br><span class="line">;-----------------------------------------------------</span><br></pre></td></tr></table></figure>



<h3 id="ReadChar-x2F-ReadKey-获取当前按键"><a href="#ReadChar-x2F-ReadKey-获取当前按键" class="headerlink" title="ReadChar&#x2F;ReadKey 获取当前按键"></a>ReadChar&#x2F;ReadKey 获取当前按键</h3><ul>
<li><p>ReadChar：等待键盘输入一个 ASCII 字符，并用 AL 返回该字符。</p>
</li>
<li><p>ReadKey：过程执行无等待键盘检查。</p>
<p>  如果控制台输入缓冲区中没有等待的按键，则ZF &#x3D; 1。</p>
<p>  如果发现有按键，则ZF&#x3D;0且 AL 等于零或 ASCII 码。EAX 和 EDX 的高 16 位被覆盖。</p>
</li>
</ul>
<p>​		如果  AL 等于 0，那么用户可能按下了特殊键（功能键、光标箭头等）。</p>
<p>​		AH 寄存器为键盘扫描码。DX 为虚拟键	码，EBX 为键盘控制键状态信息。</p>
<p>下表为控制键值列表。调用 ReadKey 之后，可以用 TEST 指令检查各种键值。</p>
<table>
<thead>
<tr>
<th>值</th>
<th>含义</th>
<th>值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>CAPSLOCK_ON</td>
<td>CAPSLOCK 指示灯亮</td>
<td>RIGHT_ALT_PRESSED</td>
<td>右 ALT 键被按下</td>
</tr>
<tr>
<td>ENHANCED_KEY</td>
<td>被按下增强的</td>
<td>RIGHT_CTRL_PRESSED</td>
<td>右 CTRL 键被按下</td>
</tr>
<tr>
<td>LEFT_ALT_PRESSED</td>
<td>该键是左 ALT 键</td>
<td>SCROLLLOCL_ON</td>
<td>SCROLLLOCK 指示灯亮</td>
</tr>
<tr>
<td>LEFT_CTRL_PRESSED</td>
<td>左 CTRL 键被按下</td>
<td>SHIFT_PRESSED</td>
<td>SHIFT 键被按下</td>
</tr>
<tr>
<td>NUMLOCK_ON</td>
<td>NUMLOCK 指示灯亮</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="GetKeyState-获取当前按下的键"><a href="#GetKeyState-获取当前按下的键" class="headerlink" title="GetKeyState 获取当前按下的键"></a>GetKeyState 获取当前按下的键</h3><p>通过测试单个键盘按键可以发现当前按下的是哪个键。方法是调用 API 函数 GetKeyState。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetKeyState PROTO, nVirtKey:DWORD</span><br></pre></td></tr></table></figure>

<p>向该函数传递如下表所示的虚拟键值。测试程序必须按照同一个表来测试 EAX 里面的返回值。</p>
<table>
<thead>
<tr>
<th>按键</th>
<th>虚拟键符号</th>
<th>EAX 中被测试的位</th>
</tr>
</thead>
<tbody><tr>
<td>NumLock</td>
<td>VK_NUMLOCK</td>
<td>0</td>
</tr>
<tr>
<td>Scroll Lock</td>
<td>VK_SCROLL</td>
<td>0</td>
</tr>
<tr>
<td>Left Shift</td>
<td>VK_LSHIFT</td>
<td>15</td>
</tr>
<tr>
<td>Right Shift</td>
<td>VK_tRSHIFT</td>
<td>15</td>
</tr>
<tr>
<td>Left Ctrl</td>
<td>VK_LCONTROL</td>
<td>15</td>
</tr>
<tr>
<td>Right Ctrl</td>
<td>VK_RCONTROL</td>
<td>15</td>
</tr>
<tr>
<td>Left Menu</td>
<td>VK_LMENU</td>
<td>15</td>
</tr>
<tr>
<td>Right Menu</td>
<td>VK_RMENU</td>
<td>15</td>
</tr>
</tbody></table>
<h2 id="窗口输出"><a href="#窗口输出" class="headerlink" title="窗口输出"></a>窗口输出</h2><h3 id="WriteConsole-输出"><a href="#WriteConsole-输出" class="headerlink" title="WriteConsole 输出"></a>WriteConsole 输出</h3><p>函数 WriteConsole 在控制台窗口的当前光标所在位置写一个字符串，并将光标留着字符串末尾右边的字符位置上。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">WriteConsole PROTO,</span><br><span class="line">  hConsoleOutput:HANDLE,</span><br><span class="line">  lpBuffer:PTR BYTE,</span><br><span class="line">  nNumberOfCharsToWrite:DWORD,</span><br><span class="line">  lpNumberOfCharsWritten:PTR DWORD,</span><br><span class="line">  lpReserved:DWORD</span><br></pre></td></tr></table></figure>

<p>hConsoleOutput 是控制台输出流句柄；</p>
<p>lpBuffer 是输出字符数组的指针；</p>
<p>nNumberOfCharsToWrite 是数组长度；</p>
<p>lpNumberOfCharsWritten 是函数返回时实际输出字符数量的整数指针。</p>
<p>最后一个参数未使用，因此将其设置为 0。</p>
<p>例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">include		Dqx.inc</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">			.data	</span><br><span class="line">endl EQU &lt;0dh,0ah&gt;</span><br><span class="line"></span><br><span class="line">b_str label byte</span><br><span class="line">	BYTE &quot;hello I am here&quot;,0Ah</span><br><span class="line">	BYTE &quot;I have no friends &quot;,0Ah</span><br><span class="line">	BYTE &quot;This is my friend.&quot;, endl</span><br><span class="line">len	DWORD ($-b_str)</span><br><span class="line"></span><br><span class="line">A_Output_Handle	HANDLE 0     ; 标准输出设备句柄</span><br><span class="line">how_much	DWORD ?      ; 输出字节数</span><br><span class="line"></span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">.code</span><br><span class="line">start:		</span><br><span class="line">	</span><br><span class="line">		INVOKE GetStdHandle, STD_OUTPUT_HANDLE</span><br><span class="line">		mov A_Output_Handle,eax</span><br><span class="line"></span><br><span class="line">		INVOKE WriteConsole,</span><br><span class="line">		A_Output_Handle,        ; 控制台输出句柄</span><br><span class="line">		ADDR b_str,		; 字符串指针</span><br><span class="line">		len,			; 字符长度</span><br><span class="line">		ADDR how_much,		; 返回输出字节数</span><br><span class="line">		0                       ; 未使用</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	invoke	ExitProcess,NULL</span><br><span class="line">end start</span><br><span class="line">;-----------------------------------------------------</span><br></pre></td></tr></table></figure>



<h3 id="WriteConsoleOutputCharacter"><a href="#WriteConsoleOutputCharacter" class="headerlink" title="WriteConsoleOutputCharacter"></a>WriteConsoleOutputCharacter</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">WriteConsoleOutputCharacter PROTO,</span><br><span class="line">    hConsoleOutput:HANDLE,                         		 ;控制台输出句柄</span><br><span class="line">    lpCharacter :PTR BYTE,                               ;缓冲区指针</span><br><span class="line">    nLength: DWORD,                                      ;缓冲区大小</span><br><span class="line">    dwWriteCoord: COORD,                             	 ;第一个单元格的坐标</span><br><span class="line">    lpNumberOfCharsWritten: PTR DWORD   				 ;输出计数器</span><br></pre></td></tr></table></figure>



<p>下面是一个失败的例子</p>
<p>还要修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">include		Dqx.inc</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">			.data	</span><br><span class="line">endl EQU &lt;0dh,0ah&gt;</span><br><span class="line"></span><br><span class="line">b_str label byte</span><br><span class="line">	BYTE &quot;hello I am here&quot;,0Ah</span><br><span class="line">	BYTE &quot;I have no friends &quot;,0Ah</span><br><span class="line">	BYTE &quot;This is my friend.&quot;, endl</span><br><span class="line">len	DWORD ($-b_str)</span><br><span class="line"></span><br><span class="line">A_Output_Handle	HANDLE 0     ; 标准输出设备句柄</span><br><span class="line">how_much	DWORD ?      ; 输出字节数</span><br><span class="line">dwWriteCoord	COORD	&lt;0,0&gt;</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">.code</span><br><span class="line">start:		</span><br><span class="line">	</span><br><span class="line">		INVOKE GetStdHandle, STD_OUTPUT_HANDLE</span><br><span class="line">		mov A_Output_Handle,eax</span><br><span class="line"></span><br><span class="line">		INVOKE WriteConsoleOutputCharacter,</span><br><span class="line">		A_Output_Handle,        ; 控制台输出句柄</span><br><span class="line">		ADDR b_str,		; 字符串指针</span><br><span class="line">		len,			; 字符长度</span><br><span class="line">		dwWriteCoord,		; 返回输出字节数</span><br><span class="line">		ADDR how_much                 ; 未使用</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	invoke	ExitProcess,NULL</span><br><span class="line">end start</span><br><span class="line">;-----------------------------------------------------</span><br></pre></td></tr></table></figure>



<h2 id="文件-处理"><a href="#文件-处理" class="headerlink" title="文件 处理"></a>文件 处理</h2><h3 id="CreateFile"><a href="#CreateFile" class="headerlink" title="CreateFile"></a>CreateFile</h3><p>函数 CreateFile 可以创建一个新文件或者打开一个已有文件。</p>
<p>如果调用成功，函数返回打开文件的句柄；</p>
<p>否则，返回特殊常数 INVALID_HANDLE_VALUEO</p>
<p> 原型如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CreateFile PROTO,                           ;创建新文件</span><br><span class="line">    lpFilename:PTR BYTE,                    ;文件名指针</span><br><span class="line">    dwDesiredAccess:DWORD,              	;访问模式</span><br><span class="line">    dwShareMode:DWORD,                  	;共享模式</span><br><span class="line">    lpSecurityAttributes:DWORD,          	;安全属性指针</span><br><span class="line">    dwCreationDisposition:DWORD,     		;文件创建选项</span><br><span class="line">    dwFlagsAndAttributes:DWORD,      		;文件属性</span><br><span class="line">    hTemplateFile:DWORD                    	;文件模板句柄</span><br></pre></td></tr></table></figure>



<p>下表对参数进行了说明。如果函数调用失败则返回值为零。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>lpFileName</td>
<td>指向一个<code>0</code>空字节结束字符串，该串为部分或全部合格的文件名  例如（C:\path\filename）</td>
</tr>
<tr>
<td>dwDesiredAccess</td>
<td>指定文件访问方式（读或写）</td>
</tr>
<tr>
<td>dwShareMode</td>
<td>控制多个程序对打开文件的访问能力</td>
</tr>
<tr>
<td>lpSecurityAttributes</td>
<td>指向安全结构，该结构控制安全权限</td>
</tr>
<tr>
<td>dwCreationDisposition</td>
<td>指定文件存在或不存在时的操作</td>
</tr>
<tr>
<td>dwFlagsAndAttributes</td>
<td>包含位标志指定文件属性，如存档、加密、隐藏、普通、系统和临时</td>
</tr>
<tr>
<td>hTemplateFile</td>
<td>包含一个可选的文件模板句柄，该文件为已创建的文件提供文件属性和扩展属性；如果不使用该参数，就将其设置为 0</td>
</tr>
</tbody></table>
<p>关于上面说到的参数</p>
<p> dwDesiredAccess</p>
<p>参数 dwDesiredAccess 允许指定对文件进行读访问、写访问、读&#x2F;写访问，或者设备查询访问。</p>
<p>可以从下表列出的值中选择，也可以从表中未列出的更多特定标志值选择。</p>
<table>
<thead>
<tr>
<th>值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>为对象指定设备查询访问。应用程序可以查询设备属性而无需访问设备，也可以检查文件是否存在</td>
</tr>
<tr>
<td>GENERIC_READ</td>
<td>读访问。可以从文件中读取数据，文件指针可以移动。与 GENERIC_WRITE 一起使用为读&#x2F;写访问</td>
</tr>
<tr>
<td>GENERIC_WRITE</td>
<td>写访问。可以向文件中写入数据，文件指针可以移动。与 GENERIC_READ 一起使用为读&#x2F;写访问</td>
</tr>
</tbody></table>
<p>dwCreationDisposition</p>
<p>参数 dwCreationDisposition 指定当文件存在或不存在时应采取怎样的操作。可从下表中选择一个值。</p>
<table>
<thead>
<tr>
<th>值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>CREATE_NEW</td>
<td>创建一个新文件。要求将参数 dwDesiredAccess 设置为 GENERIC_WRITE。如果文件已经存在，则函数调用失败</td>
</tr>
<tr>
<td>CREATE_ALWAYS</td>
<td>创建一个新文件。如果文件已存在，则函数会覆盖原文件，清除现有属性，并合并文件 属性与预定义的常数 FILE_ATTRIBUTES_ARCHIVE 中属性参数指定的标志。要求将参数 dwDesiredAccess 设置为 GENERIC WRITE</td>
</tr>
<tr>
<td>OPEN_EXISTING</td>
<td>打开文件。如果文件不存在，则函数调用失败。可用于读取和&#x2F;或写入文件</td>
</tr>
<tr>
<td>OPEN_ALWAYS</td>
<td>如果文件存在，则打开文件。如果不存在，则函数创建文件，就好像CreateDisposition 的值为 CREATE NEW</td>
</tr>
<tr>
<td>TRUNCATE_EXISTING</td>
<td>打开文件。一旦打开，文件将被截断，使其大小为零。要求将参数 dwDesiredAccess 设置为 GENERIC_WRITE。如果文件不存在，则函数调用失败</td>
</tr>
</tbody></table>
<p>下表列出了参数 dwFlagsAndAttributes 比较常用的值。</p>
<p>允许任意属性组合，除了 FILE_ATTRIBUTE_NORMAL 会被其他 所有属性覆盖。</p>
<p>这些值能映射为 2 的幂，因此可以用汇编时 OR 运算符或 + 运算符将它们组 合为一个参数：</p>
<p>例如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FILE_ATTRIBUTE_HIDDEN OR FILE_ATTRIBUTE_READONLY</span><br><span class="line">FILE_ATTRIBUTE_HIDDEN + FILE_ATTRIBUTE_READONLY</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>属性</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>FILE_ATTRIBUTE_ARCHIVE</td>
<td>文件存档。应用程序使用这个属性标记文件以便备份或移动</td>
</tr>
<tr>
<td>FILE_ATTRIBUTE_HIDDEN</td>
<td>文件隐藏。不包含在普通目录列表中</td>
</tr>
<tr>
<td>FILE_ATTRIBUTE_NORMAL</td>
<td>文件没有其他属性设置。该属性只在单独使用时有效</td>
</tr>
<tr>
<td>FILE_ATTRIBUTE_READONLY</td>
<td>文件只读。应用程序可以读文件但不能写或删除文件</td>
</tr>
<tr>
<td>FILE_ATTRIBUTE_TEMPORARY</td>
<td>文件被用于临时存储</td>
</tr>
</tbody></table>
<p>打开并读取（输入）已存在文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">INVOKE CreateFile,</span><br><span class="line">    ADDR filename,            ;文件名指针</span><br><span class="line">    GENERIC_READ,             ;读文件</span><br><span class="line">    DO_NOT_SHARE,             ;共享模式</span><br><span class="line">    NULL,                     ;安全属性指针</span><br><span class="line">    OPEN_EXISTING,            ;打开已存在文件</span><br><span class="line">    FILE_ATTRIBUTE_NORMALA    ;普通文件属性</span><br><span class="line">    0                         ;未使用</span><br></pre></td></tr></table></figure>





<p>打开并写入（输出）已存在文件。</p>
<p>文件打开后，可以通过写入覆盖当前数据，</p>
<p>或者将文件指针移到末尾，向文件添加新数据（参见11.1.6节的SetFilePointer）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">INVOKE CreateFile,</span><br><span class="line">    ADDR filename,</span><br><span class="line">    GENERIC_WRITEZ,      ;写文件</span><br><span class="line">    DO_NOT_SHARE,			;共享模式</span><br><span class="line">    NULL,				;安全属性指针</span><br><span class="line">    OPEN_EXISTIN,       ;文件必须存在</span><br><span class="line">    FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">    0					 ;未使用</span><br></pre></td></tr></table></figure>



<p>创建有普通属性的新文件，并删除所有已存在的同名文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">INVOKE CreateFile,</span><br><span class="line">    ADDR filename,</span><br><span class="line">    GENERIC_WRITE,       ;写文件</span><br><span class="line">    DO _NOT_SHARE,</span><br><span class="line">    NULL,</span><br><span class="line">    CREATE_ALWAYS,       ;覆盖已存在的文件</span><br><span class="line">    FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">    0</span><br></pre></td></tr></table></figure>



<p>若文件不存在，则创建文件；否则打开并输出现有文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">INVOKE CreateFile,</span><br><span class="line">    ADDR filename,</span><br><span class="line">    GENERIC_WRITE,         ;写文件</span><br><span class="line">    DO_NOT_SHARE,</span><br><span class="line">    NULL,</span><br><span class="line">    CREATE_NEW,            ;不删除已存在文件</span><br><span class="line">    FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">    0</span><br></pre></td></tr></table></figure>



<h3 id="CloseHandle"><a href="#CloseHandle" class="headerlink" title="CloseHandle"></a>CloseHandle</h3><p> 函数 CloseHandle 关闭一个打开的对象句柄。其原型如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CloseHandle PROTO,</span><br><span class="line">    hObject: HANDLE ;对象句柄</span><br></pre></td></tr></table></figure>



<h3 id="ReadFile"><a href="#ReadFile" class="headerlink" title="ReadFile"></a>ReadFile</h3><p>函数 ReadFile 从输入文件中读取文本。其原型如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ReadFile PROTO,</span><br><span class="line">    hFile:HANDLE,                                           ;输入句柄</span><br><span class="line">    lpBuffer:PTR BYTE,                                     	;缓冲区指针</span><br><span class="line">    nNumberOfBytesToRead:DWORD,           					;读取的字节数</span><br><span class="line">    lpNumberOfBytesRead:PTR DWORD,       					;实际读出的 字节数</span><br><span class="line">    lpOverlapped:PTR DWORD                       			;异步信息指针</span><br></pre></td></tr></table></figure>



<p>其中：</p>
<ul>
<li>hFile 是由 CreateFile 返回的打开文件的句柄；</li>
<li>lpBuffer 指向的缓冲区接收从该文件读取的数据；</li>
<li>nNumberOfBytesToRead 定义从该文件读取的最大字节数；</li>
<li>lpNumberOfBytesRead 指向的整数为函数返回时实际读取的字节数；</li>
<li>lpOverlapped 应被设置为 NULL(0)。若函数调用失败，则返回值为零。</li>
</ul>
<p>如果对同一个打开文件的句柄进行多次调用，那么 ReadFile 就会记住最后一次读取的位置，并从这个位置开始读。换句话说，函数有一个内部指针指向文件内的当前位置。</p>
<h3 id="WriteFile"><a href="#WriteFile" class="headerlink" title="WriteFile"></a>WriteFile</h3><p>函数 WriteFile 用输出句柄向文件写入数据。</p>
<p>句柄可以是屏幕缓冲区句柄，</p>
<p>也可以是分配给文本文件的句柄。</p>
<p>函数从文件内部位置指针所指向的位置开始写数据。</p>
<p>写操作完成后，文件位置指针按照实际写入的字节数进行调整。函数原型如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">WriteFile PROTO,</span><br><span class="line">    hFile:HANDLE,                                           ;输出句柄</span><br><span class="line">    lpBuffer:PTR BYTE,                                     	;缓冲区指针</span><br><span class="line">    nNumberOfBytesToWrite:DWORD,           					;缓冲区大小</span><br><span class="line">    lpNumberOfBytesWritten:PTR DWORD,   					;写入字节数</span><br><span class="line">    lpOverlapped:PTR DWORD                       			;异步信息指针</span><br></pre></td></tr></table></figure>



<p>中：</p>
<ul>
<li>hFile 是已打开文件的句柄；</li>
<li>lpBuffer 指向的缓冲区包含了写入到文件的数据；</li>
<li>nNumberOfBytesToWrite 指定向文件写入多少字节；</li>
<li>lpNumberOfBytesWritten 指向的整数为函数执行后实际写入的字节数；</li>
<li>若为同步操作，则 lpOverlapped 应被设置为 NULL。若函数调用失败，则返回值为零。</li>
</ul>
<h3 id="SetFilePointer"><a href="#SetFilePointer" class="headerlink" title="SetFilePointer"></a>SetFilePointer</h3><p>函数 SetFilePointer 移动打开文件的位置指针。该函数可以用于向文件添加数据，或是执行随机访问记录处理：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SetFilePointer PROTO,</span><br><span class="line">    hFile:HANDLE,                                          ;文件句柄</span><br><span class="line">    lpDistanceToMove:SDWORD,                  				;指针移动 字节数</span><br><span class="line">    lpDistanceToMoveHigh:PTR SDWORD,   						;指针移动字节数，高双字</span><br><span class="line">    dwMoveMethod:DWORD                        				;起点</span><br></pre></td></tr></table></figure>



<p>lpDistance移动距离本身为 64 位有符号整数值，分为两个部分：</p>
<ul>
<li>lpDistanceToMove：低 32 位</li>
<li>lpDistanceToMoveHigh：含有高 32 位的变量指针</li>
<li></li>
</ul>
<p>dwMoveMode 指定文件指针移动的起点，选择项为 3 个预定义符号：FILE_BEGIN、FILE_CURRENT 和 FILE_END。</p>
<p>若函数调用失败，则返回值为零。</p>
<p>如果 lpDistanceToMoveHigh 为空，则只用 lpDistanceToMove 的值来移动文件指针。例如，下面的代码准备添加到一个文件末尾：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INVOKE SetFilePointer,</span><br><span class="line">  fileHandle,    ;文件句柄</span><br><span class="line">  0,           ;距离低32位</span><br><span class="line">  0,           ;距离高32位</span><br><span class="line">  FILE_END     ;移动模式</span><br></pre></td></tr></table></figure>





<h2 id="控制台窗口操作"><a href="#控制台窗口操作" class="headerlink" title="控制台窗口操作"></a>控制台窗口操作</h2><p>下列函数影响的是控制台窗口及其相对于屏幕缓冲区的位置：</p>
<ul>
<li>SetConsoleWindowInfo：设置控制台窗口相对于屏幕缓冲区的大小和位置。</li>
<li>GetConsoleScreenBufferInfo：返回（还包括其他一些信息）控制台窗口相对于屏幕缓冲区的矩形坐标。</li>
<li>SetConsoleCursorPosition：将光标设置在屏幕缓冲区内的任何位置；如果区域不可见，则移动控制台窗口直到光标可见。</li>
<li>ScrollConsoleScreenBuffer：移动屏幕缓冲区中的一些或全部文本，本函数会影响控制台窗口显示的文本。</li>
</ul>
<h3 id="SetConsoleTitle"><a href="#SetConsoleTitle" class="headerlink" title="SetConsoleTitle"></a>SetConsoleTitle</h3><p>改变控制台窗口的标题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.data</span><br><span class="line">.titleStr BYTE &quot;Console title&quot;, 0</span><br><span class="line">.code</span><br><span class="line">INVOKE SetConsoleTitle, ADDR titleStr</span><br></pre></td></tr></table></figure>



<h3 id="GetConsoleScreenBufferInfo"><a href="#GetConsoleScreenBufferInfo" class="headerlink" title="GetConsoleScreenBufferInfo"></a>GetConsoleScreenBufferInfo</h3><p>函数 GetConsoleScreenBufferInfo 返回控制台窗口的当前状态信息。它有两个参数：控制台屏幕的句柄和指向该函数填充的结构的指针：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GetConsoleScreenBufferInfo PROTO,</span><br><span class="line">    hConsoleOutput:HANDLE,</span><br><span class="line">    lpConsoleScreenBufferInfo:PTR CONSOLE_SCREEN_BUFFER_INFO</span><br></pre></td></tr></table></figure>





<p>函数示例调用如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.data</span><br><span class="line">consoleInfo CONSOLE_SCREEN_BUFFER_INFO &lt;&gt;</span><br><span class="line">outHandle HANDLE ?</span><br><span class="line">.code</span><br><span class="line">INVOKE GetConsoleScreenBufferInfo, outHandle,</span><br><span class="line">  ADDR consoleInfo</span><br></pre></td></tr></table></figure>



<p>CONSOLE_SCREEN_BUFFER_INFO 结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CONSOLE_SCREEN_BUFFER_INFO STRUCT</span><br><span class="line">    dwSize COORD &lt;&gt;</span><br><span class="line">    dwCursorPosition COORD &lt;&gt;</span><br><span class="line">    wAttributes WORD ?</span><br><span class="line">    srWindow SMALL_RECT &lt;&gt;</span><br><span class="line">    dwMaximumWindowSize COORD &lt;&gt;</span><br><span class="line">CONSOLE_SCREEN_BUFFER_INFO ENDS</span><br></pre></td></tr></table></figure>

<p>dwSize 按字符行列数返回屏幕缓冲区大小。</p>
<p>dwCursorPosition 返回光标的位置。这两个字段都是 COORD 结构。</p>
<p>wAttributes 返回字符的前景色和背景色，字符由诸如 WriteConsole 和 WriteFile 等函数写到控制台。</p>
<p>srWindow 返回控制台窗口相对于屏幕缓冲区的坐标。</p>
<p>dwMaximumWindowSize 以当前屏幕缓冲区的大小、字体和视频显示大小为基础，返回控制台窗口的最大尺寸。</p>
<h3 id="SetConsoleWindowInfo"><a href="#SetConsoleWindowInfo" class="headerlink" title="SetConsoleWindowInfo"></a>SetConsoleWindowInfo</h3><p>函数 SetConsoleWindowInfo 可以设置控制台窗口相对于其屏幕缓冲区的大小和位置。函数原型如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SetConsoleWindowInfo PROTO,</span><br><span class="line">    hConsoleOutput:HANDLE,                  ;屏幕缓冲区句柄</span><br><span class="line">    bAbsolute:DWORD,                             ;坐标类型</span><br><span class="line">    lpConsoleWindow:PTR SMALL_RECT  ;矩形窗口指针</span><br></pre></td></tr></table></figure>



<p>bAbsolute 说明如何使用结构中由 lpConsoleWindow 指出的坐标。</p>
<p>如果 bAbsolute 为真，则坐标定义控制台窗口新的左上角和右下角。</p>
<p>如果 bAbsolute 为假，则坐标与当前窗口坐标相加。</p>
<p>什么叫真真假假????写一个1,他也是32位的BOOL值</p>
<p>例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">include		Dqx.inc</span><br><span class="line"></span><br><span class="line">; Appending to a File                   (AppendFile.asm)</span><br><span class="line"></span><br><span class="line">; This program appends text to an existing file.</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">message		BYTE &quot;:  This line of text was written &quot;</span><br><span class="line">		BYTE &quot;I am Dqx_Gh0st!&quot;,0dh,0ah</span><br><span class="line"></span><br><span class="line">messageSize	DWORD ($-message)</span><br><span class="line">outHandle	HANDLE 0                     ; 标准输出句柄</span><br><span class="line">bytesWritten	DWORD ?                      ; 已写入字节数</span><br><span class="line">lineNum		DWORD 0</span><br><span class="line">windowRect	SMALL_RECT &lt;0,0,60,11&gt;       ; 上，下，左，右</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.code</span><br><span class="line">start:</span><br><span class="line"></span><br><span class="line">	INVOKE GetStdHandle, STD_OUTPUT_HANDLE</span><br><span class="line">	mov outHandle,eax</span><br><span class="line"></span><br><span class="line">	.REPEAT</span><br><span class="line">                  </span><br><span class="line">	INVOKE WriteConsole,</span><br><span class="line">	outHandle,                           ; 控制台输出句柄</span><br><span class="line">	ADDR message,                        ; 字符串指针</span><br><span class="line">	messageSize,                         ; 字符串长度</span><br><span class="line">	ADDR bytesWritten,                   ; 返回已写字节数</span><br><span class="line">	0                                    ; 未使用</span><br><span class="line">	inc  lineNum                         ; 下一行编号</span><br><span class="line">	.UNTIL lineNum &gt; 5</span><br><span class="line"></span><br><span class="line">	; 调整控制台窗口相对于屏幕缓冲区的大小和位置</span><br><span class="line">	INVOKE SetConsoleWindowInfo,</span><br><span class="line">	outHandle,</span><br><span class="line">	TRUE,</span><br><span class="line">	ADDR windowRect</span><br><span class="line"></span><br><span class="line">	invoke	ExitProcess,NULL</span><br><span class="line">end start</span><br><span class="line">;-----------------------------------------------------</span><br></pre></td></tr></table></figure>



<h3 id="SetConsoleScreenBufferSize"><a href="#SetConsoleScreenBufferSize" class="headerlink" title="SetConsoleScreenBufferSize"></a>SetConsoleScreenBufferSize</h3><p>可以将屏幕缓冲区设置为 X 列 * Y 行。其原型如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SetConsoleScreenBufferSize PROTO,</span><br><span class="line">    hConsoleOutput:HANDLE,                 			;屏幕缓冲区句柄</span><br><span class="line">    dwSize:COORD                                   ;新屏幕缓冲区大小</span><br></pre></td></tr></table></figure>



<h2 id="控制台光标设置函数"><a href="#控制台光标设置函数" class="headerlink" title="控制台光标设置函数"></a>控制台光标设置函数</h2><p>Win32 API 提供了函数用于设置控制台应用光标的大小、可见度和屏幕位置。</p>
<p>与这些函数相关的重要是 CONSOLE_CURSOR_INFO，其中包含了控制台光标的大小和可见度信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CONSOLE_CURSOR_INFO STRUCT</span><br><span class="line">    dwSize DWORD ?</span><br><span class="line">    bVisible DWORD ?</span><br><span class="line">CONSOLE_CURSOR_INFO ENDS</span><br></pre></td></tr></table></figure>

<p>wSize 为光标填充的字符单元格的百分比（从 1 到 100）。</p>
<p>如果光标可见，则 bVisible 等于 TRUE(1)。</p>
<h3 id="GetConsoleCursorInfo"><a href="#GetConsoleCursorInfo" class="headerlink" title="GetConsoleCursorInfo"></a>GetConsoleCursorInfo</h3><p>返回控制台光标的大小和可见度。需向其传递指向结构 CONSOLE_CURSOR_INFO 的指针：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GetConsoleCursorInfo PROTO,</span><br><span class="line">    hConsoleOutput:HANDLE,</span><br><span class="line">    lpConsoleCursorInfo:PTR CONSOLE_CURSOR_INFO</span><br></pre></td></tr></table></figure>

<p>默认情况下，光标大小为 25，这表示光标占据了 25% 的字符单元格</p>
<h3 id="SetConsoleCursorInfo"><a href="#SetConsoleCursorInfo" class="headerlink" title="SetConsoleCursorInfo"></a>SetConsoleCursorInfo</h3><p>设置光标的大小和可见度。需向其传递指向结构 CONSOLE_CURSOR_INFO 的指针：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SetConsoleCursorInfo PROTO,</span><br><span class="line">    hConsoleOutput:HANDLE,</span><br><span class="line">    lpConsoleCursorInfo:PTR CONSOLE_CURSOR_INFO</span><br></pre></td></tr></table></figure>



<h3 id="SetConsoleCursorPosition"><a href="#SetConsoleCursorPosition" class="headerlink" title="SetConsoleCursorPosition"></a>SetConsoleCursorPosition</h3><p>设置光标的 X、Y 位置。向其传递一个 COORD 结构和控制台输岀句柄：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SetConsoleCursorPosition PROTO,</span><br><span class="line">    hConsoleOutput:DWORD,    ;输入模式句柄</span><br><span class="line">    dwCursorPosition:COORD    ;屏幕 X、Y 坐标</span><br></pre></td></tr></table></figure>



<h2 id="控制台文本颜色"><a href="#控制台文本颜色" class="headerlink" title="控制台文本颜色"></a>控制台文本颜色</h2><p>控制台窗口中的文本颜色有两种控制方法。</p>
<ul>
<li>通过调用 SetConsoleTextAttribute 来改变当前文本颜色，这种方法会影响控制台中所有后续输出文本。</li>
<li>调用 WriteConsoleOutputAttribute 来设置指定单元格的属性。函数 GetConsoleScreenBufferlnfo 返回当前屏幕的颜色以及其他控制台信息。</li>
</ul>
<h3 id="SetConsoleTextAttribute"><a href="#SetConsoleTextAttribute" class="headerlink" title="SetConsoleTextAttribute"></a>SetConsoleTextAttribute</h3><p>函数 SetConsoleTextAttribute 可以设置控制台窗口所有后续输出文本的前景色和背景色。原型如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SetConsoleTextAttribute PROTO,</span><br><span class="line">    hConsoleOutput:HANDLE,           ;控制台输出句柄</span><br><span class="line">    wAttributes : WORD                     ;颜色属性</span><br></pre></td></tr></table></figure>

<p>颜色值保存在 wAttributes 参数的低字节中。</p>
<h3 id="WriteConsoleOutputAttribute"><a href="#WriteConsoleOutputAttribute" class="headerlink" title="WriteConsoleOutputAttribute"></a>WriteConsoleOutputAttribute</h3><p>函数 WriteConsoleOutputAttribute 从指定位置开始，向控制台屏幕缓冲区的连续单元格复制一组属性值。原型如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">WriteConsoleOutputAttribute PROTO,</span><br><span class="line">    hConsoleOutput:DWORD,                               ;输出句柄</span><br><span class="line">    lpAttribute:PTR WORD,                                   ;写属性</span><br><span class="line">    nLength:DWORD,                                            ;单元格数</span><br><span class="line">    dwWriteCoord :COORD,                                  ;第一个单元格坐标</span><br><span class="line">    lpNumberOfAttrsWritten:PTR DWORD           ;输出计数</span><br></pre></td></tr></table></figure>



<p>其中：</p>
<ul>
<li>lpAttribute 指向属性数组，其中每个字节的低字节都包含了颜色值；</li>
<li>nLength 为数组长度；</li>
<li>dwWriteCoord 为接收属性的开始屏幕单元格；</li>
<li>lpNumberOfAttrsWritten 指向一个变量，其中保存的是已写单元格的数量。</li>
</ul>
<p>例子</p>
<p>这个例子有误,后续改进</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">include		Dqx.inc</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">outHandle    HANDLE ?</span><br><span class="line">cellsWritten DWORD ?</span><br><span class="line">xyPos COORD &lt;10,2&gt;</span><br><span class="line">; 字符编号数组</span><br><span class="line">buffer BYTE 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15</span><br><span class="line">       BYTE 16,17,18,19.20</span><br><span class="line">BufSize DWORD ($ - buffer)</span><br><span class="line">; 属性数组</span><br><span class="line">attributes WORD 0Fh,0Eh,0Dh,0Ch,0Bh,0Ah,9,8,7,6</span><br><span class="line">           WORD 5,4,3,2,1,0F0h,0E0h,0D0h,0C0h,0B0h</span><br><span class="line"></span><br><span class="line">.code</span><br><span class="line">start:</span><br><span class="line"></span><br><span class="line">	; 获取控制台标准输出句柄</span><br><span class="line">	INVOKE GetStdHandle,STD_OUTPUT_HANDLE</span><br><span class="line">	mov outHandle,eax</span><br><span class="line">	; 设置相邻单元格颜色</span><br><span class="line">	INVOKE WriteConsoleOutputAttribute,</span><br><span class="line">	outHandle, ADDR attributes,</span><br><span class="line">	BufSize, xyPos,</span><br><span class="line">	ADDR cellsWritten</span><br><span class="line">	; 写 1 到 20 号字符</span><br><span class="line">	INVOKE WriteConsoleOutputCharacter,</span><br><span class="line">	outHandle, ADDR buffer, BufSize,</span><br><span class="line">	xyPos, ADDR cellsWritten</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	invoke	ExitProcess,NULL</span><br><span class="line">end start</span><br><span class="line">;-----------------------------------------------------</span><br></pre></td></tr></table></figure>



<h2 id="Win32时间与日期函数"><a href="#Win32时间与日期函数" class="headerlink" title="Win32时间与日期函数"></a>Win32时间与日期函数</h2><h3 id="函数一览表-1"><a href="#函数一览表-1" class="headerlink" title="函数一览表"></a>函数一览表</h3><table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>CompareFileTime</td>
<td>比较两个 64 位的文件时间</td>
</tr>
<tr>
<td>DosDateTimeToFileTime</td>
<td>把 MS-DOS 日期和时间值转换为一个 64 位的文件时间</td>
</tr>
<tr>
<td>FileTimeToDosDateTime</td>
<td>把 64 位文件时间转换为 MS-DOS 日期和时间值</td>
</tr>
<tr>
<td>FileTimeToLocalFileTime</td>
<td>把 UTC（通用协调时间）文件时间转换为本地文件时间</td>
</tr>
<tr>
<td>FileTimeToSystemTime</td>
<td>把 64 位文件时间转换为系统时间格式</td>
</tr>
<tr>
<td>GetFileTime</td>
<td>检索文件创建、最后访问和最后修改的日期与时间</td>
</tr>
<tr>
<td>GetLocalTime</td>
<td>检索当前本地日期和时间</td>
</tr>
<tr>
<td>GetSystemTime</td>
<td>以 UTC 格式检索当前系统日期和时间</td>
</tr>
<tr>
<td>GetSystemTimeAdjustment</td>
<td>决定系统是否对其日历钟进行周期性时间调整</td>
</tr>
<tr>
<td>GetSystemTimeAsFileTime</td>
<td>以 UTC 格式检索当前系统日期和时间</td>
</tr>
<tr>
<td>GetTickCount</td>
<td>检索自系统启动后经过的毫秒数</td>
</tr>
<tr>
<td>GetTimeZoneInformation</td>
<td>检索当前时区参数</td>
</tr>
<tr>
<td>LocalFileTimeToFileTime</td>
<td>把本地文件时间转换为基于 UTC 的文件时间</td>
</tr>
<tr>
<td>SetFileTime</td>
<td>设置文件创建、最后访问和最后修改的日期与时间</td>
</tr>
<tr>
<td>SetLocalTime</td>
<td>设置当前本地时间与日期</td>
</tr>
<tr>
<td>SetSystemTime</td>
<td>设置当前系统时间与日期</td>
</tr>
<tr>
<td>SetSystemTimeAdjustment</td>
<td>启用或禁用对系统日历钟进行周期性时间调整</td>
</tr>
<tr>
<td>SetTimeZoneInformation</td>
<td>设置当前时区参数</td>
</tr>
<tr>
<td>SystemTimeToFileTime</td>
<td>把系统时间转换为文件时间</td>
</tr>
<tr>
<td>SystemTimeToTzSpecificLocalTime</td>
<td>把 UTC 时间转换为指定时区对应的本地时间</td>
</tr>
</tbody></table>
<h3 id="SYSTEMTIME-结构"><a href="#SYSTEMTIME-结构" class="headerlink" title="SYSTEMTIME 结构"></a>SYSTEMTIME 结构</h3><p>SYSTEMTIME 结构由 Windows API 的日期和时间函数使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SYSTEMTIME STRUCT</span><br><span class="line">  wYear WORD ?          ;年（4 个数子）</span><br><span class="line">  wMonth WORD ?        ;月（1 ~ 12）</span><br><span class="line">  wDayOfWeek WORD ?   ;星期（0 ~ 6）</span><br><span class="line">  wDay WORD ?          ;日（1 ~ 31）</span><br><span class="line">  wHour WORD ?         ;小时（0 ~ 23）</span><br><span class="line">  wMinute WORD ?       ;分钟（0 ~ 59）</span><br><span class="line">  wSecond WORD ?       ;秒（0 ~ 59）</span><br><span class="line">  wMilliseconds WORD ?   ;毫秒（0 ~ 999）</span><br><span class="line">SYSTEMTIME ENDS</span><br></pre></td></tr></table></figure>

<p>字段 wDayOfWeek 的值依序为星期天 &#x3D; 0，星期一 &#x3D; 1，以此类推。wMilliseconds 中的值不确定，因为系统可以与时钟源同步周期性地刷新时间。</p>
<h3 id="FILETIME"><a href="#FILETIME" class="headerlink" title="FILETIME"></a>FILETIME</h3><p>FILETIME 结构把 64 位四字分割为两个双字：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FILETIME STRUCT</span><br><span class="line">    loDateTime DWORD ?</span><br><span class="line">    hiDateTime DWORD ?</span><br><span class="line">FILETIME ENDS</span><br></pre></td></tr></table></figure>



<h3 id="GetLocalTime-和-SetLocalTime"><a href="#GetLocalTime-和-SetLocalTime" class="headerlink" title="GetLocalTime 和 SetLocalTime"></a>GetLocalTime 和 SetLocalTime</h3><p>函数 GetLocalTime 根据系统时钟返回日期和当前时间。</p>
<p>时间要调整为本地时区。</p>
<p>调用该函数时，需向其传递一个指针指向 SYSTEMTIME 结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GetLocalTime PROTO,</span><br><span class="line">    lpSystemTime:PTR SYSTEMTIME</span><br></pre></td></tr></table></figure>

<p>函数 GetLocalTime 调用示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.data</span><br><span class="line">sysTime SYSTEMTIME &lt;&gt;</span><br><span class="line">.code</span><br><span class="line">INVOKE GetLocalTime, ADDR sysTime</span><br></pre></td></tr></table></figure>



<p>函数 SetLocalTime 设置系统的本地日期和时间。</p>
<p>调用时，需向其传递一个指针指向包含了期望日期和时间的 SYSTEMTIME 结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SetLocalTime PROTO,</span><br><span class="line">    lpSystemTime:PTR SYSTEMTIME</span><br></pre></td></tr></table></figure>

<p>如果函数执行成功，则返回非零整数；如果失败，则返回零</p>
<h3 id="GetTickCount"><a href="#GetTickCount" class="headerlink" title="GetTickCount"></a>GetTickCount</h3><p>返回从系统启动起经过的毫秒数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetTickCount PROTO               ; EAX 为返回值</span><br></pre></td></tr></table></figure>

<p>由于返回值为一个双字，因此当系统连续运行 49.7 天后，时间将会回绕归零</p>
<p>。可以使用这个函数监视循环经过的时间，并在达到时间限制时终止循环。</p>
<h3 id="Sleep"><a href="#Sleep" class="headerlink" title="Sleep"></a>Sleep</h3><p>有些时候程序需要暂停或延迟一小段时间。虽然可以通过构造一个计算循环或忙循环来保持处理器工作，但是不同的处理器会使得执行时间不同</p>
<p>Win32 函数 Sleep 按照指定毫秒数暂停当前执行的线程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Sleep PROTO,</span><br><span class="line">  dwMilliseconds:DWORD</span><br></pre></td></tr></table></figure>



<h3 id="GetDateTime"><a href="#GetDateTime" class="headerlink" title="GetDateTime"></a>GetDateTime</h3><p>GetDateTime 以 100 纳秒为间隔，返回从 1601 年 1 月 1 日起经过的时间间隔数。</p>
<p>如果想要为日期计算准备系统日期&#x2F;时间值，Win32 SDK 建议采用如下步骤：</p>
<ul>
<li>调用函数，如 GetLocalTime，填充 SYSTEMTIME 结构。</li>
<li>调用函数 SystemTimeToFileTime，将 SYSTEMTIME 结构转换为 FILETIME 结构。</li>
<li>将得到的 FILETIME 结构复制到 64 位的四字。</li>
</ul>
<h2 id="图形化的Windows应用程序"><a href="#图形化的Windows应用程序" class="headerlink" title="图形化的Windows应用程序"></a>图形化的Windows应用程序</h2><p>下表列出了编写该程序时需要的各种链接库和头文件。</p>
<table>
<thead>
<tr>
<th>文件名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>WinApp.asm</td>
<td>程序源代码</td>
</tr>
<tr>
<td>GraphWin.asm</td>
<td>头文件，包含程序要使用的结构、常量和函数原型</td>
</tr>
<tr>
<td>kernel32.lib</td>
<td>本章前面使用的 MS-Windows API 链接库</td>
</tr>
<tr>
<td>user32.lib</td>
<td>其他 MS-Windows API 函数</td>
</tr>
</tbody></table>
<h3 id="必要的结构"><a href="#必要的结构" class="headerlink" title="必要的结构"></a>必要的结构</h3><p>结构 POINT 以像素为单位，定义屏幕上一个点的 X 坐标和 Y 坐标。它可以用于定位图形对象、窗口和鼠标点击：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POINT STRUCT</span><br><span class="line">  ptX DWORD ?</span><br><span class="line">  ptY DWORD ?</span><br><span class="line">POINT ENDS</span><br></pre></td></tr></table></figure>

<p>结构 RECT 定义矩形边界。成员 left 为矩形左边的 X 坐标，成员 top为矩形上边的 Y 坐标。成员 right 和 bottom 保存矩形类似的值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RECT STRUCT</span><br><span class="line">  left DWORD ?</span><br><span class="line">  top DWORD ?</span><br><span class="line">  right DWORD ?</span><br><span class="line">  bottom DWORD ?</span><br><span class="line">RECT ENDS</span><br></pre></td></tr></table></figure>





<p>结构 MSGStruct 定义 MS-Windows 需要的数据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MSGStruct STRUCT</span><br><span class="line">    msgWnd DWORD ?</span><br><span class="line">    msgMessage DWORD ?</span><br><span class="line">    msgWparam DWORD ?</span><br><span class="line">    msgLparam DWORD ?</span><br><span class="line">    msgTime    DWORD ?</span><br><span class="line">    msgPt POINT &lt;&gt;</span><br><span class="line">MSGStruct ENDS</span><br></pre></td></tr></table></figure>



<p>结构 WNDCLASS 定义窗口类。</p>
<p>程序中的每个窗口都必须属于一个类，并且每个程序都必须为其主窗口定义一个窗口类。</p>
<p>在主窗口可以显示之前，这个类必须要注册到操作系统：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">WNDCLASS STRUC</span><br><span class="line">    style DWORD ?                               ;窗口样式选项</span><br><span class="line">    lpfnWndProc DWORD ?                 ; winProc 函数指针</span><br><span class="line">    cbClsExtra DWORD ?                      ;共享内存</span><br><span class="line">    cbWndExtra DWORD ?                   ;附加字节数</span><br><span class="line">    hlnstance DWORD ?                       ;当前程序句柄</span><br><span class="line">    hlcon DWORD ?                              ;图标句柄</span><br><span class="line">    hCursor DWORD ?                          ;光标句柄</span><br><span class="line">    hbrBackground DWORD ?              ;背景刷句柄</span><br><span class="line">    IpszMenuName DWORD ?             ;菜单名指针</span><br><span class="line">    IpszClassName DWORD ?              ; WinCZLass 名指针</span><br><span class="line">WNDCLASS ENDS</span><br></pre></td></tr></table></figure>



<p>下面对WNDCLASS上述参数进行简单小结：</p>
<ul>
<li>style 是不同样式选项的集合，比如 WS_CAPTION 和 WS_BORDER，用于控制窗口外观和行为。</li>
<li>lpfnWndProc 是指向函数的指针，该函数接收并处理由用户触发的事件消息。</li>
<li>cbClsExtra 指向一个类中所有窗口使用的共享内存。可以为空。</li>
<li>cbWndExtra 指定分配给后面窗口实例的附加字节数。</li>
<li>hInstance 为当前程序实例的句柄。</li>
<li>hIcon 和 hCursor 分别为当前程序中图标资源和光标资源的句柄。</li>
<li>hbrBackground 为背景（颜色）刷的句柄。</li>
<li>lpszMenuName 指向一个菜单名。</li>
<li>lpszClassName 指向一个空字节结束的字符串，该字符串中包含了窗口的类名称。</li>
</ul>
<h3 id="WinMain过程"><a href="#WinMain过程" class="headerlink" title="WinMain过程"></a>WinMain过程</h3><p>每个 Windows 应用程序都需要一个启动过程，通常将其命名为 WinMain，该过程负责下述任务：</p>
<ul>
<li>得到当前程序的句柄。</li>
<li>加载程序的图标和光标。</li>
<li>注册程序的主窗口类，并标识处理该窗口事件消息的过程。</li>
<li>创建主窗口。</li>
<li>显示并更新主窗口。</li>
<li>开始接收和发送消息的循环，直到用户关闭应用程序窗口</li>
</ul>
<p>WinMain 包含一个名为 GetMessage 的消息处理循环，</p>
<p>从程序的消息队列中取出下一条可用消息。</p>
<p>如果 GetMessage 取出的消息是 WM_QUIT，则返回零，即通知 WinMain 暂停程序。</p>
<p>对于其他消息，WinMain 将它们传递给 DispatchMessage 函数，该函数再将消息传递给程序的 WinProc 过程。若</p>
<h3 id="WinProc过程"><a href="#WinProc过程" class="headerlink" title="WinProc过程"></a>WinProc过程</h3><p>WinProc 程接收并处理所有与窗口有关的事件消息。这些事件绝大多数是由用户通过点击和拖动鼠标、按下键盘按键等操作发起的。这个过程的工作就是解码每个消息，如果消息得以识别，则在应用程序中执行与该消息相关的任务</p>
<p>过程声明如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">WinProc PROC,</span><br><span class="line">hWnd: DWORD,         ;窗口句柄</span><br><span class="line">localMsg: DWORD,    ;消息 ID</span><br><span class="line">wParam:DWORD,       ;参数 1 （可变）</span><br><span class="line">lParam: DWORD         ;参数 2 （可变）</span><br></pre></td></tr></table></figure>

<p>根据具体的消息 ID，</p>
<p>第三个和第四个参数的内容可变。</p>
<p>比如，若点击鼠标，那么 lParam 就为点击位置的 X 坐标和 Y 坐标。</p>
<p>在后面的示例程序中，WinProc 过程处理了三种特定的消息：</p>
<ul>
<li>WM_LBUTTONDOWN，用户按下鼠标左键时产生该消息</li>
<li>WM_CREATE，表示刚刚创建主窗口</li>
<li>WM_CLOSE，表示将要关闭应用程序主窗口</li>
</ul>
<h3 id="ErrorHandler"><a href="#ErrorHandler" class="headerlink" title="ErrorHandler"></a>ErrorHandler</h3><p>过程 ErrorHandler 是可选的，如果在注册和创建程序主窗口的过程中系统报错，则调用该过程。</p>
<p>比如，如果成功注册程序主窗口，则函数 RegisterClass 返回非零值。</p>
<p>但是，如果该函数返回值为零，那么就调用 ErrorHandler( 显示一条消息 ) 并退出程序</p>
<p>例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INVOKE RegisterClass, ADDR MainWin</span><br><span class="line">.IF eax == 0</span><br><span class="line">    call ErrorHandler</span><br><span class="line">    jmp Exit_Program</span><br><span class="line">.ENDIF</span><br></pre></td></tr></table></figure>



<p>过程 ErrorHandler 需要执行几个重要任务：</p>
<ul>
<li>调用 GetLastError 取得系统错误号。</li>
<li>调用 FormatMessage 取得合适的系统格式化的错误消息字符串。</li>
<li>调用 MessageBox 显示包含错误消息字符串的弹出消息框。</li>
<li>调用 LocalFree 释放错误消息字符串使用的内存空间。</li>
</ul>
<h3 id="又一个无法运行的例子"><a href="#又一个无法运行的例子" class="headerlink" title="又一个无法运行的例子"></a>又一个无法运行的例子</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line">; Windows Application                   (WinApp.asm)</span><br><span class="line"></span><br><span class="line">; This program displays a resizable application window and</span><br><span class="line">; several popup message boxes.</span><br><span class="line">; Thanks to Tom Joyce for creating a prototype</span><br><span class="line">; from which this program was derived.</span><br><span class="line"></span><br><span class="line">INCLUDE Dqx.inc</span><br><span class="line">;==================== DATA =======================</span><br><span class="line">.data</span><br><span class="line"></span><br><span class="line">AppLoadMsgTitle BYTE &quot;Application Loaded&quot;,0</span><br><span class="line">AppLoadMsgText  BYTE &quot;This window displays when the WM_CREATE &quot;</span><br><span class="line">	            BYTE &quot;message is received&quot;,0</span><br><span class="line"></span><br><span class="line">PopupTitle BYTE &quot;Popup Window&quot;,0</span><br><span class="line">PopupText  BYTE &quot;This window was activated by a &quot;</span><br><span class="line">	       BYTE &quot;WM_LBUTTONDOWN message&quot;,0</span><br><span class="line"></span><br><span class="line">GreetTitle BYTE &quot;Main Window Active&quot;,0</span><br><span class="line">GreetText  BYTE &quot;This window is shown immediately after &quot;</span><br><span class="line">	       BYTE &quot;CreateWindow and UpdateWindow are called.&quot;,0</span><br><span class="line"></span><br><span class="line">CloseMsg   BYTE &quot;WM_CLOSE message received&quot;,0</span><br><span class="line"></span><br><span class="line">ErrorTitle  BYTE &quot;Error&quot;,0</span><br><span class="line">WindowName  BYTE &quot;ASM Windows App&quot;,0</span><br><span class="line">className   BYTE &quot;ASMWin&quot;,0</span><br><span class="line"></span><br><span class="line">; Define the Application&#x27;s Window class structure.</span><br><span class="line">MainWin WNDCLASS &lt;NULL,WinProc,NULL,NULL,NULL,NULL,NULL, \</span><br><span class="line">	COLOR_WINDOW,NULL,className&gt;</span><br><span class="line"></span><br><span class="line">msg	      MSGStruct &lt;&gt;</span><br><span class="line">winRect   RECT &lt;&gt;</span><br><span class="line">hMainWnd  DWORD ?</span><br><span class="line">hInstance DWORD ?</span><br><span class="line"></span><br><span class="line">;=================== CODE =========================</span><br><span class="line">.code</span><br><span class="line">WinMain PROC</span><br><span class="line">; Get a handle to the current process.</span><br><span class="line">	INVOKE GetModuleHandle, NULL</span><br><span class="line">	mov hInstance, eax</span><br><span class="line">	mov MainWin.hInstance, eax</span><br><span class="line"></span><br><span class="line">; Load the program&#x27;s icon and cursor.</span><br><span class="line">	INVOKE LoadIcon, NULL, IDI_APPLICATION</span><br><span class="line">	mov MainWin.hIcon, eax</span><br><span class="line">	INVOKE LoadCursor, NULL, IDC_ARROW</span><br><span class="line">	mov MainWin.hCursor, eax</span><br><span class="line"></span><br><span class="line">; Register the window class.</span><br><span class="line">	INVOKE RegisterClass, ADDR MainWin</span><br><span class="line">	.IF eax == 0</span><br><span class="line">	  call ErrorHandler</span><br><span class="line">	  jmp Exit_Program</span><br><span class="line">	.ENDIF</span><br><span class="line"></span><br><span class="line">; Create the application&#x27;s main window.</span><br><span class="line">; Returns a handle to the main window in EAX.</span><br><span class="line">	INVOKE CreateWindowEx, 0, ADDR className,</span><br><span class="line">	  ADDR WindowName,MAIN_WINDOW_STYLE,</span><br><span class="line">	  CW_USEDEFAULT,CW_USEDEFAULT,CW_USEDEFAULT,</span><br><span class="line">	  CW_USEDEFAULT,NULL,NULL,hInstance,NULL</span><br><span class="line">	mov hMainWnd,eax</span><br><span class="line"></span><br><span class="line">; If CreateWindowEx failed, display a message &amp; exit.</span><br><span class="line">	.IF eax == 0</span><br><span class="line">	  call ErrorHandler</span><br><span class="line">	  jmp  Exit_Program</span><br><span class="line">	.ENDIF</span><br><span class="line"></span><br><span class="line">; Show and draw the window.</span><br><span class="line">	INVOKE ShowWindow, hMainWnd, SW_SHOW</span><br><span class="line">	INVOKE UpdateWindow, hMainWnd</span><br><span class="line"></span><br><span class="line">; Display a greeting message.</span><br><span class="line">	INVOKE MessageBox, hMainWnd, ADDR GreetText,</span><br><span class="line">	  ADDR GreetTitle, MB_OK</span><br><span class="line"></span><br><span class="line">; Begin the program&#x27;s message-handling loop.</span><br><span class="line">Message_Loop:</span><br><span class="line">	; Get next message from the queue.</span><br><span class="line">	INVOKE GetMessage, ADDR msg, NULL,NULL,NULL</span><br><span class="line"></span><br><span class="line">	; Quit if no more messages.</span><br><span class="line">	.IF eax == 0</span><br><span class="line">	  jmp Exit_Program</span><br><span class="line">	.ENDIF</span><br><span class="line"></span><br><span class="line">	; Relay the message to the program&#x27;s WinProc.</span><br><span class="line">	INVOKE DispatchMessage, ADDR msg</span><br><span class="line">    jmp Message_Loop</span><br><span class="line"></span><br><span class="line">Exit_Program:</span><br><span class="line">	  INVOKE ExitProcess,0</span><br><span class="line">WinMain ENDP</span><br><span class="line"></span><br><span class="line">;-----------------------------------------------------</span><br><span class="line">WinProc PROC,</span><br><span class="line">	hWnd:DWORD, localMsg:DWORD, wParam:DWORD, lParam:DWORD</span><br><span class="line">; The application&#x27;s message handler, which handles</span><br><span class="line">; application-specific messages. All other messages</span><br><span class="line">; are forwarded to the default Windows message</span><br><span class="line">; handler.</span><br><span class="line">;-----------------------------------------------------</span><br><span class="line">	mov eax, localMsg</span><br><span class="line"></span><br><span class="line">	.IF eax == WM_LBUTTONDOWN		; mouse button?</span><br><span class="line">	  INVOKE MessageBox, hWnd, ADDR PopupText,</span><br><span class="line">	    ADDR PopupTitle, MB_OK</span><br><span class="line">	  jmp WinProcExit</span><br><span class="line">	.ELSEIF eax == WM_CREATE		; create window?</span><br><span class="line">	  INVOKE MessageBox, hWnd, ADDR AppLoadMsgText,</span><br><span class="line">	    ADDR AppLoadMsgTitle, MB_OK</span><br><span class="line">	  jmp WinProcExit</span><br><span class="line">	.ELSEIF eax == WM_CLOSE		; close window?</span><br><span class="line">	  INVOKE MessageBox, hWnd, ADDR CloseMsg,</span><br><span class="line">	    ADDR WindowName, MB_OK</span><br><span class="line">	  INVOKE PostQuitMessage,0</span><br><span class="line">	  jmp WinProcExit</span><br><span class="line">	.ELSE		; other message?</span><br><span class="line">	  INVOKE DefWindowProc, hWnd, localMsg, wParam, lParam</span><br><span class="line">	  jmp WinProcExit</span><br><span class="line">	.ENDIF</span><br><span class="line"></span><br><span class="line">WinProcExit:</span><br><span class="line">	ret</span><br><span class="line">WinProc ENDP</span><br><span class="line"></span><br><span class="line">;---------------------------------------------------</span><br><span class="line">ErrorHandler PROC</span><br><span class="line">; Display the appropriate system error message.</span><br><span class="line">;---------------------------------------------------</span><br><span class="line">.data</span><br><span class="line">pErrorMsg  DWORD ?		; ptr to error message</span><br><span class="line">messageID  DWORD ?</span><br><span class="line">.code</span><br><span class="line">	INVOKE GetLastError	; Returns message ID in EAX</span><br><span class="line">	mov messageID,eax</span><br><span class="line"></span><br><span class="line">	; Get the corresponding message string.</span><br><span class="line">	INVOKE FormatMessage, FORMAT_MESSAGE_ALLOCATE_BUFFER + \</span><br><span class="line">	  FORMAT_MESSAGE_FROM_SYSTEM,NULL,messageID,NULL,</span><br><span class="line">	  ADDR pErrorMsg,NULL,NULL</span><br><span class="line"></span><br><span class="line">	; Display the error message.</span><br><span class="line">	INVOKE MessageBox,NULL, pErrorMsg, ADDR ErrorTitle,</span><br><span class="line">	  MB_ICONERROR+MB_OK</span><br><span class="line"></span><br><span class="line">	; Free the error message string.</span><br><span class="line">	INVOKE LocalFree, pErrorMsg</span><br><span class="line">	ret</span><br><span class="line">ErrorHandler ENDP</span><br><span class="line"></span><br><span class="line">END WinMain</span><br></pre></td></tr></table></figure>

























































<h2 id="窗口"><a href="#窗口" class="headerlink" title="窗口"></a>窗口</h2><h3 id="一些变量前缀"><a href="#一些变量前缀" class="headerlink" title="一些变量前缀"></a>一些变量前缀</h3><p>WS :Windows Style</p>
<p>WM:windows message</p>
<h3 id="函数-供查看"><a href="#函数-供查看" class="headerlink" title="函数(供查看)"></a>函数(供查看)</h3><h4 id="GetModuleHandle-获取句柄"><a href="#GetModuleHandle-获取句柄" class="headerlink" title="GetModuleHandle 获取句柄"></a>GetModuleHandle 获取句柄</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invoke  GetModuleHandle ,lpMouleName(含有模块的字符串指针)</span><br></pre></td></tr></table></figure>



<p>他的返回值放在了eax中(之前说过)</p>
<p>但是我们通常会用到这么一个返回值,于是我们要建立一个变量去保存它</p>
<p>比如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">			.data</span><br><span class="line">str			db		&quot;user32.dll&quot;</span><br><span class="line">hInstance	dd		?</span><br><span class="line">			.code	</span><br><span class="line">.....</span><br><span class="line">			invoke  GetModuleHandle ,addr str</span><br><span class="line">			mov		hInstance,eax</span><br></pre></td></tr></table></figure>



<p>如果,lpMouleName&#x3D;NULL</p>
<p>表示调用自己</p>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<h4 id="RegisterClassEx-窗口注册"><a href="#RegisterClassEx-窗口注册" class="headerlink" title="RegisterClassEx 窗口注册"></a>RegisterClassEx 窗口注册</h4><p>用于窗口的注册</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invoke	RegisterClassEx, 窗口结构体类型的指针</span><br></pre></td></tr></table></figure>

<p>在这之前,那个窗口结构体要完成初始化</p>
<p>好比这个样子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mov	@stWndClass.hCursor,		eax</span><br><span class="line">push	hInstance</span><br><span class="line">pop	@stWndClass.hInstance</span><br><span class="line">mov	@stWndClass.cbSize,		sizeof WNDCLASSEX</span><br><span class="line">mov	@stWndClass.style,		CS_HREDRAW or CS_VREDRAW</span><br><span class="line">mov	@stWndClass.lpfnWndProc,	offset _ProcWinMain</span><br><span class="line">mov	@stWndClass.hbr</span><br><span class="line">Background,	COLOR_WINDOW + 1</span><br><span class="line">mov	@stWndClass.lpszClassName,	offset szClassName</span><br><span class="line">invoke	RegisterClassEx,		addr @stWndClass</span><br></pre></td></tr></table></figure>



<p>关于窗口结构体的与成员介绍</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">wndclassex		struct    </span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	hIcon;			dd	?	;窗口图标</span><br><span class="line">	hIconSm;		dd	?	;小图标</span><br><span class="line">	hCursor;		dd	?	;窗口光标</span><br><span class="line">	lpszMenuName;	dd	?	;窗口菜单</span><br><span class="line">	hInstance;		dd	?	;实例句柄</span><br><span class="line">	cbSize			dd	?	;结构体字节数,用sizeof计算</span><br><span class="line">	style;			dd	?	;类风格</span><br><span class="line">	hbrBackground;	dd	?	;背景色</span><br><span class="line">	lpszClassName;	dd	?	;Class_Name的字符串地址</span><br><span class="line">	cbClsExtra;		dd	?	;</span><br><span class="line">	cbWndExtra;		dd	?	;</span><br><span class="line">	lpfnWndProc;	dd	?	;窗口过程的地址</span><br><span class="line"></span><br><span class="line">wndclassex		ends</span><br></pre></td></tr></table></figure>





<h5 id="hIcon-dd-窗口图标"><a href="#hIcon-dd-窗口图标" class="headerlink" title="hIcon;			dd	?	;窗口图标"></a>hIcon;			dd	?	;窗口图标</h5><p>显示在窗口左上角的图标,</p>
<p>LoadIcon函数获取资源文件的图标,如果想自定义图标就去资源文件中定义</p>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<h5 id="hCursor-dd-窗口光标"><a href="#hCursor-dd-窗口光标" class="headerlink" title="hCursor;		dd	?	;窗口光标"></a>hCursor;		dd	?	;窗口光标</h5><p>鼠标在窗口的样子</p>
<p>LoadCursor函数指定鼠标在窗口光标的形状,,如果想自定义光标就去资源文件中定义</p>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<h5 id="lpszMenuName-dd-窗口菜单"><a href="#lpszMenuName-dd-窗口菜单" class="headerlink" title="lpszMenuName;	dd	?	;窗口菜单"></a>lpszMenuName;	dd	?	;窗口菜单</h5><p>详情见&lt;&lt;琢石成器&gt;Page.101</p>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<h5 id="hInstance-dd-实例句柄"><a href="#hInstance-dd-实例句柄" class="headerlink" title="hInstance;		dd	?	;实例句柄"></a>hInstance;		dd	?	;实例句柄</h5><p>指定注册的窗口属于哪个模块</p>
<p>在书上的代码中是这样初始化的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">push	hInstance			;hinstance是已经被初始化的一个句柄</span><br><span class="line">pop	@stWndClass.hInstance	;这这是一个引用的</span><br></pre></td></tr></table></figure>



<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<h5 id="cbSizedd-结构体字节数-用sizeof计算"><a href="#cbSizedd-结构体字节数-用sizeof计算" class="headerlink" title="cbSize			dd	?	;结构体字节数,用sizeof计算"></a>cbSize			dd	?	;结构体字节数,用sizeof计算</h5><p>详情见详情见&lt;&lt;琢石成器&gt;Page.101</p>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<h5 id="style-dd"><a href="#style-dd" class="headerlink" title="style;			dd	?	;"></a>style;			dd	?	;</h5><p>窗口的风格,常见的参数,CS_HREADRAW与CS_VREDRAW</p>
<p>小写cs_hredraw,cs_vredraw</p>
<p>还有个CS_DBLCLKS,小写cs_dblclks,指定了它,windows才会把快速双击的鼠标的行为翻译为WM_LNUTTONDBLCLK发送给窗口过程</p>
<p>小写wm_lbuttondblclk,</p>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<h5 id="hbrBackground-dd-背景色"><a href="#hbrBackground-dd-背景色" class="headerlink" title="hbrBackground;	dd	?	;背景色"></a>hbrBackground;	dd	?	;背景色</h5><p>br是brush的意思,h句柄</p>
<p>windows与预定义了一些刷子,用GetStockObject 函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invoke GetStockObject,WHITE_BRUSH</span><br></pre></td></tr></table></figure>

<p>windows</p>
<p>预定义了一些颜色,如COLOR_MENU,使用类似的颜色要<code>+1</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov	@stWndClass.hbrBackground,	COLOR_WINDOW + 1</span><br></pre></td></tr></table></figure>



<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<h5 id="lpszClassName-dd-Class-Name的字符串地址"><a href="#lpszClassName-dd-Class-Name的字符串地址" class="headerlink" title="lpszClassName;	dd	?	;Class_Name的字符串地址"></a>lpszClassName;	dd	?	;Class_Name的字符串地址</h5><blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<h5 id="cbClsExtra-x2F-cbWndExtra"><a href="#cbClsExtra-x2F-cbWndExtra" class="headerlink" title="cbClsExtra&#x2F;cbWndExtra"></a>cbClsExtra&#x2F;cbWndExtra</h5><pre><code>cbClsExtra;		dd	?	;
cbWndExtra;		dd	?
</code></pre>
<p>分别代表了windows内部保存的窗口结构体和类结构体给我们预留的内存大小</p>
<p>用于存放自定义的数据</p>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<h5 id="lpfnWndProc-dd-窗口过程的地址"><a href="#lpfnWndProc-dd-窗口过程的地址" class="headerlink" title="lpfnWndProc;	dd	?	;窗口过程的地址"></a>lpfnWndProc;	dd	?	;窗口过程的地址</h5><p>信息的交互需要使用它</p>
<p>它好像是窗口的窗口的地址,就是procMain</p>
<p>有了它windows就知道DispatchMessage函数把窗口的信息发送到哪里去</p>
<h4 id="CreateWindowEx-建立窗口"><a href="#CreateWindowEx-建立窗口" class="headerlink" title="CreateWindowEx  建立窗口"></a>CreateWindowEx  建立窗口</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">invoke 	CreateWindowEx,\</span><br><span class="line">		dwExStyle,\</span><br><span class="line">		lpClassName,\</span><br><span class="line">		lpwindowName,\</span><br><span class="line">		dwStyle,\</span><br><span class="line">		x,y,\</span><br><span class="line">		nWidth,nHeight,\</span><br><span class="line">		hWndParent,\</span><br><span class="line">		hMenu,\</span><br><span class="line">		hInstance,\</span><br><span class="line">		lpParam</span><br></pre></td></tr></table></figure>



<p>例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">invoke	CreateWindowEx,</span><br><span class="line">			WS_EX_CLIENTEDGE,</span><br><span class="line">			offset szClassName,</span><br><span class="line">			offset szCaptionMain,\</span><br><span class="line">			WS_OVERLAPPEDWINDOW,\</span><br><span class="line">			100,100,600,400,\</span><br><span class="line">			NULL,NULL,hInstance,NULL</span><br></pre></td></tr></table></figure>



<h5 id="lpClassName-之前注册的窗口类"><a href="#lpClassName-之前注册的窗口类" class="headerlink" title="lpClassName 之前注册的窗口类"></a>lpClassName 之前注册的窗口类</h5><p>初始化后目标是使用lpClassName类建立窗口</p>
<h5 id="lpwindowName-窗口标题栏字符串地址"><a href="#lpwindowName-窗口标题栏字符串地址" class="headerlink" title="lpwindowName 窗口标题栏字符串地址"></a>lpwindowName 窗口标题栏字符串地址</h5><p>是一个字符串的指针</p>
<h5 id="hMenu-菜单句柄"><a href="#hMenu-菜单句柄" class="headerlink" title="hMenu 菜单句柄"></a>hMenu 菜单句柄</h5><p>如果参数是NULL,就去使用之前在注册窗口时的menu句柄</p>
<p>如果参数是一个新的menu,就去使用新的句柄</p>
<p>如果注册窗口类是没有muen,这里也没有menu句柄,就啥也不显示</p>
<h5 id="lpParam"><a href="#lpParam" class="headerlink" title="lpParam"></a>lpParam</h5><p>见&lt;&lt;琢石成器&gt;&gt;.103</p>
<h5 id="hinstance"><a href="#hinstance" class="headerlink" title="hinstance"></a>hinstance</h5><p>指定窗口所属的程序模块</p>
<h5 id="hWndParent-窗口所属父窗口"><a href="#hWndParent-窗口所属父窗口" class="headerlink" title="hWndParent 窗口所属父窗口"></a>hWndParent 窗口所属父窗口</h5><p>主要用于在父窗口销毁时一同将子窗口销毁</p>
<h6 id="x-y"><a href="#x-y" class="headerlink" title="x,y"></a>x,y</h6><p>指定窗口左上角的位置</p>
<p>默认可指定CW_USEDEFAULT</p>
<h5 id="nWidth-nHeight"><a href="#nWidth-nHeight" class="headerlink" title="nWidth,nHeight"></a>nWidth,nHeight</h5><p>窗口的宽度高度</p>
<p>默认可指定CW_USEDEFAULT</p>
<h5 id="dwStyle-x2F-dwExStyle"><a href="#dwStyle-x2F-dwExStyle" class="headerlink" title="dwStyle&#x2F;dwExStyle"></a>dwStyle&#x2F;dwExStyle</h5><p>详情见见&lt;&lt;琢石成器&gt;&gt;.104</p>
<h4 id="Showwindows-显示窗口"><a href="#Showwindows-显示窗口" class="headerlink" title="Showwindows 显示窗口"></a>Showwindows 显示窗口</h4><p>主要用于窗口的显示状态(显示&#x2F;隐藏)</p>
<p>大小控制</p>
<p>是否激活(当前窗口还是背后窗口)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invoke	ShowWindow,hWinMain,SW_SHOWNORMAL</span><br></pre></td></tr></table></figure>

<p>第一个参数是窗口的句柄..啊?什么时候定义的句柄?</p>
<blockquote>
<p>在Crreatwindows的时候</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">invoke	CreateWindowEx,WS_EX_OVERLAPPEDWINDOW,offset szClassName,offset szCaptionMain,\</span><br><span class="line">	WS_OVERLAPPEDWINDOW,\</span><br><span class="line">	100,100,600,400,\</span><br><span class="line">	NULL,NULL,hInstance,NULL</span><br><span class="line">mov	hWinMain,eax</span><br></pre></td></tr></table></figure>

<p>这里的eax是一个返回的窗口句柄</p>
</blockquote>
<p>第二个参数是显示方式的预定义值</p>
<p>详情见见&lt;&lt;琢石成器&gt;&gt;.106</p>
<h4 id="UpdateWindow-绘制客户区"><a href="#UpdateWindow-绘制客户区" class="headerlink" title="UpdateWindow 绘制客户区"></a>UpdateWindow 绘制客户区</h4><p>本质是向窗口发送WM_PAINT消息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invoke	UpdateWindow,hWinMain</span><br></pre></td></tr></table></figure>

<p>参数是窗口的句柄</p>
<h4 id="CreatewindowEx-建立子窗口"><a href="#CreatewindowEx-建立子窗口" class="headerlink" title="CreatewindowEx 建立子窗口"></a>CreatewindowEx 建立子窗口</h4><p>Windows有很多预定义的子窗口</p>
<p>好比Button&#x2F;Edit,要建立一个子窗口就把lpClassName指向”Button”或者啥的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">		.data</span><br><span class="line">szButton	db	&quot;button&quot;,0</span><br><span class="line">szButtonText	db	&quot;&amp;OK&quot;,0</span><br><span class="line">		...</span><br><span class="line">		invoke	CreateWindowEx,NULL,\</span><br><span class="line">			offset	szButton,offset szButtonText,\</span><br><span class="line">			WS_CHILD or WS_VISIBLE,\</span><br><span class="line">			10,10,65,22,\</span><br><span class="line">			hWnd,1,hInstance,NULL</span><br><span class="line">			;这里的1是ID</span><br></pre></td></tr></table></figure>



<h4 id="消息循环"><a href="#消息循环" class="headerlink" title="消息循环"></a>消息循环</h4><p>代码示意</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.while	TRUE</span><br><span class="line">	invoke	GetMessage,addr @stMsg,NULL,0,0</span><br><span class="line">	.break	.if eax	== 0</span><br><span class="line">	invoke	TranslateMessage,addr @stMsg</span><br><span class="line">	invoke	DispatchMessage,addr @stMsg</span><br><span class="line">.endw</span><br></pre></td></tr></table></figure>



<p>消息循环用到的结构体</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MSG	struct</span><br><span class="line">	hwnd	dd	?;消息要发送到哪里去,</span><br><span class="line">	message	dd	?;消息标识符,在头文件WM开头的有预定义值</span><br><span class="line">	wparam	dd	?</span><br><span class="line">	lParam	dd	?</span><br><span class="line">	time	dd	?</span><br><span class="line">	pt	POINT	?;一个POINT数据结构,表示消息放入消息队列的鼠标坐标</span><br><span class="line">MSG	ends</span><br></pre></td></tr></table></figure>



<p>hwnd:消息要发送到哪里去,</p>
<p>message:消息标识符,在头文件WM开头的有预定义值</p>
<p>wParam:消息参数之一</p>
<p>lParam:消息参数之二</p>
<p>time:消息放入消息队列的时间</p>
<p>pt:一个POINT数据结构,表示消息放入消息队列的鼠标坐标</p>
<h5 id="GetMessage"><a href="#GetMessage" class="headerlink" title="GetMessage"></a>GetMessage</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invoke GetMessage,lpMsg,hWnd,wMsgFilterMin,wMsgFilterMax</span><br></pre></td></tr></table></figure>

<p>lpMsg: 指向一个Msg结构,函数会在这里返回取到的消息</p>
<p>hWnd:指定获取哪个窗口的信息,如果是NULL,表示获取所拥有本程序所属窗口的信息(不太理解)</p>
<p>wMsgFilterMin,wMsgFilterMax:表示获取所拥有编号的信息</p>
<p>GetMessage函数会从消息队列里获取信息,填写好MSG结构并返回,如果获取信息是<code>MSG_QUIT</code></p>
<p>那么eax返回值是0,否者返回非零,</p>
<p>于是循环推出的条件就是<code>.if !eax .break</code></p>
<h5 id="TranslateMessage"><a href="#TranslateMessage" class="headerlink" title="TranslateMessage"></a>TranslateMessage</h5><p>他将MSG的结构体信息给windows,然后进行一些键盘信息的转换,</p>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<p>在windows小,你敲击键盘会有扫描码与断码,产生的消息队列是WM_KEYDOWN&#x2F;WM_KEYUP</p>
<p>或者WM_SYSKEYDOWN&#x2F;WM_YSYSKEYUP</p>
<p>windows对这个过程的处理很麻烦</p>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<p>不怎么理解</p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<p>TranslateMessage直接把你的扫描码转化为ASCII,并在消息队列中插入WM_CHAR或者WM_SYSCHAR</p>
<p>对于一些非键盘的输入,函数不做处理</p>
<h5 id="DispatchMessage"><a href="#DispatchMessage" class="headerlink" title="DispatchMessage"></a>DispatchMessage</h5><p>在上面2个函数下,DispatchMessage函数将消息发送到消息对应的窗口过程去处理,处理过程返回,DispatchMessage才返回</p>
<p>然后开始一轮新的循环</p>
<h4 id="其它形式的消息循环"><a href="#其它形式的消息循环" class="headerlink" title="其它形式的消息循环"></a>其它形式的消息循环</h4><p>例题的代码是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.while	TRUE</span><br><span class="line">	invoke	GetMessage,		addr @stMsg,NULL,0,0</span><br><span class="line">	.break	.if eax	== 0</span><br><span class="line">	invoke	TranslateMessage,	addr @stMsg</span><br><span class="line">	invoke	DispatchMessage,	addr @stMsg</span><br><span class="line">	;获取</span><br><span class="line">	;翻译</span><br><span class="line">	;发送</span><br><span class="line">.endw</span><br></pre></td></tr></table></figure>

<p>这让CPU一直在干3件事情,而这3件事情根本没有变化,这样浪费了CPU</p>
<blockquote>
<p>我很疑惑,什么叫有消息???????,什么叫消息队列有消息???</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">invoke	CreateWindow,</span><br><span class="line">invoke	ShowWindow,</span><br><span class="line">invoke	UpdateWindows,</span><br><span class="line">.while	dwQuitFlag==0</span><br><span class="line">.endw</span><br><span class="line">invoke	ExitProcsee,0</span><br></pre></td></tr></table></figure>

<p>对于这种方式我不是特别的理解</p>
<p>他是如何GetMessage的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.while TRUE</span><br><span class="line">	invoke PeekMessage,addr @stMsg,NULL,0,0,PM_REMOVE</span><br><span class="line">	.if	eax</span><br><span class="line">		.break .if @stMsg.message==WM_QUIT</span><br><span class="line">		invoke TranslateMessage,addr @stMsg</span><br><span class="line">		invoke	DispatchMessage,addr @stMsg</span><br><span class="line">	.else</span><br><span class="line">		invoke	MessageBox,NULL,offset szText1,offset szCaption1,MB_OK</span><br><span class="line">	.endif</span><br><span class="line">.endw</span><br></pre></td></tr></table></figure>



<p>对于下面的代码我没有调试明白</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; Sample code for &lt; Win32ASM Programming 3rd Edition&gt;</span><br><span class="line">; by 罗云彬, http://www.win32asm.com.cn</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; FirstWindow.asm</span><br><span class="line">; 窗口程序的模板代码</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; 使用 nmake 或下列命令进行编译和链接:</span><br><span class="line">; ml /c /coff FirstWindow.asm</span><br><span class="line">; Link /subsystem:windows FirstWindow.obj</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.386</span><br><span class="line">		.model flat,stdcall</span><br><span class="line">		option casemap:none</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; Include 文件定义</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">include		windows.inc</span><br><span class="line">include		gdi32.inc</span><br><span class="line">includelib	gdi32.lib</span><br><span class="line">include		user32.inc</span><br><span class="line">includelib	user32.lib</span><br><span class="line">include		kernel32.inc</span><br><span class="line">includelib	kernel32.lib</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; 数据段</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.data?</span><br><span class="line">hInstance	dd		?</span><br><span class="line">hWinMain	dd		?</span><br><span class="line"></span><br><span class="line">		.const</span><br><span class="line">szClassName	db	&#x27;MyClass&#x27;,0</span><br><span class="line">szCaptionMain	db	&#x27;My first Window !&#x27;,0</span><br><span class="line">szText		db	&#x27;Win32 Assembly, Simple and powerful !&#x27;,0</span><br><span class="line">szCaption1	db	&#x27;A MessageBox !&#x27;,0</span><br><span class="line">szText1		db	&#x27;Hello, World !&#x27;,0</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; 代码段</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.code</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; 窗口过程</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">;程序的另一半</span><br><span class="line">_ProcWinMain	proc	uses ebx edi esi hWnd,uMsg,wParam,lParam</span><br><span class="line">		local	@stPs:PAINTSTRUCT</span><br><span class="line">		local	@stRect:RECT</span><br><span class="line">		local	@hDc</span><br><span class="line"></span><br><span class="line">		mov	eax,uMsg</span><br><span class="line">;********************************************************************</span><br><span class="line">		.if	eax ==	WM_PAINT</span><br><span class="line">			invoke	BeginPaint,hWnd,addr @stPs</span><br><span class="line">			mov	@hDc,eax</span><br><span class="line"></span><br><span class="line">			invoke	GetClientRect,hWnd,addr @stRect</span><br><span class="line">			invoke	DrawText,@hDc,addr szText,-1,\</span><br><span class="line">				addr @stRect,\</span><br><span class="line">				DT_SINGLELINE or DT_CENTER or DT_VCENTER</span><br><span class="line"></span><br><span class="line">			invoke	EndPaint,hWnd,addr @stPs</span><br><span class="line">;********************************************************************</span><br><span class="line">		.elseif	eax ==	WM_CLOSE</span><br><span class="line">			invoke	DestroyWindow,hWinMain</span><br><span class="line">			invoke	PostQuitMessage,NULL</span><br><span class="line">;********************************************************************</span><br><span class="line">		.else</span><br><span class="line">			invoke	DefWindowProc,hWnd,uMsg,wParam,lParam</span><br><span class="line">			ret</span><br><span class="line">		.endif</span><br><span class="line">;********************************************************************</span><br><span class="line">		xor	eax,eax</span><br><span class="line">		ret</span><br><span class="line"></span><br><span class="line">_ProcWinMain	endp</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">_WinMain	proc</span><br><span class="line">		;这个窗口的&quot;WNDCLASSEX&quot;结构体类型是已经被定义好的,现在在局部变量定义就好了</span><br><span class="line">		;这里还有一个MSG类型,wok!!</span><br><span class="line">		local	@stWndClass:WNDCLASSEX</span><br><span class="line">		local	@stMsg:MSG</span><br><span class="line">		;API-1	</span><br><span class="line">		invoke	GetModuleHandle,NULL</span><br><span class="line">		mov	hInstance,eax</span><br><span class="line">		;API-2</span><br><span class="line">		invoke	RtlZeroMemory,addr @stWndClass,sizeof @stWndClass</span><br><span class="line">;********************************************************************</span><br><span class="line">; 注册窗口类</span><br><span class="line">;********************************************************************</span><br><span class="line">		;LoadCursor指定鼠标在窗口光标的形状,这里的IDC_AERROW是预定义的</span><br><span class="line">		invoke	LoadCursor,0,IDC_ARROW</span><br><span class="line">		;初始化窗口类Class的成员</span><br><span class="line">		mov	@stWndClass.hCursor,		eax</span><br><span class="line">		push	hInstance</span><br><span class="line">		pop	@stWndClass.hInstance</span><br><span class="line">		mov	@stWndClass.cbSize,		sizeof WNDCLASSEX</span><br><span class="line">		mov	@stWndClass.style,		CS_HREDRAW or CS_VREDRAW</span><br><span class="line">		mov	@stWndClass.lpfnWndProc,	offset _ProcWinMain</span><br><span class="line">		mov	@stWndClass.hbrBackground,	COLOR_WINDOW + 1</span><br><span class="line">		mov	@stWndClass.lpszClassName,	offset szClassName</span><br><span class="line">		invoke	RegisterClassEx,		addr @stWndClass</span><br><span class="line">;********************************************************************</span><br><span class="line">; 建立并显示窗口</span><br><span class="line">;********************************************************************</span><br><span class="line">		;上面的初始化是一些class共性的初始化,而DIY的初始化在这里</span><br><span class="line">		invoke	CreateWindowEx,WS_EX_OVERLAPPEDWINDOW,offset szClassName,offset szCaptionMain,\</span><br><span class="line">			WS_OVERLAPPEDWINDOW,\</span><br><span class="line">			100,100,600,400,\</span><br><span class="line">			NULL,NULL,hInstance,NULL</span><br><span class="line">		mov	hWinMain,eax</span><br><span class="line">		;eax传回来了窗口的句柄,用来备用</span><br><span class="line">		invoke	ShowWindow,hWinMain,SW_SHOWNORMAL</span><br><span class="line">		;SHowWindos只会显示窗口,不会显示u内容</span><br><span class="line">		invoke	UpdateWindow,hWinMain</span><br><span class="line">		;Update才会先睡文本</span><br><span class="line">;********************************************************************</span><br><span class="line">; 消息循环</span><br><span class="line">;********************************************************************</span><br><span class="line">		</span><br><span class="line">		.while TRUE</span><br><span class="line">			invoke PeekMessage,addr @stMsg,NULL,0,0,PM_REMOVE</span><br><span class="line">			.if	eax</span><br><span class="line">				.break .if @stMsg.message==WM_QUIT</span><br><span class="line">				invoke TranslateMessage,addr @stMsg</span><br><span class="line">				invoke	DispatchMessage,addr @stMsg</span><br><span class="line">			.else</span><br><span class="line">				pushad</span><br><span class="line">				invoke	MessageBox,NULL,offset szText1,offset szCaption1,MB_OK</span><br><span class="line">				popad</span><br><span class="line">			.endif</span><br><span class="line">		.endw</span><br><span class="line"></span><br><span class="line">		ret</span><br><span class="line"></span><br><span class="line">_WinMain	endp</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">start:</span><br><span class="line">		call	_WinMain</span><br><span class="line">		invoke	ExitProcess,NULL</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		end	start</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>不理解为什么他会进入那3个函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.if	eax</span><br><span class="line">	.break .if @stMsg.message==WM_QUIT</span><br><span class="line">	invoke TranslateMessage,addr @stMsg</span><br><span class="line">	invoke	DispatchMessage,addr @stMsg</span><br></pre></td></tr></table></figure>

<p>或者为什么进入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.else</span><br><span class="line">	pushad</span><br><span class="line">	invoke	MessageBox,NULL,offset szText1,offset szCaption1,MB_OK</span><br><span class="line">	popad</span><br></pre></td></tr></table></figure>

<p>是什么东西在影响你的消息队列</p>
<h4 id="窗口过程"><a href="#窗口过程" class="headerlink" title="窗口过程"></a>窗口过程</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">My_ProcWinMain	proc	hWnd,uMsg,wParam,lParam</span><br></pre></td></tr></table></figure>

<p>hWnd:窗口回调要指明的操作窗口</p>
<p>uMsg:…</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">My_ProcWinMain	proc	uses ebx edi esi hWnd,uMsg,wParam,lParam</span><br></pre></td></tr></table></figure>



<p>关于那几个参数的入栈</p>
<p>uses ebx edi esi </p>
<p>为什么入栈?因为他们会被偷偷的改变,就像MessageBox修改ecx,eax..那样,他会对后面的判断做一些影响</p>
<p>uMsg参数有一定的范围,其他的不多说..这里会用到SendMesage参数来传递自定义的参数</p>
<p>….详情就在看书</p>
<p>wParam&#x2F;IParam参数是消息附带的,他们的职能会根据不同的调用而不同,详情见书</p>
<p>处理了不同的消息必须返回规定的值给windows,对于不同的过程会有不同的返回值</p>
<p>好比程序无法完成初始化就会返回-1</p>
<p>WM_CLOSE消息是按下窗口的<code>叉叉</code>按钮,主要负责释放内存,保存工作,提示用户是否需要保持</p>
<p>….</p>
<p>…上面很杂很多很难理解..主要是缺乏应用,对那些结构体的认识不够到位</p>
<p>…后面回来慢慢看</p>
<h4 id="收到消息的顺序"><a href="#收到消息的顺序" class="headerlink" title="收到消息的顺序"></a>收到消息的顺序</h4><p>收到消息不一定是从循环开始,而是在CreateWindow中开始了</p>
<p>显示和刷新窗口的函数ShowWindow和UpdateWindow</p>
<p>也向窗口过程发送信息</p>
<h3 id="窗口间的通信"><a href="#窗口间的通信" class="headerlink" title="窗口间的通信"></a>窗口间的通信</h3><h1 id="动态内存分配"><a href="#动态内存分配" class="headerlink" title="动态内存分配"></a>动态内存分配</h1><p>动态内存分配 (dynamic memory allocation)，又被称为堆分配 (heap allocation)，</p>
<p>汇编语言程序有两种方法进行动态分配：</p>
<ul>
<li>方法一：通过系统调用从操作系统获得内存块。</li>
<li>方法二：实现自己的堆管理器来服务更小的对象提出的请求。</li>
</ul>
<h2 id="函数一览表-2"><a href="#函数一览表-2" class="headerlink" title="函数一览表"></a>函数一览表</h2><p>利用下表中的几个 Win32 API .表中所有的函数都会覆盖通用寄存器，因此程序实现重要寄存器的入栈和出栈操作。</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>GetProcessHeap</td>
<td>用 EAX 返回程序现存堆区域的 32 位整数句柄。如果函数成功，则 EAX 中的返回值为堆句柄。 如果函数失败，则 EAX 中的返回值为 NULL</td>
</tr>
<tr>
<td>HeapAlloc</td>
<td>从堆中分配内存块。如果成功，EAX 中的返回值就为内存块的地址。如果失败，则 EAX 中的返 回值为 NULL</td>
</tr>
<tr>
<td>HeapCreate</td>
<td>创建新堆，并使其对调用程序可用。如果函数成功，则 EAX 中的返回值为新创建堆的句柄。如果失败，则 EAX 的返回值为 NULL</td>
</tr>
<tr>
<td>HeapDestroy</td>
<td>销毁指定堆对象，并使其句柄无效。如果函数成功，则 EAX 中的返回值为非零</td>
</tr>
<tr>
<td>HeapFree</td>
<td>释放之前从堆中分配的内存块，该堆由其地址和堆句柄进行标识。如果内存块释放成功，则返回值为非零</td>
</tr>
<tr>
<td>HeapReAlloc</td>
<td>对堆中内存块进行再分配和调整大小。如果函数成功，则返回值为指向再分配内存块的指针。如果函数失败，且没有指定 HEAP GENERATE EXCEPTIONS，则返回值为 NULL</td>
</tr>
<tr>
<td>HeapSize</td>
<td>返回之前通过调用 HeapAlloc 或 HeapReAlloc 分配的内存块的大小。如果函数成功，则 EAX 包含被分配内存块的字节数。如果函数失败，则返回值为 SIZE_T-1 ( SIZE_T 等于指针能指向的最大字节数 )</td>
</tr>
</tbody></table>
<h2 id="GetProcessHeap-返回已用堆区的地址"><a href="#GetProcessHeap-返回已用堆区的地址" class="headerlink" title="GetProcessHeap 返回已用堆区的地址"></a>GetProcessHeap 返回已用堆区的地址</h2><p>没有参数</p>
<p>如果使用的是当前程序的默认堆，那么 GetProcessHeap 就足够了。这个函数没有参数，EAX 中的返回值就是堆句柄：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetProcessHeap PROTO</span><br></pre></td></tr></table></figure>



<p>例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.data</span><br><span class="line">hHeap HANDLE ?</span><br><span class="line">.code</span><br><span class="line">INVOKE GetProcessHeap</span><br><span class="line">.IF eax == NULL           ;不能获取句柄</span><br><span class="line">    jmp quit</span><br><span class="line">.ELSE</span><br><span class="line">    mov hHeap,eax         ;句柄 ok</span><br><span class="line">.ENDIF</span><br></pre></td></tr></table></figure>



<h2 id="HeapCreate-创建堆区"><a href="#HeapCreate-创建堆区" class="headerlink" title="HeapCreate 创建堆区"></a>HeapCreate 创建堆区</h2><p>为当前程序创建一个新的私有堆：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HeapCreate PROTO,</span><br><span class="line">    flOptions:DWORD,                    ;堆分配选项</span><br><span class="line">    dwInitialSize:DWORD,               ;按字节初始化堆大小</span><br><span class="line">    dwMaximumSize:DWORD        ;最大堆字节数</span><br></pre></td></tr></table></figure>

<p>flOptions 设置为 NULL。</p>
<p>dwInitialSize 设置为初始堆字节数，其值的上限为下一页的边界。</p>
<p>如果 HeapAlloc 的调用超过了初始堆大小，那么堆最大可以扩展到 dwMaximumSize 参数中指定的大小（上限为下一页的边界）。</p>
<p>调用后，EAX 中的返回值为空就表示堆未创建成 功。HeapCreate 的调用示例如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">HEAP_START = 2000000 ; 2 MB</span><br><span class="line">HEAP_MAX = 400000000 ; 400 MB</span><br><span class="line">.data</span><br><span class="line">hHeap HANDLE ?       ; 堆句柄</span><br><span class="line">.code</span><br><span class="line">INVOKE HeapCreate, 0, HEAP_START, HEAP_MAX</span><br><span class="line">.IF eax == NULL      ; 堆未创建    call WriteWindowsMsg ; 显示错误消息</span><br><span class="line">    jmp quit</span><br><span class="line">.ELSE</span><br><span class="line">    mov hHeap,eax    ; 句柄 OK</span><br><span class="line">.ENDIF</span><br></pre></td></tr></table></figure>



<h2 id="HeapDeatroy-销毁堆区"><a href="#HeapDeatroy-销毁堆区" class="headerlink" title="HeapDeatroy 销毁堆区"></a>HeapDeatroy 销毁堆区</h2><p>销毁一个已存在的私有堆（由 HeapCreate 创建）。需向其传递堆句柄</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HeapDestroy PROTO,</span><br><span class="line">    hHeap:DWORD          ;堆句柄</span><br></pre></td></tr></table></figure>

<p>如果堆销毁失败，则 EAX 等于 NULL。下面为示例调用，其中使用了 WriteWindowsMsg 过程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.data</span><br><span class="line">hHeap HANDLE ?                ;堆句柄</span><br><span class="line">.code</span><br><span class="line">INVOKE HeapDestroy, hHeap</span><br><span class="line">.IF eax == NULL</span><br><span class="line">    call WriteWindowsMsg      ;显示错误消息</span><br><span class="line">.ENDIF</span><br></pre></td></tr></table></figure>



<h2 id="HeapAlloc-堆区中分配内存块"><a href="#HeapAlloc-堆区中分配内存块" class="headerlink" title="HeapAlloc 堆区中分配内存块"></a>HeapAlloc 堆区中分配内存块</h2><p>从已存在堆中分配一个内存块：</p>
<p>为什么还要分配!!!!!!!!!!!!!!!!!</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HeapAlloc PROTO,</span><br><span class="line">    hHeap:HANDLE,       ;现有堆内存块的句柄</span><br><span class="line">    dwFlags :DWORD,    ;堆分配控制标志</span><br><span class="line">    dwBytes:DWORD     ;分配的字节数</span><br></pre></td></tr></table></figure>

<p>需传递下述参数：</p>
<ul>
<li>hHeap：32 位堆句柄，该堆由 GetProcessHeap 或 HeapCreate 初始化。</li>
<li>dwFlags：一个双字，包含了一个或多个标志值。可以选择将其设置为 HEAP_ZERO_MEMORY，即设置内存块为全零。</li>
<li>dwBytes：一个双字，表示堆分配的字节数。</li>
</ul>
<p>如果 HeapAlloc 成功，则 EAX 包含指向新存储区的指针；</p>
<p>如果失败，则 EAX 中的返回值为 NULL。</p>
<p>下面的代码用 hHeap 标识一个堆，从该堆中分配了一个 1000 字节的数组，并将数组初始化为全零：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.data</span><br><span class="line">hHeap HANDLE ?    ;堆句柄</span><br><span class="line">pArray DWORD ?    ;数组指针</span><br><span class="line">.code</span><br><span class="line">INVOKE HeapAlloc, hHeap, HEAP_ZERO_MEMORY, 1000</span><br><span class="line">.IF eax == NULL</span><br><span class="line">    mWrite &quot;HeapAlloc failed&quot;</span><br><span class="line">    jmp quit</span><br><span class="line">.ELSE</span><br><span class="line">    mov pArray,eax</span><br><span class="line">.ENDI</span><br></pre></td></tr></table></figure>





<h2 id="HeapFree-释放在堆区分配的内存块"><a href="#HeapFree-释放在堆区分配的内存块" class="headerlink" title="HeapFree 释放在堆区分配的内存块"></a>HeapFree 释放在堆区分配的内存块</h2><p>函数 HeapFree 释放之前从堆中分配的一个内存块，该堆由其地址和堆句柄标识：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HeapFree PROTO,</span><br><span class="line">    hHeap:HANDLE,</span><br><span class="line">    dwFlags:DWORD,</span><br><span class="line">    lpMem:DWORD</span><br></pre></td></tr></table></figure>

<p>第一个参数是包含该内存块的堆的句柄。</p>
<p>第二个参数通常为零，</p>
<p>第三个参数是指向将被释放内存块的指针。</p>
<p>如果内存块释放成功，则返回值非零。非0是多少?????</p>
<p>如果该块不能被释放，则函数返回零。</p>
<p>例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INVOKE HeapFree, hHeap, 0, pArray</span><br></pre></td></tr></table></figure>



<h2 id="Error-Handling"><a href="#Error-Handling" class="headerlink" title="Error Handling"></a>Error Handling</h2><p>若在调用 HeapCreate、HeapDestroy 或 GetProcessHeap 时遇到错误，可以通过调用 API 函数 GetLastError 来获得详细信息。</p>
<h1 id="内嵌汇编"><a href="#内嵌汇编" class="headerlink" title="内嵌汇编"></a>内嵌汇编</h1><h2 id="asm-源于vs-2010"><a href="#asm-源于vs-2010" class="headerlink" title="__asm 源于vs-2010"></a>__asm 源于vs-2010</h2><p>提示：在“asm”的前面有两个下划线。</p>
<p>编写内嵌汇编代码时允许：</p>
<ul>
<li>使用 x86 指令集内的大多数指令。</li>
<li>使用寄存器名作为操作数。</li>
<li>通过名字引用函数参数。</li>
<li>引用在 asm 块之外定义的代码标号和变量。（这点很重要，因为局部函数变量必须在 asm 块的外面定义。）</li>
<li>使用包含在汇编风格或 C 风格基数表示法中的数字常数。比如，0A26h 和 0xA26 是等价的，且都能使用。</li>
<li>在语句中使用 PTR 运算符，比如 inc BYTE PTR[esi]。</li>
<li>使用 EVEN 和 ALIGN 伪指令。</li>
</ul>
<p>限制</p>
<p>编写内嵌汇编代码时不允许：</p>
<ul>
<li>使用数据定义伪指令，如 DB（BYTE）和 DW（WORD）。</li>
<li>使用汇编运算符（除了 PTR 之外）。</li>
<li>使用 STRUCT、RECORD, WIDTH 和 MASK。</li>
<li>使用宏伪指令，包括 MACRO、REPT、IRC、IRP 和 ENDM，以及宏运算符（&lt;&gt;、!、&amp;、% 和 .TYPE）。</li>
<li>通过名字引用段。（但是，可以用段寄存器名作为操作数。）</li>
</ul>
<p>对于printf输出字符串,还是要传入字符串的地址,用addr,不能用数组名.woc</p>
<p>还有就是%d的操作对象是32位的数据</p>
<h2 id="asm-源于linux系统的nasm"><a href="#asm-源于linux系统的nasm" class="headerlink" title="_asm _ 源于linux系统的nasm"></a>_asm _ 源于linux系统的nasm</h2><p>每一行有不同的情况结束</p>
<h3 id="基本内联"><a href="#基本内联" class="headerlink" title="基本内联"></a>基本内联</h3><p>1️⃣</p>
<p>__ asm __();</p>
<p>2️⃣</p>
<p>汇编里面每一句都用<code>&quot;&quot;</code>括起来</p>
<p>最后一句不用分号</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;mov rax,x;&quot;</span>	<span class="comment">//形式1</span></span><br><span class="line"><span class="string">&quot;mov rax,a \n&quot;</span> <span class="comment">//形式2</span></span><br><span class="line"><span class="string">&quot;mov prod,rax&quot;</span> <span class="comment">//最后一句</span></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> x=<span class="number">11</span>,y=<span class="number">12</span>,sum,prod;</span><br><span class="line"><span class="type">int</span> <span class="title function_">subtract</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">multiply</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;The numbers are %d and %d\n&quot;</span>,x,y);</span><br><span class="line">	__asm__</span><br><span class="line">	(</span><br><span class="line">		<span class="string">&quot;.intel_syntax noprefix;&quot;</span>   </span><br><span class="line">		<span class="string">&quot;mov rax,x;&quot;</span></span><br><span class="line">		<span class="string">&quot;add rax,y;&quot;</span></span><br><span class="line">		<span class="string">&quot;mov sum,rax&quot;</span></span><br><span class="line">	);</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;The sum is %d.\n&quot;</span>,sum);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;The difference is %d.\n&quot;</span>,subtract());</span><br><span class="line">	multiply();</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;The product is %d.\n&quot;</span>,prod);	</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">subtract</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	__asm__</span><br><span class="line">	(</span><br><span class="line">		<span class="string">&quot;.intel_syntax noprefix;&quot;</span>   </span><br><span class="line">		<span class="string">&quot;mov rax,x;&quot;</span></span><br><span class="line">		<span class="string">&quot;sub rax,y&quot;</span>			<span class="comment">// return value in rax</span></span><br><span class="line">	);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">multiply</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	__asm__</span><br><span class="line">	(</span><br><span class="line">		<span class="string">&quot;.intel_syntax noprefix;&quot;</span>   </span><br><span class="line">		<span class="string">&quot;mov rax,x;&quot;</span></span><br><span class="line">		<span class="string">&quot;imul rax,y;&quot;</span></span><br><span class="line">		<span class="string">&quot;mov prod,rax&quot;</span>			<span class="comment">//no return value, result in prod</span></span><br><span class="line">	);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="扩展内联"><a href="#扩展内联" class="headerlink" title="扩展内联"></a>扩展内联</h3><p>1️⃣.寄存器约束</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">:&quot;=a&quot;(esum)</span><br><span class="line">:&quot;d&quot;(x), &quot;c&quot;(y)</span><br></pre></td></tr></table></figure>

<p>a-&gt;rax.eax.ax.al</p>
<p>b-&gt;rbx.ebx.bx.bl</p>
<p>c-&gt;rcx.ecx.cx.cl</p>
<p>d-&gt;rdx.edx.dx.dl</p>
<p>s-&gt;rsi.esi.si</p>
<p>d-&gt;rdi.edi.di</p>
<p>r-&gt;任意寄存器</p>
<p>2️⃣.</p>
<p>可选项以<code>:</code>开头</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">:&quot;=a&quot;(eproduct)</span><br><span class="line">:&quot;d&quot;(x), &quot;c&quot;(y)</span><br><span class="line">:&quot;rbx&quot;</span><br><span class="line">//这里的rdx会被认为是被破坏的,将恢复原始值,但它不会引起崩溃</span><br></pre></td></tr></table></figure>

<p>3️⃣.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">:&quot;=a&quot;(esum)</span><br><span class="line">:&quot;d&quot;(x), &quot;c&quot;(y)</span><br></pre></td></tr></table></figure>

<p>表示输出是rax,rax引用变量esum</p>
<p>输入是rdx,rcx,分别引用x,y</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// inline2.c</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line">	<span class="type">int</span> a=<span class="number">12</span>;	<span class="comment">// global variables</span></span><br><span class="line">	<span class="type">int</span> b=<span class="number">13</span>;</span><br><span class="line">	<span class="type">int</span> bsum;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;The global variables are %d and %d\n&quot;</span>,a,b);</span><br><span class="line">__asm__(</span><br><span class="line">	<span class="string">&quot;.intel_syntax noprefix\n&quot;</span></span><br><span class="line">	<span class="string">&quot;mov rax,a \n&quot;</span></span><br><span class="line">	<span class="string">&quot;add rax,b \n&quot;</span></span><br><span class="line">	<span class="string">&quot;mov bsum,rax \n&quot;</span></span><br><span class="line">	:::<span class="string">&quot;rax&quot;</span></span><br><span class="line">	);</span><br><span class="line"></span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;The extended inline sum of global variables is %d.\n\n&quot;</span>, bsum);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> x=<span class="number">14</span>,y=<span class="number">16</span>, esum, eproduct, edif;  <span class="comment">// local variables</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;The local variables are %d and %d\n&quot;</span>,x,y);</span><br><span class="line"></span><br><span class="line">__asm__( </span><br><span class="line">	<span class="string">&quot;.intel_syntax noprefix;&quot;</span></span><br><span class="line">	<span class="string">&quot;mov rax,rdx;&quot;</span></span><br><span class="line">	<span class="string">&quot;add rax,rcx;&quot;</span></span><br><span class="line">	:<span class="string">&quot;=a&quot;</span>(esum)</span><br><span class="line">	:<span class="string">&quot;d&quot;</span>(x), <span class="string">&quot;c&quot;</span>(y)</span><br><span class="line">	);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;The extended inline sum is %d.\n&quot;</span>, esum);</span><br><span class="line"></span><br><span class="line">__asm__(</span><br><span class="line">	<span class="string">&quot;.intel_syntax noprefix;&quot;</span></span><br><span class="line">	<span class="string">&quot;mov rbx,rdx;&quot;</span></span><br><span class="line">	<span class="string">&quot;imul rbx,rcx;&quot;</span></span><br><span class="line">	<span class="string">&quot;mov rax,rbx;&quot;</span></span><br><span class="line">	:<span class="string">&quot;=a&quot;</span>(eproduct)</span><br><span class="line">	:<span class="string">&quot;d&quot;</span>(x), <span class="string">&quot;c&quot;</span>(y)</span><br><span class="line">	:<span class="string">&quot;rbx&quot;</span></span><br><span class="line">	);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;The extended inline product is %d.\n&quot;</span>, eproduct);</span><br><span class="line"></span><br><span class="line">__asm__(</span><br><span class="line">	<span class="string">&quot;.intel_syntax noprefix;&quot;</span></span><br><span class="line">	<span class="string">&quot;mov rax,rdx;&quot;</span></span><br><span class="line">	<span class="string">&quot;sub rax,rcx;&quot;</span></span><br><span class="line">	:<span class="string">&quot;=a&quot;</span>(edif)</span><br><span class="line">	:<span class="string">&quot;d&quot;</span>(x), <span class="string">&quot;c&quot;</span>(y)</span><br><span class="line">	);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;The extended inline asm difference is %d.\n&quot;</span>, edif);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="中断程序"><a href="#中断程序" class="headerlink" title="中断程序"></a>中断程序</h1><h2 id="8086"><a href="#8086" class="headerlink" title="8086"></a>8086</h2><h3 id="①-内中断"><a href="#①-内中断" class="headerlink" title="①. 内中断"></a>①. 内中断</h3><p>就是CPU立刻需要一个程序去处理的中途发生的异常,好像类似于<code>C++异常</code></p>
<p>什么是内中断?就是程序运行后,你不去物理的碰它,它发生的中断</p>
<p>关于这本书讲的中断安装….什么意思??????</p>
<p>也就是说当你打开你的DOS-BOX,然后你运行了你的中断代码.你的程序就修改了系统的一下配置,</p>
<p>但你再运行你的DOS-BOX,前提是你没有关闭,你就可以再次运行,你的系统默认中断就已经被修改了</p>
<p>好比这个安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code,ss:stack</span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">  db 32 dup(&#x27;S&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">                                   </span><br><span class="line">                                    mov ax,stack</span><br><span class="line">                                    mov ss,ax</span><br><span class="line">                                    mov sp,32</span><br><span class="line"></span><br><span class="line">                                    push cs</span><br><span class="line">                                    pop  ds</span><br><span class="line">                                    mov  si,offset int9</span><br><span class="line"></span><br><span class="line">                                    mov ax,0</span><br><span class="line">                                    mov es,ax</span><br><span class="line">                                    mov di,204h</span><br><span class="line"> </span><br><span class="line">                                    mov cx,offset int9_end - offset int9</span><br><span class="line"></span><br><span class="line">                                    cld</span><br><span class="line">                                    rep movsb</span><br><span class="line"></span><br><span class="line">                                    push es:[9*4+0]</span><br><span class="line">                                    pop  es:[200h+0]</span><br><span class="line">                                    push es:[9*4+2]</span><br><span class="line">                                    pop  es:[200h+2]</span><br><span class="line"></span><br><span class="line">                                    cli</span><br><span class="line">                                    mov word ptr es:[9*4+0],204h</span><br><span class="line">                                    mov word ptr es:[9*4+2],0</span><br><span class="line">                                    sti</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                                    mov ax,4c00h</span><br><span class="line">                                    int 21h</span><br><span class="line"></span><br><span class="line">                           int9:</span><br><span class="line">                                    push ax</span><br><span class="line">                                    push bx</span><br><span class="line">                                    push cx</span><br><span class="line">                                    push es</span><br><span class="line"></span><br><span class="line">                                    in al,60h</span><br><span class="line">                                    pushf</span><br><span class="line">                                    call dword ptr cs:[200h];调用int 9的中断</span><br><span class="line"></span><br><span class="line">                                    cmp al,48h;F1--&gt;3bh         </span><br><span class="line">                                    jne int9ret</span><br><span class="line"></span><br><span class="line">                                    mov ax,0b800h</span><br><span class="line">                                    mov es,ax</span><br><span class="line">                                    mov bx,1</span><br><span class="line">                                    mov cx,2000</span><br><span class="line">                                s:</span><br><span class="line">                                    inc byte ptr es:[bx]</span><br><span class="line">                                    add bx,2</span><br><span class="line">                                    loop s</span><br><span class="line"></span><br><span class="line">                          int9ret:  </span><br><span class="line">                                     pop es</span><br><span class="line">                                     pop cx</span><br><span class="line">                                     pop bx</span><br><span class="line">                                     pop ax</span><br><span class="line">                                     iret</span><br><span class="line">                          int9_end:  nop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start      </span><br></pre></td></tr></table></figure>

<p>当执行了这个代码后,你按一下<code>↑</code>就可以修改屏幕的颜色</p>
<p>关于写中断要注意什么????</p>
<p>你的中断不能影响原来寄存器的的状态…好比通用寄存器,标志寄存器..不是不可以动,,,只是不要动main的程序</p>
<h4 id="简要介绍"><a href="#简要介绍" class="headerlink" title="简要介绍"></a>简要介绍</h4><p>好比这样一个位置,中断向量表开始位置0000:0000</p>
<p>0000:4*0x7C</p>
<p>上面这个地址表示的是index&#x3D;0x7C的中断类型码</p>
<p>在位置0000:4*0x7C下</p>
<p>[0000:4*0x7C+0]&#x3D;某个中断例程的IP, 比如IP&#x3D;0x200</p>
<p>[0000:4*0x7C+2]&#x3D;某个中断例程的CS,比如CS&#x3D;0000</p>
<p>于是你调用中断</p>
<p><code>int 7ch</code></p>
<p>那么系统去0000:0000找到7ch</p>
<p>然后按去往IP&#x3D;[0000:4 * 0x7C+0],CS&#x3D;[0000:4 * 0x7C+2]的地址处执行中断例程</p>
<h4 id="中断的过程的入栈"><a href="#中断的过程的入栈" class="headerlink" title="中断的过程的入栈"></a>中断的过程的入栈</h4><p>调用<code>int index</code>就会<code>push 所有的寄存器,然后push cs,push ip</code></p>
<p>最后的出栈..它会调用<code>iret</code>把上面的东西都<code>pop 出去</code></p>
<p>调用了<code>int</code>,如果你想退出程序,就在初始化int函数时,写上下面的代码</p>
<p>这个代码什么意思?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov ax,4c00h</span><br><span class="line">int 21h</span><br></pre></td></tr></table></figure>



<p>调用<code>int 21h</code>中断,在调用前,初始化<code>指向子函数ah=4c,然后配置al=0</code></p>
<p>push 寄存器???</p>
<p>标志寄存器有假设10个?</p>
<p>其中8个他们的状态是11001010,于是我们把它看作一个8位的数据,可以达到<code>11001010b</code>&#x3D;<code>0xCA</code>,于是我们就把<code>0xCA</code>入栈</p>
<p>然后我们再push <code>IF,TF</code>,他们与外中断的屏蔽有关,,调用内中断时,会让<code>IF=0</code>,屏蔽了可屏蔽的外中断</p>
<p>于是我们才会用入栈6字节的数据,<code>4字节是CS:IP,2字节是8个寄存器值和2个寄存器值</code></p>
<h4 id="如何DIY一个中断"><a href="#如何DIY一个中断" class="headerlink" title="如何DIY一个中断"></a>如何DIY一个中断</h4><p>把它封装为一个函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">call init_do0</span><br><span class="line">//然后去写中断函数,安装中断函数</span><br></pre></td></tr></table></figure>

<p>书写中断函数</p>
<p>调用复制功能的函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//调用代码复制函数,因为你无法直接向中断向量的地址处写入数据,只能复制过去</span><br><span class="line">初始化DS:[SI]</span><br><span class="line">初始化ES:[di]</span><br><span class="line">初始化CX//涉及到了offset的取地址</span><br><span class="line">//这里是依据把中断函数写好了然后去复制</span><br><span class="line">执行 </span><br><span class="line">cld</span><br><span class="line">rep movsb</span><br><span class="line"></span><br><span class="line">然后初始化一下中断向量表指向那个地址</span><br><span class="line">                            mov ax,0</span><br><span class="line">                            mov es,ax</span><br><span class="line">                            mov word ptr es:[0*4+0],200h</span><br><span class="line">                            mov word ptr es:[0*4+2],0</span><br></pre></td></tr></table></figure>

<p>这个代码的意思就是</p>
<p>初始化<code>0号</code>中断,让<code>0号中断</code>执行中断例程的地址0000:0200</p>
<p>代码一</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code ,  ss:stack</span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">    db 128 dup(&#x27;y&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:                     </span><br><span class="line">                            mov ax,stack</span><br><span class="line">                            mov ss,ax;</span><br><span class="line">                            mov sp,128</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                            call init_do0;他只会push ip</span><br><span class="line">                            mov ax,1000h</span><br><span class="line">                            mov bh,1</span><br><span class="line">                            div bh</span><br><span class="line"></span><br><span class="line">                            mov ax,4c00h</span><br><span class="line">                            int 21h</span><br><span class="line">;-----------------------------------------------------------------------------------------------------------------</span><br><span class="line">                 </span><br><span class="line">                init_do0:</span><br><span class="line">                            ;先是修改数据的指向,然后是复制中断代码到中断区,中断区域的调用是自动的</span><br><span class="line">                            ;--------------------------------------------</span><br><span class="line">                            ;设置数据来源 S指-&gt;CS:[do0]</span><br><span class="line">                            mov ax,cs</span><br><span class="line">                            mov ds,ax</span><br><span class="line">                            mov si,offset do0;这样取地址就非常的妙..不想你之前根本想不到</span><br><span class="line">                            </span><br><span class="line">                            ;设置数据D-&gt;0000:[0200]</span><br><span class="line">                            mov ax,0</span><br><span class="line">                            mov es,ax</span><br><span class="line">                            mov di,200h</span><br><span class="line"></span><br><span class="line">                            mov cx,offset do0end - offset do0;循环的次数</span><br><span class="line"></span><br><span class="line">                            cld</span><br><span class="line">                            rep movsb</span><br><span class="line">                            </span><br><span class="line">                           </span><br><span class="line">                            ;数据指向完成后,初始化一下中断向量表,第[0]个向量表的地址0000:0200</span><br><span class="line">                            mov ax,0</span><br><span class="line">                            mov es,ax</span><br><span class="line">                            mov word ptr es:[0*4+0],200h</span><br><span class="line">                            mov word ptr es:[0*4+2],0</span><br><span class="line">                            </span><br><span class="line"></span><br><span class="line">                            ret  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                            ;--------------------------------------</span><br><span class="line">                    do0:</span><br><span class="line">                            jmp short do0start</span><br><span class="line">                            db &quot;over flow&quot;</span><br><span class="line">                    do0start:</span><br><span class="line">                            mov ax,cs;</span><br><span class="line">                            mov ds,ax</span><br><span class="line">                            mov si,202h;这里的si可能是在指向字符串的偏移地址,jmp占据2个字节,然后他后面的就是字符串数据</span><br><span class="line"></span><br><span class="line">                            ;y要显示的字符串</span><br><span class="line">                            mov ax,0b800h</span><br><span class="line">                            mov es,ax</span><br><span class="line"></span><br><span class="line">                            mov cx,2000</span><br><span class="line">                            mov dx,0700h</span><br><span class="line">                            mov bx,0        </span><br><span class="line">                clean_screen:</span><br><span class="line">                            mov es:[bx],dx</span><br><span class="line">                            add bx,2</span><br><span class="line">                            loop clean_screen</span><br><span class="line"></span><br><span class="line">                            mov di,12*160+36*2</span><br><span class="line"></span><br><span class="line">                            mov cx,9;字符串的长度</span><br><span class="line">                    S:</span><br><span class="line">                            mov al,ds:[si]</span><br><span class="line">                            mov ah,2</span><br><span class="line">                            mov es:[di],ax</span><br><span class="line">                            inc si</span><br><span class="line">                            add di,2</span><br><span class="line">                            loop S</span><br><span class="line"></span><br><span class="line">                            iret;他会pop ip,所以他就是类似于一个ret    </span><br><span class="line"></span><br><span class="line">                           </span><br><span class="line"></span><br><span class="line">                do0end:        </span><br><span class="line">                            nop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>









<h4 id="怎么调用一个中断"><a href="#怎么调用一个中断" class="headerlink" title="怎么调用一个中断"></a>怎么调用一个中断</h4><ol>
<li>程序崩溃时调用</li>
<li>人为的直接int index 调用</li>
</ol>
<p>我自己写的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code ,  ss:stack</span><br><span class="line"></span><br><span class="line">stack segment </span><br><span class="line">    db 32 dup(&#x27;0&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start: </span><br><span class="line">                                ;栈的初始化,容易忘记出初始化sp</span><br><span class="line">                                mov ax,stack</span><br><span class="line">                                mov ss,ax</span><br><span class="line">                                mov sp,32</span><br><span class="line"></span><br><span class="line">                                ;初始化内中断实例</span><br><span class="line">                                call init_do7ch</span><br><span class="line"></span><br><span class="line">                                ;向显存写东西</span><br><span class="line">                                mov ax,0b800h</span><br><span class="line">                                mov es,ax</span><br><span class="line">                                mov di,160*20+30</span><br><span class="line"></span><br><span class="line">                                ;初始化一些吸入什么东西</span><br><span class="line">                                mov ah,2</span><br><span class="line">                                mov al,&#x27;!&#x27;</span><br><span class="line">                                ;打印的个数</span><br><span class="line">                                mov cx,4</span><br><span class="line">                                ;安全的让bp=0</span><br><span class="line">                                mov bp,0</span><br><span class="line">                                ;待会ip要回走,所以需要一个地址的间隔</span><br><span class="line">                                mov bx,offset s0end -offset s0</span><br><span class="line">                        s0:</span><br><span class="line">                                ;开始写入显存</span><br><span class="line">                                mov es:[di],ax</span><br><span class="line">                                ;遍历</span><br><span class="line">                                add di,2</span><br><span class="line">                                ;调用</span><br><span class="line">                                int 7ch</span><br><span class="line">                        s0end:</span><br><span class="line">                                ;标志一下位置</span><br><span class="line">                                nop</span><br><span class="line"></span><br><span class="line">                                mov ax,4c00h</span><br><span class="line">                                int 21h</span><br><span class="line"></span><br><span class="line">                        init_do7ch:</span><br><span class="line">                                ;source</span><br><span class="line">                                mov ax,cs</span><br><span class="line">                                mov ds,ax</span><br><span class="line">                                mov si,offset do7ch</span><br><span class="line">                                ;destaion</span><br><span class="line">                                mov ax,0</span><br><span class="line">                                mov es,ax</span><br><span class="line">                                mov di,200h</span><br><span class="line">                                ;复制多少字节</span><br><span class="line">                                mov cx,offset do7chend - offset do7ch</span><br><span class="line"></span><br><span class="line">                                cld</span><br><span class="line">                                rep movsb</span><br><span class="line">                                ;初始化向量表</span><br><span class="line">                                mov word ptr es:[7ch*4+0],200h</span><br><span class="line">                                mov word ptr es:[7ch*4+2],0</span><br><span class="line"></span><br><span class="line">                                ret</span><br><span class="line"></span><br><span class="line">                        do7ch:</span><br><span class="line">                                ;判断是否结束</span><br><span class="line">                                dec cx</span><br><span class="line">                                jcxz lpret</span><br><span class="line">                                ;保存一下bp,因为bp=sp,在发生变化</span><br><span class="line">                                push bp</span><br><span class="line">                                mov bp,sp</span><br><span class="line">                                sub ss:[bp+2],bx;让栈了里里面的ip重新指向开始的地方</span><br><span class="line">                                pop bp</span><br><span class="line"></span><br><span class="line">                        lpret:</span><br><span class="line">                                iret</span><br><span class="line">                        do7chend:nop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>



<h4 id="int-10h-gt-ah-x3D-2-光标中断"><a href="#int-10h-gt-ah-x3D-2-光标中断" class="headerlink" title="int  10h-&gt;ah&#x3D;2 光标中断"></a>int  10h-&gt;ah&#x3D;2 光标中断</h4><p>int 10h-&gt;ah&#x3D;2置光标</p>
<p>bh-&gt;第几页</p>
<p>dh-&gt;第几行</p>
<p>dl-&gt;第几列</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mov ah,2; int 10h的子程序</span><br><span class="line">mov bh,0	;bh是di某页</span><br><span class="line">mov dh,5	;行号</span><br><span class="line">mov dl,12	;列号</span><br><span class="line">int  10h	;10h中断例程</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>80x25的字符模式下</p>
<p>0~24共25行</p>
<p>0~79共80列</p>
<p>0~7共8页</p>
<p>在80x25的模式下,B800~BFFF有32kb默认显示第0页</p>
<h4 id="int-10h-gt-ah-x3D-9-显示一个字符"><a href="#int-10h-gt-ah-x3D-9-显示一个字符" class="headerlink" title="int 10h-&gt;ah&#x3D;9 显示一个字符"></a>int 10h-&gt;ah&#x3D;9 显示一个字符</h4><p>int 10h-&gt;ah&#x3D;9,在光标处显示字符</p>
<p>al-&gt;显示的字符</p>
<p>bl-&gt;颜色</p>
<p>bh-&gt;第几页</p>
<p>cx-&gt;重复显示的个数,往后挪</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mov ah,9;调用子函数</span><br><span class="line">mov al,&#x27;?&#x27;;显示字符&#x27;?&#x27;</span><br><span class="line">mov bl,7;颜色的属性</span><br><span class="line">mov bh,0;第0页</span><br><span class="line">mov cx,3;字符重复的个数</span><br><span class="line">int 10h;调用中断</span><br></pre></td></tr></table></figure>





<h4 id="int-21h-gt-ah-x3D-9-输出以‘-’结尾的字符串"><a href="#int-21h-gt-ah-x3D-9-输出以‘-’结尾的字符串" class="headerlink" title="int 21h-&gt;ah&#x3D;9 输出以‘$’结尾的字符串"></a>int 21h-&gt;ah&#x3D;9 输出以‘$’结尾的字符串</h4><p>ds-&gt;数据来源的短地址</p>
<p>dx-&gt;数据来源的偏移地址</p>
<p>ah-&gt;9功能编号,输出字符串,遇到<code>$</code>结束</p>
<p>int 21h</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov ax,data</span><br><span class="line">mov ds,ax</span><br><span class="line">mov dx,0</span><br><span class="line">mov ah,9</span><br><span class="line">in 21h</span><br></pre></td></tr></table></figure>







<h3 id="②-外中断"><a href="#②-外中断" class="headerlink" title="②. 外中断"></a>②. 外中断</h3><h4 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h4><p>外中断-&gt;1.可以被屏蔽	2.不可以屏蔽(其中断类型码只能是<code>2</code>)</p>
<p>之前内中断我们初始化了IF</p>
<p>对于可屏蔽的中断,</p>
<p><code>IF=1,表示屏蔽中断,IF=0,表示不屏蔽中断</code></p>
<p>指令</p>
<blockquote>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sti,置IF=1</span><br><span class="line">cli 置IF=0</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="PC机I-x2F-O键盘处理过程"><a href="#PC机I-x2F-O键盘处理过程" class="headerlink" title="PC机I&#x2F;O键盘处理过程"></a>PC机I&#x2F;O键盘处理过程</h4><p>键盘主板寄存器的端口是<code>60h</code></p>
<p>按下一个键,芯片产生一个扫描码,叫<code>通码</code></p>
<p>松开一个键,芯片也会产生一个扫描码,叫<code>断码</code></p>
<p>断码&#x3D;通码+80h</p>
<p>80h&#x3D;&#x3D;1000 0000b</p>
<p>可见最开头那位是一个开关之类的东西</p>
<p><code>int 9</code>只是对你的键入做了一个判断与执行..至于你的键入后怎么操作..这就得看你怎么对<code>int 9</code>去DIY的配置</p>
<blockquote>
<p>   我还是不太明白<code>int9</code>到底有个啥用!!!!!!!!!!!!!!!!</p>
</blockquote>
<p>​                                                    </p>
<h4 id="int-9中断-打印ascii的abcef"><a href="#int-9中断-打印ascii的abcef" class="headerlink" title="int 9中断  打印ascii的abcef"></a>int 9中断  打印ascii的abcef</h4><p>键盘的输入达到<code>60h</code>端口时,芯片就会自动的向CPU发出<code>int 9</code>的中码断,如果CPU检测到<code>IF=1</code>则表示接受外界键入,然后去指向<code>int 9</code>中断过程如果<code>IF=0</code>,表述拒绝接受键入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code,ds:data,ss:stack</span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">  db 32 dup(&#x27;S&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">data segment</span><br><span class="line">  db 128 dup(&#x27;D&#x27;)</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line"></span><br><span class="line">start:</span><br><span class="line">                                        </span><br><span class="line">                                        mov ax,data</span><br><span class="line">                                        mov ds,ax</span><br><span class="line">                                        </span><br><span class="line">                                        mov ax,stack</span><br><span class="line">                                        mov ss,ax</span><br><span class="line">                                        mov sp,32</span><br><span class="line"></span><br><span class="line">                                        mov ax,0b800h</span><br><span class="line">                                        mov es,ax</span><br><span class="line"></span><br><span class="line">                                        call init_9h;专门成立一个函数去初始会化int9,而且更大程度的保障了寄存器不发生更多的变化</span><br><span class="line">                                ;===========================================================</span><br><span class="line"></span><br><span class="line">                                        mov cx,0</span><br><span class="line">                                        ;从感叹号开始显示</span><br><span class="line">                                        mov cl,&#x27;!&#x27;</span><br><span class="line">                                        ;颜色从2开始</span><br><span class="line">                                        mov ch,2</span><br><span class="line">                                        ;开始的地点是10行20列</span><br><span class="line">                                        mov di,160*10+20</span><br><span class="line"></span><br><span class="line">                                show:     </span><br><span class="line">                                        ;把配置输入到显存                           </span><br><span class="line">                                        mov es:[di],cx</span><br><span class="line">                                        ;加缓延时</span><br><span class="line">                                        call delay;delay函数不能与cmp与jne交叉,以为delay内部会有指令修改寄存器的操作  </span><br><span class="line">                                        ;指向下一个像素                           </span><br><span class="line">                                        add di,2</span><br><span class="line">                                        ;指向下一个字符</span><br><span class="line">                                        inc cl</span><br><span class="line">                                        ;重点是&#x27;~&#x27;</span><br><span class="line">                                        cmp cl,&#x27;~&#x27;</span><br><span class="line">                                        jna show</span><br><span class="line"></span><br><span class="line">                                        ;备份int9的原始向量</span><br><span class="line">                                        mov ax,0</span><br><span class="line">                                        mov es,ax</span><br><span class="line">                                        </span><br><span class="line">                                        ;原始向量恢复到向量表,,,否者DOS系统运行完毕后键盘将屏蔽你的外中断</span><br><span class="line">                                        push ds:[0]</span><br><span class="line">                                        pop es:[9*4+0]</span><br><span class="line">                                        push ds:[2]</span><br><span class="line">                                        pop es:[9*4+2]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                                        mov ax,4c00h</span><br><span class="line">                                        int 21h</span><br><span class="line">                                ;============================================================</span><br><span class="line">                                 delay:</span><br><span class="line">                                        ;它的原理我不太懂</span><br><span class="line">                                        mov ax,0</span><br><span class="line">                                        mov bx,1h</span><br><span class="line">                        delay_continue:</span><br><span class="line">                                        sub ax,1;它是控制速度的</span><br><span class="line">                                        sbb bx,0</span><br><span class="line">                                        cmp ax,0</span><br><span class="line">                                        jne delay_continue</span><br><span class="line">                                        cmp bx,0</span><br><span class="line">                                        jne delay_continue</span><br><span class="line"></span><br><span class="line">                                        ret</span><br><span class="line">                                ;============================================================</span><br><span class="line">                        init_9h:</span><br><span class="line">                                        push es</span><br><span class="line"></span><br><span class="line">                                        mov ax,0</span><br><span class="line">                                        mov es,ax</span><br><span class="line"></span><br><span class="line">                                        ;备份int 9的中断向量表</span><br><span class="line">                                        push es:[9*4+0]</span><br><span class="line">                                        pop ds:[0]</span><br><span class="line">                                        push es:[9*4+2] </span><br><span class="line">                                        pop ds:[2]</span><br><span class="line"></span><br><span class="line">                                        cli</span><br><span class="line">                                        mov word ptr es:[9*4+0],offset start_9h</span><br><span class="line">                                        mov es:[9*4+2],cs</span><br><span class="line">                                        sti</span><br><span class="line"></span><br><span class="line">                                        pop es</span><br><span class="line">                                        ret</span><br><span class="line">                            </span><br><span class="line">                              start_9h:</span><br><span class="line">                                        ;你键入的数据在端口60处</span><br><span class="line">                                        in al,60h;al从端口接收了你的键入</span><br><span class="line">                                        ;模拟int9的过程,push全部寄存器,然后push cs,IP</span><br><span class="line">                                        pushf</span><br><span class="line">                                        call dword ptr ds:[0];int9自己有iret</span><br><span class="line">                                        cmp al,48h;48h是 ↑</span><br><span class="line">                                        jne start_9h_end;如果不是上就跳过然后结束,如果这里用je会比较麻烦!!!!!!!!!!!!!!!!</span><br><span class="line">                                        inc ch</span><br><span class="line">                            start_9h_end:</span><br><span class="line">                                        iret</span><br><span class="line">                            ;=========================================================================</span><br><span class="line">                              </span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>





<h2 id="x64"><a href="#x64" class="headerlink" title="x64"></a>x64</h2><h3 id="printf-syscall"><a href="#printf-syscall" class="headerlink" title="printf_syscall"></a>printf_syscall</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov		rax,1</span><br><span class="line">mov		rdi,1</span><br><span class="line">mov 	rsi,str1</span><br><span class="line">mov 	rdx,len1</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure>

<p>rax的1代表了写入</p>
<p>rdi的1代表了标准输出</p>
<p>rsi代表了字符串输出的地址</p>
<p>rdx代表了输出的长度,最后的0不计数</p>
<p>syscall调用系统内部的和中断</p>
<p>这些寄存器可否用于其他的用途</p>
<p>于是你封装函数的时候,就传递一些动态参数,初始化一些固定的参数</p>
<h3 id="scanf-syscall"><a href="#scanf-syscall" class="headerlink" title="scanf_syscall"></a>scanf_syscall</h3><p>rax&#x3D;0,表示读取</p>
<p>rdi&#x3D;1,表示标准输入</p>
<p>rsi&#x3D;输入字符串的地址</p>
<p>rdx&#x3D;输入字符串的长度</p>
<p>它没有格式化输入与输出</p>
<p>你的rsi是字符串,你就只能输入字符串???</p>
<p>你的rsi指向dd.你就只能输入数值??</p>
<h3 id="ret-syscall"><a href="#ret-syscall" class="headerlink" title="ret_syscall"></a>ret_syscall</h3><p>下面的代码等效于main函数的return,好比ret</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov     rax, 60		; 60 = exit</span><br><span class="line">mov     rdi, 0		; 0 = success exit code</span><br><span class="line">syscall				; quit</span><br></pre></td></tr></table></figure>



<h1 id="端口"><a href="#端口" class="headerlink" title="端口"></a>端口</h1><p>类比一下中断程序</p>
<p>因为书上没有怎么介绍..依次我就没有多多的解释</p>
<h2 id="一-读写指令"><a href="#一-读写指令" class="headerlink" title="(一). 读写指令"></a>(一). 读写指令</h2><p>从<code>右-&gt;左</code>看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(读) in 寄存器/数据,  端口				//端口S的数据读进D寄存器</span><br><span class="line">(写) out 端口,       寄存器/数据		//把S的数据写进</span><br></pre></td></tr></table></figure>



<h3 id="读"><a href="#读" class="headerlink" title="读"></a>读</h3><p>从端口读入到接收者</p>
<p>端口是一个编号,也可以是装有编号的寄存器</p>
<p>写入的数据是8位就只能用AL</p>
<p>如果是16位就用AX</p>
<h3 id="写"><a href="#写" class="headerlink" title="写"></a>写</h3><p>把数据写入端口</p>
<p>端口是一个编号,也可以是装有编号的寄存器</p>
<p>写入的数据是8位就只能用AL</p>
<h2 id="二-CMOS-RAM-芯片端口"><a href="#二-CMOS-RAM-芯片端口" class="headerlink" title="(二). CMOS RAM 芯片端口"></a>(二). CMOS RAM 芯片端口</h2><h3 id="简要介绍-1"><a href="#简要介绍-1" class="headerlink" title="简要介绍"></a>简要介绍</h3><p>该芯片内部有2个端口,</p>
<p>端口地址</p>
<p>可以是70h,代表了地址写入的端口</p>
<p>可以是71h,代表了数据读取&#x2F;写入的端口</p>
<p>如何读取CMOS RAM的2号单元</p>
<p>①. 把2号写入71h <code>out 70h,2</code></p>
<p>②. 71h数据读入<code> in ax,71h</code></p>
<p>检测点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code,ss:stack</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data segment</span><br><span class="line">    db &#x27;i really love love you&#x27;,&#x27;$&#x27;</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">        db 128 dup(&#x27;y&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line"></span><br><span class="line">start:</span><br><span class="line">                                mov ax,stack</span><br><span class="line">                                mov ss,ax</span><br><span class="line">                                mov sp,128</span><br><span class="line"></span><br><span class="line">                                mov ax,0</span><br><span class="line">                                mov al,2</span><br><span class="line"></span><br><span class="line">                                out 70h,al</span><br><span class="line">                                mov ax,0</span><br><span class="line">                                in  al,71h</span><br><span class="line">                        </span><br><span class="line">                                mov ax,4c00h</span><br><span class="line">                                int 21h</span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>



<h3 id="CMOS下的时间单元"><a href="#CMOS下的时间单元" class="headerlink" title="CMOS下的时间单元"></a>CMOS下的时间单元</h3><h4 id="什么叫BCD码"><a href="#什么叫BCD码" class="headerlink" title="什么叫BCD码"></a>什么叫BCD码</h4><p><code>4位</code>的二进制就构成一个<code>BCD码</code></p>
<p>好比10进制的<code>26</code>就是由<code>0010</code>和<code>0110</code>构成</p>
<p><code>0010</code>代表<code>2</code></p>
<p><code>0110</code>代表<code>6</code></p>
<h4 id="时间单元"><a href="#时间单元" class="headerlink" title="时间单元"></a>时间单元</h4><table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>年</td>
<td>月</td>
<td>日</td>
<td>时</td>
<td>分</td>
<td>秒</td>
</tr>
<tr>
<td>9</td>
<td>8</td>
<td>7</td>
<td>4</td>
<td>2</td>
<td>0</td>
</tr>
</tbody></table>
<h5 id="打印月份"><a href="#打印月份" class="headerlink" title="打印月份"></a>打印月份</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code,ss:stack</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data segment</span><br><span class="line">    db &#x27;i really love love you&#x27;,&#x27;$&#x27;</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">        db 128 dup(&#x27;y&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line"></span><br><span class="line">start:</span><br><span class="line">                                mov ax,stack</span><br><span class="line">                                mov ss,ax</span><br><span class="line">                                mov sp,128</span><br><span class="line"></span><br><span class="line">                                mov ax,0</span><br><span class="line">                                mov al,8;把al写入数据端口</span><br><span class="line">                                out 70h,al;把对于单元的数据读取到al</span><br><span class="line">                                in  al,71h </span><br><span class="line"></span><br><span class="line">                                mov ah,al</span><br><span class="line">                                mov cl,4</span><br><span class="line">                                shr ah,cl</span><br><span class="line"></span><br><span class="line">                                and al,00001111b</span><br><span class="line"></span><br><span class="line">                                add al,30h</span><br><span class="line">                                add ah,30h</span><br><span class="line"></span><br><span class="line">                                push ax</span><br><span class="line"></span><br><span class="line">                                mov ax,0b800h</span><br><span class="line">                                mov es,ax</span><br><span class="line">                                mov di,0</span><br><span class="line"></span><br><span class="line">                                mov cx,2000</span><br><span class="line">                                mov bx,0700h</span><br><span class="line">                            s:</span><br><span class="line">                                mov es:[di],bx</span><br><span class="line">                                add di,2</span><br><span class="line">                                loop s</span><br><span class="line"></span><br><span class="line">                                pop ax</span><br><span class="line">                                mov di,160*10+20</span><br><span class="line">                                mov cl,11001010b</span><br><span class="line"></span><br><span class="line">                                mov es:[di+0],ah</span><br><span class="line">                                mov es:[di+1],cl</span><br><span class="line">                                mov es:[di+2],al</span><br><span class="line">                                mov es:[di+3],cl</span><br><span class="line"></span><br><span class="line">                                mov ax,4c00h</span><br><span class="line">                                int 21h</span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>



<h5 id="打印年月日时分秒"><a href="#打印年月日时分秒" class="headerlink" title="打印年月日时分秒"></a>打印年月日时分秒</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code,ss:stack, ds:data</span><br><span class="line"></span><br><span class="line">data segment</span><br><span class="line">  db &quot;2000/00/00/00:00:00-TIME-Dqx-Ghost&quot;,&#x27;$&#x27;</span><br><span class="line">  db 9,8,7,4,2,0</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">        db 128 dup(&#x27;y&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code segment  </span><br><span class="line">start:</span><br><span class="line"></span><br><span class="line">                                mov ax,stack</span><br><span class="line">                                mov ss,ax</span><br><span class="line">                                mov sp,128</span><br><span class="line"></span><br><span class="line">                                call clean_screen</span><br><span class="line"></span><br><span class="line">                                mov ax,data</span><br><span class="line">                                mov ds,ax</span><br><span class="line"></span><br><span class="line">                              k:                               </span><br><span class="line">                                call init_time                        </span><br><span class="line">                                call init_xy_and_show</span><br><span class="line">                                jmp k</span><br><span class="line"></span><br><span class="line">                                ;==========================================  </span><br><span class="line">                                mov ax,4c00h</span><br><span class="line">                                int 21h</span><br><span class="line">                               </span><br><span class="line">                      </span><br><span class="line">;======================================================================================</span><br><span class="line">                  clean_screen:</span><br><span class="line">                                mov ax,0b800h</span><br><span class="line">                                mov es,ax</span><br><span class="line">                                mov di,0</span><br><span class="line"></span><br><span class="line">                                mov cx,2000</span><br><span class="line">                                mov bx,0700h</span><br><span class="line">            clean_screen_start:</span><br><span class="line">                                mov es:[di],bx</span><br><span class="line">                                add di,2</span><br><span class="line">                                loop clean_screen_start</span><br><span class="line">                                ret</span><br><span class="line">;======================================================================================</span><br><span class="line">                init_time:</span><br><span class="line">                                ;数据源已经被初始化了                              </span><br><span class="line">                                ;循环6次</span><br><span class="line">                                mov cx,6</span><br><span class="line">                                ;初始化数据的指向</span><br><span class="line">                                mov si,35</span><br><span class="line">                                mov bx,2</span><br><span class="line">                                ;循环体部分                                </span><br><span class="line">                init_time_start:   </span><br><span class="line">                                push cx </span><br><span class="line">                                ;初始化端口编号  </span><br><span class="line">                                mov al,ds:[si]</span><br><span class="line">                                ;写入端口</span><br><span class="line">                                out 70h,al</span><br><span class="line">                                in  al,71h </span><br><span class="line"></span><br><span class="line">                                mov ah,al</span><br><span class="line">                                mov cl,4</span><br><span class="line">                                shr ah,cl</span><br><span class="line"></span><br><span class="line">                                and al,00001111b</span><br><span class="line"></span><br><span class="line">                                add al,30h</span><br><span class="line">                                add ah,30h</span><br><span class="line"></span><br><span class="line">                                mov byte ptr ds:[bx+0],ah</span><br><span class="line">                                mov byte ptr ds:[bx+1],al</span><br><span class="line"></span><br><span class="line">                                add bx,3</span><br><span class="line">                                inc si</span><br><span class="line">                                pop cx</span><br><span class="line">                                loop init_time_start</span><br><span class="line">                                </span><br><span class="line">                                ret</span><br><span class="line">;========================================================================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">              init_xy_and_show:</span><br><span class="line">                                mov ah,2</span><br><span class="line">                                mov bh,0</span><br><span class="line"></span><br><span class="line">                                mov dl,20</span><br><span class="line">                                mov dh,10</span><br><span class="line">                                int 10h</span><br><span class="line">                               </span><br><span class="line">                                ;数据源已经被初始化了</span><br><span class="line">                                mov dx,0</span><br><span class="line">                                mov ah,9</span><br><span class="line">                                int 21h</span><br><span class="line"></span><br><span class="line">                                ret</span><br><span class="line">                        </span><br><span class="line">code ends</span><br><span class="line">end start</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="利用BIOS进行键盘的读写"><a href="#利用BIOS进行键盘的读写" class="headerlink" title="利用BIOS进行键盘的读写"></a>利用BIOS进行键盘的读写</h3><p>这里涉及到一个<code>int 16h</code>中断</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov ax,0</span><br><span class="line">int 16h</span><br></pre></td></tr></table></figure>

<p>它的运行结果会是怎么样?</p>
<p>①.寄存器ax中会有一份值</p>
<p>ah:扫描码的通码</p>
<p>al:扫描码的ASCII码</p>
<p>②.键盘缓冲区中也会有一份值,高位通码,低位ASCII码,组成了一个字单元</p>
<p>这样的字单元会有15个</p>
<p>值得注意的是</p>
<p><code>int 16h</code>会从键盘缓冲区读取数据,,</p>
<p>如果键盘缓冲区有数据就读取一个字节<code>(至于读取谁,可以想象一下栈,它会读取最后进来那个)</code></p>
<p>如果没有数据,程序会一直等待你的输入..不会退出..直到键盘缓冲区有数据被它吃才会结束</p>
<p>核心的原理</p>
<p>读取键盘的输入,然后保存</p>
<p>如果输入back_space就让buff区那位置为0</p>
<p>如果输入enter,也是,然后那个位置置为0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code,ss:stack,ds:data</span><br><span class="line"></span><br><span class="line">data segment</span><br><span class="line">        Arr                             db      128 dup(&#x27;D&#x27;) </span><br><span class="line">        Table_A 			dw      Store_ascii,show_str,Delete_Ascii</span><br><span class="line">        which_one   			dw      0;函数指针的index</span><br><span class="line">        index                           dw      0;输入的ascii有多少个</span><br><span class="line">        input   			dw      0;你的每一个键入的ascii的缓冲区       </span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">        db 128 dup(&#x27;S&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">start:</span><br><span class="line">                mov     ax,data</span><br><span class="line">                mov     ds,ax</span><br><span class="line"></span><br><span class="line">                mov     ax,stack</span><br><span class="line">                mov     ss,ax</span><br><span class="line">                mov     sp,128</span><br><span class="line"></span><br><span class="line">                mov     di,20*2;你的输入在第一行的[20][0]处开始</span><br><span class="line"></span><br><span class="line">                call    option</span><br><span class="line"></span><br><span class="line">                mov     ax,4c00h</span><br><span class="line">                int     21h</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">;--------------------------------------------------------------------</span><br><span class="line">        option:</span><br><span class="line">                </span><br><span class="line">        option_start:</span><br><span class="line">                mov     ax,0</span><br><span class="line">                int     16h</span><br><span class="line"></span><br><span class="line">                cmp     al,20h;20h是最小的ASCII,之后的是不可见字符</span><br><span class="line">                jnb     main1     </span><br><span class="line">                cmp     al,08h;退格键</span><br><span class="line">                jz      back_space</span><br><span class="line">                cmp     al,0dh</span><br><span class="line">                jz      enter_A</span><br><span class="line"></span><br><span class="line">                jmp     option_start</span><br><span class="line"></span><br><span class="line">        option_ret:              </span><br><span class="line">                ret</span><br><span class="line">;-----------------------------------------------------------------------</span><br><span class="line">        main1:</span><br><span class="line">                mov     which_one,0*2;调用store函数</span><br><span class="line">                mov     bx,which_one</span><br><span class="line">                call  	word ptr Table_A[bx]</span><br><span class="line"></span><br><span class="line">                mov     which_one,1*2</span><br><span class="line">                mov     bx,which_one</span><br><span class="line">                call  	word ptr Table_A[bx]               </span><br><span class="line"></span><br><span class="line">                jmp     option_start</span><br><span class="line">;&#x27;----------------------------------------------------------------------------&#x27;</span><br><span class="line">        back_space:</span><br><span class="line">                mov     which_one,2*2</span><br><span class="line">                mov     bx,which_one</span><br><span class="line">                call  	word ptr Table_A[bx]</span><br><span class="line">                </span><br><span class="line">                mov     which_one,1*2</span><br><span class="line">                mov     bx,which_one</span><br><span class="line">                call  	word ptr Table_A[bx]</span><br><span class="line"></span><br><span class="line">                jmp     option_start</span><br><span class="line">;&#x27;----------------------------------------------------------------------------&#x27;</span><br><span class="line">        enter_A:</span><br><span class="line">                mov     which_one,2*2</span><br><span class="line">                mov     bx,which_one</span><br><span class="line">                call  	word ptr Table_A[bx]</span><br><span class="line"></span><br><span class="line">                mov     which_one,1*2</span><br><span class="line">                mov     bx,which_one</span><br><span class="line">                call  	word ptr Table_A[bx]  </span><br><span class="line"></span><br><span class="line">                jmp     option_ret</span><br><span class="line">;&#x27;----------------------------------------------------------------------------&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Store_ascii:</span><br><span class="line"></span><br><span class="line">                mov     input,al</span><br><span class="line">                mov     bx,index </span><br><span class="line">                mov	byte ptr [bx],al</span><br><span class="line">                inc	word ptr index </span><br><span class="line">                ret</span><br><span class="line"></span><br><span class="line">;&#x27;----------------------------------------------------------------------------&#x27;</span><br><span class="line">        Delete_Ascii: </span><br><span class="line">                dec 	word ptr index</span><br><span class="line">                mov 	input,0</span><br><span class="line">                mov     bx,index </span><br><span class="line">                mov	word ptr [bx],0</span><br><span class="line">                </span><br><span class="line">                ;退格太多,不能退太多,要回到初始位置</span><br><span class="line">                cmp 	di,40</span><br><span class="line">                jb     	back </span><br><span class="line">                jnb     back_fail</span><br><span class="line">                back:		</span><br><span class="line">                mov 	di,40</span><br><span class="line">		back_fail:</span><br><span class="line">                ret</span><br><span class="line">;&#x27;----------------------------------------------------------------------------&#x27;</span><br><span class="line">        show_str:</span><br><span class="line">                push ax</span><br><span class="line">                push es</span><br><span class="line"></span><br><span class="line">                mov ax,0b800h</span><br><span class="line">                mov es,ax</span><br><span class="line">                mov ax,160</span><br><span class="line">                </span><br><span class="line"></span><br><span class="line">                cmp input,0</span><br><span class="line">                jne  ok2</span><br><span class="line">                je   ok1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                ok1:</span><br><span class="line">                        sub  di,2;把原来那个给删除了</span><br><span class="line">                        mov byte ptr es:[di],0</span><br><span class="line">                        jmp over</span><br><span class="line">                ok2:</span><br><span class="line">                        mov al,input</span><br><span class="line">                        mov ah,2</span><br><span class="line">                        mov es:[di],ax;初始化当前的</span><br><span class="line">                        add di,2	;然后指向下一个`		</span><br><span class="line"></span><br><span class="line">	over:</span><br><span class="line">                pop es</span><br><span class="line">                pop ax</span><br><span class="line">                ret</span><br><span class="line">;&#x27;----------------------------------------------------------------------------&#x27;</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>



<p>我没看懂它的输出位置的原理,这么久输出在了di+50的地方</p>
<p>你也没有把它的push与pop给看懂,乱七八糟的push与pop</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data segment</span><br><span class="line">db 128 dup(&#x27;D&#x27;)</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                mov ax,data</span><br><span class="line">                mov ds,ax</span><br><span class="line"></span><br><span class="line">                call func</span><br><span class="line"></span><br><span class="line">                mov ax,4c00h</span><br><span class="line">                int 21h</span><br><span class="line"></span><br><span class="line">        func:</span><br><span class="line">                push ax</span><br><span class="line">        option:</span><br><span class="line">                mov ah,0</span><br><span class="line">                int 16h</span><br><span class="line"></span><br><span class="line">                cmp al,20h</span><br><span class="line">                jb  nochar</span><br><span class="line"></span><br><span class="line">                mov ah,0</span><br><span class="line">                call main1</span><br><span class="line">                </span><br><span class="line">                mov ah,2</span><br><span class="line">                call main1</span><br><span class="line"></span><br><span class="line">                jmp option</span><br><span class="line">        nochar:</span><br><span class="line">                cmp ah,0eh</span><br><span class="line">                je backspace</span><br><span class="line">                cmp ah,1ch</span><br><span class="line">                je enter_</span><br><span class="line">                jmp option</span><br><span class="line">        backspace:</span><br><span class="line">                mov ah,1</span><br><span class="line">                call main1</span><br><span class="line">                mov ah,2</span><br><span class="line">                call main1</span><br><span class="line">                jmp option</span><br><span class="line">        enter_:</span><br><span class="line">                mov al,0</span><br><span class="line">                mov ah,0</span><br><span class="line">                call main1</span><br><span class="line">                mov ah,2</span><br><span class="line">                call main1</span><br><span class="line">                pop ax</span><br><span class="line">                ret</span><br><span class="line"></span><br><span class="line">        main1:</span><br><span class="line">                jmp short Begin</span><br><span class="line">        table_          dw  Store_Ascii,Delete_Ascii,show</span><br><span class="line">        check           dw 0</span><br><span class="line">        Begin:  </span><br><span class="line">                push bx</span><br><span class="line">                push dx</span><br><span class="line">                push di</span><br><span class="line">                push es </span><br><span class="line"></span><br><span class="line">                cmp ah,2</span><br><span class="line">                ja  main1_end</span><br><span class="line"></span><br><span class="line">                mov bl,ah</span><br><span class="line">                mov bh,0</span><br><span class="line">                add bx,bx;让bx翻倍</span><br><span class="line">                jmp word ptr table_[bx];为什么index一定是16位?</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Store_Ascii:</span><br><span class="line">                mov bx,check</span><br><span class="line">                mov ds:[bx],al</span><br><span class="line">                inc check</span><br><span class="line">                jmp main1_end</span><br><span class="line">        Delete_Ascii:</span><br><span class="line">                cmp check,0</span><br><span class="line">                je main1_end</span><br><span class="line"></span><br><span class="line">                dec check</span><br><span class="line">                mov bx,check</span><br><span class="line">                jmp main1_end</span><br><span class="line">        show:</span><br><span class="line">                mov bx, 0b800h</span><br><span class="line">                mov es,bx</span><br><span class="line">                mov al,160</span><br><span class="line">                mov ah,0</span><br><span class="line">                mov di,ax</span><br><span class="line">				;下面这3行代码我真看不懂</span><br><span class="line">                ;add dl,dl</span><br><span class="line">                ;mov dh,0</span><br><span class="line">                ;add di,dx</span><br><span class="line">                mov bx,0</span><br><span class="line"></span><br><span class="line">        is_KG_or_not:</span><br><span class="line">                cmp bx,check</span><br><span class="line">                jne show_ascii</span><br><span class="line">				mov byte ptr es:[di-1],2</span><br><span class="line">                mov byte ptr es:[di+0],&#x27; &#x27;</span><br><span class="line">                jmp main1_end</span><br><span class="line">        show_ascii:</span><br><span class="line">                mov al,[bx]</span><br><span class="line">                mov es:[di],al</span><br><span class="line">                inc bx</span><br><span class="line">                add di,2</span><br><span class="line">                jmp is_KG_or_not</span><br><span class="line">        main1_end:</span><br><span class="line">                pop es</span><br><span class="line">                pop di</span><br><span class="line">                pop dx</span><br><span class="line">                pop bx</span><br><span class="line">                ret                                                </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start      </span><br></pre></td></tr></table></figure>







<h3 id="利用BIOS进行磁盘的读写"><a href="#利用BIOS进行磁盘的读写" class="headerlink" title="利用BIOS进行磁盘的读写"></a>利用BIOS进行磁盘的读写</h3><p>软盘</p>
<p>分为2面</p>
<p>每面软盘80个磁道</p>
<p>每个磁道18个扇区</p>
<p>每个扇区512个字节</p>
<table>
<thead>
<tr>
<th align="center">使用参数</th>
<th align="center">寄存器</th>
</tr>
</thead>
<tbody><tr>
<td align="center">写入-&gt;几个面</td>
<td align="center">al</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">写入-&gt;背面还是反面</td>
<td align="center">dh&#x3D;(0或者1)</td>
</tr>
<tr>
<td align="center">写入-&gt;哪个磁道</td>
<td align="center">ch</td>
</tr>
<tr>
<td align="center">写入-&gt;哪个扇区</td>
<td align="center">cl(1开始计数)</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">写入-&gt;哪个磁盘?A&#x2F;B&#x2F;C&#x2F;D</td>
<td align="center">dl</td>
</tr>
<tr>
<td align="center">数据S&#x2F;D的短地址</td>
<td align="center">ES</td>
</tr>
<tr>
<td align="center">数据S&#x2F;D的偏移地址</td>
<td align="center">BX</td>
</tr>
<tr>
<td align="center">使用哪个功能</td>
<td align="center">ah</td>
</tr>
<tr>
<td align="center">中断</td>
<td align="center">int 13h</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">逻辑扇区<code>x</code></td>
<td align="center"><code>(80xdh+ch)x18+cl-1</code></td>
</tr>
<tr>
<td align="center">面号<code>dh</code></td>
<td align="center"><code>x/1440</code></td>
</tr>
<tr>
<td align="center">磁道号<code>ch</code></td>
<td align="center"><code>(x%1400)/18</code></td>
</tr>
<tr>
<td align="center">扇区号<code>cl</code></td>
<td align="center"><code>x%1400%18+1</code></td>
</tr>
</tbody></table>
<p>把显存的4000字节依次写入1号,2号…8号扇区</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code,ss:stack,ds:data</span><br><span class="line"></span><br><span class="line">data segment</span><br><span class="line">			</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">        db 128 dup(&#x27;S&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line"></span><br><span class="line">start:</span><br><span class="line">                mov     ax,data</span><br><span class="line">                mov     ds,ax</span><br><span class="line"></span><br><span class="line">                mov     ax,stack</span><br><span class="line">                mov     ss,ax</span><br><span class="line">                mov     sp,128</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                mov     ax,0b800h;段地址</span><br><span class="line">                mov     es,ax</span><br><span class="line">                mov     bx,0;偏移地址</span><br><span class="line"></span><br><span class="line">                mov     al,8;写入8个扇区</span><br><span class="line">                mov     dl,0;在正面写入</span><br><span class="line">                </span><br><span class="line">                mov     dh,0;0面</span><br><span class="line">                mov     ch,0;0道</span><br><span class="line">                mov     cl,1;1扇区</span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">                mov     ah,3;读取</span><br><span class="line">                int     13h</span><br><span class="line"></span><br><span class="line">                mov     ax,4c00h</span><br><span class="line">                int     21h</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">;&#x27;----------------------------------------------------------------------------&#x27;</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>



<p>我很疑惑它写入了多少?<br>以什么样的格式写入</p>
<p>写入的是db,dw???</p>
<p>ascii?</p>
<h1 id="x64的文件处理"><a href="#x64的文件处理" class="headerlink" title="x64的文件处理"></a>x64的文件处理</h1><h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br></pre></td><td class="code"><pre><span class="line">; file.asm</span><br><span class="line">section .data</span><br><span class="line">;条件汇编表达式</span><br><span class="line">	CREATE 		equ 	1	;创建</span><br><span class="line">	OVERWRITE 	equ 	1	;重写</span><br><span class="line">	APPEND 		equ 	1	;追加</span><br><span class="line">	O_WRITE 	equ 	1	;二进制写入</span><br><span class="line">	READ 		equ 	1	;读取</span><br><span class="line">	O_READ 		equ 	1	;二进制读取</span><br><span class="line">	DELETE 		equ 	1	;删除</span><br><span class="line">			</span><br><span class="line">;系统调用符号</span><br><span class="line">	NR_read  	equ 	0 </span><br><span class="line">	NR_write 	equ 	1 </span><br><span class="line">	NR_open 	equ 	2 </span><br><span class="line">	NR_close 	equ 	3</span><br><span class="line">	NR_lseek 	equ 	8 </span><br><span class="line">	NR_create 	equ 	85</span><br><span class="line">	NR_unlink 	equ 	87</span><br><span class="line"></span><br><span class="line">;创建状态标志</span><br><span class="line">	O_CREAT 	equ 	00000100q	;二进制创建</span><br><span class="line">	O_APPEND 	equ 	00002000q	;二进制追加</span><br><span class="line"></span><br><span class="line">;访问模式   </span><br><span class="line">	O_RDONLY 	equ 	000000q </span><br><span class="line">	O_WRONLY 	equ 	000001q </span><br><span class="line">	O_RDWR 		equ 	000002q</span><br><span class="line"></span><br><span class="line">;创建权限</span><br><span class="line">	S_IRUSR 	equ 	00400q  ;user read permission</span><br><span class="line">	S_IWUSR 	equ 	00200q 	;user write permission</span><br><span class="line"> </span><br><span class="line">	NL	  		equ		0xa					</span><br><span class="line">	bufferlen  	equ 	64</span><br><span class="line">   </span><br><span class="line">	fileName db 	&quot;testfile.txt&quot;,0</span><br><span class="line">	FD 		 dq 	0	; 文件描述符号</span><br><span class="line"></span><br><span class="line">	text1	 db 	&quot;1. Hello...to everyone!&quot;,NL,0</span><br><span class="line">	len1     dq 	$-text1-1                  ;remove 0</span><br><span class="line">	text2    db 	&quot;2. Here I am!&quot;,NL,0</span><br><span class="line">	len2     dq 	$-text2-1                   ;remove 0</span><br><span class="line">	text3    db 	&quot;3. Alife and kicking!&quot;,NL,0</span><br><span class="line">	len3     dq 	$-text3-1                   ;remove 0</span><br><span class="line">	text4    db 	&quot;Adios !!!&quot;,NL,0</span><br><span class="line">	len4     dq 	$-text4-1</span><br><span class="line"></span><br><span class="line">	error_Create 	db &quot;error creating file&quot;,NL,0</span><br><span class="line">	error_Close 	db &quot;error closing file&quot;,NL,0</span><br><span class="line">	error_Write 	db &quot;error writing to file&quot;,NL,0</span><br><span class="line">	error_Open 	db &quot;error opening file&quot;,NL,0</span><br><span class="line">	error_Append 	db &quot;error appending to file&quot;,NL,0</span><br><span class="line">	error_Delete 	db &quot;error deleting file&quot;,NL,0</span><br><span class="line">	error_Read 	db &quot;error reading file&quot;,NL,0</span><br><span class="line">	error_Print 	db &quot;error printing string&quot;,NL,0</span><br><span class="line">	error_Position 	db &quot;error positioning in file&quot;,NL,0</span><br><span class="line"></span><br><span class="line">	success_Create 		db &quot;File created and opened&quot;,NL,0</span><br><span class="line">	success_Close 		db &quot;File closed&quot;,NL,NL,0</span><br><span class="line">	success_Write 		db &quot;Written to file&quot;,NL,0</span><br><span class="line">	success_Open 		db &quot;File opened for reading/(over)writing/updating&quot;,NL,0</span><br><span class="line">	success_Append 		db &quot;File opened for appending&quot;,NL,0</span><br><span class="line">	success_Delete 		db &quot;File deleted&quot;,NL,0</span><br><span class="line">	success_Read 		db &quot;Reading file&quot;,NL,0</span><br><span class="line">	success_Position	db &quot;Positioned in file&quot;,NL,0</span><br><span class="line">    </span><br><span class="line">section .bss							</span><br><span class="line">	buffer resb bufferlen</span><br><span class="line">section .text							</span><br><span class="line">	global main						</span><br><span class="line">main:</span><br><span class="line">	push rbp</span><br><span class="line">	mov  rbp,rsp</span><br><span class="line"></span><br><span class="line">	%IF CREATE</span><br><span class="line">	;创建打开,然后关闭</span><br><span class="line">	mov 	rdi, fileName</span><br><span class="line">	call 	createFile</span><br><span class="line">	mov 	qword [FD], rax ; save descriptor</span><br><span class="line"></span><br><span class="line">	; write to file #1</span><br><span class="line">	mov 	rdi, qword [FD]</span><br><span class="line">	mov 	rsi, text1</span><br><span class="line">	mov 	rdx, qword [len1]</span><br><span class="line">	call 	writeFile</span><br><span class="line">    </span><br><span class="line">	; close file</span><br><span class="line">	mov 	rdi, qword [FD]</span><br><span class="line">	call 	closeFile</span><br><span class="line">	%ENDIF</span><br><span class="line"></span><br><span class="line">	%IF OVERWRITE</span><br><span class="line">	;OPEN AND OVERWRITE A FILE, THEN CLOSE ---------------------------------------</span><br><span class="line">	; open file </span><br><span class="line">	mov 	rdi, fileName </span><br><span class="line">	call 	openFile  </span><br><span class="line">	mov 	qword [FD], rax ; save file descriptor</span><br><span class="line"></span><br><span class="line">	; write to file #2 OVERWRITE!</span><br><span class="line">	mov 	rdi, qword [FD]</span><br><span class="line">	mov 	rsi, text2</span><br><span class="line">	mov 	rdx, qword [len2]</span><br><span class="line">	call 	writeFile    </span><br><span class="line"></span><br><span class="line">	; close file</span><br><span class="line">	mov 	rdi, qword [FD]</span><br><span class="line">	call 	closeFile    </span><br><span class="line">	%ENDIF</span><br><span class="line"></span><br><span class="line">	%IF APPEND</span><br><span class="line">	;OPEN AND APPEND TO A FILE, THEN CLOSE ---------------------------------------</span><br><span class="line">	; open file to append</span><br><span class="line">	mov 	rdi, fileName </span><br><span class="line">	call 	appendFile  </span><br><span class="line">	mov 	qword [FD], rax ; save file descriptor</span><br><span class="line"></span><br><span class="line">	; write to file #3 APPEND!</span><br><span class="line">	mov 	rdi, qword [FD]</span><br><span class="line">	mov 	rsi, text3</span><br><span class="line">	mov 	rdx, qword [len3]</span><br><span class="line">	call 	writeFile       </span><br><span class="line"></span><br><span class="line">	; close file</span><br><span class="line">	mov 	rdi, qword [FD]</span><br><span class="line">	call 	closeFile </span><br><span class="line">	%ENDIF</span><br><span class="line"></span><br><span class="line">	%IF O_WRITE</span><br><span class="line">	;OPEN AND OVERWRITE AT AN OFFSET IN A FILE, THEN CLOSE -----------------------</span><br><span class="line">	; open file to write</span><br><span class="line">	mov 	rdi, fileName </span><br><span class="line">	call 	openFile  </span><br><span class="line">	mov 	qword [FD], rax ; save file descriptor</span><br><span class="line"></span><br><span class="line">	; position file at offset</span><br><span class="line">	mov 	rdi, qword[FD]</span><br><span class="line">	mov 	rsi, qword[len2] ;offset at this location</span><br><span class="line">	mov 	rdx, 0</span><br><span class="line">	call 	positionFile    </span><br><span class="line"></span><br><span class="line">	; write to file at offset</span><br><span class="line">	mov 	rdi, qword[FD]</span><br><span class="line">	mov 	rsi, text4</span><br><span class="line">	mov 	rdx, qword [len4]</span><br><span class="line">	call 	writeFile </span><br><span class="line"></span><br><span class="line">	; close file</span><br><span class="line">	mov 	rdi, qword [FD]</span><br><span class="line">	call 	closeFile </span><br><span class="line">	%ENDIF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	%IF READ</span><br><span class="line">	;OPEN AND READ FROM A FILE, THEN CLOSE ---------------------------------------</span><br><span class="line">	; open file to read</span><br><span class="line">	mov 	rdi, fileName </span><br><span class="line">	call 	openFile  </span><br><span class="line">	mov 	qword [FD], rax ; save file descriptor  </span><br><span class="line"></span><br><span class="line">	; read from file</span><br><span class="line">	mov 	rdi, qword [FD]</span><br><span class="line">	mov 	rsi, buffer</span><br><span class="line">	mov 	rdx, bufferlen    </span><br><span class="line">	call 	readFile</span><br><span class="line">	mov 	rdi,rax</span><br><span class="line">	call 	printString</span><br><span class="line"></span><br><span class="line">	; close file</span><br><span class="line">	mov 	rdi, qword [FD]</span><br><span class="line">	call 	closeFile </span><br><span class="line">	%ENDIF</span><br><span class="line"></span><br><span class="line">	%IF O_READ</span><br><span class="line">	;OPEN AND READ AT AN OFFSET FROM A FILE, THEN CLOSE ---------------------------------------</span><br><span class="line">	; open file to read</span><br><span class="line">	mov 	rdi, fileName </span><br><span class="line">	call 	openFile  </span><br><span class="line">	mov 	qword [FD], rax ; save file descriptor  </span><br><span class="line"></span><br><span class="line">	; position file at offset</span><br><span class="line">	mov 	rdi, qword[FD]</span><br><span class="line">	mov 	rsi, qword[len2]		;skip the first line</span><br><span class="line">	mov 	rdx, 0</span><br><span class="line">	call 	positionFile          </span><br><span class="line"></span><br><span class="line">	; read from file</span><br><span class="line">	mov 	rdi, qword [FD]</span><br><span class="line">	mov 	rsi, buffer</span><br><span class="line">	mov 	rdx, 10    ;number of characters to read</span><br><span class="line">	call 	readFile</span><br><span class="line">	mov 	rdi,rax</span><br><span class="line">	call 	printString</span><br><span class="line"></span><br><span class="line">	; close file</span><br><span class="line">	mov 	rdi, qword [FD]</span><br><span class="line">	call 	closeFile </span><br><span class="line">	%ENDIF</span><br><span class="line"></span><br><span class="line">	%IF DELETE</span><br><span class="line">	;DELETE A FILE --------------------------------------------------   </span><br><span class="line">	; delete file   UNCOMMENT NEXT LINES TO USE</span><br><span class="line">	mov 	rdi, fileName</span><br><span class="line">	call 	deleteFile                                      </span><br><span class="line">	%ENDIF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	leave</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">; FILE MANIPULATION FUNCTIONS-------------------------------------</span><br><span class="line">;-----------------------------------------------------------------</span><br><span class="line">	global readFile</span><br><span class="line">readFile:</span><br><span class="line">	mov 	rax, NR_read</span><br><span class="line">	syscall                         ; rax contains # of characters read</span><br><span class="line">	cmp 	rax, 0 </span><br><span class="line">	jl 		readerror</span><br><span class="line">	mov 	byte [rsi+rax],0	; add a terminating zero to the string</span><br><span class="line">	mov 	rax, rsi</span><br><span class="line"></span><br><span class="line">	mov 	rdi, success_Read</span><br><span class="line">	push	rax		; caller saved</span><br><span class="line">	call 	printString</span><br><span class="line">	pop		rax		; caller saved</span><br><span class="line">	ret</span><br><span class="line">readerror:</span><br><span class="line">	mov 	rdi, error_Read </span><br><span class="line">	call 	printString</span><br><span class="line">	ret  </span><br><span class="line">	;-----------------------------------------------------------------</span><br><span class="line">global deleteFile</span><br><span class="line">deleteFile:</span><br><span class="line">	mov 	rax, NR_unlink</span><br><span class="line">	syscall</span><br><span class="line">	cmp 	rax, 0 </span><br><span class="line">	jl 		deleteerror</span><br><span class="line">	mov 	rdi, success_Delete</span><br><span class="line">	call 	printString</span><br><span class="line">	ret</span><br><span class="line">deleteerror:</span><br><span class="line">	mov 	rdi, error_Delete </span><br><span class="line">	call 	printString</span><br><span class="line">	ret  </span><br><span class="line">;-----------------------------------------------------------------</span><br><span class="line">	global appendFile</span><br><span class="line">appendFile:</span><br><span class="line">	mov 	rax, NR_open </span><br><span class="line">	mov 	rsi,  O_RDWR|O_APPEND</span><br><span class="line">	syscall</span><br><span class="line">	cmp 	rax, 0 </span><br><span class="line">	jl 		appenderror</span><br><span class="line">	mov 	rdi, success_Append</span><br><span class="line">	push	rax		; caller saved</span><br><span class="line">	call 	printString</span><br><span class="line">	pop		rax		; caller saved</span><br><span class="line">	ret</span><br><span class="line">appenderror:</span><br><span class="line">	mov 	rdi, error_Append </span><br><span class="line">	call 	printString</span><br><span class="line">	ret  </span><br><span class="line">;-----------------------------------------------------------------</span><br><span class="line">global openFile</span><br><span class="line">openFile:</span><br><span class="line">	mov 	rax, NR_open </span><br><span class="line">	mov 	rsi, O_RDWR</span><br><span class="line">	syscall</span><br><span class="line">	cmp 	rax, 0 </span><br><span class="line">	jl 	openerror</span><br><span class="line">	mov 	rdi, success_Open</span><br><span class="line">	push	rax		; caller saved</span><br><span class="line">	call 	printString</span><br><span class="line">	pop		rax		; caller saved</span><br><span class="line">	ret</span><br><span class="line">openerror:</span><br><span class="line">	mov 	rdi, error_Open </span><br><span class="line">	call 	printString</span><br><span class="line">	ret  </span><br><span class="line">;-----------------------------------------------------------------</span><br><span class="line">	global writeFile</span><br><span class="line">writeFile:</span><br><span class="line">	mov 	rax, NR_write</span><br><span class="line">	syscall</span><br><span class="line">	cmp 	rax, 0 </span><br><span class="line">	jl 		writeerror</span><br><span class="line">	mov 	rdi, success_Write</span><br><span class="line">	call 	printString</span><br><span class="line">	ret</span><br><span class="line">writeerror:</span><br><span class="line">	mov 	rdi, error_Write </span><br><span class="line">	call 	printString</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">;-----------------------------------------------------------------</span><br><span class="line">global positionFile</span><br><span class="line">positionFile:</span><br><span class="line">	mov 	rax, NR_lseek</span><br><span class="line">	syscall</span><br><span class="line">	cmp 	rax, 0 </span><br><span class="line">	jl 		positionerror</span><br><span class="line">	mov 	rdi, success_Position</span><br><span class="line">	call 	printString</span><br><span class="line">	ret</span><br><span class="line">positionerror:</span><br><span class="line">	mov 	rdi, error_Position </span><br><span class="line">	call 	printString</span><br><span class="line">	ret    </span><br><span class="line">;-----------------------------------------------------------------</span><br><span class="line">	global closeFile</span><br><span class="line">closeFile:</span><br><span class="line">	mov 	rax, NR_close</span><br><span class="line">	syscall</span><br><span class="line">	cmp 	rax, 0 </span><br><span class="line">	jl 		closeerror</span><br><span class="line">	mov 	rdi, success_Close</span><br><span class="line">	call 	printString</span><br><span class="line">	ret</span><br><span class="line">closeerror:</span><br><span class="line">	mov 	rdi, error_Close </span><br><span class="line">	call 	printString</span><br><span class="line">	ret    </span><br><span class="line">;-----------------------------------------------------------------</span><br><span class="line">	global createFile</span><br><span class="line">createFile:</span><br><span class="line">	mov 	rax, NR_create</span><br><span class="line">	mov 	rsi, S_IRUSR |S_IWUSR </span><br><span class="line">	syscall</span><br><span class="line">	cmp 	rax, 0 			; file descriptor in rax</span><br><span class="line">	jl 		createerror</span><br><span class="line">	mov 	rdi, success_Create</span><br><span class="line">	push	rax		; caller saved</span><br><span class="line">	call 	printString</span><br><span class="line">	pop		rax		; caller saved</span><br><span class="line">	ret</span><br><span class="line">createerror:</span><br><span class="line">	mov 	rdi, error_Create </span><br><span class="line">	call 	printString</span><br><span class="line">	ret    </span><br><span class="line"></span><br><span class="line">	; PRINT FEEDBACK</span><br><span class="line">;-----------------------------------------------------------------</span><br><span class="line">global printString</span><br><span class="line">printString:</span><br><span class="line"></span><br><span class="line">; Count characters </span><br><span class="line">    mov 	r12, rdi</span><br><span class="line">    mov 	rdx, 0 </span><br><span class="line">strLoop:</span><br><span class="line">    cmp 	byte [r12], 0</span><br><span class="line">    je 		strDone</span><br><span class="line">    inc 	rdx                 ;length in rdx</span><br><span class="line">    inc 	r12</span><br><span class="line">    jmp 	strLoop</span><br><span class="line">strDone:</span><br><span class="line">    cmp 	rdx, 0              ; no string (0 length)</span><br><span class="line">    je 		prtDone</span><br><span class="line">    mov 	rsi,rdi</span><br><span class="line">    mov 	rax, 1 </span><br><span class="line">    mov 	rdi, 1</span><br><span class="line">    syscall</span><br><span class="line">prtDone:</span><br><span class="line"></span><br><span class="line">    ret</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>注意一些寄存器调用约定</p>
<p>好比eax是返回值,那么的话,eax就不要被偷偷的修改掉</p>
<p>一个函数肯定会有返回值,只是你用不用返回值</p>
<p>当eax有用,你就push</p>
<p>当eax无用,你就随意了</p>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><h3 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">global printString</span><br><span class="line">;参数</span><br><span class="line">;rdi 字符串地址</span><br><span class="line">;功能</span><br><span class="line">;实现字节计数,放在rdx,然后syscall输出</span><br><span class="line">;</span><br><span class="line">printString:</span><br><span class="line"></span><br><span class="line">; Count characters </span><br><span class="line">    mov 	r12, rdi</span><br><span class="line">    mov 	rdx, 0 </span><br><span class="line">strLoop:</span><br><span class="line">    cmp 	byte [r12], 0</span><br><span class="line">    je 		strDone</span><br><span class="line">    inc 	rdx                 ;length in rdx</span><br><span class="line">    inc 	r12</span><br><span class="line">    jmp 	strLoop</span><br><span class="line">strDone:</span><br><span class="line">    cmp 	rdx, 0              ; no string (0 length)</span><br><span class="line">    je 		prtDone</span><br><span class="line">    mov 	rsi,rdi</span><br><span class="line">    mov 	rax, 1 </span><br><span class="line">    mov 	rdi, 1</span><br><span class="line">    syscall</span><br><span class="line">prtDone:</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>



<h3 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov 	rdi, fileName</span><br><span class="line">call 	createFile</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">;-----------------------------------------------------------------</span><br><span class="line">global createFile</span><br><span class="line">;参数	    rdi:文件的名字</span><br><span class="line">;功能:	创建一个文件,成功就打印超过,失败就打印失败</span><br><span class="line">;返回值	rax</span><br><span class="line">;注意事项:	一些函数会默默地修改寄存器,我们得事先把它push一下</span><br><span class="line">createFile:</span><br><span class="line">   ;mov 	rdi, fileName</span><br><span class="line">    mov 	rsi, S_IRUSR | S_IWUSR  ;user read permission | user write permission</span><br><span class="line">    mov 	rax, NR_create	;85</span><br><span class="line">    syscall</span><br><span class="line">    cmp 	rax, 0 			</span><br><span class="line">    jl 		createerror</span><br><span class="line">    mov 	rdi, success_Create</span><br><span class="line">	push	rax		; caller saved</span><br><span class="line">    call 	printString</span><br><span class="line">	pop		rax		; caller saved</span><br><span class="line">    ret</span><br><span class="line">createerror:</span><br><span class="line">    mov 	rdi, error_Create </span><br><span class="line">    call 	printString</span><br><span class="line">    ret    </span><br><span class="line"></span><br><span class="line">; PRINT FEEDBACK</span><br><span class="line">;----------------------------------------------------------------</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov 	qword [FD], rax ; save descriptor</span><br></pre></td></tr></table></figure>



<h3 id="写入"><a href="#写入" class="headerlink" title="写入"></a>写入</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov 	rdi, qword [FD]</span><br><span class="line">mov 	rsi, text1</span><br><span class="line">mov 	rdx, qword [len1]</span><br><span class="line">call 	writeFile</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">;-----------------------------------------------------------------</span><br><span class="line">;文件名 writeFile</span><br><span class="line">;参数</span><br><span class="line">;rdi 文件句柄</span><br><span class="line">;rsi 字符串地址</span><br><span class="line">;rdx 字符串长度</span><br><span class="line"></span><br><span class="line">;功能 把一个字符串写入文件</span><br><span class="line"></span><br><span class="line">;返回值 没用用到</span><br><span class="line">;注意事项 </span><br><span class="line">global writeFile</span><br><span class="line">writeFile:</span><br><span class="line"> 	;rdi 文件句柄</span><br><span class="line">    ;rsi 字符串地址</span><br><span class="line">    ;rdx 字符串长度</span><br><span class="line">    mov 	rax, NR_write	;1</span><br><span class="line">    syscall</span><br><span class="line">    cmp 	rax, 0 			;返回rax 写入失败就返回负数</span><br><span class="line">    jl 		writeerror</span><br><span class="line">    mov 	rdi, success_Write</span><br><span class="line">    call 	printString</span><br><span class="line">    ret</span><br><span class="line">    writeerror:</span><br><span class="line">    mov 	rdi, error_Write </span><br><span class="line">    call 	printString</span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">;-----------------------------------------------------------------</span><br></pre></td></tr></table></figure>



<h3 id="关闭"><a href="#关闭" class="headerlink" title="关闭"></a>关闭</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov 	rdi, qword [FD]</span><br><span class="line">call 	closeFile</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">;函数名 关闭文件</span><br><span class="line">;参数 rdi, qword [FD],文件句柄</span><br><span class="line">;功能 关闭文件,失败就打印1失败,成功就打印成功</span><br><span class="line">;返回值: 未使用</span><br><span class="line">;注意事项:null</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	global closeFile</span><br><span class="line">	closeFile:</span><br><span class="line">	mov 	rax, NR_close ;3</span><br><span class="line">	syscall</span><br><span class="line">	cmp 	rax, 0 </span><br><span class="line">	jl 		closeerror</span><br><span class="line">	mov 	rdi, success_Close</span><br><span class="line">	call 	printString</span><br><span class="line">	ret</span><br><span class="line">	closeerror:</span><br><span class="line">	mov 	rdi, error_Close </span><br><span class="line">	call 	printString</span><br><span class="line">	ret   </span><br></pre></td></tr></table></figure>



<h3 id="打开"><a href="#打开" class="headerlink" title="打开"></a>打开</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov 	rdi, fileName </span><br><span class="line">call 	openFile  </span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">;函数名 打开文件</span><br><span class="line">;参数   rdi, fileName </span><br><span class="line">;功能 打开文件</span><br><span class="line">;返回值 rax 文件句柄</span><br><span class="line">;注意事项 </span><br><span class="line">global openFile</span><br><span class="line">openFile:	</span><br><span class="line">	;rdi, fileName </span><br><span class="line">	mov 	rsi, O_RDWR	;访问模式</span><br><span class="line">	mov 	rax, NR_open ;系统调用符号</span><br><span class="line">	syscall</span><br><span class="line">	cmp 	rax, 0 </span><br><span class="line">	jl 		openerror</span><br><span class="line">	mov 	rdi, success_Open</span><br><span class="line">	push	rax		; caller saved</span><br><span class="line">	call 	printString</span><br><span class="line">	pop		rax		; caller saved</span><br><span class="line">	ret</span><br><span class="line">	openerror:</span><br><span class="line">	mov 	rdi, error_Open </span><br><span class="line">	call 	printString</span><br><span class="line">	ret </span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov 	qword [FD], rax ; save file descriptor</span><br></pre></td></tr></table></figure>

<h3 id="追加形式打开"><a href="#追加形式打开" class="headerlink" title="追加形式打开"></a>追加形式打开</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov 	rdi, fileName </span><br><span class="line">call 	appendFile </span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">;;函数名 文件追加</span><br><span class="line">;参数 文件名rdi, fileName</span><br><span class="line">;功能</span><br><span class="line">;返回值 文件句柄</span><br><span class="line">;注意事项  文件指针的还原</span><br><span class="line">global appendFile</span><br><span class="line">appendFile:</span><br><span class="line">	;rdi, fileName</span><br><span class="line">	mov 	rsi,  O_RDWR|O_APPEND	;访问模式|追加状态标志</span><br><span class="line">	mov 	rax, NR_open 	        ;系统调用符号</span><br><span class="line">	syscall</span><br><span class="line">	cmp 	rax, 0 </span><br><span class="line">	jl 		appenderror</span><br><span class="line">	mov 	rdi, success_Append</span><br><span class="line">	push	rax		; caller saved</span><br><span class="line">	call 	printString</span><br><span class="line">	pop		rax		; caller saved</span><br><span class="line">	ret</span><br><span class="line">appenderror:</span><br><span class="line">	mov 	rdi, error_Append </span><br><span class="line">	call 	printString</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov 	qword [FD], rax ; save file descriptor</span><br></pre></td></tr></table></figure>





<h3 id="定位偏移量"><a href="#定位偏移量" class="headerlink" title="定位偏移量"></a>定位偏移量</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">; position file at offset</span><br><span class="line">mov 	rdi, qword[FD]</span><br><span class="line">mov 	rsi, qword[len2] ;offset at this location</span><br><span class="line">mov 	rdx, 0</span><br><span class="line">call 	positionFile </span><br></pre></td></tr></table></figure>



<p>它是怎么设置偏移量的???</p>
<p>为什么最后关闭文件的时候还是用了改变后的指针.?&#x2F;?&#x2F;?&#x2F;?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">;函数名 定位文件偏移量</span><br><span class="line">;参数 </span><br><span class="line"></span><br><span class="line">;rdi, qword[FD] 文件句柄</span><br><span class="line">;rsi, qword[len2] ;偏移量</span><br><span class="line">;rdx, 0</span><br><span class="line"></span><br><span class="line">;功能 改变句柄?</span><br><span class="line">;注意事项 指针的还原</span><br><span class="line">;返回值</span><br><span class="line"></span><br><span class="line">global positionFile</span><br><span class="line">positionFile:</span><br><span class="line">	;rdi 文件句柄</span><br><span class="line">	;rsi 偏移量</span><br><span class="line">	;rdx 0</span><br><span class="line">	mov 	rax, NR_lseek</span><br><span class="line">	syscall</span><br><span class="line">	cmp 	rax, 0 </span><br><span class="line">	jl 		positionerror</span><br><span class="line">	mov 	rdi, success_Position</span><br><span class="line">	call 	printString</span><br><span class="line">	ret</span><br><span class="line">positionerror:</span><br><span class="line">	mov 	rdi, error_Position </span><br><span class="line">	call 	printString</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>





<h3 id="读取"><a href="#读取" class="headerlink" title="读取"></a>读取</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov 	rdi, qword [FD]</span><br><span class="line">mov 	rsi, buffer</span><br><span class="line">mov 	rdx, bufferlen    </span><br><span class="line">call 	readFile</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">;函数名 读取文件</span><br><span class="line">;参数   </span><br><span class="line">;rdi, qword [FD] 	文件指针</span><br><span class="line">;rsi, buffer		字符串缓冲区</span><br><span class="line">;rdx, bufferlen 	缓冲区长度;syscall读取长度</span><br><span class="line">;功能</span><br><span class="line">;返回值 字符串地址</span><br><span class="line"></span><br><span class="line">global readFile</span><br><span class="line">readFile:</span><br><span class="line">	;rdi, qword [FD]</span><br><span class="line">	;rsi, buffer</span><br><span class="line">	;rdx, bufferlen</span><br><span class="line">	mov 	rax, NR_read</span><br><span class="line">	syscall                         ; rax contains # of characters read</span><br><span class="line">	cmp 	rax, 0 </span><br><span class="line">	;返回值是一个文件字符串的长度</span><br><span class="line">	jl 		readerror</span><br><span class="line">	mov 	byte [rsi+rax],0	; add a terminating zero to the string</span><br><span class="line">	mov 	rax, rsi</span><br><span class="line"></span><br><span class="line">	mov 	rdi, success_Read</span><br><span class="line">	push	rax		; caller saved</span><br><span class="line">	call 	printString</span><br><span class="line">	pop		rax		; caller saved</span><br><span class="line">	ret</span><br><span class="line">readerror:</span><br><span class="line">	mov 	rdi, error_Read </span><br><span class="line">	call 	printString</span><br><span class="line">	ret </span><br></pre></td></tr></table></figure>



<p>返回字符串地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov 	rdi,rax</span><br><span class="line">call 	printString</span><br></pre></td></tr></table></figure>





<h3 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a>删除文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">;函数名 删除文件</span><br><span class="line">;参数 mov 	rdi, fileName</span><br><span class="line">global deleteFile</span><br><span class="line">deleteFile:</span><br><span class="line">	;mov 	rdi, fileName</span><br><span class="line">	mov 	rax, NR_unlink</span><br><span class="line">	syscall</span><br><span class="line">	cmp 	rax, 0 </span><br><span class="line">	jl 		deleteerror</span><br><span class="line">	mov 	rdi, success_Delete</span><br><span class="line">	call 	printString</span><br><span class="line">	ret</span><br><span class="line">deleteerror:</span><br><span class="line">	mov 	rdi, error_Delete </span><br><span class="line">	call 	printString</span><br><span class="line">	ret </span><br></pre></td></tr></table></figure>





<h2 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h2><h3 id="创建-x2F-写入-x2F-关闭"><a href="#创建-x2F-写入-x2F-关闭" class="headerlink" title="创建&#x2F;写入&#x2F;关闭"></a>创建&#x2F;写入&#x2F;关闭</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">%IF CREATE</span><br><span class="line">;创建打开,然后关闭</span><br><span class="line">mov 	rdi, fileName</span><br><span class="line">call 	createFile</span><br><span class="line">mov 	qword [FD], rax ; save descriptor</span><br><span class="line"></span><br><span class="line">; write to file #1</span><br><span class="line">mov 	rdi, qword [FD]</span><br><span class="line">mov 	rsi, text1</span><br><span class="line">mov 	rdx, qword [len1]</span><br><span class="line">call 	writeFile</span><br><span class="line">   </span><br><span class="line">; close file</span><br><span class="line">mov 	rdi, qword [FD]</span><br><span class="line">call 	closeFile</span><br><span class="line">%ENDIF</span><br></pre></td></tr></table></figure>









<h3 id="打开-x2F-覆盖-x2F-关闭"><a href="#打开-x2F-覆盖-x2F-关闭" class="headerlink" title="打开&#x2F;覆盖&#x2F;关闭"></a>打开&#x2F;覆盖&#x2F;关闭</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">%IF OVERWRITE</span><br><span class="line">;OPEN AND OVERWRITE A FILE, THEN CLOSE ---------------------------------------</span><br><span class="line">; open file </span><br><span class="line">mov 	rdi, fileName </span><br><span class="line">call 	openFile  </span><br><span class="line">mov 	qword [FD], rax ; save file descriptor</span><br><span class="line"></span><br><span class="line">; write to file #2 OVERWRITE!</span><br><span class="line">mov 	rdi, qword [FD]</span><br><span class="line">mov 	rsi, text2</span><br><span class="line">mov 	rdx, qword [len2]</span><br><span class="line">call 	writeFile    </span><br><span class="line"></span><br><span class="line">; close file</span><br><span class="line">mov 	rdi, qword [FD]</span><br><span class="line">call 	closeFile    </span><br><span class="line">%ENDIF</span><br><span class="line"></span><br></pre></td></tr></table></figure>











<h3 id="追加-x2F-写入-x2F-关闭"><a href="#追加-x2F-写入-x2F-关闭" class="headerlink" title="追加&#x2F;写入&#x2F;关闭"></a>追加&#x2F;写入&#x2F;关闭</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">%IF APPEND</span><br><span class="line">;OPEN AND APPEND TO A FILE, THEN CLOSE ---------------------------------------</span><br><span class="line">; open file to append</span><br><span class="line">    mov 	rdi, fileName </span><br><span class="line">    call 	appendFile  </span><br><span class="line">    mov 	qword [FD], rax ; save file descriptor</span><br><span class="line">    </span><br><span class="line">; write to file #3 APPEND!</span><br><span class="line">    mov 	rdi, qword [FD]</span><br><span class="line">    mov 	rsi, text3</span><br><span class="line">    mov 	rdx, qword [len3]</span><br><span class="line">    call 	writeFile       </span><br><span class="line"></span><br><span class="line">; close file</span><br><span class="line">    mov 	rdi, qword [FD]</span><br><span class="line">    call 	closeFile </span><br><span class="line">%ENDIF</span><br></pre></td></tr></table></figure>









<h3 id="打开-x2F-定位偏移量-x2F-追加型覆盖写入-x2F-关闭"><a href="#打开-x2F-定位偏移量-x2F-追加型覆盖写入-x2F-关闭" class="headerlink" title="打开&#x2F;定位偏移量&#x2F;追加型覆盖写入&#x2F;关闭"></a>打开&#x2F;定位偏移量&#x2F;追加型覆盖写入&#x2F;关闭</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">%IF O_WRITE</span><br><span class="line">;OPEN AND OVERWRITE AT AN OFFSET IN A FILE, THEN CLOSE -----------------------</span><br><span class="line">; open file to write</span><br><span class="line">mov 	rdi, fileName </span><br><span class="line">call 	openFile  </span><br><span class="line">mov 	qword [FD], rax ; save file descriptor</span><br><span class="line"></span><br><span class="line">; position file at offset</span><br><span class="line">mov 	rdi, qword[FD]</span><br><span class="line">mov 	rsi, qword[len2] ;offset at this location</span><br><span class="line">mov 	rdx, 0</span><br><span class="line">call 	positionFile    </span><br><span class="line"></span><br><span class="line">; write to file at offset</span><br><span class="line">mov 	rdi, qword[FD]</span><br><span class="line">mov 	rsi, text4</span><br><span class="line">mov 	rdx, qword [len4]</span><br><span class="line">call 	writeFile </span><br><span class="line"></span><br><span class="line">; close file</span><br><span class="line">mov 	rdi, qword [FD]</span><br><span class="line">call 	closeFile </span><br><span class="line">%ENDIF</span><br></pre></td></tr></table></figure>













<h3 id="打开-x2F-读取-x2F-关闭"><a href="#打开-x2F-读取-x2F-关闭" class="headerlink" title="打开&#x2F;读取&#x2F;关闭"></a>打开&#x2F;读取&#x2F;关闭</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">%IF READ</span><br><span class="line">;OPEN AND READ FROM A FILE, THEN CLOSE ---------------------------------------</span><br><span class="line">; open file to read</span><br><span class="line">mov 	rdi, fileName </span><br><span class="line">call 	openFile  </span><br><span class="line">mov 	qword [FD], rax ; save file descriptor  </span><br><span class="line"></span><br><span class="line">; read from file</span><br><span class="line">mov 	rdi, qword [FD]</span><br><span class="line">mov 	rsi, buffer</span><br><span class="line">mov 	rdx, bufferlen    </span><br><span class="line">call 	readFile</span><br><span class="line">mov 	rdi,rax</span><br><span class="line">call 	printString</span><br><span class="line"></span><br><span class="line">; close file</span><br><span class="line">mov 	rdi, qword [FD]</span><br><span class="line">call 	closeFile </span><br><span class="line">%ENDIF</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="打开-x2F-定位偏移-x2F-读取-x2F-关闭"><a href="#打开-x2F-定位偏移-x2F-读取-x2F-关闭" class="headerlink" title="打开&#x2F;定位偏移&#x2F;读取&#x2F;关闭"></a>打开&#x2F;定位偏移&#x2F;读取&#x2F;关闭</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">%IF O_READ</span><br><span class="line">;OPEN AND READ AT AN OFFSET FROM A FILE, THEN CLOSE ---------------------------------------</span><br><span class="line">; open file to read</span><br><span class="line">mov 	rdi, fileName </span><br><span class="line">call 	openFile  </span><br><span class="line">mov 	qword [FD], rax ; save file descriptor  </span><br><span class="line"></span><br><span class="line">; position file at offset</span><br><span class="line">mov 	rdi, qword[FD]</span><br><span class="line">mov 	rsi, qword[len2]		;skip the first line</span><br><span class="line">mov 	rdx, 0</span><br><span class="line">call 	positionFile          </span><br><span class="line"></span><br><span class="line">; read from file</span><br><span class="line">mov 	rdi, qword [FD]</span><br><span class="line">mov 	rsi, buffer</span><br><span class="line">mov 	rdx, 10    ;number of characters to read</span><br><span class="line">call 	readFile</span><br><span class="line">mov 	rdi,rax</span><br><span class="line">call 	printString</span><br><span class="line"></span><br><span class="line">; close file</span><br><span class="line">mov 	rdi, qword [FD]</span><br><span class="line">call 	closeFile </span><br><span class="line">%ENDIF</span><br></pre></td></tr></table></figure>



<h3 id="删除文件-1"><a href="#删除文件-1" class="headerlink" title="删除文件"></a>删除文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%IF DELETE</span><br><span class="line">;DELETE A FILE --------------------------------------------------   </span><br><span class="line">; delete file   UNCOMMENT NEXT LINES TO USE</span><br><span class="line">mov 	rdi, fileName</span><br><span class="line">call 	deleteFile                                      </span><br><span class="line">%ENDIF</span><br></pre></td></tr></table></figure>







<h1 id="汇编调用C库函数"><a href="#汇编调用C库函数" class="headerlink" title="汇编调用C库函数"></a>汇编调用C库函数</h1><p>调用C库函数会默认修改一些寄存器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004012F1 push    rsi</span><br><span class="line">.text:00000000004012F2 push    rdx</span><br><span class="line">.text:00000000004012F3 push    rcx</span><br><span class="line">.text:00000000004012F4 push    rbp</span><br><span class="line">.text:00000000004012F5 call    _printf</span><br><span class="line">.text:00000000004012FA pop     rbp</span><br><span class="line">.text:00000000004012FB pop     rcx</span><br><span class="line">.text:00000000004012FC pop     rdx</span><br><span class="line">.text:00000000004012FD pop     rsi</span><br></pre></td></tr></table></figure>



<p>所以的话,见到这些代码也不要惊讶…</p>
<p>这些push不是传递参数</p>
<p>并且printf的参数rdi也没有被传递进去</p>
<p>这些push只不过是默默地保存一下参数</p>
<h2 id="x86"><a href="#x86" class="headerlink" title="x86"></a>x86</h2><p>首先在头文件引入库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">includelib		msvcrt.lib</span><br></pre></td></tr></table></figure>



<p>一个应用的例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">include Dqx.inc	</span><br><span class="line"></span><br><span class="line">;对要用的函数做一些声明</span><br><span class="line">printf proto C :ptr sbyte,:vararg</span><br><span class="line">scanf  proto C :ptr sbyte,:vararg</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">	n_input		byte &quot;%d %d&quot;,0</span><br><span class="line">	n_output	byte &quot;%d+%d=%d&quot;,10,0</span><br><span class="line">	s_output	BYTE &quot;%s&quot;,10,0</span><br><span class="line"></span><br><span class="line">	str1		byte &quot;welcome to my world&quot;,10</span><br><span class="line">			    byte &quot;please input 2 NUm&quot;,0</span><br><span class="line"></span><br><span class="line">	a		dd	0</span><br><span class="line">	b		dd	0</span><br><span class="line"></span><br><span class="line">.code</span><br><span class="line">start:</span><br><span class="line">	invoke	printf,addr s_output,addr str1</span><br><span class="line">	invoke	scanf,addr n_input,addr a,addr b</span><br><span class="line">	mov	eax,0</span><br><span class="line">	add	eax,a</span><br><span class="line">	add	eax,b</span><br><span class="line">	invoke	printf,addr n_output,a,b,eax</span><br><span class="line">	INVOKE	ExitProcess,0;调用结束的函数,</span><br><span class="line">;--------------------------------------------------------------------------- </span><br><span class="line">end start</span><br></pre></td></tr></table></figure>





<p>1.对于参数的传递,他得是32位的数据长度</p>
<p>好比一个void fun(char ascii),函数的汇编会有一个强制类型的转化,把你传入的一个字节变为32位的长度</p>
<p>2.参数传递的顺序,参数会从右到左依次push或者mov [esp+4],,,,,</p>
<h2 id="x64-1"><a href="#x64-1" class="headerlink" title="x64"></a>x64</h2><p>仍然需要在外部声明</p>
<h3 id="linux下"><a href="#linux下" class="headerlink" title="linux下"></a>linux下</h3><h4 id="调用printf"><a href="#调用printf" class="headerlink" title="调用printf"></a>调用printf</h4><p>rax为0,表示0个非浮点数</p>
<p>rdi 格式化字符串的地址,第一个参数</p>
<p>rdx放第二个参数</p>
<p>rsi 数值&#x2F;字符串地址, 数值好比[var],字符串地址就用数组的名字</p>
<p>遇到浮点数</p>
<p>rax&#x3D;3,表示你传入3个浮点数参数,</p>
<p>于是函数依次把xmm0,xmm1,xmm2,作为参数</p>
<p>movq传入当精度浮点数,</p>
<p>movsd传入当精度浮点数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov	rax,1</span><br><span class="line">movq xmm0,[f_Num]</span><br><span class="line">mov rdi,fmat</span><br><span class="line">call printf</span><br></pre></td></tr></table></figure>



<p>问题来了,它怎么知道我有几个参数????<br>我传入rdi,一个字符串的地址,可是它会不会读取其它的寄存器呢???</p>
<p>rdi,第一个参数,xmm0第二个参数????</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">; hello2.asm </span><br><span class="line">	</span><br><span class="line">section .data</span><br><span class="line">	str1	db      &quot;welcome to my world&quot;,10,0		;中断调用没有换行,这里手动添加一个</span><br><span class="line">	len1	equ		$-str1-1</span><br><span class="line">	str2	db		&quot;I am Dqx_Ghost&quot;,0</span><br><span class="line">	len2	equ		$-str2-1</span><br><span class="line">	</span><br><span class="line">	num		dq		2001</span><br><span class="line">	pi		dq		3.14</span><br><span class="line">	</span><br><span class="line">	fmt_int 	db		&quot;%d&quot;,10,0</span><br><span class="line">	fmt_double	db		&quot;%lf&quot;,10,0</span><br><span class="line">	fmt_str		db		&quot;%s&quot;,10,0</span><br><span class="line"></span><br><span class="line">section .bss</span><br><span class="line">section .text</span><br><span class="line">extern		printf	</span><br><span class="line">	global main</span><br><span class="line">main:</span><br><span class="line"></span><br><span class="line">	push	rbp</span><br><span class="line">	mov		rbp,rsp</span><br><span class="line">	</span><br><span class="line">	mov		rax,1</span><br><span class="line">	mov		rdi,1</span><br><span class="line">	mov 	rsi,str1</span><br><span class="line">	mov 	rdx,len1</span><br><span class="line">	syscall</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	mov		rax,0</span><br><span class="line">	mov 	rsi,str2</span><br><span class="line">	mov 	rdi,fmt_str</span><br><span class="line">	call	printf</span><br><span class="line">	</span><br><span class="line">	mov 	rax,0</span><br><span class="line">	mov 	rsi,[num]</span><br><span class="line">	mov 	rdi,fmt_int</span><br><span class="line">	call	printf</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	mov		rax,1</span><br><span class="line">	movq	xmm0,[pi]</span><br><span class="line">	mov 	rdi,fmt_double</span><br><span class="line">	call	printf</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	mov 	rsp,rbp</span><br><span class="line">	pop		rbp</span><br><span class="line"></span><br><span class="line">	mov     rax, 60		; 60 = exit</span><br><span class="line">	mov     rdi, 0		; 0 = success exit code</span><br><span class="line">	syscall				; quit</span><br></pre></td></tr></table></figure>

<h3 id="windows下"><a href="#windows下" class="headerlink" title="windows下"></a>windows下</h3><h4 id="printf"><a href="#printf" class="headerlink" title="printf"></a>printf</h4><p>rcx是第一个参数</p>
<h3 id="堆栈对齐"><a href="#堆栈对齐" class="headerlink" title="堆栈对齐"></a>堆栈对齐</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004012F1 push    rsi</span><br><span class="line">.text:00000000004012F2 push    rdx</span><br><span class="line">.text:00000000004012F3 push    rcx</span><br><span class="line">.text:00000000004012F4 push    rbp</span><br><span class="line">.text:00000000004012F5 call    _printf</span><br><span class="line">.text:00000000004012FA pop     rbp</span><br><span class="line">.text:00000000004012FB pop     rcx</span><br><span class="line">.text:00000000004012FC pop     rdx</span><br><span class="line">.text:00000000004012FD pop     rsi</span><br></pre></td></tr></table></figure>

<p>其实他没有必要push那么多的东西</p>
<p>但是一定要堆栈对齐</p>
<p>于是他就push了一些没有的东西用于了堆栈对齐</p>
<h1 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h1><h2 id="8086-课程设计"><a href="#8086-课程设计" class="headerlink" title="8086 课程设计"></a>8086 课程设计</h2><h3 id="1"><a href="#1" class="headerlink" title="1"></a>1</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br></pre></td><td class="code"><pre><span class="line">;=======================================================</span><br><span class="line">assume cs:code , ds:data, ss:stack</span><br><span class="line">;=======================================================</span><br><span class="line">data segment</span><br><span class="line">;年份</span><br><span class="line">                    db &#x27;1975&#x27;,&#x27;1976&#x27;,&#x27;1977&#x27;,&#x27;1978&#x27;,&#x27;1979&#x27;,&#x27;1980&#x27;,&#x27;1981&#x27;</span><br><span class="line">                    db &#x27;1982&#x27;,&#x27;1983&#x27;,&#x27;1984&#x27;,&#x27;1985&#x27;,&#x27;1986&#x27;,&#x27;1987&#x27;,&#x27;1988&#x27;</span><br><span class="line">                    db &#x27;1989&#x27;,&#x27;1990&#x27;,&#x27;1991&#x27;,&#x27;1992&#x27;,&#x27;1993&#x27;,&#x27;1994&#x27;,&#x27;1995&#x27;</span><br><span class="line">    </span><br><span class="line">;收入</span><br><span class="line">                    dd  16,22,382,1356,2398,8000,16000</span><br><span class="line">                    dd  24486,50065,97479,140417,197514,345980,590827</span><br><span class="line">                    dd  803528,1183000,1843000,2759000,3753000,4649000,5937000</span><br><span class="line">    </span><br><span class="line">;员工数量</span><br><span class="line">                    dw  3,7,9,13,28,38,130</span><br><span class="line">                    dw  220,476,778,1001,1442,2258,2793</span><br><span class="line">                    dw  4037,5635,8226,11542,14438,15257,17800</span><br><span class="line">data ends  </span><br><span class="line"></span><br><span class="line">                    table segment</span><br><span class="line">                        db 21 dup (&#x27;0123456789ABCDEF&#x27;)</span><br><span class="line">                    table ends</span><br><span class="line"> ;=======================================================</span><br><span class="line">;栈段</span><br><span class="line">stack segment stack</span><br><span class="line">                         db 128 dup(&#x27;y&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">string segment</span><br><span class="line">                        db 10 dup(&#x27;0&#x27;)</span><br><span class="line">string ends</span><br><span class="line">;=======================================================</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">;main code  </span><br><span class="line">;=======================================================</span><br><span class="line">;数据源S</span><br><span class="line">                        mov ax,data</span><br><span class="line">                        mov ds,ax       </span><br><span class="line">;数据地D</span><br><span class="line">                        mov ax,7e00h</span><br><span class="line">                        mov es,ax        </span><br><span class="line">;栈</span><br><span class="line">                        mov ax,stack</span><br><span class="line">                        mov ss,ax</span><br><span class="line">                        mov sp,128</span><br><span class="line">               </span><br><span class="line">;=======================================================       </span><br><span class="line">                        call input_table</span><br><span class="line">                        call clear_screen</span><br><span class="line">                        call output_table</span><br><span class="line"></span><br><span class="line">over:    </span><br><span class="line">                        mov ax,4c00h</span><br><span class="line">                        int 21h</span><br><span class="line">;=======================================================         </span><br><span class="line">;function</span><br><span class="line">input_table:</span><br><span class="line">                        mov ax,data</span><br><span class="line">                        mov ds,ax</span><br><span class="line"></span><br><span class="line">                        mov ax,table</span><br><span class="line">                        mov es,ax</span><br><span class="line"></span><br><span class="line">                        mov si,0</span><br><span class="line">                        mov di,21*4*2</span><br><span class="line">                        mov bx,0</span><br><span class="line">                        mov cx,21</span><br><span class="line"></span><br><span class="line">inputtable:</span><br><span class="line">                        ;year </span><br><span class="line">                        ;这个push与pop非常的妙,把4个字节,巧妙的传送</span><br><span class="line">                        push ds:[si]</span><br><span class="line">                        pop  es:[bx]</span><br><span class="line">                        push ds:[si+2]</span><br><span class="line">                        pop  es:[bx+2]</span><br><span class="line"></span><br><span class="line">                        ;x</span><br><span class="line">                        mov ax,ds:[si+21*4+0]</span><br><span class="line">                        mov dx,ds:[si+21*4+2]</span><br><span class="line">                        mov es:[bx+5],ax</span><br><span class="line">                        mov es:[bx+7],dx</span><br><span class="line">                        ;y</span><br><span class="line">                        push ds:[di]</span><br><span class="line">                        pop  es:[bx+10]</span><br><span class="line">                        ;z</span><br><span class="line">                        div word ptr es:[bx+10]</span><br><span class="line"></span><br><span class="line">                        mov es:[bx+13],ax</span><br><span class="line"></span><br><span class="line">                        add si,4</span><br><span class="line">                        add di,2</span><br><span class="line">                        add bx,16</span><br><span class="line">                        loop inputtable</span><br><span class="line">                        </span><br><span class="line">                        ret</span><br><span class="line">clear_screen:</span><br><span class="line">                        mov ax,0b800h</span><br><span class="line">                        mov es,ax</span><br><span class="line">                        mov bx,0</span><br><span class="line">                        mov dx,0700h</span><br><span class="line">                        mov cx,2000</span><br><span class="line">clearscreen:</span><br><span class="line">                        mov es:[bx],dx</span><br><span class="line">                        add bx,2</span><br><span class="line">                        loop clearscreen</span><br><span class="line">                    </span><br><span class="line">                        ret                        </span><br><span class="line">output_table:</span><br><span class="line">                        mov ax,table</span><br><span class="line">                        mov ds,ax</span><br><span class="line"></span><br><span class="line">                        mov ax,string </span><br><span class="line">                        mov es,ax</span><br><span class="line"></span><br><span class="line">                        mov si,0</span><br><span class="line">                        mov cx,21</span><br><span class="line">                        mov di,160*3</span><br><span class="line">                        mov bx,9</span><br><span class="line">                        ;[9]是10个当中最后一个位置</span><br><span class="line">outputtable:</span><br><span class="line">                        call show_year</span><br><span class="line">                        call show_x</span><br><span class="line">                        call show_y</span><br><span class="line">                        call show_z</span><br><span class="line"></span><br><span class="line">                        add di,160</span><br><span class="line">                        add si,16</span><br><span class="line">                        loop outputtable</span><br><span class="line"></span><br><span class="line">                        ret</span><br><span class="line">show_year:</span><br><span class="line">                        push ax</span><br><span class="line">                        push bx</span><br><span class="line">                        push cx</span><br><span class="line">                        push dx</span><br><span class="line">                        push ds</span><br><span class="line">                        push si</span><br><span class="line">                        push es</span><br><span class="line">                        push di</span><br><span class="line"></span><br><span class="line">                        mov ax,0b800h</span><br><span class="line">                        mov es,ax</span><br><span class="line"></span><br><span class="line">                        add di,3*2</span><br><span class="line">                        mov cx,4</span><br><span class="line">showyear:                        </span><br><span class="line">                        mov ah,2</span><br><span class="line">                        mov al,ds:[si]</span><br><span class="line">                        mov es:[di],ax</span><br><span class="line">                        inc si</span><br><span class="line">                        add di,2</span><br><span class="line">                        loop showyear</span><br><span class="line"></span><br><span class="line">                        pop di</span><br><span class="line">                        pop es</span><br><span class="line">                        pop si</span><br><span class="line">                        pop ds</span><br><span class="line">                        pop dx</span><br><span class="line">                        pop cx</span><br><span class="line">                        pop bx</span><br><span class="line">                        pop ax</span><br><span class="line">                        ret                                   </span><br><span class="line">show_x:</span><br><span class="line">                        push ax</span><br><span class="line">                        push bx</span><br><span class="line">                        push cx</span><br><span class="line">                        push dx</span><br><span class="line">                        push ds</span><br><span class="line">                        push si</span><br><span class="line">                        push es</span><br><span class="line">                        push di</span><br><span class="line">                        </span><br><span class="line">                        mov ax,ds:[si+5]</span><br><span class="line">                        mov dx,ds:[si+7]</span><br><span class="line"></span><br><span class="line">                        call is_short_div</span><br><span class="line">                        call init_reg</span><br><span class="line">                        add di,10*2</span><br><span class="line">                        call show_string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                        pop di</span><br><span class="line">                        pop es</span><br><span class="line">                        pop si</span><br><span class="line">                        pop ds</span><br><span class="line">                        pop dx</span><br><span class="line">                        pop cx</span><br><span class="line">                        pop bx</span><br><span class="line">                        pop ax</span><br><span class="line">                        ret</span><br><span class="line">show_y:</span><br><span class="line">                        push ax</span><br><span class="line">                        push bx</span><br><span class="line">                        push cx</span><br><span class="line">                        push dx</span><br><span class="line">                        push ds</span><br><span class="line">                        push si</span><br><span class="line">                        push es</span><br><span class="line">                        push di</span><br><span class="line">                        </span><br><span class="line">                        mov ax,ds:[si+10]</span><br><span class="line">                        mov dx,0</span><br><span class="line">                        call is_short_div</span><br><span class="line">                        call init_reg</span><br><span class="line">                        add di,2*20</span><br><span class="line">                        call show_string</span><br><span class="line"></span><br><span class="line">                        pop di</span><br><span class="line">                        pop es</span><br><span class="line">                        pop si</span><br><span class="line">                        pop ds</span><br><span class="line">                        pop dx</span><br><span class="line">                        pop cx</span><br><span class="line">                        pop bx</span><br><span class="line">                        pop ax</span><br><span class="line">                        ret</span><br><span class="line">show_z:</span><br><span class="line">                        push ax</span><br><span class="line">                        push bx</span><br><span class="line">                        push cx</span><br><span class="line">                        push dx</span><br><span class="line">                        push ds</span><br><span class="line">                        push si</span><br><span class="line">                        push es</span><br><span class="line">                        push di</span><br><span class="line">                        </span><br><span class="line">                        mov ax,ds:[si+13]</span><br><span class="line">                        mov dx,0</span><br><span class="line">                        call is_short_div</span><br><span class="line">                        call init_reg</span><br><span class="line">                        add di,2*40</span><br><span class="line">                        call show_string</span><br><span class="line"></span><br><span class="line">                        pop di</span><br><span class="line">                        pop es</span><br><span class="line">                        pop si</span><br><span class="line">                        pop ds</span><br><span class="line">                        pop dx</span><br><span class="line">                        pop cx</span><br><span class="line">                        pop bx</span><br><span class="line">                        pop ax</span><br><span class="line">                        ret</span><br><span class="line"></span><br><span class="line">is_short_div:</span><br><span class="line">                        mov cx,dx</span><br><span class="line">                        jcxz short_div</span><br><span class="line">                        call long_div</span><br><span class="line">                        jmp is_short_div</span><br><span class="line">div_ret:                       </span><br><span class="line">                        ret</span><br><span class="line">short_div:</span><br><span class="line">                        mov cx,10</span><br><span class="line">                        div cx</span><br><span class="line">                        add dx,30h</span><br><span class="line">                        mov es:[bx],dl</span><br><span class="line">                        mov cx,ax</span><br><span class="line">                        jcxz div_ret</span><br><span class="line">                        mov dx,0</span><br><span class="line">                        dec bx</span><br><span class="line">                        jmp short_div                      </span><br><span class="line">long_div:</span><br><span class="line">                        mov cx,10</span><br><span class="line">                        push ax</span><br><span class="line">                        mov bp,sp</span><br><span class="line">                        mov ax,dx</span><br><span class="line">                        mov dx,0</span><br><span class="line">                        div cx</span><br><span class="line">                        push ax</span><br><span class="line">                        mov ax,ss:[bp]</span><br><span class="line">                        div cx</span><br><span class="line">                        mov cx,dx</span><br><span class="line">                        add cx,30h</span><br><span class="line">                        mov es:[bx],cl</span><br><span class="line">                        dec bx</span><br><span class="line">                        pop dx</span><br><span class="line">                        add sp,2</span><br><span class="line"></span><br><span class="line">                        ret</span><br><span class="line">init_reg:</span><br><span class="line">                        push ax</span><br><span class="line">                        mov ax,string</span><br><span class="line">                        mov ds,ax</span><br><span class="line">                        mov ax,0b800h</span><br><span class="line">                        mov es,ax</span><br><span class="line">                        pop ax</span><br><span class="line">                        ret</span><br><span class="line">show_string:</span><br><span class="line">                        push ax</span><br><span class="line">                        push bx</span><br><span class="line">                        push cx</span><br><span class="line">                        push dx</span><br><span class="line">                        push ds</span><br><span class="line">                        push si</span><br><span class="line">                        push es</span><br><span class="line">                        push di</span><br><span class="line">showstring:</span><br><span class="line">                        mov cx,0</span><br><span class="line">                        mov cl,ds:[bx]</span><br><span class="line">                        jcxz show_ret</span><br><span class="line">                        mov ch,2</span><br><span class="line">                        mov es:[di],cx</span><br><span class="line">                        add di,2</span><br><span class="line">                        inc bx</span><br><span class="line">                        jmp showstring</span><br><span class="line">show_ret:</span><br><span class="line">                        pop di</span><br><span class="line">                        pop es</span><br><span class="line">                        pop si</span><br><span class="line">                        pop ds</span><br><span class="line">                        pop dx</span><br><span class="line">                        pop cx</span><br><span class="line">                        pop bx</span><br><span class="line">                        pop ax</span><br><span class="line">                        ret</span><br><span class="line"></span><br><span class="line">;=======================================================  </span><br><span class="line">code ends</span><br><span class="line">end start</span><br><span class="line">;=======================================================</span><br></pre></td></tr></table></figure>



<p>又写了一遍</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br></pre></td><td class="code"><pre><span class="line">;=======================================================</span><br><span class="line">assume cs:code , ds:data, ss:stack</span><br><span class="line">;=======================================================</span><br><span class="line">data segment</span><br><span class="line">;年份</span><br><span class="line">                    db &#x27;1975&#x27;,&#x27;1976&#x27;,&#x27;1977&#x27;,&#x27;1978&#x27;,&#x27;1979&#x27;,&#x27;1980&#x27;,&#x27;1981&#x27;</span><br><span class="line">                    db &#x27;1982&#x27;,&#x27;1983&#x27;,&#x27;1984&#x27;,&#x27;1985&#x27;,&#x27;1986&#x27;,&#x27;1987&#x27;,&#x27;1988&#x27;</span><br><span class="line">                    db &#x27;1989&#x27;,&#x27;1990&#x27;,&#x27;1991&#x27;,&#x27;1992&#x27;,&#x27;1993&#x27;,&#x27;1994&#x27;,&#x27;1995&#x27;</span><br><span class="line">    </span><br><span class="line">;收入</span><br><span class="line">                    dd  16,22,382,1356,2398,8000,16000</span><br><span class="line">                    dd  24486,50065,97479,140417,197514,345980,590827</span><br><span class="line">                    dd  803528,1183000,1843000,2759000,3753000,4649000,5937000</span><br><span class="line">    </span><br><span class="line">;员工数量</span><br><span class="line">                    dw  3,7,9,13,28,38,130</span><br><span class="line">                    dw  220,476,778,1001,1442,2258,2793</span><br><span class="line">                    dw  4037,5635,8226,11542,14438,15257,17800</span><br><span class="line">data ends  </span><br><span class="line"></span><br><span class="line">                    table segment</span><br><span class="line">                        db 21 dup (&#x27;0123456789ABCDEF&#x27;)</span><br><span class="line">                    table ends</span><br><span class="line"> ;=======================================================</span><br><span class="line">;栈段</span><br><span class="line">stack segment stack</span><br><span class="line">                         db 128 dup(&#x27;y&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">string segment</span><br><span class="line">                         db 16 dup(0)</span><br><span class="line">string ends</span><br><span class="line">;=======================================================</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">;main code  </span><br><span class="line">;=======================================================</span><br><span class="line">;数据源S</span><br><span class="line">                        mov ax,data</span><br><span class="line">                        mov ds,ax       </span><br><span class="line">;数据地D</span><br><span class="line">                        mov ax,7e00h</span><br><span class="line">                        mov es,ax        </span><br><span class="line">;栈</span><br><span class="line">                        mov ax,stack</span><br><span class="line">                        mov ss,ax</span><br><span class="line">                        mov sp,128</span><br><span class="line">               </span><br><span class="line">;=======================================================       </span><br><span class="line"></span><br><span class="line">                        call clean_screen</span><br><span class="line">                        call init_table</span><br><span class="line">                        call work      </span><br><span class="line"> </span><br><span class="line">over:    </span><br><span class="line">                        mov ax,4c00h</span><br><span class="line">                        int 21h</span><br><span class="line">;=======================================================         </span><br><span class="line">;function</span><br><span class="line"></span><br><span class="line">clean_screen:</span><br><span class="line">                        mov ax,0b800h</span><br><span class="line">                        mov es,ax</span><br><span class="line">                        mov bx,0</span><br><span class="line">                        mov cx,2000</span><br><span class="line">                        mov dx,0700h                        </span><br><span class="line">clean:</span><br><span class="line">                        mov es:[bx],dx</span><br><span class="line">                        add bx,2</span><br><span class="line">                        loop clean</span><br><span class="line">                        </span><br><span class="line">                        ret                        </span><br><span class="line">init_table:</span><br><span class="line">                        mov ax,data</span><br><span class="line">                        mov ds,ax</span><br><span class="line">                        mov ax,table</span><br><span class="line">                        mov es,ax</span><br><span class="line"></span><br><span class="line">                        mov cx,21</span><br><span class="line">                        mov si,0</span><br><span class="line">                        mov di,21*4*2</span><br><span class="line">                        mov bx,0</span><br><span class="line">init_small:             </span><br><span class="line">                        ;0123456789ABCDEF</span><br><span class="line">                        push ds:[si+0]</span><br><span class="line">                        pop  es:[bx]</span><br><span class="line">                        push ds:[si+2]</span><br><span class="line">                        pop  es:[bx+2]</span><br><span class="line"></span><br><span class="line">                        </span><br><span class="line"></span><br><span class="line">                        push ds:[si+21*4+0]</span><br><span class="line">                        pop  es:[bx+5]</span><br><span class="line">                        push ds:[si+21*4+2]</span><br><span class="line">                        pop  es:[bx+7]</span><br><span class="line"></span><br><span class="line">                        push ds:[di]</span><br><span class="line">                        pop  es:[bx+10]</span><br><span class="line"></span><br><span class="line">                        mov ax,es:[bx+5]</span><br><span class="line">                        mov dx,es:[bx+7]</span><br><span class="line">                        div word ptr es:[bx+10]</span><br><span class="line">                        </span><br><span class="line">                        </span><br><span class="line">                        mov es:[bx+13],ax</span><br><span class="line"></span><br><span class="line">                        mov al,58        ;:</span><br><span class="line">                        mov es:[bx+4],al</span><br><span class="line">                        mov al,47        ;/</span><br><span class="line">                        mov es:[bx+9],al</span><br><span class="line">                        mov al,61        ;=</span><br><span class="line">                        mov es:[bx+12],al</span><br><span class="line"></span><br><span class="line">                        add bx,16</span><br><span class="line">                        add si,4</span><br><span class="line">                        add di,2</span><br><span class="line">                        loop init_small</span><br><span class="line"> </span><br><span class="line">                        ret          </span><br><span class="line">work:</span><br><span class="line">                        mov ax,table</span><br><span class="line">                        mov ds,ax</span><br><span class="line">                        mov ax,string</span><br><span class="line">                        mov es,ax</span><br><span class="line"></span><br><span class="line">                        mov cx,21</span><br><span class="line">                        mov bx,0</span><br><span class="line">                        mov si,0</span><br><span class="line">                        mov di,160*3</span><br><span class="line"></span><br><span class="line">work_small:</span><br><span class="line">                        call show_year</span><br><span class="line">                        call show_x</span><br><span class="line">                        call show_y</span><br><span class="line">                        call show_z</span><br><span class="line"></span><br><span class="line">                        add  di,160</span><br><span class="line">                        add  si,16</span><br><span class="line">                        loop work_small</span><br><span class="line">                        ret</span><br><span class="line">show_year:</span><br><span class="line">                        push si</span><br><span class="line">                        push es</span><br><span class="line">                        push di</span><br><span class="line">                        push cx</span><br><span class="line">                        add di,10</span><br><span class="line"></span><br><span class="line">                        mov ax,0b800h</span><br><span class="line">                        mov es,ax</span><br><span class="line">                        mov cx,4</span><br><span class="line">year_small:</span><br><span class="line">                        mov al,ds:[si]</span><br><span class="line">                        mov es:[di],al</span><br><span class="line">                        inc si</span><br><span class="line">                        add di,2</span><br><span class="line">                        loop year_small</span><br><span class="line">                        </span><br><span class="line">                        mov al,ds:[4]</span><br><span class="line">                        mov es:[di],al</span><br><span class="line"></span><br><span class="line">                        mov al,ds:[9]</span><br><span class="line">                        mov es:[di+30],al</span><br><span class="line"></span><br><span class="line">                        mov al,ds:[12]</span><br><span class="line">                        mov es:[di+50],al</span><br><span class="line"></span><br><span class="line">                        pop cx</span><br><span class="line">                        pop di</span><br><span class="line">                        pop es</span><br><span class="line">                        pop si</span><br><span class="line">                        ret</span><br><span class="line"></span><br><span class="line">                        ;0123456789ABCDEF</span><br><span class="line">show_x:</span><br><span class="line">                        push cx</span><br><span class="line">                        push di</span><br><span class="line">                        add di,40</span><br><span class="line">                        mov ax,ds:[si+5]</span><br><span class="line">                        mov dx,ds:[si+7]</span><br><span class="line">                        mov bx,15</span><br><span class="line">                        call is_short_div</span><br><span class="line">                        call show_string</span><br><span class="line"></span><br><span class="line">                        pop di</span><br><span class="line">                        pop cx</span><br><span class="line">                        ret</span><br><span class="line"></span><br><span class="line">show_y:</span><br><span class="line">                        push cx</span><br><span class="line">                        push di</span><br><span class="line">                        add di,60</span><br><span class="line">                        mov ax,ds:[si+10]</span><br><span class="line">                        mov dx,0</span><br><span class="line">                        mov bx,15</span><br><span class="line"></span><br><span class="line">                        call is_short_div</span><br><span class="line">                        call show_string</span><br><span class="line"></span><br><span class="line">                        pop di</span><br><span class="line">                        pop cx</span><br><span class="line">                        ret</span><br><span class="line">show_z:</span><br><span class="line">                        push cx</span><br><span class="line">                        push di</span><br><span class="line">                        add di,80</span><br><span class="line">                        mov ax,ds:[si+13]</span><br><span class="line">                        mov dx,0</span><br><span class="line">                        mov bx,15</span><br><span class="line">                        call is_short_div</span><br><span class="line">                        call show_string</span><br><span class="line"></span><br><span class="line">                        pop di</span><br><span class="line">                        pop cx</span><br><span class="line">                        ret                                                  </span><br><span class="line">is_short_div:           </span><br><span class="line">                        mov cx,dx</span><br><span class="line">                        jcxz short_div</span><br><span class="line">                        call long_div</span><br><span class="line">                        jmp is_short_div                       </span><br><span class="line">div_ret:                        </span><br><span class="line">                        ret</span><br><span class="line">short_div:</span><br><span class="line">                        mov cx,10</span><br><span class="line">                        div cx</span><br><span class="line">                        add dl,30h</span><br><span class="line">                        mov es:[bx],dl</span><br><span class="line">                        mov dl,0</span><br><span class="line">                        mov es:[bx-1],dl</span><br><span class="line">                        dec bx</span><br><span class="line">                        mov cx,ax</span><br><span class="line">                        jcxz div_ret</span><br><span class="line">                        mov dx,0</span><br><span class="line">                        jmp short_div</span><br><span class="line">long_div:</span><br><span class="line">                        push ax</span><br><span class="line">                        mov bp,sp</span><br><span class="line">                        mov ax,dx</span><br><span class="line">                        mov dx,0</span><br><span class="line">                        mov cx,10</span><br><span class="line">                        div cx</span><br><span class="line">                        push ax</span><br><span class="line">                        mov ax,ss:[bp]</span><br><span class="line">                        div cx</span><br><span class="line">                        add dx,30h</span><br><span class="line">                        mov es:[bx],dl</span><br><span class="line">                        mov dl,0</span><br><span class="line">                        mov es:[bx-1],dl</span><br><span class="line">                        dec bx</span><br><span class="line"></span><br><span class="line">                        pop dx</span><br><span class="line">                        add sp,2</span><br><span class="line">                        ret                                                </span><br><span class="line"></span><br><span class="line">show_string:</span><br><span class="line">                        push es</span><br><span class="line">                        push ds</span><br><span class="line">                        push di</span><br><span class="line"></span><br><span class="line">                        mov bx,15</span><br><span class="line"></span><br><span class="line">                        mov ax,string</span><br><span class="line">                        mov ds,ax</span><br><span class="line">                        mov ax,0b800h</span><br><span class="line">                        mov es,ax</span><br><span class="line">show_str:</span><br><span class="line">                        mov ah,2</span><br><span class="line">                        mov al,ds:[bx]</span><br><span class="line">                        mov es:[di],ax</span><br><span class="line"></span><br><span class="line">                        sub di,2</span><br><span class="line">                        dec bx</span><br><span class="line"></span><br><span class="line">                        mov cx,0</span><br><span class="line">                        mov cl,ds:[bx]</span><br><span class="line">                        jcxz show_ret</span><br><span class="line">                        jmp show_str</span><br><span class="line">show_ret:                       </span><br><span class="line">                        pop di</span><br><span class="line">                        pop ds</span><br><span class="line">                        pop es</span><br><span class="line">                        ret                       </span><br><span class="line">;=======================================================  </span><br><span class="line">code ends</span><br><span class="line">end start</span><br><span class="line">;=======================================================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>出现的问题</p>
<ol>
<li>push的保存没注意先后顺序,也就是临时保存无效</li>
<li>对结构的化编程不是很清晰,老是走一步看一步</li>
<li>一个小小的寄存器错误,就导致中断,程序崩溃</li>
<li>如果数据溢出是会中断的,而不是报错</li>
</ol>
<h2 id="8086-课后实验"><a href="#8086-课后实验" class="headerlink" title="8086 课后实验"></a>8086 课后实验</h2><h3 id="模拟jcxz"><a href="#模拟jcxz" class="headerlink" title="模拟jcxz"></a>模拟jcxz</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">;=======================================================</span><br><span class="line">assume cs:code , ds:data, ss:stack</span><br><span class="line">;=======================================================</span><br><span class="line">data segment</span><br><span class="line">    db 256 dup(&#x27;A&#x27;)    </span><br><span class="line">data ends  </span><br><span class="line">;=======================================================</span><br><span class="line">stack segment stack</span><br><span class="line">    db 128 dup(&#x27;w&#x27;)</span><br><span class="line">stack ends</span><br><span class="line">;=======================================================</span><br><span class="line">code segment</span><br><span class="line"> start:  </span><br><span class="line"> ;=======================================================</span><br><span class="line">            ;栈</span><br><span class="line">            mov ax,stack</span><br><span class="line">            mov ss,ax</span><br><span class="line">            mov sp,128</span><br><span class="line">            </span><br><span class="line">            ;数据段</span><br><span class="line">            mov ax,2000h</span><br><span class="line">            mov ds,ax</span><br><span class="line">            mov bx,0</span><br><span class="line">            </span><br><span class="line"> ;=======================================================       </span><br><span class="line">            </span><br><span class="line">             mov cx,10</span><br><span class="line">             mov al,1</span><br><span class="line">init:       mov byte ptr ds:[bx], al</span><br><span class="line">             inc bx</span><br><span class="line">             inc al</span><br><span class="line">             loop init</span><br><span class="line">             </span><br><span class="line">             mov bx,0</span><br><span class="line">fun:       mov cl,byte ptr ds:[bx]</span><br><span class="line">             jcxz over</span><br><span class="line">             inc bx</span><br><span class="line">             jmp fun</span><br><span class="line">           </span><br><span class="line"></span><br><span class="line">;=======================================================  </span><br><span class="line">over:    mov ax,4c00h</span><br><span class="line">            int 21h</span><br><span class="line">;=======================================================</span><br><span class="line">code ends</span><br><span class="line">end start</span><br><span class="line">;=======================================================</span><br></pre></td></tr></table></figure>

<p>还是要注意数据的初始化</p>
<p>另外要注意循环是哪里开始的,不要乱循环</p>
<h3 id="关于loop与cx去检索数据段中0的位置"><a href="#关于loop与cx去检索数据段中0的位置" class="headerlink" title="关于loop与cx去检索数据段中0的位置"></a>关于loop与cx去检索数据段中0的位置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">s:</span><br><span class="line">mov cl,ds:[bx]</span><br><span class="line">mov ch,0</span><br><span class="line">inc cx</span><br><span class="line">inc bx</span><br><span class="line">loop s</span><br><span class="line">ok:</span><br><span class="line">dec bx</span><br><span class="line">mov dx,bx</span><br></pre></td></tr></table></figure>

<p>它的检索,是靠bx++的来依次检索</p>
<p>但是又靠cx!&#x3D;0来推动检索</p>
<p>所以才达到避免cx单一化,又推动了片段的检索</p>
<p>代码要求是得到位置</p>
<p>因此最后会有一个</p>
<p>dec bx</p>
<p>mov dx,bx</p>
<h3 id="一个经典的指令复制实验-jmp指令的本质"><a href="#一个经典的指令复制实验-jmp指令的本质" class="headerlink" title="一个经典的指令复制实验-jmp指令的本质"></a>一个经典的指令复制实验-jmp指令的本质</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">;=======================================================</span><br><span class="line">assume cs:code </span><br><span class="line">;=======================================================</span><br><span class="line"> </span><br><span class="line"> ;=======================================================</span><br><span class="line"></span><br><span class="line">;=======================================================</span><br><span class="line">code segment</span><br><span class="line"> </span><br><span class="line"> ;=======================================================</span><br><span class="line">       mov ax,4c00h</span><br><span class="line">       int 21h</span><br><span class="line">start: </span><br><span class="line">        mov ax,0</span><br><span class="line">s:</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        </span><br><span class="line">        mov di,offset s</span><br><span class="line">        mov si,offset s2</span><br><span class="line">        mov ax,cs:[si]</span><br><span class="line">        mov cs:[di],ax</span><br><span class="line">        </span><br><span class="line">s0:</span><br><span class="line">        jmp short s</span><br><span class="line">        </span><br><span class="line">no_use:</span><br><span class="line">        mov ax,0</span><br><span class="line">        int 21h</span><br><span class="line">        mov ax,0</span><br><span class="line">        </span><br><span class="line">        s2:</span><br><span class="line">        jmp short no_use</span><br><span class="line">        nop</span><br><span class="line">        </span><br><span class="line">code ends</span><br><span class="line">end start</span><br><span class="line">        </span><br><span class="line">;=======================================================       </span><br><span class="line"> ;main code</span><br><span class="line"> </span><br><span class="line">;=======================================================  </span><br><span class="line">;fun area            </span><br><span class="line">            </span><br><span class="line">           </span><br><span class="line"></span><br><span class="line">;=======================================================  </span><br><span class="line"></span><br><span class="line">;=======================================================</span><br><span class="line">code ends</span><br><span class="line">end start</span><br><span class="line">;=======================================================</span><br></pre></td></tr></table></figure>

<p>假如我们有指令</p>
<p>jmp s1</p>
<p>在复制jmp s1的时候</p>
<p>它不是复制jmp s1</p>
<p>而是复制他的汇编指令</p>
<p>加入它的指令是EBF6</p>
<p>F6-然后1111 0110然后取反0000 1001然后+1为然后0000 1010然后10进制为10</p>
<p>说明它以前往后面跳了10个位移</p>
<p>debug那个代码</p>
<p>以前的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmp short no_use</span><br></pre></td></tr></table></figure>

<p>它的汇编就是EBF6,于是就复制了EBF6</p>
<p><img src="https://s2.loli.net/2022/02/26/J6SBkol3NjqODnb.png" alt="image-20220204172011883"></p>
<p>可以看到,以前的nop,nop</p>
<p>变为了EBF6</p>
<p>那么的话</p>
<p>因为我们复制的是EBF6</p>
<p>不是复制jmp short ptr no_use</p>
<p>所以的话</p>
<p>出现jmp 0000也不要诧异</p>
<p>为什么是0000</p>
<p>因为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">076A:0008    EBF6 jmp 0000</span><br><span class="line">076A:000A    BF0800	 mov di,0008 </span><br></pre></td></tr></table></figure>

<p>于是从000A处往上面从0开始数到10</p>
<p>就可以得到地址 0000</p>
<p>同时我们事先就安排好了,0000处是程序的结束位置</p>
<h3 id="在屏幕中央显示带颜色的字符串‘welcome-to-masm’"><a href="#在屏幕中央显示带颜色的字符串‘welcome-to-masm’" class="headerlink" title="在屏幕中央显示带颜色的字符串‘welcome to masm’"></a>在屏幕中央显示带颜色的字符串‘welcome to masm’</h3><p>DOS窗口的</p>
<p>一行有160个字节</p>
<p>一共有25行</p>
<p>一页有4000个字节</p>
<p>一共有8页</p>
<p>偶数地址存放ASCII字符</p>
<p>基数地址存放字符的颜色</p>
<p><img src="https://s2.loli.net/2022/02/26/4oS3IPbOpQ5uKT9.png" alt="image-20220204192938719"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">;=======================================================</span><br><span class="line">assume cs:code , ds:data, ss:stack</span><br><span class="line">;=======================================================</span><br><span class="line">data segment</span><br><span class="line"></span><br><span class="line">        db  &#x27;welcome to masm!&#x27;</span><br><span class="line">        db  00000010b</span><br><span class="line">        db  00100100b</span><br><span class="line">        db  01110001b</span><br><span class="line">        </span><br><span class="line">data ends  </span><br><span class="line"> ;=======================================================</span><br><span class="line">stack segment stack</span><br><span class="line">        db 128 dup(&#x27;m&#x27;)</span><br><span class="line">stack ends</span><br><span class="line">;=======================================================</span><br><span class="line">code segment</span><br><span class="line">start:  </span><br><span class="line"> ;=======================================================</span><br><span class="line">        ;栈</span><br><span class="line">        mov ax,stack</span><br><span class="line">        mov ss,ax</span><br><span class="line">        mov sp,128</span><br><span class="line">        ;数据源</span><br><span class="line">        mov ax,data</span><br><span class="line">        mov ds,ax</span><br><span class="line">        mov si,0</span><br><span class="line">        mov bx,16</span><br><span class="line">        </span><br><span class="line">        ;数据目的地</span><br><span class="line">        mov ax,0B800h;显存的地址0xB800</span><br><span class="line">        mov es,ax</span><br><span class="line">        mov di,160*12+30*2;第[12]行第[60]字节处</span><br><span class="line">;=======================================================       </span><br><span class="line"> ;main code</span><br><span class="line">        </span><br><span class="line">        jmp show</span><br><span class="line">    </span><br><span class="line">over:    </span><br><span class="line">        mov ax,4c00h</span><br><span class="line">        int 21h</span><br><span class="line">;=======================================================  </span><br><span class="line">;fun area            </span><br><span class="line">show:</span><br><span class="line">        mov cx,3;大循环3次</span><br><span class="line">        </span><br><span class="line">point:       </span><br><span class="line">        push cx</span><br><span class="line">        push di</span><br><span class="line">        mov cx,16;初始化小循环16次</span><br><span class="line">        mov si,0</span><br><span class="line">        mov dh,ds:[bx]</span><br><span class="line">        ;规律是高位修改color颜色,低位修改ASCII字符,dh是奇数位,al是偶数位,连续地址 [00] [01] 中,在dx的排布是[01] [00]</span><br><span class="line">show_str:</span><br><span class="line">        ;把ASCII与颜色依次打入显存</span><br><span class="line">        mov dl,ds:[si]</span><br><span class="line">        mov es:[di],dx</span><br><span class="line">        ;检索下一个字符</span><br><span class="line">        add di,2;传输是字符与颜色的共同传输</span><br><span class="line">        inc si;字符的检索</span><br><span class="line">        loop show_str</span><br><span class="line">                </span><br><span class="line">        pop di;还原di</span><br><span class="line">        pop cx;还原大循环cx的次数</span><br><span class="line">        add di,160;把下行打入显存</span><br><span class="line">        inc bx;配置下一个颜色</span><br><span class="line">        loop point;再一次循环</span><br><span class="line"></span><br><span class="line">        jmp over           </span><br><span class="line"></span><br><span class="line">;=======================================================</span><br><span class="line">code ends</span><br><span class="line">end start</span><br><span class="line">;=======================================================</span><br></pre></td></tr></table></figure>

<p>我自己再写一遍</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">;=======================================================</span><br><span class="line">assume cs:code , ds:data, ss:stack</span><br><span class="line">;=======================================================</span><br><span class="line">;数据源S</span><br><span class="line">data segment</span><br><span class="line">        db  &#x27;welcome to masm!&#x27;</span><br><span class="line">        db  00000010b</span><br><span class="line">        db  00100100b</span><br><span class="line">        db  01110001b</span><br><span class="line">data ends  </span><br><span class="line"> ;=======================================================</span><br><span class="line">;栈段</span><br><span class="line">stack segment stack</span><br><span class="line">        db 128 dup(&#x27;y&#x27;)</span><br><span class="line">stack ends</span><br><span class="line">;=======================================================</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line"> ;main code  </span><br><span class="line"> ;=======================================================</span><br><span class="line">        ;数据源S</span><br><span class="line">        mov ax,data</span><br><span class="line">        mov ds,ax</span><br><span class="line">        mov si,0        ;si=0;si&lt;16;si++</span><br><span class="line">        mov bx,16     ;bx=0;bx&lt;3;bx++</span><br><span class="line">        </span><br><span class="line">        ;数据地D</span><br><span class="line">        mov ax,0B800h</span><br><span class="line">        mov es,ax</span><br><span class="line">        mov di,160*12+30*2 ;di=160*12+30*2;di&lt;xx+160*3;di+=160</span><br><span class="line">        </span><br><span class="line">        ;栈</span><br><span class="line">        mov ax,stack</span><br><span class="line">        mov ss,ax</span><br><span class="line">        mov sp,128</span><br><span class="line">               </span><br><span class="line">;=======================================================       </span><br><span class="line">        </span><br><span class="line">        ;把颜色,ascii打入字符串当中</span><br><span class="line">        ;颜色在cx=3大循环中打入,ASCII在小循环cx=16中打入</span><br><span class="line">        ;用bx寻颜色</span><br><span class="line">        ;用si,di寻ASCII</span><br><span class="line">        </span><br><span class="line">        mov cx,3</span><br><span class="line">big:</span><br><span class="line">        </span><br><span class="line">        push cx;cx=3,在小循环cx=16,会用到</span><br><span class="line">        push di</span><br><span class="line">        </span><br><span class="line">        mov dh,ds:[bx]</span><br><span class="line">        mov cx, 16</span><br><span class="line">        mov si,0</span><br><span class="line">         </span><br><span class="line">        </span><br><span class="line">small:</span><br><span class="line">        mov dl,ds:[si]</span><br><span class="line">        mov es:[di],dx</span><br><span class="line">        inc si</span><br><span class="line">        add di,2</span><br><span class="line">        loop small</span><br><span class="line">        </span><br><span class="line">        pop di                </span><br><span class="line">        pop cx</span><br><span class="line">        </span><br><span class="line">        add di,160</span><br><span class="line">        inc bx</span><br><span class="line">        loop big</span><br><span class="line"> over:    </span><br><span class="line">        mov ax,4c00h</span><br><span class="line">        int 21h</span><br><span class="line">;=======================================================         </span><br><span class="line">;function</span><br><span class="line"></span><br><span class="line">                        </span><br><span class="line">           </span><br><span class="line">;=======================================================  </span><br><span class="line">code ends</span><br><span class="line">end start</span><br><span class="line">;=======================================================</span><br></pre></td></tr></table></figure>

<p>出现的问题</p>
<p>没注意数据的长度,体现在</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">small:</span><br><span class="line">        mov dl,ds:[si]</span><br><span class="line">        mov es:[di],dx</span><br><span class="line">        inc si</span><br><span class="line">        inc di</span><br><span class="line">        loop small</span><br></pre></td></tr></table></figure>

<p>这里的话</p>
<p>应该是</p>
<p>add di,2</p>
<p>不是</p>
<p>di++</p>
<h3 id="复制的脚本"><a href="#复制的脚本" class="headerlink" title="复制的脚本"></a>复制的脚本</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line"></span><br><span class="line">        mov bx,0</span><br><span class="line">        mov cx,16   </span><br><span class="line"></span><br><span class="line">func:     </span><br><span class="line">        mov ax,0FFFFh</span><br><span class="line">        mov ds,ax           </span><br><span class="line">        mov dl,ds:[bx]      ;dl=[0xFFFF:bx]</span><br><span class="line">        </span><br><span class="line">        mov ax,0020h</span><br><span class="line">        mov ds,ax           </span><br><span class="line">        mov ds:[bx],dl       ;[0020:bx]=dl</span><br><span class="line">        </span><br><span class="line">        inc bx      </span><br><span class="line">        loop func       </span><br><span class="line"></span><br><span class="line">	   mov ax,4c00h</span><br><span class="line">	   int 21h</span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>另外一种</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line"></span><br><span class="line">        mov ax,0ffffh</span><br><span class="line">        mov ds,ax           ;ds 数据从哪里来</span><br><span class="line">        </span><br><span class="line">        mov ax,0020h</span><br><span class="line">        mov es,ax           ;es 数据给到哪里去</span><br><span class="line">        </span><br><span class="line">        mov bx,0</span><br><span class="line">        mov cx,16</span><br><span class="line">     </span><br><span class="line">func:</span><br><span class="line">        mov dl,ds:[bx]      ;取出来</span><br><span class="line">        mov es:[bx],dl      ;放进去</span><br><span class="line">        inc bx              ;遍历</span><br><span class="line">        loop func</span><br><span class="line">        </span><br><span class="line">	   mov ax,4c00h</span><br><span class="line">	   int 21h</span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure>



<h3 id="指令复制"><a href="#指令复制" class="headerlink" title="指令复制"></a>指令复制</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data segment</span><br><span class="line">    db 256 dup(&#x27;A&#x27;)    </span><br><span class="line">data ends  </span><br><span class="line"></span><br><span class="line">stack segment stack</span><br><span class="line">    db 128 dup(&#x27;w&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line"></span><br><span class="line">start: </span><br><span class="line">            ;ss初始化</span><br><span class="line">            mov ax,stack</span><br><span class="line">            mov ss,ax</span><br><span class="line">            mov sp,128</span><br><span class="line">           </span><br><span class="line">            s:</span><br><span class="line">            mov ax,bx</span><br><span class="line">            mov si,offset s</span><br><span class="line">            mov di, offset s0</span><br><span class="line">            </span><br><span class="line">            mov dx,cs:[si]</span><br><span class="line">            mov cs:[di],dx</span><br><span class="line">            </span><br><span class="line">            s0:</span><br><span class="line">            nop</span><br><span class="line">            nop</span><br><span class="line">            </span><br><span class="line">         </span><br><span class="line">        </span><br><span class="line">            end:</span><br><span class="line">            mov ax,4c00h</span><br><span class="line">            int 21h</span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line"></span><br><span class="line">end start</span><br></pre></td></tr></table></figure>

<p>这里只是复制了一条指令</p>
<p>把指令 17行的指令 mov ax,bx占2个字节</p>
<p>复制到 29行处 mov ax,bx</p>
<p>你也可以通过循环复制多条指令</p>
<p>但是,指令的长度,你必须要好好考虑一下</p>
<h3 id="打印小写与大写字符串"><a href="#打印小写与大写字符串" class="headerlink" title="打印小写与大写字符串"></a>打印小写与大写字符串</h3><p>类型一</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">;=======================================================</span><br><span class="line">assume cs:code , ds:data, ss:stack</span><br><span class="line">;=======================================================</span><br><span class="line">;数据源S</span><br><span class="line">data segment</span><br><span class="line">        db &#x27;dengquxiang are&#x27;,0</span><br><span class="line">data ends  </span><br><span class="line"> ;=======================================================</span><br><span class="line">;栈段</span><br><span class="line">stack segment stack</span><br><span class="line">        db 128 dup(&#x27;y&#x27;)</span><br><span class="line">stack ends</span><br><span class="line">;=======================================================</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line"> ;main code  </span><br><span class="line"> ;=======================================================</span><br><span class="line">        ;数据源S</span><br><span class="line">        mov ax,data</span><br><span class="line">        mov ds,ax</span><br><span class="line">        mov si,0</span><br><span class="line">        mov bx,0</span><br><span class="line">        </span><br><span class="line">        ;数据地D</span><br><span class="line">        mov ax,7e00h</span><br><span class="line">        mov es,ax</span><br><span class="line">        mov di,0</span><br><span class="line">        </span><br><span class="line">        ;栈</span><br><span class="line">        mov ax,stack</span><br><span class="line">        mov ss,ax</span><br><span class="line">        mov sp,128</span><br><span class="line">               </span><br><span class="line">;=======================================================       </span><br><span class="line">        call init_reg</span><br><span class="line">        call clean_screen</span><br><span class="line">        call show_small</span><br><span class="line">        call init_big</span><br><span class="line">        call show_big</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> over:    </span><br><span class="line">        mov ax,4c00h</span><br><span class="line">        int 21h</span><br><span class="line">;=======================================================         </span><br><span class="line">;function</span><br><span class="line">init_reg:</span><br><span class="line">        mov bx,data</span><br><span class="line">        mov ds,bx</span><br><span class="line">        </span><br><span class="line">        mov bx,0b800h</span><br><span class="line">        mov es,bx</span><br><span class="line">        ret</span><br><span class="line">clean_screen:</span><br><span class="line">        mov bx,0</span><br><span class="line">        mov dx,0700h</span><br><span class="line">        mov cx,2000</span><br><span class="line">cleanscreen:       </span><br><span class="line">        mov es:[bx],dx</span><br><span class="line">        add bx,2</span><br><span class="line">        loop cleanscreen</span><br><span class="line">        ret</span><br><span class="line">show_small:</span><br><span class="line">        mov si,0</span><br><span class="line">        mov di,160*10+30*2</span><br><span class="line">        </span><br><span class="line">        call show_str</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        ret                       </span><br><span class="line">show_str:</span><br><span class="line">        push cx</span><br><span class="line">        push ds</span><br><span class="line">        push es</span><br><span class="line">        push si</span><br><span class="line">        push di</span><br><span class="line">        </span><br><span class="line">        mov cx,0</span><br><span class="line">showstr:</span><br><span class="line">         mov cl,ds:[si]</span><br><span class="line">         jcxz show_ret</span><br><span class="line">         mov es:[di],cl</span><br><span class="line">         add di,2</span><br><span class="line">         inc si</span><br><span class="line">         jmp showstr</span><br><span class="line">           ret           </span><br><span class="line">show_ret:</span><br><span class="line">        pop di</span><br><span class="line">        pop si</span><br><span class="line">        pop es</span><br><span class="line">        pop ds</span><br><span class="line">        pop cx</span><br><span class="line">        ret</span><br><span class="line">init_big:</span><br><span class="line">        mov si,0</span><br><span class="line">        call capital</span><br><span class="line">        ret</span><br><span class="line">capital:</span><br><span class="line">        push cx</span><br><span class="line">        push ds</span><br><span class="line">        push si</span><br><span class="line">        push di</span><br><span class="line">        mov cx,0</span><br><span class="line">point:</span><br><span class="line">        mov cl,ds:[si]</span><br><span class="line">        jcxz capital_ret</span><br><span class="line">        and byte ptr ds:[si],11011111b</span><br><span class="line">        inc si</span><br><span class="line">        jmp point</span><br><span class="line">        </span><br><span class="line">capital_ret: </span><br><span class="line">        pop di</span><br><span class="line">        pop si</span><br><span class="line">        pop ds</span><br><span class="line">        pop cx      </span><br><span class="line">        ret</span><br><span class="line">show_big:</span><br><span class="line">        mov si,0</span><br><span class="line">        mov di,160*11+30*2</span><br><span class="line">        call show_str</span><br><span class="line">        </span><br><span class="line">        ret</span><br><span class="line">;=======================================================  </span><br><span class="line">code ends</span><br><span class="line">end start</span><br><span class="line">;=======================================================</span><br></pre></td></tr></table></figure>

<p>我写的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">;=======================================================</span><br><span class="line">assume cs:code , ds:data, ss:stack</span><br><span class="line">;=======================================================</span><br><span class="line">;数据源S</span><br><span class="line">data segment</span><br><span class="line">        db &#x27;tinyxiangxiangs&#x27;,0</span><br><span class="line">data ends  </span><br><span class="line"> ;=======================================================</span><br><span class="line">;栈段</span><br><span class="line">stack segment stack</span><br><span class="line">        db 128 dup(&#x27;y&#x27;)</span><br><span class="line">stack ends</span><br><span class="line">;=======================================================</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line"> ;main code  </span><br><span class="line"> ;=======================================================</span><br><span class="line">        ;数据源S</span><br><span class="line">        mov ax,data</span><br><span class="line">        mov ds,ax</span><br><span class="line">        mov si,0</span><br><span class="line">        mov bx,0</span><br><span class="line">        </span><br><span class="line">        ;数据地D</span><br><span class="line">        mov ax,7e00h</span><br><span class="line">        mov es,ax</span><br><span class="line">        mov di,0</span><br><span class="line">        </span><br><span class="line">        ;栈</span><br><span class="line">        mov ax,stack</span><br><span class="line">        mov ss,ax</span><br><span class="line">        mov sp,128</span><br><span class="line">               </span><br><span class="line">;=======================================================       </span><br><span class="line">;初始化指向</span><br><span class="line">;显示数据</span><br><span class="line">;修改数据</span><br><span class="line">;显示数据</span><br><span class="line">;数据显示是一个函数</span><br><span class="line">        call init_reg</span><br><span class="line">        call init_screen</span><br><span class="line">        call show_small</span><br><span class="line">        call show_big</span><br><span class="line"> over:    </span><br><span class="line">        mov ax,4c00h</span><br><span class="line">        int 21h</span><br><span class="line">;=======================================================         </span><br><span class="line">;function </span><br><span class="line">;0700h是默认颜色 160*10+30*2是显示的位置,显存的地址0b800h</span><br><span class="line"></span><br><span class="line">init_reg:</span><br><span class="line">        ;指向的地址</span><br><span class="line">        mov ax,0b800h</span><br><span class="line">        mov es,ax</span><br><span class="line">        mov si,0;si+=1</span><br><span class="line">        mov di,160*10+30*2;di+=2</span><br><span class="line">        ret</span><br><span class="line">init_screen:</span><br><span class="line">        mov cx,2000</span><br><span class="line">        mov ax,0 </span><br><span class="line">        push di</span><br><span class="line">        mov di,0</span><br><span class="line">loop1:</span><br><span class="line">        mov es:[di],ax</span><br><span class="line">        add di,2</span><br><span class="line">        loop loop1</span><br><span class="line">        pop di</span><br><span class="line">        ret            </span><br><span class="line">show_small:</span><br><span class="line">        push si</span><br><span class="line">        push di</span><br><span class="line">        mov cx,16</span><br><span class="line">        mov ah,11011111b</span><br><span class="line">loop2:</span><br><span class="line">        mov al,ds:[si]</span><br><span class="line">        mov es:[di],ax</span><br><span class="line">        inc si</span><br><span class="line">        add di,2</span><br><span class="line">        loop loop2</span><br><span class="line">        pop di</span><br><span class="line">        pop si    </span><br><span class="line">        ret </span><br><span class="line">show_big:</span><br><span class="line">        push si</span><br><span class="line">        push di</span><br><span class="line">        mov di,160*11+30*2</span><br><span class="line">        mov cx,16</span><br><span class="line">        mov ah,11011111b</span><br><span class="line">loop3:</span><br><span class="line">        mov al,ds:[si]</span><br><span class="line">        and al,11011111b</span><br><span class="line">        mov es:[di],ax</span><br><span class="line">        inc si</span><br><span class="line">        add di,2</span><br><span class="line">        loop loop3</span><br><span class="line">        pop di</span><br><span class="line">        pop di    </span><br><span class="line">        ret        </span><br><span class="line">          </span><br><span class="line">;=======================================================  </span><br><span class="line">code ends</span><br><span class="line">end start</span><br><span class="line">;=======================================================</span><br></pre></td></tr></table></figure>



<p>类型2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">;=======================================================</span><br><span class="line">assume cs:code , ds:data, ss:stack</span><br><span class="line">;=======================================================</span><br><span class="line">;数据源S</span><br><span class="line">data segment</span><br><span class="line">        db &#x27;wind&#x27;,0</span><br><span class="line">        db &#x27;good&#x27;,0</span><br><span class="line">        db &#x27;word&#x27;,0</span><br><span class="line">        db &#x27;unix&#x27;,0</span><br><span class="line">data ends  </span><br><span class="line"> ;=======================================================</span><br><span class="line">;栈段</span><br><span class="line">stack segment stack</span><br><span class="line">        db 128 dup(&#x27;y&#x27;)</span><br><span class="line">stack ends</span><br><span class="line">;=======================================================</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line"> ;main code  </span><br><span class="line"> ;=======================================================</span><br><span class="line">        ;数据源S</span><br><span class="line">        mov ax,data</span><br><span class="line">        mov ds,ax</span><br><span class="line">        mov si,0</span><br><span class="line">        mov bx,0</span><br><span class="line">        </span><br><span class="line">        ;数据地D</span><br><span class="line">        mov ax,7e00h</span><br><span class="line">        mov es,ax</span><br><span class="line">        mov di,0</span><br><span class="line">        </span><br><span class="line">        ;栈</span><br><span class="line">        mov ax,stack</span><br><span class="line">        mov ss,ax</span><br><span class="line">        mov sp,128</span><br><span class="line">               </span><br><span class="line">;=======================================================       </span><br><span class="line">        call init_reg</span><br><span class="line">        call clean_screen</span><br><span class="line">        call make_big</span><br><span class="line">black:       </span><br><span class="line">        mov ax,1000h</span><br><span class="line">        jmp black</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> over:    </span><br><span class="line">        mov ax,4c00h</span><br><span class="line">        int 21h</span><br><span class="line">;=======================================================         </span><br><span class="line">;function</span><br><span class="line">init_reg:</span><br><span class="line">        mov bx,data</span><br><span class="line">        mov ds,bx</span><br><span class="line">        mov bx,0b800h</span><br><span class="line">        mov es,bx</span><br><span class="line">        ret</span><br><span class="line">clean_screen:</span><br><span class="line">        mov bx,0</span><br><span class="line">        mov dx,0700h</span><br><span class="line">        mov cx,2000</span><br><span class="line">cleanscreen:</span><br><span class="line">        mov es:[bx],dx</span><br><span class="line">        add bx,2</span><br><span class="line">        loop cleanscreen </span><br><span class="line">        ret                       </span><br><span class="line">make_big:</span><br><span class="line">        mov si,0</span><br><span class="line">        mov di,160*10+30*2</span><br><span class="line">        mov cx,4</span><br><span class="line">makebig:       </span><br><span class="line">        call show_str</span><br><span class="line">        call capital_letter</span><br><span class="line">        call show_word</span><br><span class="line">        add di,160</span><br><span class="line">        add si,5</span><br><span class="line">        loop makebig</span><br><span class="line">        </span><br><span class="line">        ret</span><br><span class="line">show_str:</span><br><span class="line">        push cx</span><br><span class="line">        push ds</span><br><span class="line">        push es</span><br><span class="line">        push di</span><br><span class="line">        push si</span><br><span class="line">        </span><br><span class="line">        mov cx,0</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">showstr:</span><br><span class="line">        mov cl,ds:[si]</span><br><span class="line">        jcxz show_str_ret</span><br><span class="line">        mov es:[di],cl</span><br><span class="line">        add di,2</span><br><span class="line">        inc si</span><br><span class="line">        jmp showstr</span><br><span class="line"></span><br><span class="line">show_str_ret:</span><br><span class="line">        pop si</span><br><span class="line">        pop di</span><br><span class="line">        pop es</span><br><span class="line">        pop ds</span><br><span class="line">        pop cx</span><br><span class="line">        </span><br><span class="line">        ret  </span><br><span class="line">capital_letter:</span><br><span class="line">        push cx</span><br><span class="line">        push ds</span><br><span class="line">        push si</span><br><span class="line">        push di</span><br><span class="line">        </span><br><span class="line">        mov cx,0</span><br><span class="line">capitalletter:</span><br><span class="line">        mov cl,ds:[si]</span><br><span class="line">        jcxz capital_ret</span><br><span class="line">        and byte ptr ds:[si],11011111b</span><br><span class="line">        inc si</span><br><span class="line">        jmp capitalletter</span><br><span class="line">        </span><br><span class="line">capital_ret:</span><br><span class="line">        pop di</span><br><span class="line">        pop si</span><br><span class="line">        pop ds</span><br><span class="line">        pop cx</span><br><span class="line">        ret   </span><br><span class="line">show_word:</span><br><span class="line">        push di</span><br><span class="line">        add di,10*2</span><br><span class="line">        call show_str</span><br><span class="line">        pop di</span><br><span class="line">        ret </span><br><span class="line">;=======================================================  </span><br><span class="line">code ends</span><br><span class="line">end start</span><br><span class="line">;=======================================================  </span><br></pre></td></tr></table></figure>

<p>我写的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line">;=======================================================</span><br><span class="line">assume cs:code , ds:data, ss:stack</span><br><span class="line">;=======================================================</span><br><span class="line">;数据源S</span><br><span class="line">data segment</span><br><span class="line">        db &#x27;wind&#x27;,0</span><br><span class="line">        db &#x27;good&#x27;,0</span><br><span class="line">        db &#x27;word&#x27;,0</span><br><span class="line">        db &#x27;unix&#x27;,0</span><br><span class="line">        db  0,0,0,0,0</span><br><span class="line">        ;5个5个的循环,160++的显示</span><br><span class="line">data ends </span><br><span class="line"> ;=======================================================</span><br><span class="line">;栈段</span><br><span class="line">stack segment stack</span><br><span class="line">     db 128 dup(&#x27;y&#x27;)</span><br><span class="line">stack ends</span><br><span class="line">;=======================================================</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line"> ;main code  </span><br><span class="line"> ;=======================================================</span><br><span class="line">    ;数据源S</span><br><span class="line">    mov ax,data</span><br><span class="line">    mov ds,ax</span><br><span class="line">    mov si,0</span><br><span class="line">    mov bx,0</span><br><span class="line">        </span><br><span class="line">    ;数据地D</span><br><span class="line">    mov ax,7e00h</span><br><span class="line">    mov es,ax</span><br><span class="line">    mov di,0</span><br><span class="line">        </span><br><span class="line">    ;栈</span><br><span class="line">    mov ax,stack</span><br><span class="line">    mov ss,ax</span><br><span class="line">    mov sp,128</span><br><span class="line">               </span><br><span class="line">;=======================================================       </span><br><span class="line">    </span><br><span class="line">    call init_reg</span><br><span class="line">    call clean_screen</span><br><span class="line">    call show_small</span><br><span class="line">    call show_big</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">over:    </span><br><span class="line">    mov ax,4c00h</span><br><span class="line">    int 21h</span><br><span class="line">;=======================================================         </span><br><span class="line">;function</span><br><span class="line"></span><br><span class="line">init_reg:</span><br><span class="line">    mov ax,0b800h</span><br><span class="line">    mov es,ax</span><br><span class="line">    mov di,160*10+30*2</span><br><span class="line"></span><br><span class="line">    ret</span><br><span class="line">;=======================================================</span><br><span class="line">clean_screen:</span><br><span class="line">    </span><br><span class="line">    mov cx,2000</span><br><span class="line">    mov ax,0700h</span><br><span class="line">    push di</span><br><span class="line">    mov di,0</span><br><span class="line">lop1:</span><br><span class="line">    mov es:[di],ax</span><br><span class="line">    add di,2</span><br><span class="line">    loop lop1</span><br><span class="line"></span><br><span class="line">    pop di</span><br><span class="line">    ret</span><br><span class="line">;=======================================================</span><br><span class="line">show_small:   </span><br><span class="line">    mov si,0</span><br><span class="line">    mov bx,si</span><br><span class="line">    ;大循环</span><br><span class="line">    push di</span><br><span class="line">lop3:</span><br><span class="line">    mov cx,0</span><br><span class="line">    mov cl,ds:[bx]</span><br><span class="line">    jcxz small_ret</span><br><span class="line">    push di</span><br><span class="line"></span><br><span class="line">    ;小循环</span><br><span class="line">lop2:    </span><br><span class="line">    mov cl,0</span><br><span class="line">    mov cl,ds:[si]</span><br><span class="line">  </span><br><span class="line">    jcxz lop2_out</span><br><span class="line">    mov es:[di],cl</span><br><span class="line">    mov byte ptr es:[di+1],11011111b</span><br><span class="line">    inc si</span><br><span class="line">    add di,2</span><br><span class="line">    jmp lop2</span><br><span class="line"></span><br><span class="line">lop2_out:</span><br><span class="line">    pop di</span><br><span class="line">    add di,160</span><br><span class="line">    add bx,5</span><br><span class="line">    inc si  ;容易忽略</span><br><span class="line">    jmp lop3</span><br><span class="line">small_ret:</span><br><span class="line">    pop di</span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">;=======================================================</span><br><span class="line">show_big:</span><br><span class="line">    mov bx,0</span><br><span class="line">    mov cx,0</span><br><span class="line">    mov si,0</span><br><span class="line">    mov di,160*10+30*2+12;本身就存在10个字节的长度,ASCII+颜色,就是2个字节,并且di的位置起点必须还是偶数,否则后面的数据会错位填补</span><br><span class="line">    mov bx,si</span><br><span class="line">    ;大循环</span><br><span class="line">    push di</span><br><span class="line">lop5:</span><br><span class="line">    mov cx,0</span><br><span class="line">    mov cl,ds:[bx]</span><br><span class="line">    jcxz big_ret</span><br><span class="line">    push di</span><br><span class="line"></span><br><span class="line">    ;小循环</span><br><span class="line">lop4:    </span><br><span class="line">    mov cl,0</span><br><span class="line">    mov cl,ds:[si]</span><br><span class="line">    </span><br><span class="line">    jcxz lop4_out</span><br><span class="line">    and cl,11011111b</span><br><span class="line">    mov es:[di],cl</span><br><span class="line">    mov byte ptr es:[di+1],11011111b</span><br><span class="line">    inc si</span><br><span class="line">    add di,2</span><br><span class="line">    jmp lop4</span><br><span class="line"></span><br><span class="line">lop4_out:</span><br><span class="line">    pop di</span><br><span class="line">    add di,160</span><br><span class="line">    add bx,5</span><br><span class="line">    inc si  ;容易忽略</span><br><span class="line">    jmp lop5</span><br><span class="line">big_ret:</span><br><span class="line">    pop di</span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">             </span><br><span class="line">;=======================================================  </span><br><span class="line">code ends</span><br><span class="line">end start</span><br><span class="line">;=======================================================</span><br></pre></td></tr></table></figure>

<p>没有去注意数据的位置有何意义,也没有注意数据的长度</p>
<h3 id="打印一个字符串"><a href="#打印一个字符串" class="headerlink" title="打印一个字符串"></a>打印一个字符串</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">;=======================================================</span><br><span class="line">assume cs:code , ds:data, ss:stack</span><br><span class="line">;=======================================================</span><br><span class="line">;数据源S</span><br><span class="line">data segment</span><br><span class="line">     db &#x27;welcome to masm!&#x27;,0 </span><br><span class="line">data ends  </span><br><span class="line"> ;=======================================================</span><br><span class="line">;栈段</span><br><span class="line">stack segment stack</span><br><span class="line">     db 128 dup(&#x27;y&#x27;)</span><br><span class="line">stack ends</span><br><span class="line">;=======================================================</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line"> ;main code  </span><br><span class="line"> ;=======================================================</span><br><span class="line">    ;数据源S</span><br><span class="line">    mov ax,data</span><br><span class="line">    mov ds,ax</span><br><span class="line">    mov si,0</span><br><span class="line">    mov bx,0</span><br><span class="line">        </span><br><span class="line">    ;数据地D</span><br><span class="line">    mov ax,7e00h</span><br><span class="line">    mov es,ax</span><br><span class="line">    mov di,0</span><br><span class="line">        </span><br><span class="line">    ;栈</span><br><span class="line">    mov ax,stack</span><br><span class="line">    mov ss,ax</span><br><span class="line">    mov sp,128</span><br><span class="line">               </span><br><span class="line">;=======================================================       </span><br><span class="line"></span><br><span class="line">    call init_reg</span><br><span class="line">    call show</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">over:    </span><br><span class="line">    mov ax,4c00h</span><br><span class="line">    int 21h</span><br><span class="line">;=======================================================         </span><br><span class="line">;function</span><br><span class="line">init_reg:</span><br><span class="line">    mov dh,23</span><br><span class="line">    mov dl,3</span><br><span class="line">    mov cl,2</span><br><span class="line">    </span><br><span class="line">    mov ax,0b800h</span><br><span class="line">    mov es,ax</span><br><span class="line"></span><br><span class="line">    mov ax,0</span><br><span class="line">    mov al,dh</span><br><span class="line">    mov bx, 160</span><br><span class="line">    mul bx</span><br><span class="line">    mov di,ax</span><br><span class="line"></span><br><span class="line">    mov al,dl</span><br><span class="line">    mov bx,0</span><br><span class="line">    mov bl,2</span><br><span class="line">    mul bl</span><br><span class="line">    add di,ax</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ret</span><br><span class="line">show:</span><br><span class="line"></span><br><span class="line">    mov cx,0</span><br><span class="line">    mov cl,ds:[si]</span><br><span class="line">    jcxz show_ret</span><br><span class="line">    mov ch,2</span><br><span class="line">    mov es:[di],cx</span><br><span class="line">    add di,2</span><br><span class="line">    inc si</span><br><span class="line">    jmp show</span><br><span class="line"></span><br><span class="line">show_ret:</span><br><span class="line">    ret</span><br><span class="line">           </span><br><span class="line">;=======================================================  </span><br><span class="line">code ends</span><br><span class="line">end start</span><br><span class="line">;=======================================================</span><br></pre></td></tr></table></figure>

<p>出现的问题</p>
<p>对于cx中带颜色,jcxz怎么办</p>
<p>jcxz中jmp的位置不对</p>
<p>jcxz发现cx一直不为0,woc</p>
<p>直接用</p>
<p>mov di,160*23+6</p>
<p>这样更快</p>
<h3 id="源代码-gt-ASCII的打印"><a href="#源代码-gt-ASCII的打印" class="headerlink" title="源代码-&gt;ASCII的打印"></a>源代码-&gt;ASCII的打印</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">;=======================================================</span><br><span class="line">assume cs:code , ds:data, ss:stack</span><br><span class="line">;=======================================================</span><br><span class="line">;数据源S</span><br><span class="line">data segment</span><br><span class="line">     dd 0ffffh,5678,65535,0</span><br><span class="line">data ends  </span><br><span class="line"> ;=======================================================</span><br><span class="line">;栈段</span><br><span class="line">stack segment stack</span><br><span class="line">     db 128 dup(&#x27;y&#x27;)</span><br><span class="line">stack ends</span><br><span class="line">;=======================================================</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line"> ;main code  </span><br><span class="line"> ;=======================================================</span><br><span class="line">    ;数据源S</span><br><span class="line">    mov ax,data</span><br><span class="line">    mov ds,ax</span><br><span class="line">    mov si,0</span><br><span class="line">    mov bx,0</span><br><span class="line">        </span><br><span class="line">    ;数据地D</span><br><span class="line">    mov ax,7e00h</span><br><span class="line">    mov es,ax</span><br><span class="line">    mov di,0</span><br><span class="line">        </span><br><span class="line">    ;栈</span><br><span class="line">    mov ax,stack</span><br><span class="line">    mov ss,ax</span><br><span class="line">    mov sp,128</span><br><span class="line">               </span><br><span class="line">;=======================================================       </span><br><span class="line">    call init_reg</span><br><span class="line">    call show_number</span><br><span class="line"> </span><br><span class="line">over:    </span><br><span class="line">    mov ax,4c00h</span><br><span class="line">    int 21h</span><br><span class="line">;=======================================================         </span><br><span class="line">;function</span><br><span class="line">init_reg:</span><br><span class="line">    </span><br><span class="line">    mov ax,0b800h</span><br><span class="line">    mov es,ax</span><br><span class="line"></span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">Break_Up_Digit:         ;将数字, 好比1234, 利用%的方法去分解为 ,1 2, 3, 4, 然后打入显存</span><br><span class="line">    push ax</span><br><span class="line">    push bx</span><br><span class="line">    push cx</span><br><span class="line">    push dx</span><br><span class="line">    push ds</span><br><span class="line">    push es</span><br><span class="line">    push si</span><br><span class="line">    push di</span><br><span class="line"></span><br><span class="line">    ;初始化 被除数 / 除数 = ?</span><br><span class="line">    mov ax,ds:[si]</span><br><span class="line">    mov dx,ds:[si+2]</span><br><span class="line">    mov bx,10</span><br><span class="line"></span><br><span class="line">lp1:</span><br><span class="line">    div bx </span><br><span class="line">    mov dh,2</span><br><span class="line">    add dl,30h          ;余数-&gt;ASCII </span><br><span class="line">    mov es:[di],dx      ;ASCII-显存</span><br><span class="line">    sub di,2            ;右往左依次填补</span><br><span class="line">    mov cx,ax           ;取商到 cx               </span><br><span class="line">    jcxz fun_ret        ;如果商为0,就退出-&gt;当数据本身就是0,也不影响它的输出</span><br><span class="line">    mov dx,0            ;清空dx,它本身用来装东西的</span><br><span class="line">    jmp lp1</span><br><span class="line"></span><br><span class="line">fun_ret:</span><br><span class="line">    pop di</span><br><span class="line">    pop si</span><br><span class="line">    pop es</span><br><span class="line">    pop ds</span><br><span class="line">    pop dx</span><br><span class="line">    pop cx</span><br><span class="line">    pop bx</span><br><span class="line">    pop ax</span><br><span class="line"></span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">show_number:</span><br><span class="line">    mov si,0        </span><br><span class="line">    mov di,160*10+40*2</span><br><span class="line">    mov cx,4            ;我们有4行数据</span><br><span class="line">shownumber:</span><br><span class="line">    call Break_Up_Digit</span><br><span class="line">    add si,4            ;指向数据段的下一个word数据</span><br><span class="line">    add di,160          ;显示在下一行</span><br><span class="line">    loop shownumber     ;循环往复</span><br><span class="line">    </span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">;=======================================================  </span><br><span class="line">code ends</span><br><span class="line">end start</span><br><span class="line">;=======================================================</span><br></pre></td></tr></table></figure>

<p>里面用到了看数的分解</p>
<p>用32位除法的余数dx去有效的代替%,那么就可以自动的判断了</p>
<p>我自己写的</p>
<p>怎么处理 over_flow 除法??????</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">;=======================================================</span><br><span class="line">assume cs:code , ds:data, ss:stack</span><br><span class="line">;=======================================================</span><br><span class="line">;数据源S</span><br><span class="line">data segment</span><br><span class="line">     db 01,02,03,04,05,06,07,08,09,10</span><br><span class="line">     ;所以要10次?</span><br><span class="line">     </span><br><span class="line">data ends  </span><br><span class="line"> ;=======================================================</span><br><span class="line">;栈段</span><br><span class="line">stack segment stack</span><br><span class="line">     db 128 dup(&#x27;y&#x27;)</span><br><span class="line">stack ends</span><br><span class="line">;=======================================================</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line"> ;main code  </span><br><span class="line"> ;=======================================================</span><br><span class="line">    ;数据源S</span><br><span class="line">    mov ax,data</span><br><span class="line">    mov ds,ax</span><br><span class="line">    mov si,0</span><br><span class="line">    mov bx,0</span><br><span class="line">        </span><br><span class="line">    ;数据地D</span><br><span class="line">    mov ax,7e00h</span><br><span class="line">    mov es,ax</span><br><span class="line">    mov di,0</span><br><span class="line">        </span><br><span class="line">    ;栈</span><br><span class="line">    mov ax,stack</span><br><span class="line">    mov ss,ax</span><br><span class="line">    mov sp,128</span><br><span class="line">               </span><br><span class="line">;=======================================================       </span><br><span class="line">    call Init_Reg       </span><br><span class="line">    call Show_Data</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">over:    </span><br><span class="line">    mov ax,4c00h</span><br><span class="line">    int 21h</span><br><span class="line">;=======================================================         </span><br><span class="line">;function</span><br><span class="line"></span><br><span class="line">Init_Reg:</span><br><span class="line">    </span><br><span class="line">    mov ax,0b800h</span><br><span class="line">    mov es,ax</span><br><span class="line">    mov di,10*160+30*2</span><br><span class="line"></span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">Show_Data:</span><br><span class="line">    ;采用数分解的方式</span><br><span class="line"></span><br><span class="line">    mov cx,10</span><br><span class="line">    mov si,0</span><br><span class="line">    mov bx,0</span><br><span class="line">    </span><br><span class="line">lp2:</span><br><span class="line">    push cx</span><br><span class="line">    push di</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    mov ah,0</span><br><span class="line">    mov al,ds:[si]</span><br><span class="line"></span><br><span class="line">    mov dx,0</span><br><span class="line">    mov bx,10</span><br><span class="line">    ;余数在dx中</span><br><span class="line">lp1:</span><br><span class="line">    div bx</span><br><span class="line">    add dl,30h</span><br><span class="line">    mov dh,2</span><br><span class="line">    mov es:[di],dx</span><br><span class="line">    mov cx,ax</span><br><span class="line">    jcxz continue_x</span><br><span class="line">    sub di,2</span><br><span class="line">    mov dx,0</span><br><span class="line">    jmp lp1</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">continue_x:</span><br><span class="line">    pop di</span><br><span class="line">    pop cx</span><br><span class="line">    add di,160</span><br><span class="line">    inc si</span><br><span class="line">    loop lp2</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    ret</span><br><span class="line">           </span><br><span class="line">;=======================================================  </span><br><span class="line">code ends</span><br><span class="line">end start</span><br><span class="line">;=======================================================</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>出现的问题</p>
<blockquote>
<p>  对循环而言,不知道那些指令是要循环的,哪些指令它是不需要循环的</p>
</blockquote>
<blockquote>
<p>  对数据经不起考验,也就是代码不严谨</p>
<p>  好比对于除法,每一次它的计算,你最好要去初始化一下,否者很容易数据错位而算出奇奇怪怪的东西</p>
</blockquote>
<ol start="4">
<li></li>
</ol>
<h3 id="屏幕复制"><a href="#屏幕复制" class="headerlink" title="屏幕复制"></a>屏幕复制</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">;=======================================================</span><br><span class="line">assume cs:code , ds:data, ss:stack</span><br><span class="line">;=======================================================</span><br><span class="line">;数据源S</span><br><span class="line">        data segment</span><br><span class="line">                        db 128 dup(&#x27;x&#x27;) </span><br><span class="line">        data ends  </span><br><span class="line"> ;=======================================================</span><br><span class="line">;栈段</span><br><span class="line">        stack segment stack</span><br><span class="line">                        db 128 dup(&#x27;y&#x27;)</span><br><span class="line">        stack ends</span><br><span class="line">;=======================================================</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">;main code  </span><br><span class="line">;=======================================================</span><br><span class="line">;数据源S</span><br><span class="line">                        mov ax,data</span><br><span class="line">                        mov ds,ax       </span><br><span class="line">;数据地D</span><br><span class="line">                        mov ax,7e00h</span><br><span class="line">                        mov es,ax        </span><br><span class="line">;栈</span><br><span class="line">                        mov ax,stack</span><br><span class="line">                        mov ss,ax</span><br><span class="line">                        mov sp,128</span><br><span class="line">               </span><br><span class="line">;=======================================================       </span><br><span class="line">        </span><br><span class="line">                        call init_reg</span><br><span class="line"></span><br><span class="line">                        call cpy_screen</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">over:    </span><br><span class="line">                        mov ax,4c00h</span><br><span class="line">                        int 21h</span><br><span class="line">;=======================================================         </span><br><span class="line">;function</span><br><span class="line">init_reg:</span><br><span class="line">                        </span><br><span class="line">                        mov bx,0b800h</span><br><span class="line">                        mov ds,bx</span><br><span class="line">                        mov es,bx</span><br><span class="line">                        ret</span><br><span class="line">cpy_screen:</span><br><span class="line">                        </span><br><span class="line">                        mov cx,24</span><br><span class="line">                        mov si,160</span><br><span class="line">                        mov di,0</span><br><span class="line">cpy_screen_cmd:</span><br><span class="line">                        push cx</span><br><span class="line">                        push si</span><br><span class="line">                        push di</span><br><span class="line">                        mov cx,80</span><br><span class="line"></span><br><span class="line">                        cld</span><br><span class="line">                        rep movsw</span><br><span class="line"></span><br><span class="line">                        pop di</span><br><span class="line">                        pop si</span><br><span class="line">                        pop cx</span><br><span class="line">                        add si,160</span><br><span class="line">                        add di,160</span><br><span class="line">                        loop cpy_screen_cmd                        </span><br><span class="line"></span><br><span class="line">                        ret</span><br><span class="line">                        </span><br><span class="line">           </span><br><span class="line">;=======================================================  </span><br><span class="line">code ends</span><br><span class="line">end start</span><br><span class="line">;=======================================================</span><br></pre></td></tr></table></figure>



<h3 id="指令复制-1"><a href="#指令复制-1" class="headerlink" title="指令复制"></a>指令复制</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">;=======================================================</span><br><span class="line">assume cs:code , ds:data, ss:stack</span><br><span class="line">;=======================================================</span><br><span class="line">;数据源S</span><br><span class="line">        data segment</span><br><span class="line">                        db 128 dup(&#x27;x&#x27;) </span><br><span class="line">        data ends  </span><br><span class="line"> ;=======================================================</span><br><span class="line">;栈段</span><br><span class="line">        stack segment stack</span><br><span class="line">                        db 128 dup(&#x27;y&#x27;)</span><br><span class="line">        stack ends</span><br><span class="line">;=======================================================</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">;main code  </span><br><span class="line">;=======================================================</span><br><span class="line">;数据源S</span><br><span class="line">                        mov ax,data</span><br><span class="line">                        mov ds,ax       </span><br><span class="line">;数据地D</span><br><span class="line">                        mov ax,7e00h</span><br><span class="line">                        mov es,ax        </span><br><span class="line">;栈</span><br><span class="line">                        mov ax,stack</span><br><span class="line">                        mov ss,ax</span><br><span class="line">                        mov sp,128</span><br><span class="line">               </span><br><span class="line">;=======================================================       </span><br><span class="line">                        call copy_cmd</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">over:    </span><br><span class="line">                        mov ax,4c00h</span><br><span class="line">                        int 21h</span><br><span class="line">;=======================================================         </span><br><span class="line">;function</span><br><span class="line"></span><br><span class="line">cmd:                    mov ax,10</span><br><span class="line">                        mov ax,10</span><br><span class="line">                        mov ax,10</span><br><span class="line">                        mov ax,10</span><br><span class="line">                        mov ax,10</span><br><span class="line">cmd_end:                nop</span><br><span class="line"></span><br><span class="line">copy_cmd:</span><br><span class="line">                        mov bx,cs</span><br><span class="line">                        mov ds,bx</span><br><span class="line">                        mov si,offset cmd</span><br><span class="line"></span><br><span class="line">                        mov bx,0</span><br><span class="line">                        mov es,bx</span><br><span class="line">                        mov di,7e00h</span><br><span class="line"></span><br><span class="line">                        mov cx,offset cmd_end-cmd</span><br><span class="line">                        cld</span><br><span class="line">                        rep movsb</span><br><span class="line">                        </span><br><span class="line">                        ret</span><br><span class="line">                        </span><br><span class="line">           </span><br><span class="line">;=======================================================  </span><br><span class="line">code ends</span><br><span class="line">end start</span><br><span class="line">;=======================================================</span><br></pre></td></tr></table></figure>







<h3 id="Copy-Code函数"><a href="#Copy-Code函数" class="headerlink" title="Copy_Code函数"></a>Copy_Code函数</h3><p>用到了几个参数</p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CX</span><br></pre></td></tr></table></figure>

<p>:代表了循环的次数</p>
</blockquote>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cld </span><br><span class="line">rep movsb</span><br></pre></td></tr></table></figure>

<p>代表了复制的功能</p>
<p>sb就是byte的一种复制</p>
</blockquote>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ds:[si]</span><br><span class="line">es:[di]</span><br></pre></td></tr></table></figure>

<p>要复制什么代码</p>
<p>复制到哪里去</p>
</blockquote>
<h3 id="用中断模拟没有loop-的的loop"><a href="#用中断模拟没有loop-的的loop" class="headerlink" title="用中断模拟没有loop 的的loop"></a>用中断模拟没有loop 的的loop</h3><p>它的原理是修改栈里的IP</p>
<p>然后pop出去被修改的IP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code ,  ss:stack</span><br><span class="line"></span><br><span class="line">stack segment </span><br><span class="line">    db 32 dup(&#x27;0&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:                     </span><br><span class="line">                                mov ax,stack</span><br><span class="line">                                mov ss,ax;</span><br><span class="line">                                mov sp,32</span><br><span class="line"></span><br><span class="line">                                call init_do7ch;他只会push ip</span><br><span class="line"></span><br><span class="line">                                mov ax,0b800h</span><br><span class="line">                                mov es,ax</span><br><span class="line">                                mov di,160*12</span><br><span class="line"></span><br><span class="line">                                mov bx,offset s - offset send</span><br><span class="line">                                mov cx,8</span><br><span class="line">                        s:</span><br><span class="line">                                </span><br><span class="line">                                mov byte ptr es:[di+0],&#x27;!&#x27;</span><br><span class="line">                                mov byte ptr es:[di+1],2 </span><br><span class="line">                                add di,2   </span><br><span class="line">                                int 7ch</span><br><span class="line">                        send:</span><br><span class="line">                                nop</span><br><span class="line"></span><br><span class="line">                            mov ax,4c00h</span><br><span class="line">                            int 21h</span><br><span class="line"></span><br><span class="line">;-----------------------------------------------------------------------------------------------------------------</span><br><span class="line">                 </span><br><span class="line">                init_do7ch:</span><br><span class="line">                            ;先是修改数据的指向,然后是复制中断代码到中断区,中断区域的调用是自动的</span><br><span class="line">                            ;--------------------------------------------</span><br><span class="line">                            ;设置数据来源 S指-&gt;CS:[do7ch]</span><br><span class="line">                            mov ax,cs</span><br><span class="line">                            mov ds,ax</span><br><span class="line">                            mov si,offset do7ch;这样取地址就非常的妙..不想你之前根本想不到</span><br><span class="line">                            </span><br><span class="line">                            ;设置数据D-&gt;0000:[0200]</span><br><span class="line">                            mov ax,0</span><br><span class="line">                            mov es,ax</span><br><span class="line">                            mov di,200h</span><br><span class="line"></span><br><span class="line">                            mov cx,offset do7chend - offset do7ch;循环的次数</span><br><span class="line"></span><br><span class="line">                            cld</span><br><span class="line">                            rep movsb</span><br><span class="line">                            </span><br><span class="line">                           </span><br><span class="line">                            ;数据指向完成后,初始化一下中断向量表,第[0]个向量表的地址0000:0200</span><br><span class="line">                            mov ax,0</span><br><span class="line">                            mov es,ax</span><br><span class="line">                            mov word ptr es:[7ch*4+0],200h</span><br><span class="line">                            mov word ptr es:[7ch*4+2],0</span><br><span class="line">                            </span><br><span class="line">                            ret  </span><br><span class="line"></span><br><span class="line">                            ;--------------------------------------</span><br><span class="line">                do7ch:</span><br><span class="line">                            push bp</span><br><span class="line">                            mov bp,sp;因为这里让bp发生了改变...所以我们要保存bp的初始化值</span><br><span class="line">                            dec cx</span><br><span class="line">                            jcxz lpret</span><br><span class="line">                            add ss:[bp+2],bx;woc,这里不是默认的ds:</span><br><span class="line">                lpret:</span><br><span class="line">                            pop bp    </span><br><span class="line">                            iret    </span><br><span class="line">                            </span><br><span class="line">                do7chend:        </span><br><span class="line">                            nop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>



<h3 id="在一定的光标位置显示字符"><a href="#在一定的光标位置显示字符" class="headerlink" title="在一定的光标位置显示字符"></a>在一定的光标位置显示字符</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code,ss:stack</span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">        db 128 dup(&#x27;y&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line"></span><br><span class="line">start:</span><br><span class="line">                                mov ax,stack</span><br><span class="line">                                mov ss,ax</span><br><span class="line">                                mov sp,128</span><br><span class="line"></span><br><span class="line">                                ;bh 总 是 代 表 着 页 数</span><br><span class="line">                                ;ah总 是 代 表 着 编 号</span><br><span class="line"> </span><br><span class="line">                                mov ah,2</span><br><span class="line">                                mov bh,0</span><br><span class="line">                                mov dh,5</span><br><span class="line">                                mov dl,2</span><br><span class="line">                                int 10h</span><br><span class="line"></span><br><span class="line">                                mov ah,9</span><br><span class="line">                                mov al,&#x27;a&#x27;</span><br><span class="line"></span><br><span class="line">                                mov bl,11001010b</span><br><span class="line">                                mov bh,0</span><br><span class="line">                                mov cx,6</span><br><span class="line">                                int 10h</span><br><span class="line">                        </span><br><span class="line">                                mov ax,4c00h</span><br><span class="line">                                int 21h</span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>



























<h3 id="int-7ch-计算sqrt"><a href="#int-7ch-计算sqrt" class="headerlink" title="int 7ch 计算sqrt"></a>int 7ch 计算sqrt</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code ,  ss:stack</span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">    db 128 dup(&#x27;y&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:                     </span><br><span class="line">                            mov ax,stack</span><br><span class="line">                            mov ss,ax;</span><br><span class="line">                            mov sp,128</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                            call init_do7ch;他只会push ip</span><br><span class="line">                            mov ax,8</span><br><span class="line">                            int 7ch</span><br><span class="line">                            add ax,ax</span><br><span class="line">                            adc dx,dx</span><br><span class="line">                            </span><br><span class="line">                            mov ax,4c00h</span><br><span class="line">                            int 21h  </span><br><span class="line">;-----------------------------------------------------------------------------------------------------------------</span><br><span class="line">                 </span><br><span class="line">                init_do7ch:</span><br><span class="line">                            ;先是修改数据的指向,然后是复制中断代码到中断区,中断区域的调用是自动的</span><br><span class="line">                            ;--------------------------------------------</span><br><span class="line">                            ;设置数据来源 S指-&gt;CS:[do7ch]</span><br><span class="line">                            mov ax,cs</span><br><span class="line">                            mov ds,ax</span><br><span class="line">                            mov si,offset do7ch;这样取地址就非常的妙..不想你之前根本想不到</span><br><span class="line">                            </span><br><span class="line">                            ;设置数据D-&gt;0000:[0200]</span><br><span class="line">                            mov ax,0</span><br><span class="line">                            mov es,ax</span><br><span class="line">                            mov di,200h</span><br><span class="line"></span><br><span class="line">                            mov cx,offset do7chend - offset do7ch;循环的次数</span><br><span class="line"></span><br><span class="line">                            cld</span><br><span class="line">                            rep movsb</span><br><span class="line">                            </span><br><span class="line">                           </span><br><span class="line">                            ;数据指向完成后,初始化一下中断向量表,第[0]个向量表的地址0000:0200</span><br><span class="line">                            mov ax,0</span><br><span class="line">                            mov es,ax</span><br><span class="line">                            mov word ptr es:[7ch*4+0],200h</span><br><span class="line">                            mov word ptr es:[7ch*4+2],0</span><br><span class="line">                            </span><br><span class="line"></span><br><span class="line">                            ret  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                            ;--------------------------------------</span><br><span class="line">                    do7ch:</span><br><span class="line">                            mul ax </span><br><span class="line">                            iret    </span><br><span class="line">                           </span><br><span class="line"></span><br><span class="line">                do7chend:        </span><br><span class="line">                            nop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>



<h3 id="int-7ch-大小写转化"><a href="#int-7ch-大小写转化" class="headerlink" title="int 7ch 大小写转化"></a>int 7ch 大小写转化</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code ,  ss:stack</span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">    db 16 dup(&#x27;0&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:                     </span><br><span class="line">                                mov ax,stack</span><br><span class="line">                                mov ss,ax;</span><br><span class="line">                                mov sp,16</span><br><span class="line">                                </span><br><span class="line">                                </span><br><span class="line">                                ;只是设置一个光标</span><br><span class="line">                                mov ah,2</span><br><span class="line"></span><br><span class="line">                                mov bh,0</span><br><span class="line"></span><br><span class="line">                                mov dh,5</span><br><span class="line">                                mov dl,12</span><br><span class="line"></span><br><span class="line">                                int 10h</span><br><span class="line"></span><br><span class="line">                                ;只修改颜色配置的属性然后输出对应的字符串</span><br><span class="line">                                mov ah,9</span><br><span class="line">                                mov al,&#x27;&amp;&#x27;</span><br><span class="line">                                mov bl,11001010b</span><br><span class="line">                                mov bh,0</span><br><span class="line">                                mov cx,3</span><br><span class="line">                                int 10h</span><br><span class="line"></span><br><span class="line">                                ;call int_7ch</span><br><span class="line">                                </span><br><span class="line">                                mov ax,4c00h</span><br><span class="line">                                int 21h</span><br><span class="line">                                </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">         </span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>



<h3 id="手写实现-int21h的ah-x3D-9"><a href="#手写实现-int21h的ah-x3D-9" class="headerlink" title="手写实现 int21h的ah&#x3D;9"></a>手写实现 int21h的ah&#x3D;9</h3><p>打印字符串的函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code ,  ss:stack ,ds:data</span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">    db 16 dup(&#x27;0&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">data segment</span><br><span class="line">    db &quot;hello! I am Dqx-Gh0st...weclome to my world&quot;,0</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:                     </span><br><span class="line">                                mov ax,stack</span><br><span class="line">                                mov ss,ax </span><br><span class="line">                                mov sp,16</span><br><span class="line">                                </span><br><span class="line">                                call init_do7ch                               </span><br><span class="line">                                ;行号</span><br><span class="line">                                mov dh,10</span><br><span class="line">                                ;列好</span><br><span class="line">                                mov dl,10</span><br><span class="line">                                ;颜色</span><br><span class="line">                                mov cl,11001010b</span><br><span class="line">                                ;数据源</span><br><span class="line">                                mov ax,data</span><br><span class="line">                                mov ds,ax</span><br><span class="line">                                mov si,0</span><br><span class="line">                                </span><br><span class="line">                                int 7ch</span><br><span class="line">                                                             </span><br><span class="line">                                mov ax,4c00h</span><br><span class="line">                                int 21h</span><br><span class="line">                                </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                        init_do7ch:</span><br><span class="line"></span><br><span class="line">                                mov ax,cs</span><br><span class="line">                                mov ds,ax</span><br><span class="line">                                mov si, offset do7ch_start</span><br><span class="line"></span><br><span class="line">                                mov ax,0</span><br><span class="line">                                mov es,ax</span><br><span class="line">                                mov di,200h</span><br><span class="line"></span><br><span class="line">                                mov cx,offset do7ch_end - offset do7ch_start</span><br><span class="line"></span><br><span class="line">                                cld</span><br><span class="line">                                rep movsb</span><br><span class="line"></span><br><span class="line">                                mov word ptr es:[7ch*4+0],200h</span><br><span class="line">                                mov word ptr es:[7ch*4+2],0</span><br><span class="line"></span><br><span class="line">                                ret</span><br><span class="line"></span><br><span class="line">                        do7ch_start:</span><br><span class="line">                                </span><br><span class="line">                                mov ax,0b800h</span><br><span class="line">                                mov es,ax</span><br><span class="line"></span><br><span class="line">                                mov ax,0</span><br><span class="line">                                mov al,160</span><br><span class="line">                                mul dh</span><br><span class="line">                                ;结果放在ax中</span><br><span class="line">                                </span><br><span class="line">                                mov di,ax</span><br><span class="line">                                mov ax,0</span><br><span class="line">                                mov al,2</span><br><span class="line">                                mul dl</span><br><span class="line">                                ;又得到数据放在了ax中</span><br><span class="line">                                add di,ax</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                        s:        </span><br><span class="line">                                push cx</span><br><span class="line">                                mov cx,0</span><br><span class="line">                                mov cl,ds:[si]</span><br><span class="line">                                jcxz retend</span><br><span class="line">                                pop cx;还原那个颜色属性的配置...cl</span><br><span class="line">                                mov ch,ds:[si];再次赋予数据</span><br><span class="line">                                mov byte ptr es:[di+0],ch</span><br><span class="line">                                mov byte ptr es:[di+1],cl</span><br><span class="line"></span><br><span class="line">                                add di,2</span><br><span class="line">                                inc si</span><br><span class="line">                                jmp s</span><br><span class="line"></span><br><span class="line">                        retend:</span><br><span class="line"></span><br><span class="line">                                add sp,2;这里会比较容易的去忘记.....只管跑...东西都忘记了拿</span><br><span class="line">                                iret</span><br><span class="line"></span><br><span class="line">                        do7ch_end:nop</span><br><span class="line">                                 </span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>









<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code ,  ss:stack ,ds:data</span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">    db 16 dup(&#x27;0&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">data segment</span><br><span class="line">    db &quot;123456789&quot;,0</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:                     </span><br><span class="line">                                mov ax,stack</span><br><span class="line">                                mov ss,ax </span><br><span class="line">                                mov sp,16</span><br><span class="line">                                </span><br><span class="line">                                call init_do7ch</span><br><span class="line"></span><br><span class="line">                                mov ax,0b800h</span><br><span class="line">                                mov es,ax</span><br><span class="line">                                mov di,160*12</span><br><span class="line">                                mov bx, offset send - offset s</span><br><span class="line">                                mov cx,10</span><br><span class="line"></span><br><span class="line">                            s:</span><br><span class="line">                                mov byte ptr es:[di+0],&#x27;?&#x27;</span><br><span class="line">                                mov byte ptr es:[di+1],2</span><br><span class="line">                                add di,2</span><br><span class="line">                                int 7ch</span><br><span class="line">                            send:nop                                                          </span><br><span class="line">                                mov ax,4c00h</span><br><span class="line">                                int 21h</span><br><span class="line">                                </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                        init_do7ch:</span><br><span class="line"></span><br><span class="line">                                mov ax,cs</span><br><span class="line">                                mov ds,ax</span><br><span class="line">                                mov si, offset do7ch_start</span><br><span class="line"></span><br><span class="line">                                mov ax,0</span><br><span class="line">                                mov es,ax</span><br><span class="line">                                mov di,200h</span><br><span class="line"></span><br><span class="line">                                mov cx,offset do7ch_end - offset do7ch_start</span><br><span class="line"></span><br><span class="line">                                cld</span><br><span class="line">                                rep movsb</span><br><span class="line"></span><br><span class="line">                                mov word ptr es:[7ch*4+0],200h</span><br><span class="line">                                mov word ptr es:[7ch*4+2],0</span><br><span class="line"></span><br><span class="line">                                ret</span><br><span class="line"></span><br><span class="line">                        do7ch_start:</span><br><span class="line">                                dec cx</span><br><span class="line">                                jcxz retend</span><br><span class="line">                                mov bp,0</span><br><span class="line">                                push bp</span><br><span class="line">                                mov bp,sp</span><br><span class="line">                                sub ss:[bp+2],bx</span><br><span class="line">                                pop bp</span><br><span class="line">                        retend:                             </span><br><span class="line">                                iret</span><br><span class="line"></span><br><span class="line">                        do7ch_end:nop</span><br><span class="line">                                 </span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>





<h3 id="输出4句诗"><a href="#输出4句诗" class="headerlink" title="输出4句诗"></a>输出4句诗</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code ,  ss:stack </span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">    db 16 dup(&#x27;0&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line"></span><br><span class="line">    s1:     db  &quot;Good,better,best&quot;,&#x27;,&#x27;,&#x27;$&#x27;</span><br><span class="line">    s2:     db  &quot;Never let it rest&quot;,&#x27;,&#x27;,&#x27;$&#x27;</span><br><span class="line">    s3:     db  &quot;Till good is bettre&quot;,&#x27;,&#x27;,&#x27;$&#x27;</span><br><span class="line">    s4:     db  &quot;And better ,best.&quot;,&#x27;,&#x27;,&#x27;$&#x27;</span><br><span class="line">    s:      dw   offset s1, offset s2,  offset s3,  offset s4</span><br><span class="line">    row:    db  2,4,6,8</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">start:                     </span><br><span class="line">                                mov ax,stack</span><br><span class="line">                                mov ss,ax </span><br><span class="line">                                mov sp,16</span><br><span class="line">                                </span><br><span class="line"></span><br><span class="line">                                mov ax,cs</span><br><span class="line">                                mov ds,ax</span><br><span class="line">                                mov bx,offset s</span><br><span class="line">                                mov si,offset row</span><br><span class="line">                                mov cx,4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                            ok:</span><br><span class="line">                                mov ah,2;2函数</span><br><span class="line"></span><br><span class="line">                                mov bh,0;0页</span><br><span class="line">                                ;mov dh,byte ptr ds:[si] ;si+=2;第某某行</span><br><span class="line">                                mov dh,cs:[si]</span><br><span class="line">                                mov dl,10                                </span><br><span class="line">                                int 10h</span><br><span class="line"></span><br><span class="line">                                ;mov dx,bx</span><br><span class="line">                                mov dx,cs:[bx]</span><br><span class="line">                                mov ah,9</span><br><span class="line">                                int 21h</span><br><span class="line"></span><br><span class="line">                                add bx,2</span><br><span class="line">                                inc si</span><br><span class="line">                                loop ok</span><br><span class="line"></span><br><span class="line">                                mov ax,4c00h</span><br><span class="line">                                int 21h</span><br><span class="line">                                </span><br><span class="line">                                mov ax,4c00h</span><br><span class="line">                                int 21h</span><br><span class="line">                                 </span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>





<h3 id="用int9打印一首五颜六色的情诗"><a href="#用int9打印一首五颜六色的情诗" class="headerlink" title="用int9打印一首五颜六色的情诗"></a>用int9打印一首五颜六色的情诗</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code,ss:stack,ds:data</span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">  db 32 dup(&#x27;S&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">data segment</span><br><span class="line">      db 16 dup(&#x27;D&#x27;)</span><br><span class="line">      db &quot;How do I love you? Let me count the ways.&quot;,0</span><br><span class="line">      db &quot;I love you to the depth and breath and height.&quot;,0</span><br><span class="line">      db &quot;My soul can reach ,when feeling out sight.&quot;,0</span><br><span class="line">      db &quot;For the ends of being and ideal Grace.&quot;,0</span><br><span class="line">      db &quot;I love you to the level of ideal everyday&#x27;s.&quot;,0</span><br><span class="line">      db &quot;Most quiet need,by sun and candlelight.&quot;,0</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">row:  db 10,11,12,13,14,15</span><br><span class="line">start:</span><br><span class="line">                                    mov ax,data</span><br><span class="line">                                    mov ds,ax</span><br><span class="line">                                    </span><br><span class="line">                                    mov ax,stack</span><br><span class="line">                                    mov ss,ax</span><br><span class="line">                                    mov sp,32</span><br><span class="line"></span><br><span class="line">                                    mov ax,0b800h</span><br><span class="line">                                    mov es,ax  </span><br><span class="line">                                  ;---------------------------------------</span><br><span class="line">                                    call init_9h</span><br><span class="line">                                  ;---------------------------------------  </span><br><span class="line">                                    mov cx,6;有6句诗</span><br><span class="line">                                    mov si,16;si指向字符串开始位置</span><br><span class="line">                                    mov bx,offset row;记住bx指针,而不是指向的值</span><br><span class="line">                                    mov dh,2;它是颜色,因为dx很少用,避免冲突,我们就取dx</span><br><span class="line"></span><br><span class="line">                                  ;--------------------------------============ </span><br><span class="line">                              k:      </span><br><span class="line">                                    call show_str;</span><br><span class="line">                                    loop k</span><br><span class="line">                                  ;----------------把键盘的控制权还给int9  </span><br><span class="line"></span><br><span class="line">                                    mov ax,0</span><br><span class="line">                                    mov es,ax</span><br><span class="line">                                    </span><br><span class="line">                                    push ds:[0]</span><br><span class="line">                                    pop es:[9*4+0]</span><br><span class="line">                                    push ds:[2]</span><br><span class="line">                                    pop es:[9*4+2]</span><br><span class="line">                                  ;------------------------------------</span><br><span class="line">                                    mov ax,4c00h</span><br><span class="line">                                    int 21h</span><br><span class="line">                                </span><br><span class="line"></span><br><span class="line">                        init_9h:    </span><br><span class="line">                                    ;修改的位置指向0000:9*4</span><br><span class="line">                                    push es</span><br><span class="line">                                    mov ax,0</span><br><span class="line">                                    mov es,ax</span><br><span class="line"></span><br><span class="line">                                    ;保存一下以前的int9,后面我们还要调用</span><br><span class="line">                                    push es:[9*4+0]</span><br><span class="line">                                    pop  ds:[0]</span><br><span class="line">                                    push es:[9*4+2]</span><br><span class="line">                                    pop ds:[2]</span><br><span class="line">                                    ;DIY一下int9,让它的中断向量表发生一些变化</span><br><span class="line">                                    mov word ptr es:[9*4+0],offset start_9h</span><br><span class="line">                                    mov es:[9*4+2],cs</span><br><span class="line"></span><br><span class="line">                                    pop es</span><br><span class="line">                                    ret</span><br><span class="line"></span><br><span class="line">                                  ;DIY的int9长这样</span><br><span class="line">                        start_9h:</span><br><span class="line">                                    in al,60h;呼叫端口,我们的键入都在端口那里,al接收了我们的键入</span><br><span class="line">                                    pushf;模拟int9的入栈</span><br><span class="line">                                    call dword ptr ds:[0];模拟int9的入栈</span><br><span class="line">                                    cmp al,48h;如果键入是 ↑</span><br><span class="line">                                    jne start_9h_end;不是就退出</span><br><span class="line">                                    inc dh;就修改颜色</span><br><span class="line">                        start_9h_end:</span><br><span class="line">                                    iret   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                        show_str:</span><br><span class="line">                                    mov al,160;每一行160</span><br><span class="line">                                    mul byte ptr cs:[bx];每一行x那个行数,bx是指针,bx+=2</span><br><span class="line">                                    mov di,ax;然目的地址接收结果</span><br><span class="line">                                    add di,20*2;指向20列</span><br><span class="line">                show_str_sontinue:                                           </span><br><span class="line">                                    mov dl,ds:[si];si指针指针指向了字符串</span><br><span class="line">                                    cmp dl,0;如果是0,就退出,然后+1,跳过0,指向下一个字符串</span><br><span class="line">                                    je show_end</span><br><span class="line">                                    call delay;缓冲一下</span><br><span class="line">                                    mov es:[di],dx</span><br><span class="line">                                    add di,2;指向下一个像素</span><br><span class="line">                                    inc si;指向下一个字符</span><br><span class="line">                                    jmp show_str_sontinue;继续循环</span><br><span class="line"></span><br><span class="line">                        show_end:   inc bx;指向下一行</span><br><span class="line">                                    inc si;跳过0</span><br><span class="line">                                    ret</span><br><span class="line"></span><br><span class="line">                        delay:</span><br><span class="line">                                    push ax</span><br><span class="line">                                    push bx</span><br><span class="line">                                    mov ax,0</span><br><span class="line">                                    mov bx,01h</span><br><span class="line">                      delay_continue:            </span><br><span class="line">                                    sub ax,1</span><br><span class="line">                                    sbb bx,0</span><br><span class="line">                                    cmp ax,0</span><br><span class="line">                                    jne delay_continue</span><br><span class="line">                                    cmp bx,0</span><br><span class="line">                                    jne delay_continue</span><br><span class="line"></span><br><span class="line">                                    pop bx</span><br><span class="line">                                    pop ax</span><br><span class="line">                                    ret</span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start      </span><br></pre></td></tr></table></figure>



<h3 id="在代码据放data-segment的坏处"><a href="#在代码据放data-segment的坏处" class="headerlink" title="在代码据放data segment的坏处"></a>在代码据放data segment的坏处</h3><p>好处?</p>
<p>就是寻址很方便,因为代码区,你可以用指令<code>offset</code>来寻址,</p>
<p>但就问题就存在</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mov bx,offset s1</span><br><span class="line">mov si,offset s2</span><br><span class="line">...</span><br><span class="line">mov dx,cs:[bx]</span><br><span class="line">...</span><br><span class="line">mov dh,cs:[si]</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>可以在上面看到其实也没啥&#x2F;…</p>
<p>但是cs:[<del>],你&#96;</del><code>只能用</code>纯数字,bx寄存器,ip,si,di&#96;,,…si,di有重要的用途,,,,,ip无法用…..bx有太少</p>
<h3 id="安装DIY的int9中断-然后运行-可以修改屏幕的颜色"><a href="#安装DIY的int9中断-然后运行-可以修改屏幕的颜色" class="headerlink" title="安装DIY的int9中断,然后运行,,,可以修改屏幕的颜色"></a>安装DIY的int9中断,然后运行,,,可以修改屏幕的颜色</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code,ss:stack</span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">  db 32 dup(&#x27;S&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">                                   </span><br><span class="line">                                    mov ax,stack</span><br><span class="line">                                    mov ss,ax</span><br><span class="line">                                    mov sp,32</span><br><span class="line"></span><br><span class="line">                                    push cs</span><br><span class="line">                                    pop  ds</span><br><span class="line">                                    mov  si,offset int9</span><br><span class="line"></span><br><span class="line">                                    mov ax,0</span><br><span class="line">                                    mov es,ax</span><br><span class="line">                                    mov di,204h</span><br><span class="line"> </span><br><span class="line">                                    mov cx,offset int9_end - offset int9</span><br><span class="line"></span><br><span class="line">                                    cld</span><br><span class="line">                                    rep movsb</span><br><span class="line"></span><br><span class="line">                                    push es:[9*4+0]</span><br><span class="line">                                    pop  es:[200h+0]</span><br><span class="line">                                    push es:[9*4+2]</span><br><span class="line">                                    pop  es:[200h+2]</span><br><span class="line"></span><br><span class="line">                                    cli</span><br><span class="line">                                    mov word ptr es:[9*4+0],204h</span><br><span class="line">                                    mov word ptr es:[9*4+2],0</span><br><span class="line">                                    sti</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                                    mov ax,4c00h</span><br><span class="line">                                    int 21h</span><br><span class="line"></span><br><span class="line">                           int9:</span><br><span class="line">                                    push ax</span><br><span class="line">                                    push bx</span><br><span class="line">                                    push cx</span><br><span class="line">                                    push es</span><br><span class="line"></span><br><span class="line">                                    in al,60h</span><br><span class="line">                                    pushf</span><br><span class="line">                                    call dword ptr cs:[200h];调用int 9的中断</span><br><span class="line"></span><br><span class="line">                                    cmp al,48h;F1--&gt;3bh         </span><br><span class="line">                                    jne int9ret</span><br><span class="line"></span><br><span class="line">                                    mov ax,0b800h</span><br><span class="line">                                    mov es,ax</span><br><span class="line">                                    mov bx,1</span><br><span class="line">                                    mov cx,2000</span><br><span class="line">                                s:</span><br><span class="line">                                    inc byte ptr es:[bx]</span><br><span class="line">                                    add bx,2</span><br><span class="line">                                    loop s</span><br><span class="line"></span><br><span class="line">                          int9ret:  </span><br><span class="line">                                     pop es</span><br><span class="line">                                     pop cx</span><br><span class="line">                                     pop bx</span><br><span class="line">                                     pop ax</span><br><span class="line">                                     iret</span><br><span class="line">                          int9_end:  nop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start      </span><br></pre></td></tr></table></figure>



<p>运行之后你就可以按一下</p>
<h3 id="自己写了一遍-发现了很多的问题"><a href="#自己写了一遍-发现了很多的问题" class="headerlink" title="自己写了一遍..发现了很多的问题"></a>自己写了一遍..发现了很多的问题</h3><p>①. 程序没有不接收.你没有<code>mov ax,4c00h;int 21h</code></p>
<p>②. 对原有的中断向量表做了保存却不去修改原有的向量表</p>
<p>③. 我们是先键入,再调用int9去</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code,ss:stack,ds:data</span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">  db 128 dup(&#x27;S&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">data segment</span><br><span class="line">  db 128 dup(&#x27;D&#x27;)</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">                                   </span><br><span class="line">                                    mov ax,stack</span><br><span class="line">                                    mov ss,ax </span><br><span class="line">                                    mov sp,128</span><br><span class="line"></span><br><span class="line">                                    mov ax,cs</span><br><span class="line">                                    mov ds,ax</span><br><span class="line">                                    mov si,offset init_int9</span><br><span class="line"></span><br><span class="line">                                    mov ax,0</span><br><span class="line">                                    mov es,ax</span><br><span class="line">                                    mov di,204h</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                                    mov cx , offset init_int9_end - offset init_int9                                  </span><br><span class="line">                                    cld</span><br><span class="line">                                    rep movsb</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                                    push es:[9*4+0] </span><br><span class="line">                                    pop  es:[200h+0]</span><br><span class="line">                                    push es:[9*4+2]</span><br><span class="line">                                    pop  es:[200h+2] </span><br><span class="line">                                    </span><br><span class="line"></span><br><span class="line">                                    cli </span><br><span class="line">                                    mov word ptr es:[9*4],204h</span><br><span class="line">                                    mov word ptr es:[9*4+2],0</span><br><span class="line">                                    sti</span><br><span class="line"></span><br><span class="line">                                    mov ax,4c00h</span><br><span class="line">                                    int 21h</span><br><span class="line">                                  </span><br><span class="line">                          init_int9:</span><br><span class="line">                                    push ax</span><br><span class="line">                                    push es</span><br><span class="line">                                    push bx</span><br><span class="line">                                    push cx</span><br><span class="line">                                    </span><br><span class="line">                                    in al,60h</span><br><span class="line">                              </span><br><span class="line">                                    ;是先发生键入,再调用外中断</span><br><span class="line">                                    pushf</span><br><span class="line">                                    call dword ptr cs:[200h];这里有个问题,如果mov ax,0 mov ds,ax  call word ptr ds:[200h]就没有用</span><br><span class="line"></span><br><span class="line">                                    cmp al,48h</span><br><span class="line">                                    jne int9_ret</span><br><span class="line"></span><br><span class="line">                                    mov ax,0b800h</span><br><span class="line">                                    mov es,ax</span><br><span class="line">                                    mov bx,1</span><br><span class="line">                                    mov cx,2000</span><br><span class="line">                    change_screen: </span><br><span class="line">                                    inc byte ptr es:[bx]</span><br><span class="line">                                    add bx,2</span><br><span class="line">                                    loop change_screen            </span><br><span class="line">                                    </span><br><span class="line">                          int9_ret:</span><br><span class="line">                                    pop cx</span><br><span class="line">                                    pop bx</span><br><span class="line">                                    pop es</span><br><span class="line">                                    pop ax</span><br><span class="line">                                    iret     </span><br><span class="line">                          init_int9_end:nop         </span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start      </span><br></pre></td></tr></table></figure>



<p>教材实验</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code,ss:stack</span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">  db 32 dup(&#x27;S&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line">                                   </span><br><span class="line">                                    mov ax,stack</span><br><span class="line">                                    mov ss,ax</span><br><span class="line">                                    mov sp,32</span><br><span class="line"></span><br><span class="line">                                    push cs</span><br><span class="line">                                    pop  ds</span><br><span class="line">                                    mov  si,offset int9</span><br><span class="line"></span><br><span class="line">                                    mov ax,0</span><br><span class="line">                                    mov es,ax</span><br><span class="line">                                    mov di,204h</span><br><span class="line"> </span><br><span class="line">                                    mov cx,offset int9_end - offset int9</span><br><span class="line"></span><br><span class="line">                                    cld</span><br><span class="line">                                    rep movsb</span><br><span class="line"></span><br><span class="line">                                    push es:[9*4+0]</span><br><span class="line">                                    pop  es:[200h+0]</span><br><span class="line">                                    push es:[9*4+2]</span><br><span class="line">                                    pop  es:[200h+2]</span><br><span class="line"></span><br><span class="line">                                    cli</span><br><span class="line">                                    mov word ptr es:[9*4+0],204h</span><br><span class="line">                                    mov word ptr es:[9*4+2],0</span><br><span class="line">                                    sti</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                                    mov ax,4c00h</span><br><span class="line">                                    int 21h</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                           int9:</span><br><span class="line">                                    push ax</span><br><span class="line">                                    push bx</span><br><span class="line">                                    push cx</span><br><span class="line">                                    push es</span><br><span class="line"></span><br><span class="line">                                    ;in al,60h</span><br><span class="line">                                    ;pushf</span><br><span class="line">                                    ;call dword ptr cs:[200h];调用int 9的中断</span><br><span class="line"></span><br><span class="line">                                    ;cmp al,3bh;F1--&gt;3bh         </span><br><span class="line">                                    ;jne int9ret</span><br><span class="line">                                    ;它探测的是你的断码..不是同码....因此就不用再去2次call int9</span><br><span class="line"></span><br><span class="line">                                    in al,60h</span><br><span class="line">                                    pushf</span><br><span class="line">                                    call dword ptr cs:[200h]</span><br><span class="line">                                    cmp al,3bh+80h</span><br><span class="line">                                    jne int9ret</span><br><span class="line">                              show:      </span><br><span class="line">                                    mov ax,0b800h</span><br><span class="line">                                    mov es,ax</span><br><span class="line">                                    mov bx,1</span><br><span class="line">                                    mov cx,1000</span><br><span class="line">                                s:</span><br><span class="line">                                    inc byte ptr es:[bx]</span><br><span class="line">                                    mov byte ptr es:[bx-1],&#x27;?&#x27;</span><br><span class="line">                                    add bx,2</span><br><span class="line">                                    loop s</span><br><span class="line"></span><br><span class="line">                          int9ret:  </span><br><span class="line">                                     pop es</span><br><span class="line">                                     pop cx</span><br><span class="line">                                     pop bx</span><br><span class="line">                                     pop ax</span><br><span class="line">                                     iret</span><br><span class="line">                          int9_end:  nop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start      </span><br></pre></td></tr></table></figure>



<h3 id="DIY中断安装-执行4个函数的功能"><a href="#DIY中断安装-执行4个函数的功能" class="headerlink" title="DIY中断安装,执行4个函数的功能"></a>DIY中断安装,执行4个函数的功能</h3><p>出了很多的错</p>
<p>还是那些问题</p>
<p>①.</p>
<p>对整个代码的思路不是很清晰….老师写了一半发现自己写乱了..思路不明确</p>
<p>②.</p>
<p>提取了原有的中断到一定的位置去,却不修改原有的中断&#x3D;&#x3D;没有修改中断</p>
<p>③.</p>
<p>call far ptr但是错用ret..导致堆栈错误….不平衡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code,ss:stack,ds:data</span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">    db 32 dup(&#x27;S&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">data segment</span><br><span class="line">    db 32 dup(&#x27;D&#x27;)</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:                                     </span><br><span class="line">                                        mov ax,stack</span><br><span class="line">                                        mov ss,ax</span><br><span class="line">                                        ;对整个代码的思路不是很清晰….老师写了一半发现自己写乱了..思路不明确</span><br><span class="line">                                        call init_int9</span><br><span class="line"></span><br><span class="line">                                        mov ax,4c00h</span><br><span class="line">                                        int 21h    </span><br><span class="line"></span><br><span class="line">                                init_int9:</span><br><span class="line">                                        mov ax,0</span><br><span class="line">                                        mov ds,ax</span><br><span class="line"></span><br><span class="line">                                        push ds:[4*9+0]</span><br><span class="line">                                        pop  ds:[200h]</span><br><span class="line">                                        push ds:[4*9+2]</span><br><span class="line">                                        pop  ds:[202h]</span><br><span class="line"></span><br><span class="line">										;提取了原有的中断到一定的位置去,却不修改原有的中断==没有修改中断</span><br><span class="line">                                        cli</span><br><span class="line">                                        mov word ptr ds:[4*9+0],200h </span><br><span class="line">                                        mov word ptr ds:[4*9+2],0</span><br><span class="line">                                        sti</span><br><span class="line">                                        </span><br><span class="line">                                        ;源地址</span><br><span class="line">                                        push cs</span><br><span class="line">                                        pop ds</span><br><span class="line">                                        mov si,offset copy_start</span><br><span class="line">										;目的地址</span><br><span class="line">                                        mov ax,0</span><br><span class="line">                                        mov es,ax</span><br><span class="line">                                        mov di,204h</span><br><span class="line">										;循环次数</span><br><span class="line">                                        mov cx,offset copy_end - offset copy_start</span><br><span class="line"></span><br><span class="line">                                        cld</span><br><span class="line">                                        rep movsb                                     </span><br><span class="line">                                        ret</span><br><span class="line">                                </span><br><span class="line">                                copy_start:</span><br><span class="line">                                            ;担心害怕就把所有的寄存器给备份</span><br><span class="line">                                            pushf</span><br><span class="line">                                            push ax</span><br><span class="line">                                            push bx</span><br><span class="line">                                            push cx</span><br><span class="line">                                            push dx</span><br><span class="line">                                            push ds</span><br><span class="line">                                            push si</span><br><span class="line">                                            push es</span><br><span class="line">                                            push di</span><br><span class="line"></span><br><span class="line">											;获取扫描码</span><br><span class="line">                                            in al,60h</span><br><span class="line"></span><br><span class="line">                                            pushf</span><br><span class="line">                                            call dword ptr cs:[200h]</span><br><span class="line"></span><br><span class="line">                                            cmp al,2h;把扫描码与通码比较</span><br><span class="line">                                            je  set0</span><br><span class="line"></span><br><span class="line">                                            cmp al,3h;</span><br><span class="line">                                            je  set1</span><br><span class="line"></span><br><span class="line">                                            cmp al,4h;2</span><br><span class="line">                                            je  set2</span><br><span class="line"></span><br><span class="line">                                            cmp al,5h;3</span><br><span class="line">                                            je  set3</span><br><span class="line"></span><br><span class="line">                                            jmp real_ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                                    set0:   mov ah,0</span><br><span class="line">                                            jmp do9_ret</span><br><span class="line">                                    set1:   mov ah,1</span><br><span class="line">                                            jmp do9_ret</span><br><span class="line">                                    set2:   mov ah,2</span><br><span class="line">                                            jmp do9_ret</span><br><span class="line">                                    set3:   mov ah,3</span><br><span class="line">                                            jmp do9_ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                                    do9_ret:</span><br><span class="line">                                            call setscreen</span><br><span class="line">                                            ;call far ptr但是错用ret..导致堆栈错误….不平衡</span><br><span class="line">                                    real_ret:</span><br><span class="line">                    </span><br><span class="line">                                            pop di</span><br><span class="line">                                            pop es</span><br><span class="line">                                            pop si</span><br><span class="line">                                            pop ds</span><br><span class="line">                                            pop dx</span><br><span class="line">                                            pop cx</span><br><span class="line">                                            pop bx</span><br><span class="line">                                            pop ax</span><br><span class="line">                                            popf</span><br><span class="line"></span><br><span class="line">                                            iret</span><br><span class="line"></span><br><span class="line">                                        ;做一个屏幕的清理 ------------------ </span><br><span class="line">                                        ;初始会配置</span><br><span class="line">                                        setscreen:</span><br><span class="line">                                            push ax</span><br><span class="line"></span><br><span class="line">                                            cmp ah,0</span><br><span class="line">                                            je do1</span><br><span class="line">                                            cmp ah,1</span><br><span class="line">                                            je do2</span><br><span class="line">                                            cmp ah,2</span><br><span class="line">                                            je do3</span><br><span class="line">                                            cmp ah,3</span><br><span class="line">                                            je do4  </span><br><span class="line">                                            jmp sret</span><br><span class="line"></span><br><span class="line">                                        do1:</span><br><span class="line">                                            call sub1</span><br><span class="line">                                            jmp short sret</span><br><span class="line">                                        do2:</span><br><span class="line">                                            call sub2</span><br><span class="line">                                            jmp short sret</span><br><span class="line">                                        do3:</span><br><span class="line">                                            call sub3</span><br><span class="line">                                            jmp short sret</span><br><span class="line">                                        do4:</span><br><span class="line">                                            call sub4</span><br><span class="line">                                            jmp short sret</span><br><span class="line">                                        sret:</span><br><span class="line"></span><br><span class="line">                                            pop ax</span><br><span class="line">                                            ret </span><br><span class="line"></span><br><span class="line">                                        sub1:</span><br><span class="line">                                            push bx</span><br><span class="line">                                            push cx</span><br><span class="line">                                            push es</span><br><span class="line"></span><br><span class="line">                                            mov bx,0b800h</span><br><span class="line">                                            mov es,bx</span><br><span class="line">                                            mov bx,0</span><br><span class="line">                                            mov cx,2000</span><br><span class="line">                                        subls:</span><br><span class="line">                                            mov byte ptr es:[bx],&#x27; &#x27;</span><br><span class="line">                                            mov byte ptr es:[bx+1],0</span><br><span class="line">                                            add bx,2</span><br><span class="line"></span><br><span class="line">                                            loop subls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                                            pop es</span><br><span class="line">                                            pop cx</span><br><span class="line">                                            pop bx</span><br><span class="line">                                            ret </span><br><span class="line">                                        ;设置前景色-------------------</span><br><span class="line">                                        sub2:</span><br><span class="line">                                            push bx</span><br><span class="line">                                            push cx</span><br><span class="line">                                            push es</span><br><span class="line">                                            push ax</span><br><span class="line"></span><br><span class="line">                                            mov bx,0b800h</span><br><span class="line">                                            mov es,bx</span><br><span class="line"></span><br><span class="line">                                            mov bx,1</span><br><span class="line"></span><br><span class="line">                                            mov cx,2000</span><br><span class="line"></span><br><span class="line">                                        sub2s:</span><br><span class="line">                                            push cx</span><br><span class="line">                                            mov al,byte ptr es:[bx]   </span><br><span class="line">                                            mov ah,al                                  </span><br><span class="line">                                            mov cl,4</span><br><span class="line"></span><br><span class="line">                                            ;头4位</span><br><span class="line">                                            shr al,cl</span><br><span class="line">                                            inc al</span><br><span class="line">                                            shl al,cl</span><br><span class="line"></span><br><span class="line">                                            shl ah,cl</span><br><span class="line">                                            shr ah,cl</span><br><span class="line"></span><br><span class="line">                                            or al,ah</span><br><span class="line"></span><br><span class="line">                                            mov byte ptr es:[bx],al</span><br><span class="line">                                            add bx,2</span><br><span class="line">                                            pop cx</span><br><span class="line">                                            loop sub2s</span><br><span class="line"></span><br><span class="line">                                            pop ax</span><br><span class="line">                                            pop es</span><br><span class="line">                                            pop cx</span><br><span class="line">                                            pop bx</span><br><span class="line">                                            ret </span><br><span class="line">                                            ;设置背景色----------------------------</span><br><span class="line">                                        sub3:</span><br><span class="line">                                            push bx</span><br><span class="line">                                            push cx</span><br><span class="line">                                            push es</span><br><span class="line">                                            push ax</span><br><span class="line"></span><br><span class="line">                                            mov bx,0b800h</span><br><span class="line">                                            mov es,bx</span><br><span class="line"></span><br><span class="line">                                            mov bx,1</span><br><span class="line"></span><br><span class="line">                                            mov cx,2000</span><br><span class="line"></span><br><span class="line">                                        sub3s:</span><br><span class="line">                                            push cx</span><br><span class="line"></span><br><span class="line">                                            mov al,byte ptr es:[bx]</span><br><span class="line">                                            mov ah,al</span><br><span class="line"></span><br><span class="line">                                            mov cl,4</span><br><span class="line">                                            ;后4位</span><br><span class="line">                                            ;我是u怎么发现问题的????</span><br><span class="line">                                            ;还是对位运算不理解呀....</span><br><span class="line">                                            shl al,cl</span><br><span class="line">                                            shr al,cl                                          </span><br><span class="line">                                            inc al</span><br><span class="line">                                            </span><br><span class="line">                                            shr ah,cl</span><br><span class="line">                                            shl ah,cl</span><br><span class="line"></span><br><span class="line">                                            or al,ah</span><br><span class="line">                                            ;mov al,11001010b;我是怎么发现问题的?????对里面的参数去做修改,然后看发生了什么变化</span><br><span class="line">                                            mov byte ptr es:[bx],al</span><br><span class="line">                                            add bx,2</span><br><span class="line">                                            pop cx</span><br><span class="line">                                            loop sub3s</span><br><span class="line"></span><br><span class="line">                                            pop ax</span><br><span class="line">                                            pop es</span><br><span class="line">                                            pop cx</span><br><span class="line">                                            pop bx</span><br><span class="line">                                            ret </span><br><span class="line">                                        sub4:</span><br><span class="line">                                            push cx</span><br><span class="line">                                            push si</span><br><span class="line">                                            push di</span><br><span class="line">                                            push es</span><br><span class="line">                                            push ds</span><br><span class="line">                                            </span><br><span class="line">                                            mov si,0b800h</span><br><span class="line">                                            mov es,si</span><br><span class="line">                                            mov ds,si</span><br><span class="line">                                            mov si,160;指向[1]第二行</span><br><span class="line">                                            mov di,0;指向[0]第一行</span><br><span class="line">                                            cld</span><br><span class="line">                                            mov cx,24;指向[24]最后一行</span><br><span class="line"></span><br><span class="line">                                            ;处理1行来上移</span><br><span class="line">                                        sub4s:</span><br><span class="line">                                            push cx</span><br><span class="line">                                            mov cx,160</span><br><span class="line">                                            rep movsb</span><br><span class="line">                                            pop cx</span><br><span class="line">                                            loop sub4s</span><br><span class="line">                                            mov cx,80</span><br><span class="line">                                            mov si,0</span><br><span class="line">                                            ;最后一行置空</span><br><span class="line">                                        sub4s1:</span><br><span class="line">                                            mov byte ptr [160*24+si],&#x27;?&#x27;</span><br><span class="line">                                            mov byte ptr [160*24+si+1],0</span><br><span class="line">                                            add si,2</span><br><span class="line">                                            loop sub4s1</span><br><span class="line"></span><br><span class="line">                                            pop ds</span><br><span class="line">                                            pop es</span><br><span class="line">                                            pop di</span><br><span class="line">                                            pop si</span><br><span class="line">                                            pop cx</span><br><span class="line">                                            ret                                              </span><br><span class="line">                            copy_end:       nop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>



<p>如何让做到inc每个配置??????????????</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br></pre></td><td class="code"><pre><span class="line">assume cs:code,ss:stack,ds:data</span><br><span class="line"></span><br><span class="line">stack segment</span><br><span class="line">    db 32 dup(&#x27;S&#x27;)</span><br><span class="line">stack ends</span><br><span class="line"></span><br><span class="line">data segment</span><br><span class="line">    db 32 dup(&#x27;D&#x27;)</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:                                     </span><br><span class="line">                                        mov ax,stack</span><br><span class="line">                                        mov ss,ax</span><br><span class="line"></span><br><span class="line">                                        call init_int9</span><br><span class="line"></span><br><span class="line">                                        mov ax,4c00h</span><br><span class="line">                                        int 21h    </span><br><span class="line"></span><br><span class="line">                                init_int9:</span><br><span class="line">                                        mov ax,0</span><br><span class="line">                                        mov ds,ax</span><br><span class="line"></span><br><span class="line">                                        push ds:[4*9+0]</span><br><span class="line">                                        pop  ds:[200h]</span><br><span class="line">                                        push ds:[4*9+2]</span><br><span class="line">                                        pop  ds:[202h]</span><br><span class="line"></span><br><span class="line">										;错误②</span><br><span class="line">                                        cli</span><br><span class="line">                                        mov word ptr ds:[4*9+0],200h </span><br><span class="line">                                        mov word ptr ds:[4*9+2],0</span><br><span class="line">                                        sti</span><br><span class="line">                                        </span><br><span class="line">                                        ;源地址</span><br><span class="line">                                        push cs</span><br><span class="line">                                        pop ds</span><br><span class="line">                                        mov si,offset copy_start</span><br><span class="line">										;目的地址</span><br><span class="line">                                        mov ax,0</span><br><span class="line">                                        mov es,ax</span><br><span class="line">                                        mov di,204h</span><br><span class="line">										;循环次数</span><br><span class="line">                                        mov cx,offset copy_end - offset copy_start</span><br><span class="line"></span><br><span class="line">                                        cld</span><br><span class="line">                                        rep movsb                                     </span><br><span class="line">                                        ret</span><br><span class="line">                                </span><br><span class="line">                                copy_start:</span><br><span class="line">                                			;担心害怕就把所有的寄存器给备份</span><br><span class="line">                                			pushf</span><br><span class="line">                                            push ax</span><br><span class="line">                                            push bx</span><br><span class="line">                                            push cx</span><br><span class="line">                                            push dx</span><br><span class="line">                                            push ds</span><br><span class="line">                                            push si</span><br><span class="line">                                            push es</span><br><span class="line">                                            push di</span><br><span class="line">											;获取扫描码</span><br><span class="line">                                            in al,60h</span><br><span class="line">                                            pushf</span><br><span class="line">                                            call dword ptr cs:[200h]</span><br><span class="line"></span><br><span class="line">                                            cmp al,2;把扫描码与通码比较</span><br><span class="line">                                            je  set0</span><br><span class="line"></span><br><span class="line">                                            cmp al,3;</span><br><span class="line">                                            je  set1</span><br><span class="line"></span><br><span class="line">                                            cmp al,4;2</span><br><span class="line">                                            je  set2</span><br><span class="line"></span><br><span class="line">                                            cmp al,5;3</span><br><span class="line">                                            je  set3</span><br><span class="line"></span><br><span class="line">                                            jmp real_ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                                    set0:   mov ah,0</span><br><span class="line">                                            jmp do9_ret</span><br><span class="line">                                    set1:   mov ah,1</span><br><span class="line">                                            ;mov al,00000010b</span><br><span class="line">                                            jmp do9_ret</span><br><span class="line">                                    set2:   mov ah,2</span><br><span class="line">                                            ;mov al,10100000b</span><br><span class="line">                                            jmp do9_ret</span><br><span class="line">                                    set3:   mov ah,2</span><br><span class="line">                                            jmp do9_ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                                    do9_ret:</span><br><span class="line">                                            call setscreen</span><br><span class="line">                                    real_ret:</span><br><span class="line">                    </span><br><span class="line">                                            pop di</span><br><span class="line">                                            pop es</span><br><span class="line">                                            pop si</span><br><span class="line">                                            pop ds</span><br><span class="line">                                            pop dx</span><br><span class="line">                                            pop cx</span><br><span class="line">                                            pop bx</span><br><span class="line">                                            pop ax</span><br><span class="line">                                            popf</span><br><span class="line"></span><br><span class="line">                                            iret</span><br><span class="line"></span><br><span class="line">                                        ;做一个屏幕的清理 ------------------ </span><br><span class="line">                                        ;初始会配置</span><br><span class="line">                                        setscreen:</span><br><span class="line">                                            cmp ah,0</span><br><span class="line">                                            je do1</span><br><span class="line">                                            cmp ah,1</span><br><span class="line">                                            je do2</span><br><span class="line">                                            cmp ah,2</span><br><span class="line">                                            je do3</span><br><span class="line">                                            cmp ah,3</span><br><span class="line">                                            je do4  </span><br><span class="line">                                            jmp sret</span><br><span class="line"></span><br><span class="line">                                        do1:</span><br><span class="line">                                            call sub1</span><br><span class="line">                                            jmp short sret</span><br><span class="line">                                        do2:</span><br><span class="line">                                            call sub2</span><br><span class="line">                                            jmp short sret</span><br><span class="line">                                        do3:</span><br><span class="line">                                            call sub3</span><br><span class="line">                                            jmp short sret</span><br><span class="line">                                        do4:</span><br><span class="line">                                            call sub4</span><br><span class="line">                                        sret:</span><br><span class="line">                                            ret </span><br><span class="line"></span><br><span class="line">                                        sub1:</span><br><span class="line">                                            push bx</span><br><span class="line">                                            push cx</span><br><span class="line">                                            push es</span><br><span class="line">                                            mov bx,0b800h</span><br><span class="line">                                            mov es,bx</span><br><span class="line">                                            mov bx,0</span><br><span class="line">                                            mov cx,2000</span><br><span class="line">                                        subls:</span><br><span class="line">                                            mov byte ptr es:[bx],&#x27; &#x27;</span><br><span class="line">                                            or  byte ptr es:[bx+1],0</span><br><span class="line">                                            add bx,2</span><br><span class="line"></span><br><span class="line">                                            loop subls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                                            pop es</span><br><span class="line">                                            pop cx</span><br><span class="line">                                            pop bx</span><br><span class="line">                                            ret </span><br><span class="line">                                        ;设置前景色-------------------</span><br><span class="line">                                        sub2:</span><br><span class="line">                                            push bx</span><br><span class="line">                                            push cx</span><br><span class="line">                                            push es</span><br><span class="line">                                            push ax</span><br><span class="line"></span><br><span class="line">                                            mov bx,0b800h</span><br><span class="line">                                            mov es,bx</span><br><span class="line">                                            mov bx,1</span><br><span class="line">                                            mov cx,2000</span><br><span class="line">                                        sub2s:</span><br><span class="line">                                            push cx</span><br><span class="line">                                            mov al,byte ptr es:[bx]   </span><br><span class="line">                                            mov ah,al                                  </span><br><span class="line">                                            mov cl,4</span><br><span class="line"></span><br><span class="line">                                            ;头4位</span><br><span class="line">                                            shr al,cl</span><br><span class="line">                                            inc al</span><br><span class="line">                                            shl al,cl</span><br><span class="line"></span><br><span class="line">                                            shl ah,cl</span><br><span class="line">                                            shr ah,cl</span><br><span class="line"></span><br><span class="line">                                            or al,ah</span><br><span class="line"></span><br><span class="line">                                            mov byte ptr es:[bx],al</span><br><span class="line">                                            add bx,2</span><br><span class="line">                                            pop cx</span><br><span class="line">                                            loop sub2s</span><br><span class="line"></span><br><span class="line">                                            pop ax</span><br><span class="line">                                            pop es</span><br><span class="line">                                            pop cx</span><br><span class="line">                                            pop bx</span><br><span class="line">                                            ret </span><br><span class="line">                                            ;设置背景色----------------------------</span><br><span class="line">                                        sub3:</span><br><span class="line">                                            push bx</span><br><span class="line">                                            push cx</span><br><span class="line">                                            push es</span><br><span class="line">                                            push ax</span><br><span class="line"></span><br><span class="line">                                            mov bx,0b800h</span><br><span class="line">                                            mov es,bx</span><br><span class="line">                                            mov bx,1</span><br><span class="line">                                            mov cx,2000</span><br><span class="line"></span><br><span class="line">                                        sub3s:</span><br><span class="line">                                            push cx</span><br><span class="line">                                            mov al,byte ptr es:[bx]</span><br><span class="line">                                            mov ah,al</span><br><span class="line">                                            mov cl,4</span><br><span class="line">                                            ;后4位</span><br><span class="line">                                            shl al,cl</span><br><span class="line">                                            inc al</span><br><span class="line">                                            shr al,cl</span><br><span class="line"></span><br><span class="line">                                            shr ah,cl</span><br><span class="line">                                            shl ah,cl</span><br><span class="line"></span><br><span class="line">                                            or al,ah</span><br><span class="line"></span><br><span class="line">                                            mov byte ptr es:[bx],al</span><br><span class="line">                                            add bx,2</span><br><span class="line">                                            pop cx</span><br><span class="line">                                            loop sub3s</span><br><span class="line"></span><br><span class="line">                                            pop ax</span><br><span class="line">                                            pop es</span><br><span class="line">                                            pop cx</span><br><span class="line">                                            pop bx</span><br><span class="line">                                            ret </span><br><span class="line">                                        sub4:</span><br><span class="line">                                            push cx</span><br><span class="line">                                            push si</span><br><span class="line">                                            push di</span><br><span class="line">                                            push es</span><br><span class="line">                                            push ds</span><br><span class="line">                                            </span><br><span class="line">                                            mov si,0b800h</span><br><span class="line">                                            mov es,si</span><br><span class="line">                                            mov ds,si</span><br><span class="line">                                            mov si,160;指向[1]第二行</span><br><span class="line">                                            mov di,0;指向[0]第一行</span><br><span class="line">                                            cld</span><br><span class="line">                                            mov cx,24;指向[24]最后一行</span><br><span class="line"></span><br><span class="line">                                            ;处理1行来上移</span><br><span class="line">                                        sub4s:</span><br><span class="line">                                            push cx</span><br><span class="line">                                            mov cx,160</span><br><span class="line">                                            rep movsb</span><br><span class="line">                                            pop cx</span><br><span class="line">                                            loop sub4s</span><br><span class="line">                                            mov cx,80</span><br><span class="line">                                            mov si,0</span><br><span class="line">                                            ;最后一行置空</span><br><span class="line">                                        sub4s1:</span><br><span class="line">                                            mov byte ptr [160*24+si],&#x27;?&#x27;</span><br><span class="line">                                            mov byte ptr [160*24+si+1],0</span><br><span class="line">                                            add si,2</span><br><span class="line">                                            loop sub4s1</span><br><span class="line"></span><br><span class="line">                                            pop ds</span><br><span class="line">                                            pop es</span><br><span class="line">                                            pop di</span><br><span class="line">                                            pop si</span><br><span class="line">                                            pop cx</span><br><span class="line">                                            ret       </span><br><span class="line"></span><br><span class="line">                                        </span><br><span class="line">                            copy_end: nop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>





<h3 id="8086CPU-gt-div的Interger-over-flow解决方案"><a href="#8086CPU-gt-div的Interger-over-flow解决方案" class="headerlink" title="8086CPU-&gt;div的Interger_over_flow解决方案"></a>8086CPU-&gt;div的Interger_over_flow解决方案</h3><p>这里系统自动把结果的低16位给了ax</p>
<p>我们人为的把结果的高16位给了dx</p>
<p>人为的把余数放在cx中</p>
<p>使得溢出的数据不再丢失</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">;=======================================================</span><br><span class="line">assume cs:code , ds:data, ss:stack</span><br><span class="line">;=======================================================</span><br><span class="line">;数据源S</span><br><span class="line">data segment</span><br><span class="line">     dd 1234567 ;87 D6 12 00</span><br><span class="line">data ends  </span><br><span class="line"> ;=======================================================</span><br><span class="line">;栈段</span><br><span class="line">stack segment stack</span><br><span class="line">     db 128 dup(&#x27;y&#x27;)</span><br><span class="line">stack ends</span><br><span class="line">;=======================================================</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line"> ;main code  </span><br><span class="line"> ;=======================================================</span><br><span class="line">    ;数据源S</span><br><span class="line">    mov ax,data</span><br><span class="line">    mov ds,ax</span><br><span class="line">    mov si,0</span><br><span class="line">    mov bx,0</span><br><span class="line">        </span><br><span class="line">    ;数据地D</span><br><span class="line">    mov ax,7e00h</span><br><span class="line">    mov es,ax</span><br><span class="line">    mov di,0</span><br><span class="line">        </span><br><span class="line">    ;栈</span><br><span class="line">    mov ax,stack</span><br><span class="line">    mov ss,ax</span><br><span class="line">    mov sp,128</span><br><span class="line">               </span><br><span class="line">;=======================================================       </span><br><span class="line">    call div_number   </span><br><span class="line"></span><br><span class="line">over:    </span><br><span class="line">    mov ax,4c00h</span><br><span class="line">    int 21h</span><br><span class="line">;=======================================================         </span><br><span class="line">;function</span><br><span class="line"></span><br><span class="line">div_number:</span><br><span class="line">    ;87 D6 12 00  0x0012D687</span><br><span class="line">    mov ax,ds:[0]   ;0xD687 </span><br><span class="line">    mov dx,ds:[2]   ;0x0012</span><br><span class="line"></span><br><span class="line">    mov cx,10        </span><br><span class="line">    push ax         ;push 0xD687</span><br><span class="line">    mov bp,sp</span><br><span class="line">    ;取bp,自动向下获取数据</span><br><span class="line"></span><br><span class="line">    call long_div</span><br><span class="line">    add sp,2</span><br><span class="line"></span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">long_div:</span><br><span class="line">    mov ax,dx       ;ax=高8位</span><br><span class="line">    mov dx,0        ;dx=0,避免干扰</span><br><span class="line">    div cx          ;</span><br><span class="line">    push ax         ;把高位的数据保存一下,余数作为低位除法的高位</span><br><span class="line">    </span><br><span class="line">    mov ax,ss:[bp]  ;bp记录了低8位原始数据的地址,ax=低8位</span><br><span class="line">    div cx          ;</span><br><span class="line">    mov cx,dx       ;我们自定义把最后的余数给了cx</span><br><span class="line">    pop dx          ;把溢出的数据给了dx</span><br><span class="line"></span><br><span class="line">    ret</span><br><span class="line">;=======================================================  </span><br><span class="line">code ends</span><br><span class="line">end start</span><br><span class="line">;=======================================================</span><br></pre></td></tr></table></figure>

<p>例子就是</p>
<p> <img src="/re4mile.github.io/../../../../Img/Asm-%E5%AE%9E%E8%B7%B5/image-20221025005544886.png" alt="image-20221025005544886"></p>
<p>自我尝试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">;=======================================================</span><br><span class="line">assume cs:code , ds:data, ss:stack</span><br><span class="line">;=======================================================</span><br><span class="line">;数据源S</span><br><span class="line">data segment</span><br><span class="line">     dd 1234567</span><br><span class="line">data ends  </span><br><span class="line"> ;=======================================================</span><br><span class="line">;栈段</span><br><span class="line">stack segment stack</span><br><span class="line">     db 128 dup(&#x27;y&#x27;)</span><br><span class="line">stack ends</span><br><span class="line">;=======================================================</span><br><span class="line">code segment</span><br><span class="line">start:</span><br><span class="line"> ;main code  </span><br><span class="line"> ;=======================================================</span><br><span class="line">    ;数据源S</span><br><span class="line">    mov ax,data</span><br><span class="line">    mov ds,ax</span><br><span class="line">    mov si,0</span><br><span class="line">    mov bx,0</span><br><span class="line">        </span><br><span class="line">    ;数据地D</span><br><span class="line">    mov ax,7e00h</span><br><span class="line">    mov es,ax</span><br><span class="line">    mov di,0</span><br><span class="line">        </span><br><span class="line">    ;栈</span><br><span class="line">    mov ax,stack</span><br><span class="line">    mov ss,ax</span><br><span class="line">    mov sp,128</span><br><span class="line">               </span><br><span class="line">;=======================================================       </span><br><span class="line">    mov ax,ds:[0]</span><br><span class="line">    mov dx,ds:[2]</span><br><span class="line">    mov cx,10</span><br><span class="line"></span><br><span class="line">    push ax</span><br><span class="line">    mov bp,sp</span><br><span class="line">    mov ax,dx</span><br><span class="line">    mov dx,0</span><br><span class="line">    div cx</span><br><span class="line"></span><br><span class="line">    push ax</span><br><span class="line">    </span><br><span class="line">    mov ax,ss:[bp]</span><br><span class="line">    div cx</span><br><span class="line">    </span><br><span class="line">    mov cx,dx</span><br><span class="line">    pop dx</span><br><span class="line"></span><br><span class="line">    add sp,2;堆栈的平衡</span><br><span class="line">over:    </span><br><span class="line">    mov ax,4c00h</span><br><span class="line">    int 21h</span><br><span class="line">;=======================================================         </span><br><span class="line">;function</span><br><span class="line"></span><br><span class="line">                        </span><br><span class="line">           </span><br><span class="line">;=======================================================  </span><br><span class="line">code ends</span><br><span class="line">end start</span><br><span class="line">;=======================================================</span><br></pre></td></tr></table></figure>

<p>它背后的思想是什么?</p>
<p>把数据大数化小,然后一句不变的性质取解除答案</p>
<p>再次书写出现的问题</p>
<p>1.老是忘记mov dx,0</p>
<p>2.add sp,2没有加对位置</p>
<p>3.对于ASCII的打印还不是很理解</p>
<h2 id="x86-课堂代码"><a href="#x86-课堂代码" class="headerlink" title="x86 课堂代码"></a>x86 课堂代码</h2><h3 id="复制字符串"><a href="#复制字符串" class="headerlink" title="复制字符串"></a>复制字符串</h3><p>我的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">title Dqx_Gh0st</span><br><span class="line"></span><br><span class="line">.386</span><br><span class="line">.MODEL flat,stdcall</span><br><span class="line">ExitProcess PROTO, dwExitCode:DWORD	</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">	arr1		db  &quot;hello,I am dqx_Gh0st&quot;,0</span><br><span class="line">	arr2		db   sizeof arr1 dup(0)</span><br><span class="line">.code</span><br><span class="line">main PROC</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">						xor eax,eax                                                                                                                                                                                        </span><br><span class="line">						mov ecx ,sizeof arr1</span><br><span class="line">						mov esi , offset arr1</span><br><span class="line">						mov edi, offset arr2</span><br><span class="line">add_num:</span><br><span class="line">						mov al,[esi]</span><br><span class="line">						mov  [edi],al</span><br><span class="line">						inc	esi</span><br><span class="line">						inc	edi</span><br><span class="line">						loop add_num</span><br><span class="line">			</span><br><span class="line">	INVOKE	ExitProcess,0;调用结束的函数,</span><br><span class="line">;--------------------------------------------------------------------------- </span><br><span class="line">main ENDP</span><br><span class="line">END main</span><br></pre></td></tr></table></figure>

<p>书上的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">						xor eax,eax                                                                                                                                                                                        </span><br><span class="line">						mov ecx ,sizeof arr1</span><br><span class="line">						mov esi , 0</span><br><span class="line">add_num:</span><br><span class="line">						mov al,arr1[esi]</span><br><span class="line">						mov  arr2[esi],al</span><br><span class="line">						inc	esi</span><br><span class="line">						loop add_num</span><br></pre></td></tr></table></figure>





<h3 id="逆序字符串-IDA无法调试-xdebug可以"><a href="#逆序字符串-IDA无法调试-xdebug可以" class="headerlink" title="逆序字符串,IDA无法调试,xdebug可以"></a>逆序字符串,IDA无法调试,xdebug可以</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">title Dqx_Gh0st</span><br><span class="line"></span><br><span class="line">.386</span><br><span class="line">.MODEL flat,stdcall</span><br><span class="line">ExitProcess PROTO, dwExitCode:DWORD	</span><br><span class="line">.stack 128</span><br><span class="line">.data</span><br><span class="line">	arr1	BYTE  &quot;I am Dqx_Gh0st!&quot;,0</span><br><span class="line">	len=($-arr1)-1</span><br><span class="line">	arr2  db   len dup (0)</span><br><span class="line">.code</span><br><span class="line">main PROC</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">						xor eax,eax                                                                                                                                                                                        </span><br><span class="line">						mov ecx,len</span><br><span class="line">						mov esi,offset arr1</span><br><span class="line">		push_str:</span><br><span class="line">						mov al,byte ptr [esi]</span><br><span class="line">						push ax</span><br><span class="line">						inc esi</span><br><span class="line">						loop push_str</span><br><span class="line"></span><br><span class="line">						mov ecx,len</span><br><span class="line">						mov edi,offset arr2</span><br><span class="line">		pop_str:</span><br><span class="line">						pop ax</span><br><span class="line">						mov byte ptr [edi],al</span><br><span class="line">						inc edi</span><br><span class="line">						loop pop_str</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		INVOKE	ExitProcess,0</span><br><span class="line">;--------------------------------------------------------------------------- </span><br><span class="line">main ENDP</span><br><span class="line">END main</span><br></pre></td></tr></table></figure>





<h3 id="strcmp-汇编版-无高级调用"><a href="#strcmp-汇编版-无高级调用" class="headerlink" title="strcmp 汇编版-无高级调用"></a>strcmp 汇编版-无高级调用</h3><p>2个比较的字符串数据长度不一致</p>
<p>1️⃣.结果肯定是不相等</p>
<p>2️⃣.我们还是在小的范围里面比较一下</p>
<p>比较情况</p>
<p>1️⃣.数据尺度一致,一直比较到字符串不相等的地方</p>
<p>2️⃣.数据尺度不一致</p>
<p>在前面长度内,他们的数据都一样,导致ZF一直为1,如果你通过检测到0而采取退出的话,最后的ZF就还是1,而逻辑上的ZF&#x3D;0,毕竟他们不相等</p>
<p>因此,就算我们检测到0,也还是要比较一下,除非2个字符串都检测到0,说明前面都相等,后面也就0,0自然也相等</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">include		Dqx.inc</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.data</span><br><span class="line">;--------------------------------------------------------		</span><br><span class="line">A1	db	&quot;abcdABCD&quot;,0</span><br><span class="line">B1	db	&quot;abcdabcd&quot;,0</span><br><span class="line">len	dd	lengthof A1</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">		;function</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">strcmp proto :ptr byte,:ptr byte</span><br><span class="line"></span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">		.code</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">start:</span><br><span class="line">	</span><br><span class="line">	invoke	strcmp,addr A1,addr B1</span><br><span class="line">over:</span><br><span class="line">	invoke	ExitProcess,NULL</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">;function</span><br><span class="line"></span><br><span class="line">;--------------------------------------</span><br><span class="line">strcmp proc uses eax edx esi edi,str1:ptr byte,str2:ptr byte</span><br><span class="line">		mov esi, str1</span><br><span class="line">		mov edi, str2</span><br><span class="line">check_continue: </span><br><span class="line">		mov al, [esi]</span><br><span class="line">		mov dl, [edi]</span><br><span class="line">		cmp al, 0            </span><br><span class="line">		jne check             </span><br><span class="line">		cmp dl, 0           </span><br><span class="line">		jne check </span><br><span class="line">        ;上面2个cmp操作</span><br><span class="line">        ;当最后字符串末尾都是0就不再检查</span><br><span class="line">        ;如果其中一个是0,另外一个不是0,那么cmp一下,肯定不相等</span><br><span class="line">		jmp no_check             </span><br><span class="line">check:              </span><br><span class="line">		cmp al,dl</span><br><span class="line">		pushfd</span><br><span class="line">		inc esi              </span><br><span class="line">		inc edi </span><br><span class="line">		popfd</span><br><span class="line">		je  check_continue</span><br><span class="line">no_check: </span><br><span class="line">		ret                 </span><br><span class="line">strcmp endp</span><br><span class="line"></span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">end	start</span><br><span class="line">;--------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>inc会影响ZF寄存器,woc</p>
<h3 id="strlen-汇编版-无高级调用"><a href="#strlen-汇编版-无高级调用" class="headerlink" title="strlen 汇编版-无高级调用"></a>strlen 汇编版-无高级调用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">include		Dqx.inc</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.data</span><br><span class="line">;--------------------------------------------------------		</span><br><span class="line">A1	db	&quot;abcd&quot;,0</span><br><span class="line">B1	db	&quot;abcdabcd&quot;,0</span><br><span class="line">len	dd	lengthof A1</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">		;function</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">strlen proto :ptr byte</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">		.code</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">start:</span><br><span class="line">	</span><br><span class="line">	invoke	strlen,addr A1</span><br><span class="line">over:</span><br><span class="line">	invoke	ExitProcess,NULL</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">;function</span><br><span class="line"></span><br><span class="line">;--------------------------------------</span><br><span class="line">strlen proc uses edi,pStr:ptr byte   </span><br><span class="line"></span><br><span class="line">		mov edi, pStr       </span><br><span class="line">		mov eax, 0            </span><br><span class="line">check_continue:	</span><br><span class="line">		cmp byte ptr [edi],0</span><br><span class="line">		je  check_end                 </span><br><span class="line">		inc edi                </span><br><span class="line">		inc eax                </span><br><span class="line">		jmp  check_continue</span><br><span class="line">check_end: </span><br><span class="line">		ret</span><br><span class="line">strlen endp</span><br><span class="line"></span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">end	start</span><br><span class="line">;--------------------------------------------------------</span><br></pre></td></tr></table></figure>



<h3 id="有输入的strlen"><a href="#有输入的strlen" class="headerlink" title="有输入的strlen"></a>有输入的strlen</h3><p>值得注意的是,scanf遇到输入空格就会停止,所以你在键入的时候,就不要输入空格</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">include Dqx.inc</span><br><span class="line">printf proto C :ptr sbyte,:vararg</span><br><span class="line">scanf  proto C :ptr sbyte,:vararg</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.data			</span><br><span class="line">.data</span><br><span class="line"></span><br><span class="line">arr	db	128 dup(0)</span><br><span class="line">in_fmt	db	&quot;%s&quot;,0</span><br><span class="line">out_fmt db	&quot;%d&quot;,0</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.code </span><br><span class="line">start:</span><br><span class="line">		</span><br><span class="line">		invoke scanf,offset in_fmt, offset arr</span><br><span class="line"></span><br><span class="line">		mov al,0</span><br><span class="line">		lea edi,arr</span><br><span class="line">		mov ecx,10</span><br><span class="line">		cld</span><br><span class="line">		repne scasb</span><br><span class="line">		dec edi</span><br><span class="line"></span><br><span class="line">		lea eax,arr</span><br><span class="line">		sub edi,eax</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		invoke	printf,addr out_fmt,edi</span><br><span class="line">		invoke	ExitProcess,NULL</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		end	start</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="strcpy-汇编版-无高级调用"><a href="#strcpy-汇编版-无高级调用" class="headerlink" title="strcpy 汇编版-无高级调用"></a>strcpy 汇编版-无高级调用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">include		Dqx.inc</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.data</span><br><span class="line">;--------------------------------------------------------		</span><br><span class="line">A1	db	&quot;Dqx&quot;,0</span><br><span class="line">len	=	lengthof A1</span><br><span class="line">B1	db	len dup (0)</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">		;function</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">Strcopy proto source:PTR BYTE,  target:PTR BYTE  </span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">		.code</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">start:</span><br><span class="line">	</span><br><span class="line">	invoke	Strcopy ,addr A1,addr B1</span><br><span class="line">over:</span><br><span class="line">	invoke	ExitProcess,NULL</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">;function</span><br><span class="line">;--------------------------------------</span><br><span class="line">;--------------------------------------</span><br><span class="line">Strcopy PROC USES eax ecx esi edi,</span><br><span class="line">    source:PTR BYTE,       ; source string</span><br><span class="line">    target:PTR BYTE        ; target string</span><br><span class="line">;将字符串从源串复制到目的串。</span><br><span class="line">;要求：目标串必须有足够空间容纳从源复制来的串。</span><br><span class="line">;--------------------------------------</span><br><span class="line">    mov		ecx,len             </span><br><span class="line">    mov		esi, source</span><br><span class="line">    mov		edi, target</span><br><span class="line">    cld                            ;</span><br><span class="line">    rep		movsb                  </span><br><span class="line">    ret</span><br><span class="line">Strcopy ENDP</span><br><span class="line"></span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">end	start</span><br><span class="line">;--------------------------------------------------------</span><br></pre></td></tr></table></figure>



<h3 id="strtrim-删除末尾特定的字符"><a href="#strtrim-删除末尾特定的字符" class="headerlink" title="strtrim 删除末尾特定的字符"></a>strtrim 删除末尾特定的字符</h3><p>就一个字符串,假设末尾有字符”#”,然后我们就把它删除</p>
<p>这个函数的巧妙之处就是它是从后面开始遍历的,而不是从头开始</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">include		Dqx.inc</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.data</span><br><span class="line">;--------------------------------------------------------		</span><br><span class="line">A1	db	&quot;Dqx##&quot;,0</span><br><span class="line">len	=	lengthof A1</span><br><span class="line">B1	db	len dup (0)</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">		;function</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">Strtrim proto source:PTR BYTE, : BYTE  </span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">		.code</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">start:</span><br><span class="line">	</span><br><span class="line">	invoke	Strtrim ,addr A1,&quot;#&quot;</span><br><span class="line">	invoke	ExitProcess,NULL</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">;function</span><br><span class="line">;--------------------------------------</span><br><span class="line">;Str_trim</span><br><span class="line">;从字符串末尾删除所有与给定分隔符匹配的字符。</span><br><span class="line">;返回：无</span><br><span class="line">;-------------------------------------</span><br><span class="line">Strtrim PROC USES eax ecx edi,</span><br><span class="line">	pStr:PTR BYTE,                </span><br><span class="line">	char: BYTE                       </span><br><span class="line">	mov edi,pStr                  </span><br><span class="line">	mov eax,len-1   ;我们用len计算的长度是+上了最后一个字节了的        </span><br><span class="line">	cmp eax,0        ;长度为0,就结束这里的bug就是长度为0,0-1=无符号的大数                </span><br><span class="line">	je	over                      </span><br><span class="line">	mov ecx, eax                     </span><br><span class="line">	dec eax	</span><br><span class="line">	add edi,eax	;让inde指向最后一个                    </span><br><span class="line">check_continue:</span><br><span class="line">	mov al, [edi]                 </span><br><span class="line">	cmp al,char                </span><br><span class="line">	jne get_it                        </span><br><span class="line">	dec edi                       </span><br><span class="line">	loop check_continue                  </span><br><span class="line">get_it: </span><br><span class="line">	mov BYTE PTR [edi+1 ],0         </span><br><span class="line">over:</span><br><span class="line">	ret</span><br><span class="line">Strtrim ENDP</span><br><span class="line"></span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">end	start</span><br><span class="line">;--------------------------------------------------------</span><br></pre></td></tr></table></figure>





<h3 id="toupper-字符串大写话"><a href="#toupper-字符串大写话" class="headerlink" title="toupper 字符串大写话"></a>toupper 字符串大写话</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">include		Dqx.inc</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.data</span><br><span class="line">;--------------------------------------------------------		</span><br><span class="line">A1	db	&quot;I_am_Dqx_Gh0st&quot;,0</span><br><span class="line">len	=	lengthof A1</span><br><span class="line">B1	db	len dup (0)</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">		;function</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">toupper proto source:PTR BYTE</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">		.code</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">start:</span><br><span class="line">	</span><br><span class="line">	invoke	toupper ,addr A1</span><br><span class="line">	invoke	ExitProcess,NULL</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">;function</span><br><span class="line">;--------------------------------------</span><br><span class="line">;Str_trim</span><br><span class="line">;从字符串末尾删除所有与给定分隔符匹配的字符。</span><br><span class="line">;返回：无</span><br><span class="line">;-------------------------------------</span><br><span class="line">;---------------------------------</span><br><span class="line">;Str_ucase</span><br><span class="line">;将空字节结束的字符串转换为大写字母。</span><br><span class="line">;返回：无</span><br><span class="line">;---------------------------------</span><br><span class="line">toupper proc uses eax esi,</span><br><span class="line">	pStr:PTR BYTE</span><br><span class="line">	mov esi,pStr</span><br><span class="line">work:</span><br><span class="line">	mov al, [esi]           ;取字符</span><br><span class="line">	cmp al, 0               ;字符串是否结束？</span><br><span class="line">	je over                   ;是：退出</span><br><span class="line">	cmp al, &#x27;a&#x27;             ;小于&quot;a&quot; ？</span><br><span class="line">	jb next</span><br><span class="line">	cmp al, &#x27;z&#x27;             ;大于&quot;z&quot; ？</span><br><span class="line">	ja next</span><br><span class="line">	and byte ptr [esi], 11011111b ;转换字符</span><br><span class="line">next:	</span><br><span class="line">	inc esi                 ;下一个字符</span><br><span class="line">	jmp work</span><br><span class="line">over:	ret</span><br><span class="line">toupper endp</span><br><span class="line"></span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">end	start</span><br><span class="line">;--------------------------------------------------------</span><br></pre></td></tr></table></figure>



<h3 id="tolower-字符串小写化"><a href="#tolower-字符串小写化" class="headerlink" title="tolower 字符串小写化"></a>tolower 字符串小写化</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">include		Dqx.inc</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.data</span><br><span class="line">;--------------------------------------------------------		</span><br><span class="line">A1	db	&quot;I_am_Dqx_Gh0st&quot;,0</span><br><span class="line">len	=	lengthof A1</span><br><span class="line">B1	db	len dup (0)</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">		;function</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">toupper proto source:PTR BYTE</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">		.code</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">start:</span><br><span class="line">	</span><br><span class="line">	invoke	toupper ,addr A1</span><br><span class="line">	invoke	ExitProcess,NULL</span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">;function</span><br><span class="line">;--------------------------------------</span><br><span class="line">;Str_trim</span><br><span class="line">;从字符串末尾删除所有与给定分隔符匹配的字符。</span><br><span class="line">;返回：无</span><br><span class="line">;-------------------------------------</span><br><span class="line">;---------------------------------</span><br><span class="line">;Str_ucase</span><br><span class="line">;将空字节结束的字符串转换为大写字母。</span><br><span class="line">;返回：无</span><br><span class="line">;---------------------------------</span><br><span class="line">toupper proc uses eax esi,</span><br><span class="line">	pStr:PTR BYTE</span><br><span class="line">	mov esi,pStr</span><br><span class="line">work:</span><br><span class="line">	mov al, [esi]           ;取字符</span><br><span class="line">	cmp al, 0               ;字符串是否结束？</span><br><span class="line">	je over                   ;是：退出</span><br><span class="line">	cmp al, &#x27;A&#x27;             ;小于&quot;a&quot; ？</span><br><span class="line">	jb next</span><br><span class="line">	cmp al, &#x27;Z&#x27;             ;大于&quot;z&quot; ？</span><br><span class="line">	ja next</span><br><span class="line">	or byte ptr [esi], 00100000b ;转换字符</span><br><span class="line">next:	</span><br><span class="line">	inc esi                 ;下一个字符</span><br><span class="line">	jmp work</span><br><span class="line">over:	ret</span><br><span class="line">toupper endp</span><br><span class="line"></span><br><span class="line">;--------------------------------------------------------</span><br><span class="line">end	start</span><br><span class="line">;--------------------------------------------------------</span><br></pre></td></tr></table></figure>



<h3 id="asm-两数相加"><a href="#asm-两数相加" class="headerlink" title="__asm 两数相加"></a>__asm 两数相加</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;hello\n&quot;</span>);</span><br><span class="line">	<span class="type">int</span> x,y,z;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>,&amp;x,&amp;y);</span><br><span class="line">	__asm</span><br><span class="line">	&#123;</span><br><span class="line">		mov eax,x</span><br><span class="line">		add eax,y</span><br><span class="line">		mov z,eax</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,z);</span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是一个简单的相加</p>
<h3 id="asm-数组求和"><a href="#asm-数组求和" class="headerlink" title="__asm 数组求和"></a>__asm 数组求和</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">func</span><span class="params">(<span class="type">int</span>*,<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> arr[]=&#123;<span class="number">2</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">8</span>,<span class="number">10</span>&#125;;</span><br><span class="line">	<span class="type">int</span> len=<span class="keyword">sizeof</span>(arr)/<span class="keyword">sizeof</span>(arr[<span class="number">0</span>]);</span><br><span class="line">	<span class="type">int</span> sum=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;wecome to my world\n&quot;</span>);</span><br><span class="line">	sum=func(arr,len);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,sum);</span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">func</span><span class="params">(<span class="type">int</span> *arr,<span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> sum=<span class="number">0</span>;</span><br><span class="line">	__asm</span><br><span class="line">	&#123;</span><br><span class="line">		mov esi,arr</span><br><span class="line">		mov ecx,len</span><br><span class="line">		mov ebx,<span class="number">0</span></span><br><span class="line">		mov eax,<span class="number">0</span></span><br><span class="line">		flag:</span><br><span class="line">			add eax,[esi+ebx*<span class="number">4</span>]</span><br><span class="line">			inc ebx</span><br><span class="line">		loop flag</span><br><span class="line">		mov sum,eax</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>别看你在func函数里面只写了几句汇编,其实你的func函数还是有很多的东西的</p>
<p>好比寄存器的入栈,函数栈的开辟</p>
<h3 id="asm-10进制value-gt-2进制字符串"><a href="#asm-10进制value-gt-2进制字符串" class="headerlink" title="__asm 10进制value-&gt;2进制字符串"></a>__asm 10进制value-&gt;2进制字符串</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">func</span><span class="params">(<span class="type">int</span>,<span class="type">char</span>*)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> str[<span class="number">32</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;wecome to my world\n&quot;</span>);</span><br><span class="line">	func(<span class="number">52</span>,str);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Dec %d= Bin %s\n&quot;</span>,<span class="number">52</span>,str);</span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">func</span><span class="params">(<span class="type">int</span> value,<span class="type">char</span> *<span class="built_in">string</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	__asm</span><br><span class="line">	&#123;</span><br><span class="line">		mov esi,<span class="built_in">string</span></span><br><span class="line">		mov eax,value</span><br><span class="line">		mov byte ptr [esi],<span class="string">&#x27;0&#x27;</span></span><br><span class="line">        <span class="comment">//数值最高位是0,字符串最低位是0</span></span><br><span class="line">		bsr ecx,value</span><br><span class="line">		jz over</span><br><span class="line">		mov byte ptr[esi],<span class="string">&#x27;1&#x27;</span></span><br><span class="line">        <span class="comment">//数值最高位是1,字符串最低位是1</span></span><br><span class="line">		</span><br><span class="line">		flag:</span><br><span class="line">			bt value,<span class="number">0</span></span><br><span class="line">			adc byte ptr[esi+ecx],<span class="string">&#x27;0&#x27;</span></span><br><span class="line">            <span class="comment">//把字符串从最高位往最低位初始化</span></span><br><span class="line">            <span class="comment">//数值从最低位到最高位读取</span></span><br><span class="line">			shr value,<span class="number">1</span></span><br><span class="line">		loop flag</span><br><span class="line">		over:</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于bsr指令和bt指令,见目录寻找</p>
<h3 id="取余运算-难看"><a href="#取余运算-难看" class="headerlink" title="取余运算,难看"></a>取余运算,难看</h3><p>C码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if ((c+1) % 8 == 0) </span><br><span class="line">    printf(&quot; &quot;);</span><br></pre></td></tr></table></figure>

<p>IDA码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add     rax, 1</span><br><span class="line">and     eax, 7          ; 这是一个取模的运输</span><br><span class="line">test    rax, rax        ; rax=0,ZF=1</span><br><span class="line">jnz     short loc_401384</span><br></pre></td></tr></table></figure>



<p>7的二进制00000111</p>
<p>当一个数是0,&amp;7才会是0,其他情况都是非0</p>
<p>所以从0到111,就是一个循环</p>
<h3 id="处理-输入-x2F-输出-溢出"><a href="#处理-输入-x2F-输出-溢出" class="headerlink" title="处理 输入&#x2F;输出 溢出"></a>处理 输入&#x2F;输出 溢出</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">; console2.asm</span><br><span class="line"></span><br><span class="line">section .data							</span><br><span class="line">	msg1	    db    	&quot;Hello, World!&quot;,10,0			</span><br><span class="line">   	msg2  	    db   	&quot;Your turn (only a-z): &quot;,0</span><br><span class="line">  	msg3  	    db    	&quot;You answered: &quot;,0</span><br><span class="line">  	inputlen    equ 	10			;inputbuffer</span><br><span class="line">	NL		    db		0xa					</span><br><span class="line">	</span><br><span class="line">section .bss							</span><br><span class="line">  	input       resb    inputlen+1 		;provide space for ending 0</span><br><span class="line">section .text							</span><br><span class="line">	global main						</span><br><span class="line">main:</span><br><span class="line">    push	rbp </span><br><span class="line">    mov 	rbp,rsp</span><br><span class="line">	mov 	rdi, msg1     	; print first string </span><br><span class="line">	call 	prints   </span><br><span class="line">	 </span><br><span class="line">	mov 	rdi, msg2	; print second string, no NL </span><br><span class="line">	call 	prints</span><br><span class="line">	</span><br><span class="line">	mov 	rdi, input    	; address of inputbuffer</span><br><span class="line">	mov 	rsi, inputlen	; length of inputbuffer </span><br><span class="line">	call 	reads			; wait for input </span><br><span class="line">	</span><br><span class="line">	mov 	rdi, msg3    	; print third string and add the input string</span><br><span class="line">	call 	prints</span><br><span class="line">	</span><br><span class="line">	mov 	rdi, input    	; print the inputbuffer</span><br><span class="line">	call 	prints</span><br><span class="line">	</span><br><span class="line">  	mov 	rdi,NL 			; print NL</span><br><span class="line">	call 	prints     </span><br><span class="line">	</span><br><span class="line">    leave</span><br><span class="line">    ret</span><br><span class="line">;----------------------------------------------------------</span><br><span class="line">prints:</span><br><span class="line">push	rbp</span><br><span class="line">mov		rbp, rsp</span><br><span class="line">push	r12					; callee saved</span><br><span class="line"></span><br><span class="line">; Count characters </span><br><span class="line">    	xor 	rdx, rdx 	; length in rdx</span><br><span class="line">    	mov 	r12, rdi   </span><br><span class="line">.lengthloop:</span><br><span class="line">    	cmp 	byte [r12], 0</span><br><span class="line">    	je 		.lengthfound</span><br><span class="line">    	inc 	rdx</span><br><span class="line">    	inc 	r12</span><br><span class="line">    	jmp 	.lengthloop</span><br><span class="line">.lengthfound:		; print the string, length in rdx</span><br><span class="line">    	cmp 	rdx, 0     	; no string (0 length)</span><br><span class="line">    	je 		.done</span><br><span class="line">    	mov 	rsi,rdi		; rdi contains address of string</span><br><span class="line">    	mov 	rax, 1  	; 1 = write</span><br><span class="line">    	mov 	rdi, 1		; 1 = stdout</span><br><span class="line">    	syscall</span><br><span class="line">.done:</span><br><span class="line">pop r12</span><br><span class="line">leave </span><br><span class="line">ret</span><br><span class="line">;----------------------------------------------------------</span><br><span class="line">reads:</span><br><span class="line">section .data</span><br><span class="line">section .bss</span><br><span class="line">    	.inputchar 	resb 	1  </span><br><span class="line">section .text</span><br><span class="line">push	rbp</span><br><span class="line">mov	rbp, rsp</span><br><span class="line">	    push	r12			; callee saved</span><br><span class="line">	    push	r13			; callee saved</span><br><span class="line">	    push	r14			; callee saved</span><br><span class="line">	    mov 	r12, rdi	; address of stringbuffer</span><br><span class="line">        mov 	r13, rsi   	; max length in r13</span><br><span class="line">       	xor 	r14, r14  	; character counter</span><br><span class="line">.readc: </span><br><span class="line">    	mov 	rax, 0   		; read</span><br><span class="line">    	mov 	rdi, 1      	; stdin</span><br><span class="line">    	lea 	rsi, [.inputchar] 	; address of input</span><br><span class="line">    	mov 	rdx, 1      	; # of characters to read</span><br><span class="line">    	syscall</span><br><span class="line">    	mov 	al, [.inputchar]  	; char is NL?</span><br><span class="line">    	cmp 	al, byte[NL]</span><br><span class="line">    	je 		.done			; NL end</span><br><span class="line">		cmp		al, 97			; lower than a?</span><br><span class="line">		jl		.readc			; ignore it</span><br><span class="line">		cmp		al, 122			; higher than z?</span><br><span class="line">		jg		.readc			; ignore it</span><br><span class="line">    	inc 	r14				; inc counter</span><br><span class="line">    	cmp 	r14, r13</span><br><span class="line">    	ja 		.readc       	; buffer max reached, ignore</span><br><span class="line">    	mov 	byte [r12], al 	; safe the char in the buffer</span><br><span class="line">    	inc 	r12           	; point to next char in buffer</span><br><span class="line">    	jmp 	.readc </span><br><span class="line">.done:</span><br><span class="line">    	inc 	r12</span><br><span class="line">    	mov 	byte [r12],0   	; add end 0 to stringbuffer</span><br><span class="line">	    pop 	r14			; callee saved</span><br><span class="line">	    pop		r13			; callee saved</span><br><span class="line">	    pop		r12			; callee saved</span><br><span class="line">        leave</span><br><span class="line">        ret</span><br></pre></td></tr></table></figure>



<p>他的思路</p>
<p>它使用了一些寄存器来保存参数</p>
<p>用r12,r13来捕捉缓冲区的字符串长度,缓冲区的字符串地址</p>
<p>用r14来做字符串缓冲区的指针,满足条件就移动r14来填入输入的数据</p>
<p>关于输入,他把你的输入作为单个字符,传入一个char buff&#x3D;0的缓冲区,然后检buff</p>
<p>如果buff是换行符就读取结束</p>
<p>如果读取是不满足条件的字符就读取下一个数据,字符串缓冲区的指针不发生变化,继续读取下一个字符</p>
<p>如果满足对应的字符,查看输入的字符串长度是否超过了,如果超过了,不移动指针,继续读取下一个字符</p>
<p>如果没有超过,就移动指针,往字符串地址里面天厨char 的buff</p>
<p>就是这样一个解决读取溢出的</p>
<p>读取是读取到一个一旦长度的buff区域</p>
<p>,读取溢出解决,输出就解决了</p>
<h2 id="win32"><a href="#win32" class="headerlink" title="win32"></a>win32</h2><h3 id="helloword"><a href="#helloword" class="headerlink" title="helloword"></a>helloword</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; 使用 nmake 或下列命令进行编译和链接:</span><br><span class="line">; ml /c /coff Hello.asm</span><br><span class="line">; Link /subsystem:windows Hello.obj</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.386</span><br><span class="line">		.model flat,stdcall</span><br><span class="line">		option casemap:none</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; Include 文件定义</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">c</span><br><span class="line">;对于上面的lib,inc还不是很理解</span><br><span class="line"></span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; 数据段</span><br><span class="line">.data</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">A_Title			db	&#x27;My_First_Box !&#x27;,0</span><br><span class="line">A_Text			db	&#x27;Hello, Dqx_Ghost !&#x27;,0</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; 代码段</span><br><span class="line">.code</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;	</span><br><span class="line">start:</span><br><span class="line">		invoke	MessageBox, NULL, offset A_Text, offset A_Title, MB_OK</span><br><span class="line">		;传递了4个参数,NULL,标题,内容,MB_OK</span><br><span class="line">		invoke	ExitProcess,NULL</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		end	start</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>





<p>IDA</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public start</span><br><span class="line">start proc near</span><br><span class="line">push    0               ; 参数1</span><br><span class="line">push    offset Caption  ; 参数2,标题&quot;My_First_Box !&quot;</span><br><span class="line">push    offset Text     ; 参数3,内容&quot;Hello, Dqx_Ghost !&quot;</span><br><span class="line">push    0               ; 参数4,hwnd????</span><br><span class="line">call    MessageBoxA</span><br><span class="line">push    0               ; uExitCode</span><br><span class="line">call    ExitProcess</span><br><span class="line">start endp</span><br></pre></td></tr></table></figure>





<h3 id="第一个窗口"><a href="#第一个窗口" class="headerlink" title="第一个窗口"></a>第一个窗口</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; Sample code for &lt; Win32ASM Programming 3rd Edition&gt;</span><br><span class="line">; by 罗云彬, http://www.win32asm.com.cn</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; FirstWindow.asm</span><br><span class="line">; 窗口程序的模板代码</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; 使用 nmake 或下列命令进行编译和链接:</span><br><span class="line">; ml /c /coff FirstWindow.asm</span><br><span class="line">; Link /subsystem:windows FirstWindow.obj</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.386</span><br><span class="line">		.model flat,stdcall</span><br><span class="line">		option casemap:none</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; Include 文件定义</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">include		windows.inc</span><br><span class="line">include		gdi32.inc</span><br><span class="line">includelib	gdi32.lib</span><br><span class="line">include		user32.inc</span><br><span class="line">includelib	user32.lib</span><br><span class="line">include		kernel32.inc</span><br><span class="line">includelib	kernel32.lib</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; 数据段</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.data?</span><br><span class="line">hInstance	dd		?	;用来接收资源模块的地址</span><br><span class="line">hWinMain	dd		?	;hWinMain会接受一个窗口的地址</span><br><span class="line"></span><br><span class="line">		.const</span><br><span class="line">szClassName	db	&#x27;MyClass&#x27;,0</span><br><span class="line">szCaptionMain	db	&#x27;My first Window !&#x27;,0</span><br><span class="line">szText		db	&#x27;Win32 Assembly, Simple and powerful !&#x27;,0</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; 代码段</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		.code</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">; 窗口过程</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">_ProcWinMain	proc	uses ebx edi esi hWnd,uMsg,wParam,lParam</span><br><span class="line">		local	@stPs:PAINTSTRUCT</span><br><span class="line">		local	@stRect:RECT</span><br><span class="line">		local	@hDc</span><br><span class="line"></span><br><span class="line">		mov	eax,uMsg</span><br><span class="line">;********************************************************************</span><br><span class="line">		.if	eax ==	WM_PAINT</span><br><span class="line">			invoke	BeginPaint,hWnd,addr @stPs</span><br><span class="line">			mov	@hDc,eax</span><br><span class="line"></span><br><span class="line">			invoke	GetClientRect,hWnd,addr @stRect</span><br><span class="line">			invoke	DrawText,@hDc,addr szText,-1,\</span><br><span class="line">				addr @stRect,\</span><br><span class="line">				DT_SINGLELINE or DT_CENTER or DT_VCENTER</span><br><span class="line"></span><br><span class="line">			invoke	EndPaint,hWnd,addr @stPs</span><br><span class="line">;********************************************************************</span><br><span class="line">		.elseif	eax ==	WM_CLOSE</span><br><span class="line">			invoke	DestroyWindow,hWinMain</span><br><span class="line">			invoke	PostQuitMessage,NULL</span><br><span class="line">;********************************************************************</span><br><span class="line">		.else</span><br><span class="line">			invoke	DefWindowProc,hWnd,uMsg,wParam,lParam</span><br><span class="line">			ret</span><br><span class="line">		.endif</span><br><span class="line">;********************************************************************</span><br><span class="line">		xor	eax,eax</span><br><span class="line">		ret</span><br><span class="line"></span><br><span class="line">_ProcWinMain	endp</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">_WinMain	proc</span><br><span class="line">		local	@stWndClass:WNDCLASSEX</span><br><span class="line">		local	@stMsg:MSG</span><br><span class="line">		</span><br><span class="line">		;参数0,代表0号模块</span><br><span class="line">		invoke	GetModuleHandle,NULL</span><br><span class="line">		mov	hInstance,eax</span><br><span class="line"></span><br><span class="line">		;参数</span><br><span class="line">		;结构体起始地址</span><br><span class="line">		;sizeof(结构体)</span><br><span class="line">		;功能初始化结构体为0</span><br><span class="line">		invoke	RtlZeroMemory,addr @stWndClass,sizeof @stWndClass</span><br><span class="line">;********************************************************************</span><br><span class="line">; 注册窗口类</span><br><span class="line">;重要的参数</span><br><span class="line">;hInstance</span><br><span class="line">;@stWndClass.lpfnWndProc</span><br><span class="line">;@stWndClass.lpszClassName</span><br><span class="line">;********************************************************************</span><br><span class="line">		invoke	LoadCursor,0,IDC_ARROW</span><br><span class="line">		mov	@stWndClass.hCursor,eax</span><br><span class="line">		push	hInstance</span><br><span class="line">		pop	@stWndClass.hInstance</span><br><span class="line">		mov	@stWndClass.cbSize,sizeof WNDCLASSEX</span><br><span class="line">		mov	@stWndClass.style,CS_HREDRAW or CS_VREDRAW</span><br><span class="line">		mov	@stWndClass.lpfnWndProc,offset _ProcWinMain</span><br><span class="line">		mov	@stWndClass.hbrBackground,COLOR_WINDOW + 1</span><br><span class="line">		mov	@stWndClass.lpszClassName,offset szClassName</span><br><span class="line"></span><br><span class="line">		;参数</span><br><span class="line">		;一个已经初始化好的结构体</span><br><span class="line">		;功能:把已经准备好的结构体信息给zhuche3函数</span><br><span class="line">		invoke	RegisterClassEx,addr @stWndClass</span><br><span class="line">;********************************************************************</span><br><span class="line">; 建立并显示窗口</span><br><span class="line">;重要参数</span><br><span class="line">;szClassName 这个参数好像不怎么重要,就是一个名字,或者是一个指针的名字</span><br><span class="line">;hInstance</span><br><span class="line">;********************************************************************</span><br><span class="line">		invoke	CreateWindowEx,WS_EX_CLIENTEDGE,offset szClassName,offset szCaptionMain,\</span><br><span class="line">			WS_OVERLAPPEDWINDOW,\</span><br><span class="line">			100,100,600,400,\</span><br><span class="line">			NULL,NULL,hInstance,NULL</span><br><span class="line">		mov	hWinMain,eax</span><br><span class="line">		;重要的参数是hWinMain</span><br><span class="line">		;参数是窗口的地址</span><br><span class="line">		invoke	ShowWindow,hWinMain,SW_SHOWNORMAL</span><br><span class="line">		invoke	UpdateWindow,hWinMain</span><br><span class="line">;********************************************************************</span><br><span class="line">; 消息循环</span><br><span class="line">;********************************************************************</span><br><span class="line">		.while	TRUE</span><br><span class="line">			;参数	@stMsg,</span><br><span class="line">			;函数的功能获取信息然后初始化@stMsg</span><br><span class="line">			invoke	GetMessage,addr @stMsg,NULL,0,0</span><br><span class="line">			.break	.if eax	== 0</span><br><span class="line">			invoke	TranslateMessage,addr @stMsg</span><br><span class="line">			invoke	DispatchMessage,addr @stMsg</span><br><span class="line">		.endw</span><br><span class="line">		ret</span><br><span class="line"></span><br><span class="line">_WinMain	endp</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">start:</span><br><span class="line">		call	_WinMain</span><br><span class="line">		invoke	ExitProcess,NULL</span><br><span class="line">;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">		end	start</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="第二个窗口"><a href="#第二个窗口" class="headerlink" title="第二个窗口"></a>第二个窗口</h3><p>修改IP的方法?</p>
<p>call	一个位置</p>
<p>然后	jmp到一个位置</p>
<p>最后	ret xx</p>
<p>这就让ip发生了鬼鬼祟祟的变化</p>
<p>这就是回调函数?</p>
<h2 id="asm-gt-avx"><a href="#asm-gt-avx" class="headerlink" title="asm-&gt;avx"></a>asm-&gt;avx</h2><h2 id="打印16进制"><a href="#打印16进制" class="headerlink" title="打印16进制"></a>打印16进制</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000040137C print_xmm       proc near               ; CODE XREF: apply_mxcsr+50↑p</span><br><span class="line">.text:000000000040137C                 push    rbp</span><br><span class="line">.text:000000000040137D                 mov     rbp, rsp</span><br><span class="line">.text:0000000000401380                 mov     rdi, offset hex ; &quot;0x&quot;</span><br><span class="line">.text:000000000040138A                 call    _printf</span><br><span class="line">.text:000000000040138F                 mov     ecx, 8			;它只会打印8字节,默认的</span><br><span class="line">.text:0000000000401394</span><br><span class="line">.text:0000000000401394 print_xmm_loop:                         ; CODE XREF: print_xmm+29↓j</span><br><span class="line">.text:0000000000401394                 xor     rdi, rdi</span><br><span class="line">.text:0000000000401397                 mov     dil, [rcx+404143h]</span><br><span class="line">.text:000000000040139E                 push    rcx</span><br><span class="line">.text:000000000040139F                 call    print_hex	;一个字节字节的打印</span><br><span class="line">.text:00000000004013A4                 pop     rcx</span><br><span class="line">.text:00000000004013A5                 loop    print_xmm_loop</span><br><span class="line">.text:00000000004013A7                 leave</span><br><span class="line">.text:00000000004013A8                 retn</span><br><span class="line">.text:00000000004013A8 print_xmm       endp</span><br></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000040142B print_hex       proc near               ; CODE XREF: print_xmm+23↑p</span><br><span class="line">.text:000000000040142B</span><br><span class="line">.text:000000000040142B var_4           = byte ptr -4</span><br><span class="line">.text:000000000040142B</span><br><span class="line">.text:000000000040142B ; __unwind &#123;</span><br><span class="line">.text:000000000040142B                 endbr64</span><br><span class="line">.text:000000000040142F                 push    rbp</span><br><span class="line">.text:0000000000401430                 mov     rbp, rsp</span><br><span class="line">.text:0000000000401433                 sub     rsp, 10h</span><br><span class="line"></span><br><span class="line">.text:0000000000401437                 mov     eax, edi</span><br><span class="line">.text:0000000000401439                 mov     [rbp+var_4], al</span><br><span class="line">.text:000000000040143C                 cmp     [rbp+var_4], 15</span><br><span class="line">.text:0000000000401440                 ja      short loc_40144C</span><br><span class="line">.text:0000000000401442                 mov     edi, 30h ; &#x27;0&#x27;  ; c</span><br><span class="line">.text:0000000000401447                 call    _putchar</span><br><span class="line">.text:000000000040144C</span><br><span class="line">.text:000000000040144C loc_40144C:                             ; CODE XREF: print_hex+15↑j</span><br><span class="line">.text:000000000040144C                 movzx   eax, [rbp+var_4]</span><br><span class="line">.text:0000000000401450                 mov     esi, eax</span><br><span class="line">.text:0000000000401452                 lea     rdi, format     ; &quot;%x&quot;</span><br><span class="line">.text:0000000000401459                 mov     eax, 0</span><br><span class="line">.text:000000000040145E                 call    _printf</span><br><span class="line">.text:0000000000401463                 nop</span><br><span class="line">.text:0000000000401464                 leave</span><br><span class="line">.text:0000000000401465                 retn</span><br><span class="line">.text:0000000000401465 ; &#125; // starts at 40142B</span><br><span class="line">.text:0000000000401465 print_hex       endp</span><br></pre></td></tr></table></figure>

<h2 id="打印二进制"><a href="#打印二进制" class="headerlink" title="打印二进制"></a>打印二进制</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004013A9 print_mxcsr     proc near               ; CODE XREF: apply_mxcsr+6C↑p</span><br><span class="line">.text:00000000004013A9                                         ; apply_mxcsr+88↑p</span><br><span class="line">.text:00000000004013A9</span><br><span class="line">.text:00000000004013A9 var_18          = qword ptr -18h</span><br><span class="line">.text:00000000004013A9 var_10          = qword ptr -10h</span><br><span class="line">.text:00000000004013A9 var_8           = qword ptr -8</span><br><span class="line">.text:00000000004013A9</span><br><span class="line">.text:00000000004013A9 ; __unwind &#123;</span><br><span class="line">.text:00000000004013A9                 endbr64</span><br><span class="line">.text:00000000004013AD                 push    rbp</span><br><span class="line">.text:00000000004013AE                 mov     rbp, rsp</span><br><span class="line">.text:00000000004013B1                 sub     rsp, 20h</span><br><span class="line">.text:00000000004013B5                 mov     [rbp+var_18], rdi</span><br><span class="line">.text:00000000004013B9                 mov     [rbp+var_10], 0Fh</span><br><span class="line">.text:00000000004013C1                 jmp     short loc_401417</span><br><span class="line">.text:00000000004013C3 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000004013C3</span><br><span class="line">.text:00000000004013C3 loc_4013C3:                             ; CODE XREF: print_mxcsr+73↓j</span><br><span class="line">.text:00000000004013C3                 mov     rax, [rbp+var_10]</span><br><span class="line">.text:00000000004013C7                 mov     edx, eax</span><br><span class="line">.text:00000000004013C9                 mov     rax, [rbp+var_18]</span><br><span class="line">.text:00000000004013CD                 mov     ecx, edx</span><br><span class="line">										;用于判断空格输出</span><br><span class="line">.text:00000000004013CF                 sar     rax, cl </span><br><span class="line">.text:00000000004013D2                 mov     [rbp+var_8], rax</span><br><span class="line">.text:00000000004013D6                 mov     rax, [rbp+var_10]</span><br><span class="line">.text:00000000004013DA                 add     rax, 1</span><br><span class="line">.text:00000000004013DE                 and     eax, 3</span><br><span class="line">.text:00000000004013E1                 test    rax, rax</span><br><span class="line">.text:00000000004013E4                 jnz     short loc_4013F0</span><br><span class="line">.text:00000000004013E6                 mov     edi, 20h ; &#x27; &#x27;  ; c</span><br><span class="line">.text:00000000004013EB                 call    _putchar</span><br><span class="line">.text:00000000004013F0</span><br><span class="line">.text:00000000004013F0 loc_4013F0:                             ; CODE XREF: print_mxcsr+3B↑j</span><br><span class="line">.text:00000000004013F0                 mov     rax, [rbp+var_8]</span><br><span class="line">.text:00000000004013F4                 and     eax, 1</span><br><span class="line">.text:00000000004013F7                 test    rax, rax</span><br><span class="line">.text:00000000004013FA                 jz      short loc_401408</span><br><span class="line">.text:00000000004013FC                 mov     edi, 31h ; &#x27;1&#x27;  ; c</span><br><span class="line">.text:0000000000401401                 call    _putchar</span><br><span class="line">.text:0000000000401406                 jmp     short loc_401412</span><br><span class="line">.text:0000000000401408 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000401408</span><br><span class="line">.text:0000000000401408 loc_401408:                             ; CODE XREF: print_mxcsr+51↑j</span><br><span class="line">.text:0000000000401408                 mov     edi, 30h ; &#x27;0&#x27;  ; c</span><br><span class="line">.text:000000000040140D                 call    _putchar</span><br><span class="line">.text:0000000000401412</span><br><span class="line">.text:0000000000401412 loc_401412:                             ; CODE XREF: print_mxcsr+5D↑j</span><br><span class="line">.text:0000000000401412                 sub     [rbp+var_10], 1</span><br><span class="line">.text:0000000000401417</span><br><span class="line">.text:0000000000401417 loc_401417:                             ; CODE XREF: print_mxcsr+18↑j</span><br><span class="line">.text:0000000000401417                 cmp     [rbp+var_10], 0</span><br><span class="line">.text:000000000040141C                 jns     short loc_4013C3</span><br><span class="line">.text:000000000040141E                 mov     edi, 0Ah        ; 换行</span><br><span class="line">.text:0000000000401423                 call    _putchar</span><br><span class="line">.text:0000000000401428                 nop</span><br><span class="line">.text:0000000000401429                 leave</span><br><span class="line">.text:000000000040142A                 retn</span><br><span class="line">.text:000000000040142A ; &#125; // starts at 4013A9</span><br><span class="line">.text:000000000040142A print_mxcsr     endp</span><br></pre></td></tr></table></figure>







<h1 id="实验的收获"><a href="#实验的收获" class="headerlink" title="实验的收获"></a>实验的收获</h1><p>对于重复的代码,尽量少些,多去调用</p>
<h2 id="循环遍历的方法"><a href="#循环遍历的方法" class="headerlink" title="循环遍历的方法"></a>循环遍历的方法</h2><h3 id="jcxz-jmp"><a href="#jcxz-jmp" class="headerlink" title="jcxz+jmp"></a>jcxz+jmp</h3><p>假设字符串 最后以0来结尾</p>
<p>可能适用于你不知道字符串的长度,然后用0来表示标志位的结尾</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    push  si</span><br><span class="line">    push di</span><br><span class="line">flag:</span><br><span class="line">	mov cx,ds:[si]</span><br><span class="line">	mov es:[di],cx</span><br><span class="line">	jcxz over</span><br><span class="line">	inc si</span><br><span class="line">	add di,2</span><br><span class="line">over:</span><br><span class="line">	pop di</span><br><span class="line">	pop si</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>

<h3 id="loop与cx"><a href="#loop与cx" class="headerlink" title="loop与cx"></a>loop与cx</h3><p>可能适用于你知道cx的长度,然后去遍历它的字符串长度</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    push si</span><br><span class="line">    push di</span><br><span class="line">    mov cx,16</span><br><span class="line">flag:</span><br><span class="line">	mov ax,ds:[si]</span><br><span class="line">	mov es:[di],ax</span><br><span class="line">	inc si</span><br><span class="line">	add di,2</span><br><span class="line">	loop flag</span><br><span class="line">over:</span><br><span class="line">	pop di</span><br><span class="line">	pop si</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>



<h2 id="数据获取string-dup-0"><a href="#数据获取string-dup-0" class="headerlink" title="数据获取string dup (0)"></a>数据获取string dup (0)</h2><p>对于</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0000000000000000</span><br></pre></td></tr></table></figure>

<p>然后填入数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00000000002222222</span><br></pre></td></tr></table></figure>

<p>获取数据时,我们常常jcxz一下</p>
<p>于是获取完毕</p>
<p>但是下一次获取的时候</p>
<p>数据89</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00000000022222289</span><br></pre></td></tr></table></figure>

<p>前面的(上一次的)数影响了</p>
<p>于是怎么办?</p>
<p>就每次填入数据的时候,就是初始化数据的时候,就多写一个标志0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0000022222222</span><br></pre></td></tr></table></figure>

<p>第二次初始化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0000022222089</span><br></pre></td></tr></table></figure>

<p>在89前面就有一个0作为标志位</p>
<h2 id="程序死机的原因"><a href="#程序死机的原因" class="headerlink" title="程序死机的原因"></a>程序死机的原因</h2><p>你没有写</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov ax,<span class="number">4</span>c00h</span><br><span class="line"><span class="type">int</span> <span class="number">21</span>h</span><br></pre></td></tr></table></figure>





<p>关于该数据要用多少位的寄存器存放?</p>
<p>一个无符号的bit位,假设n位,其最大值就是<code>2^n-1</code></p>
<p>一个有符号的bit位,假设n位,其最大值就是<code>2^(n-1)-1</code></p>
<p>遗留的问题(浮点数)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int main(void)</span><br><span class="line">&#123;</span><br><span class="line">	double 	x=3.1415926;</span><br><span class="line">	char	z=&#x27;I&#x27;;</span><br><span class="line">	int		y=(int)x;</span><br><span class="line">	char	ascii1=&#x27;O&#x27;;</span><br><span class="line">	puts(&quot;Good!&quot;);</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">include Dqx.inc	</span><br><span class="line">printf proto C :ptr sbyte,:vararg</span><br><span class="line">scanf  proto C :ptr sbyte,:vararg</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">	n_input		byte &quot;%d %d&quot;,0</span><br><span class="line">	n_output	byte &quot;%d+%d=%d&quot;,10,0</span><br><span class="line">	s_output	BYTE &quot;%s&quot;,10,0</span><br><span class="line"></span><br><span class="line">	str1		byte &quot;welcome to my world&quot;,10</span><br><span class="line">			byte &quot;please input 2 NUm&quot;,0</span><br><span class="line"></span><br><span class="line">	a		dd	0</span><br><span class="line">	b		dd	0</span><br><span class="line"></span><br><span class="line">.code</span><br><span class="line">start:</span><br><span class="line">	invoke	printf,addr s_output,addr str1</span><br><span class="line">	invoke	scanf,addr n_input,addr a,addr b</span><br><span class="line">	mov	eax,0</span><br><span class="line">	add	eax,a</span><br><span class="line">	add	eax,b</span><br><span class="line">	invoke	printf,addr n_output,a,b,eax</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	INVOKE	ExitProcess,0;调用结束的函数,</span><br><span class="line">;--------------------------------------------------------------------------- </span><br><span class="line">end start</span><br></pre></td></tr></table></figure>

<p>输入2个数字,然后相加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">welcome to my world</span><br><span class="line">please input 2 NUm</span><br><span class="line">10 20</span><br><span class="line">10+20=30</span><br></pre></td></tr></table></figure>



<h1 id="windows下-C-x2F-C-学习-调试"><a href="#windows下-C-x2F-C-学习-调试" class="headerlink" title="windows下 C&#x2F;C++学习-调试"></a>windows下 C&#x2F;C++学习-调试</h1><h2 id="x86-1"><a href="#x86-1" class="headerlink" title="x86"></a>x86</h2><h3 id="count-3-x3D-x3D-0-吐了"><a href="#count-3-x3D-x3D-0-吐了" class="headerlink" title="count++ % 3 &#x3D;&#x3D; 0 吐了"></a>count++ % 3 &#x3D;&#x3D; 0 吐了</h3><p>汇编翻译吐了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* count.c -- using standard I/O */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> ((ch = getc(in)) != EOF)</span><br><span class="line">    &#123;</span><br><span class="line">    	<span class="keyword">if</span> (count++ % <span class="number">3</span> == <span class="number">0</span>)</span><br><span class="line">            ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">//int版本</span><br><span class="line">mov     ecx, [esp+1Ch]</span><br><span class="line">lea     eax, [ecx+1]</span><br><span class="line">mov     [esp+28], eax</span><br><span class="line">mov     edx, 55555556h</span><br><span class="line">mov     eax, ecx</span><br><span class="line">imul    edx</span><br><span class="line">mov     eax, ecx</span><br><span class="line">sar     eax, 31</span><br><span class="line">sub     edx, eax</span><br><span class="line">mov     eax, edx</span><br><span class="line">mov     edx, eax</span><br><span class="line">add     edx, edx</span><br><span class="line">add     edx, eax</span><br><span class="line">mov     eax, ecx</span><br><span class="line">sub     eax, edx</span><br><span class="line">test    eax, eax</span><br><span class="line">jnz     short loc_4015A9</span><br><span class="line">//byte版本</span><br><span class="line">movzx   ecx, byte ptr [esp+31]</span><br><span class="line">mov     eax, ecx</span><br><span class="line">add     eax, 1</span><br><span class="line">mov     [esp+31], al</span><br><span class="line">movsx   ax, cl</span><br><span class="line">imul    eax, 86</span><br><span class="line">shr     ax, 8</span><br><span class="line">mov     edx, eax</span><br><span class="line">mov     eax, ecx</span><br><span class="line">sar     al, 7</span><br><span class="line">sub     edx, eax</span><br><span class="line">mov     eax, edx</span><br><span class="line">mov     edx, eax</span><br><span class="line">add     edx, edx</span><br><span class="line">add     edx, eax</span><br><span class="line">mov     eax, ecx</span><br><span class="line">sub     eax, edx</span><br><span class="line">test    al, al</span><br><span class="line">jnz     short loc_4015AD</span><br></pre></td></tr></table></figure>

<p>它的意思是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">//byte版本</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">  	<span class="type">int</span> result=<span class="number">0</span>;<span class="comment">//eax</span></span><br><span class="line">    <span class="type">int</span> count=<span class="number">6</span>;<span class="comment">//ecx, byte ptr [esp+31]</span></span><br><span class="line">   	result=count<span class="number">-3</span>*((count*<span class="number">86</span>)&gt;&gt;<span class="number">8</span>-(count&gt;&gt;<span class="number">7</span>));</span><br><span class="line">   	<span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//int版本</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">    int result=0;</span></span><br><span class="line"><span class="comment">    int count=10;</span></span><br><span class="line"><span class="comment">   	result-=count-3*(count*0x55555556&gt;&gt;32-count&gt;&gt;31);</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>我还是看不懂</p>
<h3 id="ds-iob-func"><a href="#ds-iob-func" class="headerlink" title="ds:__iob_func"></a>ds:__iob_func</h3><p><code>__iob_func()</code>返回一个指向<code>FILE</code>描述符数组的指针，</p>
<p>该数组包含<code>stdin</code>、<code>stdout</code>和通过 C 运行时库打开的<code>stderr</code>任何对象。</p>
<h3 id="RTC-CheckEsp"><a href="#RTC-CheckEsp" class="headerlink" title="RTC_CheckEsp"></a>RTC_CheckEsp</h3><p>参数 ZF寄存器</p>
<p>它主要分布在一些函数调用之间,</p>
<p>也就是函数前mov esi,ebp</p>
<p>函数结束后就cmp esi,ebp</p>
<p>验证<code>esp</code>, stack, register 正确性的调用。调用它以确保<code>esp</code>在函数调用中保存 的值。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0044</span>EE35  mov         esi,esp</span><br><span class="line">    .....一些操作</span><br><span class="line">	......</span><br><span class="line"><span class="number">0044</span>EE4D  cmp         esi,esp </span><br><span class="line"><span class="number">0044</span>EE4F  call        @ILT+<span class="number">6745</span>(__RTC_CheckEsp) (<span class="number">42B</span>A5Eh) </span><br></pre></td></tr></table></figure>

<p>在那一顿操作过后,他就检测栈是否还原</p>
<p>就是比较esi与esp</p>
<h3 id="关于函数-RTC-CheckEsp"><a href="#关于函数-RTC-CheckEsp" class="headerlink" title="关于函数__RTC_CheckEsp"></a>关于函数__RTC_CheckEsp</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">_RTC_CheckEsp:</span><br><span class="line"><span class="number">00475</span><span class="function">A60  jne         <span class="title">esperror</span> <span class="params">(<span class="number">475</span>A63h)</span> </span></span><br><span class="line"><span class="function">00475A62  ret         <span class="comment">//如果相等就返回</span></span></span><br><span class="line"><span class="function">    				 <span class="comment">//不相等就死了</span></span></span><br><span class="line"><span class="function">esperror:</span></span><br><span class="line"><span class="function"><span class="number">00475</span>A63  push        ebp  </span></span><br><span class="line"><span class="function"><span class="number">00475</span>A64  mov         ebp,esp </span></span><br><span class="line"><span class="function"><span class="number">00475</span>A66  sub         esp,<span class="number">0</span> </span></span><br><span class="line"><span class="function"><span class="number">00475</span>A69  push        eax  </span></span><br><span class="line"><span class="function"><span class="number">00475</span>A6A  push        edx  </span></span><br><span class="line"><span class="function"><span class="number">00475</span>A6B  push        ebx  </span></span><br><span class="line"><span class="function"><span class="number">00475</span>A6C  push        esi  </span></span><br><span class="line"><span class="function"><span class="number">00475</span>A6D  push        edi  </span></span><br><span class="line"><span class="function"><span class="number">00475</span>A6E  mov         eax,dword ptr [ebp+<span class="number">4</span>] </span></span><br><span class="line"><span class="function"><span class="number">00475</span>A71  push        <span class="number">0</span>    </span></span><br><span class="line"><span class="function"><span class="number">00475</span>A73  push        eax  </span></span><br><span class="line"><span class="function"><span class="number">00475</span>A74  call        _RTC_Failure (<span class="number">42</span>C34Bh) </span></span><br><span class="line"><span class="function"><span class="number">00475</span>A79  add         esp,<span class="number">8</span> </span></span><br><span class="line"><span class="function"><span class="number">00475</span>A7C  pop         edi  </span></span><br><span class="line"><span class="function"><span class="number">00475</span>A7D  pop         esi  </span></span><br><span class="line"><span class="function"><span class="number">00475</span>A7E  pop         ebx  </span></span><br><span class="line"><span class="function"><span class="number">00475</span>A7F  pop         edx  </span></span><br><span class="line"><span class="function"><span class="number">00475</span>A80  pop         eax  </span></span><br><span class="line"><span class="function"><span class="number">00475</span>A81  mov         esp,ebp </span></span><br><span class="line"><span class="function"><span class="number">00475</span>A83  pop         ebp  </span></span><br><span class="line"><span class="function"><span class="number">00475</span>A84  ret </span></span><br></pre></td></tr></table></figure>



<h3 id="security-check-cookie"><a href="#security-check-cookie" class="headerlink" title="@__security_check_cookie"></a>@__security_check_cookie</h3><p>基于Cookie的缓冲区溢出安全检查！</p>
<p>这个Cookie的变量位于函数体内的局部变量和EBP的存放地址之间，具体表示就是：[EBP-4]。</p>
<p>__security_init_cookie()这个函数对__security_cookie变量再次初始化</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取cooike变量</span></span><br><span class="line"><span class="comment">//每个函数的ebp保持不变且不同,于是coike与ebp异或</span></span><br><span class="line"><span class="comment">//把cooike压入ebp-4</span></span><br><span class="line">mov eax,dword ptr [___security_cookie (<span class="number">4B</span>7A74h)]</span><br><span class="line"><span class="keyword">xor</span> eax,ebp</span><br><span class="line">mov dword ptr [ebp<span class="number">-4</span>],eax</span><br></pre></td></tr></table></figure>



<p>关于cooike在栈中的位置</p>
<p>就是最开始压入EBP后ESP的值，</p>
<p>ebp减4就刚好挨着一进函数时压入的EBP的地址减4。好了！Cookie变量已经在栈帧中了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00991010</span> push    ebp					<span class="comment">//这里是ebp位置</span></span><br><span class="line">.text:<span class="number">00991011</span> mov     ebp, esp			</span><br><span class="line">.text:<span class="number">00991013</span> sub     esp, <span class="number">13</span>Ch			<span class="comment">//esp的开辟</span></span><br></pre></td></tr></table></figure>



<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00F</span>5FBA0  <span class="number">66</span>DDC4AD  							<span class="comment">//cooike</span></span><br><span class="line"><span class="number">00F</span>5FBA4  <span class="number">00F</span>5FBF4  Stack[<span class="number">000022</span>C4]:<span class="number">00F</span>5FBF4	<span class="comment">//ebp</span></span><br><span class="line"><span class="number">00F</span>5FBA8  <span class="number">0099170F</span>  ___tmainCRTStartup+<span class="number">1B</span>F</span><br></pre></td></tr></table></figure>



<p>与EBP异或当然有好处。</p>
<ol>
<li><p>可以增加随机性，尽可能使不同函数的安全Cookie都不同。</p>
</li>
<li><p>可以检查EBP是否被破坏，因为在函数结束检查Cookie时，还会将Cookie变量值再次与EBP异或，如果EBP的值没有变化，那么就能恢  复成原来的___security_cookie值。</p>
</li>
</ol>
<p>一系列过程允许后又回到</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//取出cokkie变量</span></span><br><span class="line"><span class="comment">//还原cookie变量</span></span><br><span class="line"><span class="comment">//检查是否和原来一样</span></span><br><span class="line">mov         ecx,dword ptr [ebp<span class="number">-4</span>]</span><br><span class="line"><span class="keyword">xor</span>         ecx,ebp</span><br><span class="line">call        @ILT+<span class="number">920</span>(@__security_check_cookie@<span class="number">4</span>) (<span class="number">43739</span>Dh)</span><br></pre></td></tr></table></figure>



<p>好像函数@__security_check_cookie@4采用了某个调用约定,所以的话ecx是第一个参数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00991220</span> ; <span class="type">void</span> __fastcall __security_check_cookie(<span class="type">uintptr_t</span> StackCookie)	<span class="comment">//某个调用约定</span></span><br><span class="line">.text:<span class="number">00991220</span> @__security_check_cookie@<span class="number">4</span> proc near    ; CODE XREF: _main_0+<span class="number">153</span>↑p</span><br><span class="line">.text:<span class="number">00991220</span>                                         ; <span class="built_in">failwithmessage</span>(<span class="type">void</span> *,<span class="type">int</span>,<span class="type">int</span>,<span class="type">char</span> <span class="type">const</span> *)+<span class="number">208</span>↓p ...</span><br><span class="line">.text:<span class="number">00991220</span> cmp     ecx, ___security_cookie		<span class="comment">//把参数于原始的cooike做一个比较</span></span><br><span class="line">.text:<span class="number">00991226</span> jnz     <span class="type">short</span> $failure$<span class="number">26820</span>			<span class="comment">//不相等就死翘翘</span></span><br><span class="line">.text:<span class="number">00991228</span> rep retn</span><br><span class="line">.text:<span class="number">0099122</span>A ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0099122</span>A</span><br><span class="line">.text:<span class="number">0099122</span>A $failure$<span class="number">26820</span>:                         ; CODE XREF: __security_check_cookie(x)+<span class="number">6</span>↑j</span><br><span class="line">.text:<span class="number">0099122</span>A jmp     ___report_gsfailure			<span class="comment">//到这里来了后就处理cooike不正常的处理</span></span><br><span class="line">.text:<span class="number">0099122</span>A @__security_check_cookie@<span class="number">4</span> endp</span><br></pre></td></tr></table></figure>





<h3 id="RTC-CheckStackVar"><a href="#RTC-CheckStackVar" class="headerlink" title="@_RTC_CheckStackVar"></a>@_RTC_CheckStackVar</h3><p>顾名思义，就是用来检查局部数据是否访问越界。</p>
<p>相对来说，</p>
<p>&#x3D;&#x3D;这种检查只能起到一定的作用&#x3D;&#x3D;，并不会所有越界访问都能检查到。</p>
<p>&#x3D;&#x3D;既然是检查局部的&#x3D;&#x3D;，那么在函数内定义的static类型数组或者函数外部的全局数组并不会采用此检查，</p>
<p>&#x3D;&#x3D;既然是检查数组&#x3D;&#x3D;，那么如果函数内没有局部数组时，此检查也不会存在。</p>
<blockquote>
<p> 背景</p>
<p>在VS的debug版本下，局部变量之间并不是连续存放在栈内存里的</p>
<p>而是以4字节对齐的方式，前后都会有保护字节的。保护字节占4个字节，可能是值为0xcc，很明显这是汇编指令int 3中断的代码字节</p>
</blockquote>
<p>原始代码void  __fastcall _RTC_CheckStackVars( void *_Esp, _RTC_framedesc *_Fd );</p>
<p>参数 </p>
<p>ecx 	原来函数的ebp</p>
<p>edx	一个fd结构体指针</p>
<p>参数传递</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0099114B</span> mov     ecx, ebp   	<span class="comment">//参数1                     ; Esp</span></span><br><span class="line">.text:<span class="number">0099114</span>D push    eax</span><br><span class="line">.text:<span class="number">0099114</span>E lea     edx, Fd	<span class="comment">//参数2</span></span><br><span class="line">.text:<span class="number">00991154</span> call    @_RTC_CheckStackVars@<span class="number">8</span></span><br></pre></td></tr></table></figure>

<p>关于fd结构体类型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">RTC_framedesc</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">int</span> varCount;                            <span class="comment">//  要检查的数组的个数</span></span><br><span class="line">    _RTC_vardesc *variables;        		<span class="comment">//  要检查的数组的相关信息</span></span><br><span class="line"></span><br><span class="line">&#125; _RTC_framedesc;</span><br></pre></td></tr></table></figure>



<p>关于嵌套的结构体 _RTC_vardesc</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">RTC_vardesc</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">int</span> addr;                                   	<span class="comment">//  数组的首地址相对于EBP的偏移量</span></span><br><span class="line">    <span class="type">int</span> size;                                    <span class="comment">//  数组的大小字节数</span></span><br><span class="line">    <span class="type">char</span> *name;                             	<span class="comment">//  数组的名字</span></span><br><span class="line">&#125; _RTC_vardesc;</span><br></pre></td></tr></table></figure>

<p>起反汇编代码</p>
<p>也不是很难…..</p>
<p>瞎看C代码–基于vs2008</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">RTC_vardesc</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">int</span> addr;</span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line">    <span class="type">char</span>* name;</span><br><span class="line">&#125; _RTC_vardesc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">RTC_framedesc</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">int</span> varCount;</span><br><span class="line">    _RTC_vardesc* variables;	<span class="comment">//结构体指针</span></span><br><span class="line">&#125; _RTC_framedesc;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __fastcall _RTC_CheckStackVars( <span class="type">void</span>* _Esp, _RTC_framedesc* _Fd )	<span class="comment">//ecx,edx</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( _Fd-&gt;varCount == <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">//如果数组个数是0,就不检测</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> _RetAddr = <span class="number">0</span>;</span><br><span class="line">    __asm</span><br><span class="line">    &#123;</span><br><span class="line">        mov eax, ebp</span><br><span class="line">        add eax, <span class="number">4</span></span><br><span class="line">        mov _RetAddr, eax   <span class="comment">// 保存返回地址</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ( i &lt; _Fd-&gt;varCount ) <span class="comment">//i&lt;数组的个数</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span>* pAddr = ( <span class="type">char</span>* )_Esp + _Fd-&gt;variables[i].addr - <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">if</span> ( *( <span class="type">int</span>* )pAddr != <span class="number">0xcccccccc</span> )</span><br><span class="line">            __asm <span class="type">int</span> <span class="number">3</span>  <span class="comment">// 引发中断</span></span><br><span class="line">            </span><br><span class="line">        <span class="type">int</span> ofs = _Fd-&gt;variables[i].addr + _Fd-&gt;variables[i].size;</span><br><span class="line">        pAddr = ( <span class="type">char</span>* )_Esp + ofs;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( *( <span class="type">int</span>* )pAddr != <span class="number">0xcccccccc</span> )</span><br><span class="line">            __asm <span class="type">int</span> <span class="number">3</span>  <span class="comment">// 引发中断</span></span><br><span class="line">        ++i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>vs2010的IDA伪代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall _RTC_CheckStackVars(<span class="type">void</span> *Esp, _RTC_framedesc *Fd)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// edi</span></span><br><span class="line">  _RTC_vardesc *variables; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> addr; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+Ch] [ebp-4h]</span></span><br><span class="line">  <span class="type">void</span> *retaddr; <span class="comment">// [esp+14h] [ebp+4h]</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; Fd-&gt;varCount; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    variables = Fd-&gt;variables;	<span class="comment">//包含数组信息的结构体</span></span><br><span class="line">    addr = variables[v2].addr;	<span class="comment">//[index]小结构体的指针</span></span><br><span class="line">      <span class="comment">//检测对应数组2边的保护字节????0xcc</span></span><br><span class="line">    <span class="keyword">if</span> ( *(_DWORD *)((<span class="type">char</span> *)Esp + addr - <span class="number">4</span>) != <span class="number">0xCCCCCCCC</span></span><br><span class="line">      || *(_DWORD *)((<span class="type">char</span> *)Esp + addr + variables[v2].size) != <span class="number">0xCCCCCCCC</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      _RTC_StackFailure(retaddr, variables[v2].name);</span><br><span class="line">    &#125;</span><br><span class="line">    ++v2;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>vs2008的汇编</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00991260</span> ; <span class="type">void</span> __fastcall _RTC_CheckStackVars(<span class="type">void</span> *Esp, _RTC_framedesc *Fd)</span><br><span class="line">.text:<span class="number">00991260</span> @_RTC_CheckStackVars@<span class="number">8</span> proc near        ; CODE XREF: _main_0+<span class="number">144</span>↑p</span><br><span class="line">.text:<span class="number">00991260</span></span><br><span class="line">.text:<span class="number">00991260</span> var_4= dword ptr <span class="number">-4</span></span><br><span class="line">.text:<span class="number">00991260</span></span><br><span class="line">.text:<span class="number">00991260</span> mov     edi, edi</span><br><span class="line">    </span><br><span class="line">.text:<span class="number">00991262</span> push    ebp</span><br><span class="line">.text:<span class="number">00991263</span> mov     ebp, esp</span><br><span class="line">    </span><br><span class="line">.text:<span class="number">00991265</span> push    ecx</span><br><span class="line">.text:<span class="number">00991266</span> push    ebx</span><br><span class="line">.text:<span class="number">00991267</span> push    esi</span><br><span class="line">.text:<span class="number">00991268</span> push    edi</span><br><span class="line">    </span><br><span class="line">.text:<span class="number">00991269</span> <span class="keyword">xor</span>     edi, edi</span><br><span class="line">.text:<span class="number">0099126B</span> mov     esi, edx	<span class="comment">// 将_RTC_framedesc结构指针赋值给esi</span></span><br><span class="line">.text:<span class="number">0099126</span>D mov     ebx, ecx	<span class="comment">// 将函数的栈帧赋值给ebx</span></span><br><span class="line">.text:<span class="number">0099126F</span> mov     [ebp+var_4], edi	<span class="comment">// 这里的i应该是循环变量，后面根据数组的个数循环检测</span></span><br><span class="line">    </span><br><span class="line">.text:<span class="number">00991272</span> cmp     [esi], edi		<span class="comment">//cmp fd,0	 比较数值个数是否为0</span></span><br><span class="line">    </span><br><span class="line">.text:<span class="number">00991274</span> jle     <span class="type">short</span> loc_9912BE		<span class="comment">//没有数组,万事大吉,通过检测</span></span><br><span class="line">.text:<span class="number">00991276</span> jmp     <span class="type">short</span> loc_991280		<span class="comment">//进一步检测</span></span><br><span class="line">.text:<span class="number">00991276</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">00991278</span> align <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">00991280</span></span><br><span class="line">.text:<span class="number">00991280</span> loc_991280:                             ; CODE XREF: _RTC_CheckStackVars(x,x)+<span class="number">16</span>↑j</span><br><span class="line">.text:<span class="number">00991280</span>                                         ; _RTC_CheckStackVars(x,x)+<span class="number">5</span>C↓j</span><br><span class="line">.text:<span class="number">00991280</span> mov     eax, [esi+<span class="number">4</span>]		 <span class="comment">//  +4之后就是_RTC_framedesc.variables指针</span></span><br><span class="line">.text:<span class="number">00991283</span> mov     ecx, [eax+edi] 	<span class="comment">//  _RTC_vardesc-&gt;addr了，就是数组的首地址相对于TestVars的EBP的偏</span></span><br><span class="line">.text:<span class="number">00991286</span> cmp     dword ptr [ecx+ebx<span class="number">-4</span>], <span class="number">0</span>CCCCCCCCh  <span class="comment">//  如果不等于0xcccccccc就报错_RTC_StackFailure</span></span><br><span class="line">.text:<span class="number">0099128</span>E jnz     <span class="type">short</span> loc_99129F</span><br><span class="line">.text:<span class="number">00991290</span> mov     edx, [eax+edi+<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">00991294</span> add     edx, ecx</span><br><span class="line">.text:<span class="number">00991296</span> cmp     dword ptr [edx+ebx], <span class="number">0</span>CCCCCCCCh</span><br><span class="line">.text:<span class="number">0099129</span>D jz      <span class="type">short</span> loc_9912B0</span><br><span class="line">.text:<span class="number">0099129F</span></span><br><span class="line">.text:<span class="number">0099129F</span> loc_99129F:                             ; CODE XREF: _RTC_CheckStackVars(x,x)+<span class="number">2</span>E↑j</span><br><span class="line">.text:<span class="number">0099129F</span> mov     ecx, [eax+edi+<span class="number">8</span>]				<span class="comment">//即是_RTC_vardesc-&gt;name，用于报错提示</span></span><br><span class="line">.text:<span class="number">009912</span>A3 mov     edx, [ebp+<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">009912</span>A6 push    ecx                             ; <span class="type">char</span> * <span class="comment">// 传入越界的数组名</span></span><br><span class="line">.text:<span class="number">009912</span>A7 push    edx                             ; <span class="type">void</span> * </span><br><span class="line">    <span class="comment">// 传入edx=EBP+4的地址，此地址正是_RTC_CheckStackVars的返回地址，用于定位</span></span><br><span class="line">.text:<span class="number">009912</span>A8 call    ?_RTC_StackFailure@@YAXPAXPBD@Z ; _RTC_StackFailure(<span class="type">void</span> *,<span class="type">char</span> <span class="type">const</span> *)</span><br><span class="line">     <span class="comment">// 调用此函数后，弹出异常MessageBox，提示哪个数组越界</span></span><br><span class="line">.text:<span class="number">009912</span>AD add     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">009912B</span>0</span><br><span class="line">.text:<span class="number">009912B</span>0 loc_9912B0:                             ; CODE XREF: _RTC_CheckStackVars(x,x)+<span class="number">3</span>D↑j</span><br><span class="line">.text:<span class="number">009912B</span>0 mov     eax, [ebp+var_4]			  <span class="comment">// 存在多个数组需要检查时有用</span></span><br><span class="line">.text:<span class="number">009912B</span>3 inc     eax</span><br><span class="line">.text:<span class="number">009912B</span>4 add     edi, <span class="number">0</span>Ch					 <span class="comment">// 定位到下一个_RTC_vardesc结构</span></span><br><span class="line">.text:<span class="number">009912B</span>7 mov     [ebp+var_4], eax</span><br><span class="line">.text:<span class="number">009912B</span>A cmp     eax, [esi]</span><br><span class="line">.text:<span class="number">009912B</span>C jl      <span class="type">short</span> loc_991280</span><br><span class="line">.text:<span class="number">009912B</span>E</span><br><span class="line">    </span><br><span class="line">.text:<span class="number">009912B</span>E loc_9912BE:                             ; CODE XREF: _RTC_CheckStackVars(x,x)+<span class="number">14</span>↑j</span><br><span class="line">.text:<span class="number">009912B</span>E pop     edi</span><br><span class="line">.text:<span class="number">009912B</span>F pop     esi</span><br><span class="line">.text:<span class="number">009912</span>C0 pop     ebx</span><br><span class="line">.text:<span class="number">009912</span>C1 mov     esp, ebp</span><br><span class="line">.text:<span class="number">009912</span>C3 pop     ebp</span><br><span class="line">.text:<span class="number">009912</span>C4 retn</span><br><span class="line">.text:<span class="number">009912</span>C4 @_RTC_CheckStackVars@<span class="number">8</span> endp</span><br></pre></td></tr></table></figure>



<h3 id="基于数组缓冲区溢出修改ip"><a href="#基于数组缓冲区溢出修改ip" class="headerlink" title="基于数组缓冲区溢出修改ip"></a>基于数组缓冲区溢出修改ip</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line">				</span><br><span class="line"><span class="type">void</span> <span class="title function_">HelloWord</span><span class="params">()</span>			</span><br><span class="line">&#123;			</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Hello World&quot;</span>);						</span><br><span class="line">&#125;			</span><br><span class="line"><span class="type">void</span> <span class="title function_">Fun</span><span class="params">()</span>			</span><br><span class="line">&#123;			</span><br><span class="line">	<span class="type">int</span> arr[<span class="number">5</span>] = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;;				</span><br><span class="line">	arr[<span class="number">6</span>] = (<span class="type">int</span>)HelloWord;				</span><br><span class="line">&#125;	</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	Fun();	</span><br><span class="line">&#125;		</span><br><span class="line"><span class="comment">//运行环境 devc++ x86 debug</span></span><br><span class="line"><span class="comment">//代码可以打印出&quot;Hello World&quot;</span></span><br></pre></td></tr></table></figure>



<p>数组只有5个,强行写了6个</p>
<p>数值最后一个元素在[ebp-4]</p>
<p>强行写的arr[6],超出来2个</p>
<p>arr[5]已经超出来,arr[5]是ebp,ebp里面存放了原来的ebp</p>
<p>arr[6]已经超出来,arr[6]是ebp-4,ebp-4存放了push 进去的ip 现在ip被修改为了一个函数的地址</p>
<p>于是就可以运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line">sub     esp, 20h</span><br><span class="line">mov     dword ptr [ebp-20], 1</span><br><span class="line">mov     dword ptr [ebp-16], 2</span><br><span class="line">mov     dword ptr [ebp-12], 3</span><br><span class="line">mov     dword ptr [ebp-8], 4</span><br><span class="line">mov     dword ptr [ebp-4], 5</span><br><span class="line">mov     eax, offset __Z9HelloWordv ; HelloWord(void)</span><br><span class="line">mov     [ebp+4], eax</span><br><span class="line">leave</span><br><span class="line">retn</span><br></pre></td></tr></table></figure>







<h3 id="缓冲区溢出修改其它变量"><a href="#缓冲区溢出修改其它变量" class="headerlink" title="缓冲区溢出修改其它变量"></a>缓冲区溢出修改其它变量</h3><p>用不休止的hello world</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">//exe会	用不休止的hello world			</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Fun</span><span class="params">()</span>					</span><br><span class="line">&#123;					</span><br><span class="line">	<span class="type">int</span> i;				</span><br><span class="line">	<span class="type">int</span> arr[<span class="number">5</span>] = &#123;<span class="number">0</span>&#125;;							</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;=<span class="number">5</span>;i++)				</span><br><span class="line">	&#123;				</span><br><span class="line">		arr[i] = <span class="number">0</span>;			</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Hello World!...&quot;</span>);			</span><br><span class="line">	&#125;				</span><br><span class="line">&#125;					</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	Fun();	</span><br><span class="line">&#125;		</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">                push    ebp</span><br><span class="line">                mov     ebp, esp</span><br><span class="line">                sub     esp, 38h</span><br><span class="line">                mov     dword ptr [ebp-32], 0</span><br><span class="line">                mov     dword ptr [ebp-28], 0</span><br><span class="line">                mov     dword ptr [ebp-24], 0</span><br><span class="line">                mov     dword ptr [ebp-20], 0</span><br><span class="line">                mov     dword ptr [ebp-16], 0</span><br><span class="line">                mov     dword ptr [ebp-12], 0</span><br><span class="line">                jmp     short loc_40154D</span><br><span class="line">; ---------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">loc_401532:                             ; CODE XREF: Fun(void)+51↓j</span><br><span class="line">                mov     eax, [ebp-12]</span><br><span class="line">                mov     dword ptr [ebp+eax*4-32], 0</span><br><span class="line">                mov     dword ptr [esp], offset Buffer ; &quot;Hello World!...&quot;</span><br><span class="line">                call    _puts</span><br><span class="line">                add     [ebp+i], 1</span><br><span class="line"></span><br><span class="line">loc_40154D:                             ; CODE XREF: Fun(void)+30↑j</span><br><span class="line">                cmp     [ebp+i], 5</span><br><span class="line">                jle     short loc_401532</span><br><span class="line">                leave</span><br><span class="line">                retn</span><br></pre></td></tr></table></figure>



<p>通过arr数组缓冲区溢出,修改了变量i,最后又再一次为0</p>
<h3 id="gets内存越界"><a href="#gets内存越界" class="headerlink" title="gets内存越界"></a>gets内存越界</h3><p>内存越界</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">( )</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> str[<span class="number">5</span>];</span><br><span class="line">    <span class="type">char</span> a;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;Enter a value :&quot;</span>);</span><br><span class="line">    fgets( str,<span class="number">5</span>,<span class="built_in">stdin</span> );      </span><br><span class="line">    <span class="comment">//gets(str);</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;result: \n&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>( str );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a: %c \n&quot;</span>,a);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Enter a value :123456789</span><br><span class="line">result:</span><br><span class="line">1234</span><br><span class="line">a: x</span><br></pre></td></tr></table></figure>





<h3 id="确定哪个call是主要的call"><a href="#确定哪个call是主要的call" class="headerlink" title="确定哪个call是主要的call"></a>确定哪个call是主要的call</h3><p>比如</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>* ptr=(<span class="type">int</span>*)<span class="built_in">calloc</span>(<span class="number">1024</span>,<span class="keyword">sizeof</span>(<span class="type">int</span>));</span><br></pre></td></tr></table></figure>

<p>跟进函数calloc</p>
<p>然后calloc函数里面可能还会有很多的call</p>
<p>于是你就看哪个call对eax,或者ptr做了修改,那么那个call就可能是主要的call</p>
<h2 id="x64-2"><a href="#x64-2" class="headerlink" title="x64"></a>x64</h2><h3 id="printf-1"><a href="#printf-1" class="headerlink" title="printf"></a>printf</h3><p>参数1是rcx</p>
<p>参数2是rdx</p>
<p>参数3是r8f</p>
<p>参数4是r9d</p>
<h1 id="switch"><a href="#switch" class="headerlink" title="switch"></a>switch</h1><p>1.分支&lt;&#x3D;3的时候，用switch没有意义，因为编译器会生成类似if..else之类的反汇编</p>
<h1 id="硬编码"><a href="#硬编码" class="headerlink" title="硬编码"></a>硬编码</h1><p>对于vs来说,修改一下项目属性</p>
<p>项目属性-&gt;链接器-&gt;高级-&gt;执行数据保护-&gt;取消</p>
<p>对于Dev来说,就不需要了,用gcc编译的字节码去</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> code[] = </span><br><span class="line">&#123;</span><br><span class="line">    <span class="number">0x55</span>, <span class="number">0x89</span>, <span class="number">0xE5</span>, <span class="number">0x8B</span>, <span class="number">0x55</span>, <span class="number">0x08</span>, <span class="number">0x8B</span>, <span class="number">0x45</span>, <span class="number">0x0C</span>, <span class="number">0x01</span>, <span class="number">0xD0</span>, <span class="number">0x5D</span>,<span class="number">0xc3</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> x + y;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> (*pfun)(<span class="type">int</span>, <span class="type">int</span>) = (<span class="type">int</span>(*)(<span class="type">int</span>, <span class="type">int</span>))&amp;code;</span><br><span class="line">	<span class="type">int</span> sum =pfun(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, sum);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>对于vs,可以用gcc的字节码</p>
<p>对于gcc,不要用vs的字节码</p>
<p>vs有很多自带的,特殊的字节码,所以在vs里面就不要去调用那些字节码</p>
<h1 id="PELAOD"><a href="#PELAOD" class="headerlink" title="PELAOD"></a>PELAOD</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><span class="line">.386</span><br><span class="line">.model flat,stdcall</span><br><span class="line">option casemap:none</span><br><span class="line"> </span><br><span class="line">include windows.inc</span><br><span class="line">include msvcrt.inc</span><br><span class="line">include user32.inc</span><br><span class="line">include kernel32.inc</span><br><span class="line"> </span><br><span class="line">includelib msvcrt.lib</span><br><span class="line">includelib user32.lib</span><br><span class="line">includelib kernel32.lib</span><br><span class="line"> </span><br><span class="line">.data</span><br><span class="line">IMAGE_SIZE equ 2000h  ;程序加载更改项</span><br><span class="line"> </span><br><span class="line">.const</span><br><span class="line">g_fileName db &quot;helloPe.exe&quot;,0 ;程序加载更改项</span><br><span class="line"> </span><br><span class="line">.code</span><br><span class="line">org IMAGE_SIZE - 1000h ;这里减1000是程序本身具有头文件可以不拷贝，直接利用</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">checkPE proc lpAddress:LPVOID</span><br><span class="line">     </span><br><span class="line">    mov esi,lpAddress</span><br><span class="line">    assume esi : ptr IMAGE_DOS_HEADER</span><br><span class="line">     </span><br><span class="line">    .if [esi].e_magic != &#x27;ZM&#x27;</span><br><span class="line">        mov eax,0</span><br><span class="line">        ret</span><br><span class="line">    .endif</span><br><span class="line">     </span><br><span class="line">    ;指向PE文件头</span><br><span class="line">    add esi,[esi].e_lfanew</span><br><span class="line">    assume esi : ptr IMAGE_NT_HEADERS</span><br><span class="line">    .if[esi].Signature !=&#x27;EP&#x27;</span><br><span class="line">        mov eax,0</span><br><span class="line">        ret</span><br><span class="line">    .endif</span><br><span class="line">     </span><br><span class="line">    ret</span><br><span class="line">checkPE endp</span><br><span class="line"> </span><br><span class="line">LoadPe proc uses esi ebx edi hMod:HMODULE</span><br><span class="line">    LOCAL @hFile:HANDLE</span><br><span class="line">    LOCAL @hMap:HANDLE</span><br><span class="line">    LOCAL @lpAddress:LPVOID</span><br><span class="line">    LOCAL @NumberOfSections:dword ;节区表数量</span><br><span class="line">    LOCAL @SizeOfOptional:dword ;可选头大小</span><br><span class="line">    LOCAL @AddrOfEntryPoint:dword;程序执行入口</span><br><span class="line">    LOCAL @SizeOfImage:dword;所有头部加节表大小</span><br><span class="line">    LOCAL @SizeOfHeaders:dword;头部占空间的大小</span><br><span class="line">    LOCAL @dwOld:dword</span><br><span class="line">    LOCAL @SectionAddr:dword</span><br><span class="line">    LOCAL @importAddr:dword</span><br><span class="line">    LOCAL @zeroIDD :IMAGE_DATA_DIRECTORY</span><br><span class="line">    LOCAL @DllhMod:HMODULE</span><br><span class="line">     </span><br><span class="line">    invoke RtlZeroMemory, addr @zeroIDD,sizeof IMAGE_DATA_DIRECTORY ;设置全0结构体检测地址是否为0</span><br><span class="line">     </span><br><span class="line">    ;读取文件</span><br><span class="line">    invoke CreateFile,offset g_fileName,GENERIC_READ,FILE_SHARE_READ,0,OPEN_EXISTING,FILE_ATTRIBUTE_NORMAL,0</span><br><span class="line">    .if eax==INVALID_HANDLE_VALUE</span><br><span class="line">        jmp DISPOSE_ERROR</span><br><span class="line">    .endif </span><br><span class="line">    mov @hFile,eax</span><br><span class="line">     </span><br><span class="line">    ;创建内存位图</span><br><span class="line">    invoke CreateFileMapping,@hFile,NULL,PAGE_READONLY,0,0,NULL</span><br><span class="line">    .if eax==NULL</span><br><span class="line">        jmp DISPOSE_ERROR</span><br><span class="line">    .endif </span><br><span class="line">    mov @hMap,eax</span><br><span class="line">     </span><br><span class="line">    ;位图映射到进程,复制可执行文件的头部到PE装载器申请内存的首地址</span><br><span class="line">    invoke MapViewOfFile,@hMap,FILE_MAP_READ,0,0,0</span><br><span class="line">    .if eax==NULL</span><br><span class="line">        jmp DISPOSE_ERROR</span><br><span class="line">    .endif </span><br><span class="line">    mov @lpAddress,eax</span><br><span class="line">     </span><br><span class="line">    ;检查PE的头文件格式是否合法</span><br><span class="line">    invoke checkPE,@lpAddress</span><br><span class="line">    .if eax ==NULL</span><br><span class="line">        jmp DISPOSE_ERROR</span><br><span class="line">    .endif</span><br><span class="line">     </span><br><span class="line"> </span><br><span class="line">    mov esi,@lpAddress</span><br><span class="line">    assume esi : ptr IMAGE_DOS_HEADER</span><br><span class="line">     </span><br><span class="line">    ;需要拿到的属性filehead 的可选头大小，节区表数量，需要optionhead里AddressOfEntryPoint</span><br><span class="line">    ;SizeOfHeaders</span><br><span class="line">         </span><br><span class="line">    add esi,[esi].e_lfanew</span><br><span class="line">    assume esi : ptr IMAGE_NT_HEADERS</span><br><span class="line">         </span><br><span class="line">    movzx eax,[esi].FileHeader.NumberOfSections</span><br><span class="line">    mov @NumberOfSections,eax</span><br><span class="line">     </span><br><span class="line">    movzx eax,[esi].FileHeader.SizeOfOptionalHeader</span><br><span class="line">    mov @SizeOfOptional,eax</span><br><span class="line">     </span><br><span class="line">    mov eax,[esi].OptionalHeader.AddressOfEntryPoint ;拿到程序入口点地址</span><br><span class="line">    mov @AddrOfEntryPoint,eax</span><br><span class="line">    mov eax,[esi].OptionalHeader.SizeOfImage ;拿到头部+节区表的总长度</span><br><span class="line">    mov @SizeOfImage,eax</span><br><span class="line">    mov eax,[esi].OptionalHeader.SizeOfHeaders</span><br><span class="line">    mov @SizeOfHeaders,eax</span><br><span class="line">     </span><br><span class="line">    ;这里获取导入表的地址,等于导入信息表的下标1*结构体的大小</span><br><span class="line">    lea eax,[esi].OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT * sizeof IMAGE_DATA_DIRECTORY]</span><br><span class="line">    mov @importAddr,eax</span><br><span class="line">     </span><br><span class="line">    ;拷贝可执行文件的头部到当前文件的模块载入地址</span><br><span class="line">     </span><br><span class="line">    ;更改代码段的属性</span><br><span class="line">    invoke VirtualProtect,hMod,@SizeOfImage,PAGE_EXECUTE_READWRITE,addr @dwOld</span><br><span class="line"> </span><br><span class="line">    invoke crt_memcpy, hMod, @lpAddress,@SizeOfHeaders</span><br><span class="line">    .if eax==NULL</span><br><span class="line">        jmp DISPOSE_ERROR</span><br><span class="line">    .endif</span><br><span class="line">         </span><br><span class="line">    ;5 复制区块表的相关数据到PE装载器申请内存的相应地址,注意：记得加模块偏移</span><br><span class="line">    lea esi,[esi].OptionalHeader</span><br><span class="line">    add esi,@SizeOfOptional</span><br><span class="line">     </span><br><span class="line">    ;拿到了区块表的起始地址</span><br><span class="line">    mov @SectionAddr,esi</span><br><span class="line">     </span><br><span class="line">    ;转换esi地址为IMAGE_SECTION_HEADER结构体</span><br><span class="line">    mov esi,@SectionAddr</span><br><span class="line">    assume esi:ptr IMAGE_SECTION_HEADER</span><br><span class="line">    xor ecx,ecx</span><br><span class="line">     </span><br><span class="line">    .while ecx&lt;@NumberOfSections</span><br><span class="line">        .if [esi].SizeOfRawData!=0 ;首先判断文件偏移是否为0，为0是未初始化的节区</span><br><span class="line">        mov eax,[esi].PointerToRawData ;文件的偏移加文件在内存中的基地址得到文件区块的起始位置</span><br><span class="line">        add eax,@lpAddress ;在文件中的偏移加文件的基地址</span><br><span class="line">         </span><br><span class="line">        mov edi,[esi].VirtualAddress;文件在内存中映射的位置</span><br><span class="line">        add edi,hMod ;在内存中的偏移加内存中的基地址</span><br><span class="line">         </span><br><span class="line">        invoke crt_memcpy ,edi,eax,[esi].SizeOfRawData</span><br><span class="line">        .if eax ==NULL</span><br><span class="line">            jmp DISPOSE_ERROR</span><br><span class="line">        .endif</span><br><span class="line">         </span><br><span class="line">        .endif </span><br><span class="line">        inc ecx</span><br><span class="line">        add esi,sizeof IMAGE_SECTION_HEADER</span><br><span class="line">    .endw</span><br><span class="line">     </span><br><span class="line">    ;加载导入表信息</span><br><span class="line">    mov esi,@importAddr</span><br><span class="line">    mov esi,dword ptr[esi]</span><br><span class="line">    add esi,hMod</span><br><span class="line">    assume esi:ptr IMAGE_IMPORT_DESCRIPTOR</span><br><span class="line">     </span><br><span class="line">    invoke crt_memcmp,esi,addr @zeroIDD,sizeof @zeroIDD</span><br><span class="line">    .while eax!=0</span><br><span class="line">        mov eax,[esi].FirstThunk</span><br><span class="line">        add eax ,hMod</span><br><span class="line">        .if dword ptr [eax] != 0 ;IAT表不为空</span><br><span class="line"> </span><br><span class="line">            mov ebx,[esi].OriginalFirstThunk</span><br><span class="line">            .if ebx == 0</span><br><span class="line">             mov ebx,[esi].FirstThunk</span><br><span class="line">            .endif</span><br><span class="line">             </span><br><span class="line">            add ebx,hMod ;不管是IAT表为空还是INT表为空，值都会保存在Ebx</span><br><span class="line">             </span><br><span class="line">            mov edi,[esi].FirstThunk</span><br><span class="line">            add edi,hMod ;edi得到iat的位置</span><br><span class="line">             </span><br><span class="line">            mov eax,[esi].Name1</span><br><span class="line">            add eax,hMod</span><br><span class="line">             </span><br><span class="line">            ;获取模块的名称</span><br><span class="line">            push ecx</span><br><span class="line">            invoke LoadLibrary,eax</span><br><span class="line">            pop ecx</span><br><span class="line">            mov @DllhMod,eax</span><br><span class="line">             </span><br><span class="line">            mov ecx,0</span><br><span class="line">            .while dword ptr[ebx+ecx*4] !=0</span><br><span class="line">                mov eax,[ebx+ecx*4]</span><br><span class="line">                .if eax&amp;80000000h</span><br><span class="line">                    ;序号导入</span><br><span class="line">                    and eax,0ffffh ;拿到了低4位的值</span><br><span class="line">                 </span><br><span class="line">                .else</span><br><span class="line">                    ;名称导入</span><br><span class="line">                    add eax,hMod</span><br><span class="line">                    assume eax:ptr IMAGE_IMPORT_BY_NAME</span><br><span class="line">                    lea eax,[eax].Name1</span><br><span class="line">                .endif         </span><br><span class="line">                    ;此时eax保存了序号或者函数名</span><br><span class="line">                    push ecx</span><br><span class="line">                    invoke GetProcAddress, @DllhMod,eax</span><br><span class="line">                    pop ecx</span><br><span class="line">                    mov [edi+ecx*4],eax</span><br><span class="line">                    inc ecx</span><br><span class="line">            .endw</span><br><span class="line">             </span><br><span class="line">        .endif</span><br><span class="line">         </span><br><span class="line">        add esi,sizeof IMAGE_IMPORT_DESCRIPTOR</span><br><span class="line">        invoke crt_memcmp,esi,addr @zeroIDD,sizeof @zeroIDD</span><br><span class="line">    .endw</span><br><span class="line">     </span><br><span class="line">    ;跳转到程序入口点</span><br><span class="line">    mov eax,hMod</span><br><span class="line">    add @AddrOfEntryPoint,eax</span><br><span class="line">    call @AddrOfEntryPoint</span><br><span class="line">     </span><br><span class="line">DISPOSE_ERROR:</span><br><span class="line"> </span><br><span class="line">    .if @lpAddress !=NULL</span><br><span class="line">        invoke UnmapViewOfFile,@lpAddress</span><br><span class="line">    .endif</span><br><span class="line">     </span><br><span class="line">    .if @hMap!=NULL</span><br><span class="line">        invoke CloseHandle,@hMap</span><br><span class="line">    .endif</span><br><span class="line"> </span><br><span class="line">    .if @hFile!=INVALID_HANDLE_VALUE</span><br><span class="line">        invoke CloseHandle,@hFile</span><br><span class="line">    .endif</span><br><span class="line">    ret</span><br><span class="line">LoadPe endp</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">START:</span><br><span class="line">    ;获取程序载入模块的确切地址</span><br><span class="line">    invoke GetModuleHandle,NULL</span><br><span class="line">    invoke LoadPe,eax</span><br><span class="line">    invoke ExitProcess,0</span><br><span class="line">end START</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/re4mile.github.io/2023/01/11/language/Asm/windwos/32/%E5%9F%BA%E7%A1%80/language/" rel="prev" title="">
                  <i class="fa fa-chevron-left"></i> 
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/re4mile.github.io/2023/01/11/language/Asm/windwos/32/%E5%B0%8F%E4%B8%93%E9%A2%98/CRT%E6%A0%87%E5%87%86%E5%BA%93/language/" rel="next" title="x86汇编 CRT标准库">
                  x86汇编 CRT标准库 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">re4mile(邓渠香)</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/re4mile.github.io/js/comments.js"></script><script src="/re4mile.github.io/js/utils.js"></script><script src="/re4mile.github.io/js/motion.js"></script><script src="/re4mile.github.io/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/re4mile.github.io/js/third-party/search/local-search.js"></script>





  





</body>
</html>
